<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="http://yueban.github.io">
  <title>极客时间 - 《趣谈网络协议》笔记 | 月半兄的小站</title><meta name="robots" content="noindex">
  <meta name="generator" content="hexo-theme-yilia-plus">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="description" content="第1讲 | 为什么要学习网络协议？协议三要素  语法，就是这一段内容要符合一定的规则和格式。 语义，就是这一段内容要代表某种意义。 顺序，就是先干啥，后干啥。  协议举例: HTTP12345678910HTTP&#x2F;1.1 200 OKDate: Tue, 27 Mar 2018 16:50:26 GMTContent-Type: text&#x2F;html;charset&#x3D;UTF-8Content-Lan">
<meta property="og:type" content="article">
<meta property="og:title" content="极客时间 - 《趣谈网络协议》笔记">
<meta property="og:url" content="http://yueban.github.io/2019/03/12/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4-%E3%80%8A%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E3%80%8B%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="月半兄的小站">
<meta property="og:description" content="第1讲 | 为什么要学习网络协议？协议三要素  语法，就是这一段内容要符合一定的规则和格式。 语义，就是这一段内容要代表某种意义。 顺序，就是先干啥，后干啥。  协议举例: HTTP12345678910HTTP&#x2F;1.1 200 OKDate: Tue, 27 Mar 2018 16:50:26 GMTContent-Type: text&#x2F;html;charset&#x3D;UTF-8Content-Lan">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/39/1f/395b304f49559034af34c882bd86f11f.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/54/86/54ffefbe4f493f0f4a39f45504bd5086.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e1/24/e1e45ba0d86d2774ec80a1d86f87b724.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/7d/0e/7da571c18b974582a9cfe4718c5dea0e.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/6e/a4/6e69007db3fc68ff6da8496266abf6a4.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/1f/11/1f6a5e17b34f00d28722428b7b8ccb11.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/da/ab/dab9f6ee2908b05ed6f15f3e21be88ab.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/16/7b/16dcd6fb8105a1caa75887b5ffa0bd7b.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/f7/a4/f7b1d3bc6b6d8e55f0951e82294c8ba4.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/77/92/77d5eeb659d5347874bda5e8f711f692.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/77/ef/778687d1a02ffc0c24078c33be2ac1ef.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/60/8c/602d09290bd4f9e0183f530e9653348c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/d3/1c/d353eee3c387332e378c1e517c642f1c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ab/d7/ab6e0ecfee5e21f7a563999a94bd8bd7.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/cf/19/cff688ede147809da4d65fe4152ffb19.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/10/74/10ff27d1032bf32393195f23ef2f9874.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/1c/c1/1c2cfd4326d0dfca652ac8501321fac1.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/0b/7a/0bc51f8f887aae04ef89a1a88cb5a17a.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/03/dd/03d4a216c024a9e761ed43c6787bf7dd.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/a6/22/a66563b46906e7708cc69a02d43afb22.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/70/02/7042f5c3d9e3437d5b0b30b30f43c802.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/43/b4/433a51e15d0ed50e313454ceccd61cb4.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e4/f8/e4d4b538c434ec0eade37028a34391f8.jpg">
<meta property="og:image" content="http://yueban.github.io/2019/03/12/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4-%E3%80%8A%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E3%80%8B%E7%AC%94%E8%AE%B0/!%5B%5D(https://static001.geekbang.org/resource/image/b8/70/b8f215697ce950005a532d3be341f570.jpg)">
<meta property="og:image" content="http://images.cppblog.com/cppblog_com/elva/530c5a8a2cdb1936c9fc7a6a.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/42/60/42dcd0705e3b1bad05d59fd9d6707d60.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/14/2e/14221e482876b0b243f5213c7a1cc62e.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/1a/4b/1a97a0b90c2304cbdf22a2bc8a8ce94b.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/52/ee/52d2e201f87462bc3afed8ce4d743aee.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/8e/cf/8ece62f3f99cb3fe7ee0274a1ad79fcf.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/59/a6/59f79cba26904ff721aabfcdc0c27da6.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ff/f2/ff7e8f824ebd1f7e16ef5d70cd79bdf2.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/56/d1/569ddad1a0c5a5f60341fbe023b47cd1.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/91/00/914d44e3d9246804b1b670b216146100.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/9e/38/9edb73c0e7b369de8784376485427e38.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/d8/cc/d8c77f59d6b7ac894b5192252239cfcc.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/8f/f8/8fdfb8d4e1cd5a9a086f99b98a7555f8.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/84/94/84196dedd044cc135bfc28ede4687d94.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/11/50/116a168c0eb55fabd7786fca728bd850.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/10/3a/10aa7eac3fd38dfc2a09d6475ff4d93a.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/08/13/080ce3bbe673de38e196b5b741a86313.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/2a/2c/2aa3787c31c52defc7614c53f0a71d2c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/90/eb/9002b47ad5dc7762faf37e60250211eb.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/99/92/99f86d113a629d81bb52786d80ca5c92.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/a7/f1/a7c0a7fd2334d7145d093cf24bc6d7f1.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/34/af/34a952bd1abeec19460b8d5dca5cd0af.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/28/78/28a3938ab8efaf9fa7f313a46d0e1478.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/87/59/87a34817f22ed4a2afb58e8f6496f159.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/71/ca/71fa17f5bb21c12aec1234eec85a6dca.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/df/b5/dfc5a7934added3cc11d9c95a69a9bb5.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ab/32/ab77ad0cec6a26f43bacb3f51b0c8d32.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/78/ee/782742e09ddddcef169c9982b65c69ee.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/94/84/947e2fece5e3b2750b0b73c9458f3784.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ba/ec/bae67c4e3f4a4127bad07de4bb577bec.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/3c/dd/3cd18d212bf76e7151ea73aa65ef48dd.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/c0/e2/c065c4f15421c7fd9924c472948aa8e2.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/39/90/39fa17696761d28f2f04c8555041aa90.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/94/18/9453ee22b697455ba3f2c4f89936b018.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e4/50/e40f7cb5754e01ed82ae120d8d571f50.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/03/29/0397a72d0c5d76d4e3591cbe61eef729.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/84/32/84c128c408ac748f1206b9b4d4500132.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/4d/d2/4d3e9282b00410a28e77f91f9375f4d2.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/9a/7e/9a257afaa9c8a158a5a99e2df00dcf7e.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/93/f4/9347b67409e26924ea9358f052f2e9f4.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e5/07/e55e9a85106d9086e51cd649a182d707.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/a1/b7/a145ea19a844b3e38834efbf0f4cedb7.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/2d/c4/2dd447992fbf4901f92a3dfdf8086bc4.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/72/8b/72b49cdeeb8846025f310a1f59b6b88b.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/34/f9/346fe3b3dbe1024e7119ec4ffa9377f9.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/38/d0/383710afd8e2b7e99ba8ccfef69c02d0.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ed/f7/ed8939e33728c6118db3c0283b1dbdf7.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/91/77/91a7f011885ec48ca57d61940b748477.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/34/22/342ac21bda24e20d8d78f47ca8415a22.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/6e/b4/6e1ddc1eb92c85cda32f40b62dd9fcb4.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/8a/6c/8a1956cb5bbf03de7d6cbaa2e706046c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/d8/14/d870e5bfcad8ec45d146c3226cdccb14.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/27/a8/274442ba251fdc63c88bc5dbfc6183a8.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/24/59/24b09861632f7ba7211073e2829d4f59.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/a9/fc/a924ccda5d54bcad6f67fdebe0a6c1fc.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/89/fd/897618c5f5b65e8c35ef5f20a731cdfd.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/1a/17/1a0ba797b9a0f0e32c9e561b97955917.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/93/a3/93aa707cb55c47023ae958d6cadde8a3.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/24/24/246db57c915d9ccf6e0d66182de0fe24.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/1a/1a/1a5d299c2eb5480eda93a8f8e3b3ca1a.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e7/a6/e7eda457d064071bcfa92219e6aefaa6.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/7e/3e/7e3218260e75bb9f18d68641928ff33e.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/da/71/da3a4653469877d9d98f1610ccaefd71.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/c2/15/c2170423769b8dfb6e6ff854287ab115.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/9a/b5/9a1b8a7c0c5403a2b4b3c277545991b5.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/b1/31/b189df0a6ee4b0462818bf2f154c9531.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/76/ce/76298ce51d349bc9805fbf317312e4ce.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/3b/0f/3b02d54c9093e3de6d1a847dd0eb060f.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e4/77/e4541dfd1571aab11694343520970a77.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/27/79/27b0f23c0e94c10bac63d2ec6401e079.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/37/6c/377070660f2474b90489b0f10f8f686c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/5b/6e/5ba8f197a682de2539594ef5d7e7d56e.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/b4/19/b4d39cfc833be380be67eeee8019d319.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/20/d2/20e87bc215b9d049a4a504d775d26dd2.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/49/bb/49bb6b2a30fe76b124182980da935ebb.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/01/c8/01ee306698c7dd6207e80fea0a8238c8.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/a5/01/a568cb08c615b351e871bd981541a201.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/c3/9c/c3e999c033a0417df98c0bcc34c9349c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e5/7d/e59559ad7b46b9811553b6b0a85e8e7d.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/df/b2/df8d92d84af55369055738283339d6b2.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/f7/ff/f7e9467901ccb4b7e8039c53314244ff.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/88/84/88a1817b32c3c364fbbdf50b05d49e84.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/85/25/8534c52daf3682cd1cfe5a3375ec9525.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/2a/eb/2a0fd84c2d3dced623511e2a5226d0eb.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/4a/af/4a649954fea1cee22fcfa8bdb34c03af.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/c7/65/c724675527afdbd43964bdf24684fa65.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/5c/58/5c3ebb31ac4415d7895247bf8758fa58.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/27/b9/27dc1ccd0481408055c87e0e5d8b02b9.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/2a/7c/2aff190d1f878749d2a5bd73228ca37c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/33/e4/33e1afe4a79e81096e09b850424930e4.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/f0/b8/f08ef51889add2c26c57c9edd3db93b8.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/c6/c2/c622af64f47e264453088e79c3e631c2.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ef/ce/ef916f46dc293ac2d5739b496f0b27ce.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/50/3c/50443d6848f890e475e71be11489d33c.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/15/02/15e254a8e92e031b20feb6ebdcc32402.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ed/20/eddde5929de2a72b197321e5ad87e120.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/d6/a7/d66c01c39e911e784525a118c37b50a7.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e1/24/e132bc3ba500b1197139f30c02e20124.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/85/fc/85c125c225faba29c0f374e18ea8c6fc.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/70/83/705e4cc5acc7b364bdf015f333d40783.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/99/49/99c282efaca15deb79c7821c9c577349.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/8e/5a/8edfb048b27aed3cc2eeb892ae22175a.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/48/24/4879c63596736cc91dbb696046e95024.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/ab/52/ab5b03ebf7facf71721566165f921252.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/1f/11/1f6a5e17b34f00d28722428b7b8ccb11.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/fe/5f/fe9fb6d6e9deea8c3543f54572ec765f.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/8a/71/8af9a0a7c1d24b73d26ab0ef5f54b071.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/e5/94/e561d8a5ec5842a67513ba42bda09494.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/2b/0b/2bf7de23e5bda856c606a73f66dd050b.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/56/f8/56e282315a2ef361aa0a8bb1cf0b38f8.jpg">
<meta property="article:published_time" content="2019-03-12T12:04:53.000Z">
<meta property="article:modified_time" content="2020-05-16T08:21:29.828Z">
<meta property="article:author" content="月半兄">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static001.geekbang.org/resource/image/39/1f/395b304f49559034af34c882bd86f11f.jpg">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  
    <link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.a5fda8.css">
  <style type="text/css">
    
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

  
  


  

</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      


<div class="overlay" style="background: #4d4d4d;"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/img/author.jpg" class="js-avatar">
		</a>
		<hgroup>
			<h1 class="header-author"><a href="/">月半兄</a></h1>
		</hgroup>
		
		<p class="header-subtitle">程序员的男人</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/" target="_blank">主页</a></li>
			
				<li><a href="/tags/Android/" target="_blank">Android</a></li>
			
				<li><a href="/tags/Java/" target="_blank">Java</a></li>
			
				<li><a href="/tags/%E7%AC%94%E8%AE%B0/" target="_blank">笔记</a></li>
			
			</ul>
		</nav>
		<nav class="header-smart-menu">
			
				
					<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
				
			
				
					<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
				
			
				
					<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
				
			
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" href="https://github.com/yueban" title="GitHub" target="_blank"><i class="icon-github"></i></a>
				
					<a class="zhihu" href="http://www.zhihu.com/people/fan-bai-zhou" title="知乎" target="_blank"><i class="icon-zhihu"></i></a>
				
					<a class="mail" href="mailto:fbzhh007@gmail.com" title="NULL" target="_blank"><i class="icon-mail"></i></a>
				
			</div>
		
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
      
      <a class="forkMe" style="position:absolute;z-index:999;top:0;right:0.5em;" 
        href="https://github.com/yueban" target="_blank">
        <img src="/img/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
      
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<a href="/">
					<img src="/img/author.jpg" class="js-avatar">
				</a>
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">月半兄</h1>
			</hgroup>
			
			<p class="header-subtitle"><i class="icon icon-quo-left"></i>程序员的男人<i class="icon icon-quo-right"></i></p>
			
			
			
				
			
				
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/yueban" title="GitHub"><i class="icon-github"></i></a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/fan-bai-zhou" title="知乎"><i class="icon-zhihu"></i></a>
			        
						<a class="mail" target="_blank" href="mailto:fbzhh007@gmail.com" title="NULL"><i class="icon-mail"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 70%">
				
				
					<li style="width: 25%"><a href="/">主页</a></li>
		        
					<li style="width: 25%"><a href="/tags/Android/">Android</a></li>
		        
					<li style="width: 25%"><a href="/tags/Java/">Java</a></li>
		        
					<li style="width: 25%"><a href="/tags/%E7%AC%94%E8%AE%B0/">笔记</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1"
              class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-极客时间-《趣谈网络协议》笔记" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 class="article-title" itemprop="name">
      极客时间 - 《趣谈网络协议》笔记
    </h1>
  


  
  
        
        <span id="busuanzi_container_page_pv" style='display:none' class="archive-article-date">
              <i class="icon-smile icon"></i> 阅读数：<span id="busuanzi_value_page_pv"></span>次
        </span>

<a href="/2019/03/12/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4-%E3%80%8A%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E3%80%8B%E7%AC%94%E8%AE%B0/" class="archive-article-date">
        <time datetime="2019-03-12T12:04:53.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2019-03-12</time>
</a>

  
  
    
<div style="margin-top:10px;">
  <span class="post-time">
    <span class="post-meta-item-icon">
      <!-- fonts.scss -->
      <!-- 百度字体平台:http://fontstore.baidu.com/static/editor/index.html -->
      <i class="icon-statistics"></i>
      <span class="post-meta-item-text"> 字数统计:</span>
      <span class="post-count">66.1k字</span>
    </span>
  </span>

  <span class="post-time">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
      <i class="icon-book icon"></i>
      <span class="post-meta-item-text"> 阅读时长≈</span>
      <span class="post-count">237分</span>
    </span>
  </span>
</div>


  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h2 id="第1讲-为什么要学习网络协议？"><a href="#第1讲-为什么要学习网络协议？" class="headerlink" title="第1讲 | 为什么要学习网络协议？"></a>第1讲 | 为什么要学习网络协议？</h2><p>协议三要素</p>
<ul>
<li>语法，就是这一段内容要符合一定的规则和格式。</li>
<li>语义，就是这一段内容要代表某种意义。</li>
<li>顺序，就是先干啥，后干啥。</li>
</ul>
<h4 id="协议举例-HTTP"><a href="#协议举例-HTTP" class="headerlink" title="协议举例: HTTP"></a>协议举例: HTTP</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Tue, 27 Mar 2018 16:50:26 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Content-Language: zh-CN</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"https://pages.kaola.com/"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>/&gt;</span> <span class="tag">&lt;<span class="name">title</span>&gt;</span> 网易考拉 3 周年主会场 <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>符合语法，只有按照上面那个格式来，浏览器才认。例如，上来是状态，然后是首部，然后是内容。</li>
<li>符合语义，就是要按照约定的意思来。例如，状态 200，表述的意思是网页成功返回。如果不成功，就是我们常见的“404”。</li>
<li>符合顺序，你一点浏览器，就是发送出一个 HTTP 请求，然后才有上面那一串 HTTP 返回的东西。</li>
</ul>
<a id="more"></a>

<hr>
<h2 id="第2讲-网络分层的真实含义是什么？"><a href="#第2讲-网络分层的真实含义是什么？" class="headerlink" title="第2讲 | 网络分层的真实含义是什么？"></a>第2讲 | 网络分层的真实含义是什么？</h2><h4 id="网络为什么要分层"><a href="#网络为什么要分层" class="headerlink" title="网络为什么要分层"></a>网络为什么要分层</h4><p>复杂的程序都要分层，这是程序设计的要求。</p>
<blockquote>
<p>(个人理解) 分层的本质还是效率与性能的平衡，程序分层的背后是硬件性能的提升，因而可以分层换来更高的可复用性，可拓展性等，虽然这其中会损失一部分性能，还是综合来说效率更高了。</p>
</blockquote>
<h4 id="揭秘层与层之间的关系"><a href="#揭秘层与层之间的关系" class="headerlink" title="揭秘层与层之间的关系"></a>揭秘层与层之间的关系</h4><p>只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。</p>
<hr>
<h2 id="第3讲-ifconfig：最熟悉又陌生的命令行"><a href="#第3讲-ifconfig：最熟悉又陌生的命令行" class="headerlink" title="第3讲 | ifconfig：最熟悉又陌生的命令行"></a>第3讲 | ifconfig：最熟悉又陌生的命令行</h2><h4 id="MAC-地址与-IP-地址"><a href="#MAC-地址与-IP-地址" class="headerlink" title="MAC 地址与 IP 地址"></a>MAC 地址与 IP 地址</h4><ul>
<li>MAC 是身份证，是唯一标识</li>
<li>IP 是地址，有定位功能，解决了寻址问题</li>
</ul>
<h4 id="IP-地址分类"><a href="#IP-地址分类" class="headerlink" title="IP 地址分类"></a>IP 地址分类</h4><ul>
<li>IP 地址分为 A,B,C,D 等类，每一类又分为公有 IP 和私有 IP</li>
<li>CIDR 是为了解决 IP 地址分类不科学导致 IP 不够用的问题</li>
<li>CIDR 可以用来判断是否同属一个私有网络</li>
</ul>
<hr>
<h2 id="第4讲-DHCP与PXE：IP是怎么来的，又是怎么没的？"><a href="#第4讲-DHCP与PXE：IP是怎么来的，又是怎么没的？" class="headerlink" title="第4讲 | DHCP与PXE：IP是怎么来的，又是怎么没的？"></a>第4讲 | DHCP与PXE：IP是怎么来的，又是怎么没的？</h2><h4 id="动态主机配置协议（DHCP）"><a href="#动态主机配置协议（DHCP）" class="headerlink" title="动态主机配置协议（DHCP）"></a>动态主机配置协议（DHCP）</h4><ol>
<li>DHCP Discover(客户机告诉网段我需要一个 ip)<br><img src="https://static001.geekbang.org/resource/image/39/1f/395b304f49559034af34c882bd86f11f.jpg" alt=""></li>
<li>DHCP Offer(DHCP 服务器告诉客户机我可以提供 ip)<br><img src="https://static001.geekbang.org/resource/image/54/86/54ffefbe4f493f0f4a39f45504bd5086.jpg" alt=""></li>
<li>DHCP request(客户机确认使用某一个 DHCP Offer)<br><img src="https://static001.geekbang.org/resource/image/e1/24/e1e45ba0d86d2774ec80a1d86f87b724.jpg" alt=""></li>
<li>DHCP ACK(DHCP Server 确认收到客户机的确认)<br><img src="https://static001.geekbang.org/resource/image/7d/0e/7da571c18b974582a9cfe4718c5dea0e.jpg" alt=""><blockquote>
<p>IP 租用更新就: 客户机会在租期过去 50% 的时候，直接向为其提供 IP 地址的 DHCP Server 发送 DHCP request 消息包。客户机接收到该服务器回应的 DHCP ACK 消息包，会根据包中所提供的新的租期以及其他已经更新的 TCP/IP 参数，更新自己的配置。</p>
</blockquote>
</li>
</ol>
<h4 id="预启动执行环境（Pre-boot-Execution-Environment），简称PXE。"><a href="#预启动执行环境（Pre-boot-Execution-Environment），简称PXE。" class="headerlink" title="预启动执行环境（Pre-boot Execution Environment），简称PXE。"></a>预启动执行环境（Pre-boot Execution Environment），简称PXE。</h4><ul>
<li>PXE 协议分为客户端和服务器端，由于还没有操作系统，只能先把客户端放在 BIOS 里面。当计算机启动时，BIOS 把 PXE 客户端调入内存里面，就可以连接到服务端做一些操作了。</li>
<li>PXE 客户端发送 DHCP Discover 后，会在 DHCP Server 返回的 DHCP Offer 中得到 PXE 服务端的信息。(以及 DHCP Offer 本就包含的 ip 地址等信息)</li>
</ul>
<h4 id="PXE-的工作过程"><a href="#PXE-的工作过程" class="headerlink" title="PXE 的工作过程"></a>PXE 的工作过程</h4><p><img src="https://static001.geekbang.org/resource/image/6e/a4/6e69007db3fc68ff6da8496266abf6a4.jpg" alt=""></p>
<hr>
<h2 id="第5讲-从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？"><a href="#第5讲-从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？" class="headerlink" title="第5讲 | 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？"></a>第5讲 | 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？</h2><h4 id="数据链路层解决的三个问题"><a href="#数据链路层解决的三个问题" class="headerlink" title="数据链路层解决的三个问题"></a>数据链路层解决的三个问题</h4><ol>
<li>这个包是发给谁的？谁应该接收？</li>
<li>大家都在发，会不会产生混乱？有没有谁先发、谁后发的规则？</li>
<li>如果发送的时候出现了错误，怎么办？</li>
</ol>
<h4 id="数据链路层解决的三个问题的解决方案"><a href="#数据链路层解决的三个问题的解决方案" class="headerlink" title="数据链路层解决的三个问题的解决方案"></a>数据链路层解决的三个问题的解决方案</h4><ul>
<li>通过 Medium Access Control，即媒体访问控制来解决问题2，简称 MAC。<ul>
<li>信道划分: 分多车道，各走各的</li>
<li>轮流协议: 分单双号，轮着来</li>
<li>随机接入协议: 直接出发，发现特堵，就回去，错过高峰再出。<blockquote>
<p>著名的以太网，用的就是这个方式。</p>
</blockquote>
</li>
</ul>
</li>
<li>引入一个物理地址的概念来解决问题1，叫作链路层地址。<blockquote>
<p>但是因为第二层主要解决媒体接入控制的问题，所以它常被称为MAC 地址。</p>
</blockquote>
</li>
<li>对于以太网，第二层的最后面是CRC，也就是循环冗余检测。通过 XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误，主要解决问题3</li>
</ul>
<h4 id="ARP-协议"><a href="#ARP-协议" class="headerlink" title="ARP 协议"></a>ARP 协议</h4><p>已知 IP 地址，求 MAC 地址的协议。主要解决源机器不知道目标机器地址的情况</p>
<h4 id="集线器-Hub-与-交换机-Switcher"><a href="#集线器-Hub-与-交换机-Switcher" class="headerlink" title="集线器(Hub) 与 交换机(Switcher)"></a>集线器(Hub) 与 交换机(Switcher)</h4><ul>
<li>集线器工作在物理层，会将每一个端口发来的数据包，都复制到其他端口去</li>
<li>交换机工作在数据链路层，会根据转发表将数据包只发送至目标设备(端口)<blockquote>
<p>交换机是有 MAC 地址学习能力的，学完了它就知道谁在哪儿了，不用广播了。</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="第6讲-交换机与VLAN：办公室太复杂，我要回学校"><a href="#第6讲-交换机与VLAN：办公室太复杂，我要回学校" class="headerlink" title="第6讲 | 交换机与VLAN：办公室太复杂，我要回学校"></a>第6讲 | 交换机与VLAN：办公室太复杂，我要回学校</h2><h4 id="环路问题"><a href="#环路问题" class="headerlink" title="环路问题"></a>环路问题</h4><ul>
<li>环路问题会导致交换机记录的设备所在局域网信息不准确，并不停更新设备所在局域网信息</li>
<li>环路问题在数据结构中可以看做<strong>图</strong></li>
</ul>
<h4 id="STP-Spanning-Tree-Protocol"><a href="#STP-Spanning-Tree-Protocol" class="headerlink" title="STP (Spanning Tree Protocol)"></a>STP (Spanning Tree Protocol)</h4><ul>
<li>通过<strong>最小生成树</strong>算法，使得网络中的交换机相互比较生成一个<strong>树</strong></li>
<li><strong>树</strong>解决了<strong>图</strong>导致的环路问题</li>
<li>STP 工作机制相关的概念<ul>
<li>Root Bridge，根交换机，即<strong>根</strong></li>
<li>Designated Bridges，指定交换机，即<strong>树枝</strong></li>
<li>Bridge Protocol Data Units(BPDU) ，网桥协议数据单元，即两个节点相互比较的协议</li>
<li>Priority Vector，优先级向量，代表一个节点优先级的量，是一组 ID，<code>[Root Bridge ID, Root Path Cost, Bridge ID, and Port ID]</code></li>
</ul>
</li>
</ul>
<h4 id="如何解决广播问题和安全问题？"><a href="#如何解决广播问题和安全问题？" class="headerlink" title="如何解决广播问题和安全问题？"></a>如何解决广播问题和安全问题？</h4><ul>
<li>物理隔离，每一个局域网的交换机等设备在物理上与其他网络的不可见</li>
<li>虚拟隔离，即 VLAN，或者叫虚拟局域网。在原来的二层的头上加一个 TAG，里面有一个 VLAN ID，一共 12 位。只有相同 VLAN 的包，才会互相转发</li>
</ul>
<hr>
<h2 id="第7讲-ICMP与ping：投石问路的侦察兵"><a href="#第7讲-ICMP与ping：投石问路的侦察兵" class="headerlink" title="第7讲 | ICMP与ping：投石问路的侦察兵"></a>第7讲 | ICMP与ping：投石问路的侦察兵</h2><h4 id="ICMP-协议的格式"><a href="#ICMP-协议的格式" class="headerlink" title="ICMP 协议的格式"></a>ICMP 协议的格式</h4><ul>
<li>ICMP全称Internet Control Message Protocol，就是互联网控制报文协议</li>
<li>ICMP 报文是封装在 IP 包里面的。因为传输指令的时候，肯定需要源地址和目标地址</li>
</ul>
<h4 id="ICMP-报文类型"><a href="#ICMP-报文类型" class="headerlink" title="ICMP 报文类型"></a>ICMP 报文类型</h4><ul>
<li>查询报文: 主动发起请求的报文，或主动请求应答的报文等<blockquote>
<p>ping 就是查询报文</p>
</blockquote>
</li>
<li>差错报文: 请求发生错误的报文<ul>
<li>终点不可达<ul>
<li>网络不可达，找不到对应网络</li>
<li>主机不可达: 找到了网络，找不到对应主机</li>
<li>协议不可达: 找到了主机，但协议不匹配</li>
<li>端口不可达: 找到了主机，协议匹配，但在目标端口上没有对应服务</li>
<li>需要进行分片但设置了不分片位，如数据包过大，在经过某些节点时需要分片发送，但设置了不允许分片</li>
</ul>
</li>
<li>源站抑制，源站告知需要放慢发送速度。</li>
<li>时间超时</li>
<li>路由重定向<blockquote>
<p>Traceroute 就是利用了差错报文进行工作的</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第8讲-世界这么大，我想出网关：欧洲十国游与玄奘西行"><a href="#第8讲-世界这么大，我想出网关：欧洲十国游与玄奘西行" class="headerlink" title="第8讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行"></a>第8讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行</h2><h4 id="请求目标-ip-的两种场景"><a href="#请求目标-ip-的两种场景" class="headerlink" title="请求目标 ip 的两种场景"></a>请求目标 ip 的两种场景</h4><ul>
<li>目标 ip 与源 ip 同属一个网段，则直接通过 ARP 获取目标 ip 的 mac 地址，并发送请求</li>
<li>目标 ip 与源 ip 不属同一网段，则目标 mac 地址会改为网关 (Gateway) 对应的 mac，然后进行发送，之后由网关处理下一步转发<blockquote>
<p>网关往往是一个路由器，是一个三层转发设备</p>
</blockquote>
</li>
</ul>
<h4 id="静态路由下，通过网关转发的两种场景"><a href="#静态路由下，通过网关转发的两种场景" class="headerlink" title="静态路由下，通过网关转发的两种场景"></a>静态路由下，通过网关转发的两种场景</h4><ul>
<li>不同网段不存在 ip 冲突的场景<ul>
<li>目标 ip 与源 ip 不变，每次转发时，源 mac 地址是当前网关 mac，目标 mac 地址是下一个网关的 mac，直到发送至目标 ip 所属网段内，最后一次发送至目标设备</li>
</ul>
</li>
<li>不同网段存在 ip 冲突的场景<blockquote>
<p>更贴近实际生活中的场景，比如两个家庭的网段都是 192.168.1.0，可能源 ip 与目标 ip 都是 192.168.1.10</p>
</blockquote>
<ul>
<li>源 ip 与目标 ip 首先通过 NAT 服务转换为公网 ip，之后每次转发时，与上一种场景相同，只修改相应 mac 地址，知道发送至目标 ip 所属网段内，最后一次发送需要修改 ip 为目标在网段内的内网 ip<blockquote>
<p>Network Address Translation，简称NAT。<br>两种场景下，ip 地址在转发期间都是不变的，区别在于是否需要通过 NAT 服务将 ip 转换为公网 ip</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第9讲-路由协议：西出网关无故人，敢问路在何方"><a href="#第9讲-路由协议：西出网关无故人，敢问路在何方" class="headerlink" title="第9讲 | 路由协议：西出网关无故人，敢问路在何方"></a>第9讲 | 路由协议：西出网关无故人，敢问路在何方</h2><h4 id="如何确定下一个转发目标？"><a href="#如何确定下一个转发目标？" class="headerlink" title="如何确定下一个转发目标？"></a>如何确定下一个转发目标？</h4><ul>
<li>当一个入口的网络包送到路由器时，它会根据一个本地的转发信息库，来决定如何正确地转发流量。这个转发信息库通常被称为路由表</li>
</ul>
<p>一张路由表中会有多条路由规则。每一条规则至少包含这三项信息</p>
<ul>
<li>目的网络：这个包想去哪儿？</li>
<li>出口设备：将包从哪个口扔出去？</li>
<li>下一跳网关：下一个路由器的地址。</li>
</ul>
<h4 id="策略路由-仅用于静态路由"><a href="#策略路由-仅用于静态路由" class="headerlink" title="策略路由 (仅用于静态路由)"></a>策略路由 (仅用于静态路由)</h4><ul>
<li>在真实的复杂的网络环境中，除了可以根据目的 ip 地址配置路由外，还可以根据多个参数来配置路由，这就称为策略路由。</li>
<li>可以配置多个路由表，可以根据源 IP 地址、入口设备、TOS 等选择路由表，然后在路由表中查找路由。这样可以使得来自不同来源的包走不同的路由。</li>
<li>一条路由规则中，也可以走多条路径。比如设置下一跳有两个 ip，但有不同的权重。</li>
</ul>
<h4 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h4><ul>
<li>手动配置路由表，叫做静态路由</li>
<li>根据路由协议算法生成动态路由表，随网络运行状况的变化而变化，叫做动态路由</li>
</ul>
<h4 id="动态路由算法"><a href="#动态路由算法" class="headerlink" title="动态路由算法"></a>动态路由算法</h4><ul>
<li>动态路由算法本质是解决最短路径问题。网络中的设备组成一个网路<strong>图</strong>，两点之间的通信一定希望越近越快越好，因此是最短路径问题。</li>
<li>距离矢量路由算法 (基于 Bellman-Ford 算法)<ul>
<li>基本思路: 每个路由器都保存一个路由表，包含多行，每行对应网络中的一个路由器，每一行包含两部分信息，一个是要到目标路由器，从哪条线出去，另一个是到目标路由器的距离。</li>
<li>更新策略: 每过几秒，每个路由器都将自己所知的到达所有的路由器的距离告知邻居，每个路由器也能从邻居那里得到相似的信息。</li>
<li>问题<ul>
<li>好消息传得快，坏消息传得慢。新路由器加入的消息会很快得到广播，但有路由器挂掉是不会有广播的，可能得到一定时间后才回认为这个路由器掉线。</li>
<li>每次发送的时候，要发送整个全局路由表。当网络越来越大时，效能太差。</li>
</ul>
</li>
</ul>
</li>
<li>链路状态路由算法 (基于 Dijkstra 算法)<ul>
<li>基本思路: 路由器每寻找到一个邻居，即将自己和邻居之间的链路状态包(距离信息等)广播出去，发送到整个网络的每个路由器。这样每个路由器都能够收到它和邻居之间的关系的信息。因而，每个路由器都能在自己本地构建一个完整的图，然后针对这个图使用 Dijkstra 算法，找到两点之间的最短路径。</li>
<li>更新策略: 链路状态路由协议只广播更新的或改变的网络拓扑</li>
<li>解决了<strong>距离矢量路由算法</strong>的两个问题<ul>
<li>更新信息更小，节省了带宽和 CPU 利用率</li>
<li>一旦一个路由器挂了，它的邻居都会广播这个消息，可以使得坏消息迅速收敛</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="动态路由协议"><a href="#动态路由协议" class="headerlink" title="动态路由协议"></a>动态路由协议</h4><ul>
<li>基于链路状态路由算法的 OSPF (内网)<ul>
<li>OSPF（Open Shortest Path First，开放式最短路径优先）是一个基于链路状态路由协议，广泛应用在数据中心中的协议。</li>
<li>由于主要用在数据中心内部，用于路由决策，因而称为内部网关协议（Interior Gateway Protocol，简称IGP）。</li>
<li>内部网关协议的重点就是找到最短的路径。有时候 OSPF 可以发现多个最短的路径，可以在这多个路径中进行负载均衡，这常常被称为等价路由。</li>
</ul>
</li>
<li>基于距离矢量路由算法的 BGP (外网)<ul>
<li>每个数据中心都设置自己的 Policy。例如，哪些外部的 IP 可以让内部知晓，哪些内部的 IP 可以让外部知晓，哪些可以通过，哪些不能通过。</li>
<li>这一个个数据中心称为自治系统AS（Autonomous System）。自治系统分几种类型。<ul>
<li>Stub AS：对外只有一个连接。这类 AS 不会传输其他 AS 的包。例如，个人或者小公司的网络。</li>
<li>Multihomed AS：可能有多个连接连到其他的 AS，但是大多拒绝帮其他的 AS 传输包。例如一些大公司的网络。</li>
<li>Transit AS：有多个连接连到其他的 AS，并且可以帮助其他的 AS 传输包。例如主干网。</li>
</ul>
</li>
<li>BGP 又分为两类，eBGP 和 iBGP<ul>
<li>自治系统间，边界路由器之间使用 eBGP 广播路由。</li>
<li>边界路由器将 BGP 学习到的路由导入到内部网络，就是通过运行 iBGP，使得内部的路由器能够找到到达外网目的地的最好的边界路由器。</li>
</ul>
</li>
<li>BGP 协议使用的算法是路径矢量路由协议（path-vector protocol）。它是距离矢量路由协议的升级版。<ul>
<li>关于距离矢量路由协议收敛慢的问题: 在 BGP 里面，除了下一跳 hop 之外，还包括了自治系统 AS 的路径，从而可以避免坏消息传的慢的问题。比如 B 知道 C(内网) 原来能够到达 A(另一个内网)，是因为通过自己(数据中心)，一旦自己都到达不了 A 了，就不用假设 C 还能到达 A 了。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第10讲-UDP协议：因性善而简单，难免碰到“城会玩”"><a href="#第10讲-UDP协议：因性善而简单，难免碰到“城会玩”" class="headerlink" title="第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”"></a>第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”</h2><h4 id="TCP-和-UDP-有哪些区别？"><a href="#TCP-和-UDP-有哪些区别？" class="headerlink" title="TCP 和 UDP 有哪些区别？"></a>TCP 和 UDP 有哪些区别？</h4><ul>
<li>连接类型<ul>
<li>TCP 是面向连接的</li>
<li>UDP 是面向无连接的<blockquote>
<p>所谓的建立连接，是为了在客户端和服务端维护连接，而建立一定的数据结构来维护双方交互的状态，用这样的数据结构来保证所谓的面向连接的特性。</p>
</blockquote>
</li>
</ul>
</li>
<li>可靠性<ul>
<li>TCP 提供可靠交付</li>
<li>UDP 继承了 IP 包的特性，不保证不丢失，不保证按顺序到达</li>
</ul>
</li>
<li>数据单元<ul>
<li>TCP 是面向字节流的</li>
<li>UDP 继承了 IP 的特性，基于数据报的，一个一个地发，一个一个地收</li>
</ul>
</li>
<li>可控性<ul>
<li>TCP 是可以有拥塞控制的</li>
<li>UDP 不会，应用让我发，我就发</li>
</ul>
</li>
<li>服务类型<ul>
<li>TCP 是一个有状态服务。里面精确地记着发送了没有，接收到没有，发送到哪个了，应该接收哪个了等等状态信息</li>
<li>TCP 是一个无状态服务</li>
</ul>
</li>
</ul>
<h4 id="UDP-的三大使用场景"><a href="#UDP-的三大使用场景" class="headerlink" title="UDP 的三大使用场景"></a>UDP 的三大使用场景</h4><ul>
<li>需要资源少，在网络情况比较好的内网，或者对于丢包不敏感的应用</li>
<li>不需要一对一沟通，建立连接，而是可以广播的应用</li>
<li>需要处理速度快，时延低，可以容忍少数丢包，但是要求即便网络拥塞，也毫不退缩，一往无前的时候</li>
</ul>
<h4 id="基于-UDP-的五个例子"><a href="#基于-UDP-的五个例子" class="headerlink" title="基于 UDP 的五个例子"></a>基于 UDP 的五个例子</h4><ul>
<li>网页或者 APP 的访问<ul>
<li>HTTP 建立连接的成本太高，且连接虽然看似并发，但在 tcp 层还是一帧一帧发的，效率低。Google 则推出了一种基于 UDP 改进的通信协议 QUIC（全称Quick UDP Internet Connections，快速 UDP 互联网连接）</li>
</ul>
</li>
<li>流媒体的协议<ul>
<li>比如直播使用的 RTMP，直播中前一帧丢掉就丢掉了，继续播收到的下一帧就好</li>
</ul>
</li>
<li>实时游戏<ul>
<li>TCP 需要消耗资源来维持长链接，游戏玩家一多，Server 的开销会大，另外则是 TCP 严格按照顺序发送，一旦有一个数据没送到，之后的都会阻塞，这在实时游戏中是不可接受的。因此，这里更适合采用自定义的可靠 UDP 协议</li>
</ul>
</li>
<li>IoT 物联网<ul>
<li>IoT 设备性能有限，维持 TCP 协议代价较大，另一方面 IoT 对延时十分敏感。Google 旗下的 Nest 建立 Thread Group，推出了物联网通信协议 Thread，就是基于 UDP 协议的。</li>
</ul>
</li>
<li>移动通信领域<ul>
<li>在 4G 网络里，移动流量上网的数据面对的协议 GTP-U 是基于 UDP 的。因为移动网络协议比较复杂，而 GTP 协议本身就包含复杂的手机上线下线的通信协议。如果基于 TCP，TCP 的机制就显得非常多余。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第11讲-TCP协议（上）：因性恶而复杂，先恶后善反轻松"><a href="#第11讲-TCP协议（上）：因性恶而复杂，先恶后善反轻松" class="headerlink" title="第11讲 | TCP协议（上）：因性恶而复杂，先恶后善反轻松"></a>第11讲 | TCP协议（上）：因性恶而复杂，先恶后善反轻松</h2><h4 id="TCP-包头主要关注的5个问题"><a href="#TCP-包头主要关注的5个问题" class="headerlink" title="TCP 包头主要关注的5个问题"></a>TCP 包头主要关注的5个问题</h4><ul>
<li>顺序问题</li>
<li>丢包问题</li>
<li>连接维护</li>
<li>流量控制</li>
<li>拥塞控制</li>
</ul>
<h4 id="TCP-的三次握手"><a href="#TCP-的三次握手" class="headerlink" title="TCP 的三次握手"></a>TCP 的三次握手</h4><ul>
<li>三次握手举例<ol>
<li>A：您好，我是 A。</li>
<li>B：您好 A，我是 B。</li>
<li>A：您好 B。</li>
</ol>
</li>
<li>三次握手是 A B 双方都确认对方可以收到消息 (1,2 是 A 确认 B 可以收到消息；2,3 是 B 确认 A 可以收到消息)</li>
<li>三次握手除了双方建立连接外，主要还是为了沟通一件事情，就是TCP 包的序号的问题。<blockquote>
<p>为什么序号不能都从 1 开始呢？</p>
<p>例如，A 连上 B 之后，发送了 1、2、3 三个包，但是发送 3 的时候，中间丢了，或者绕路了，于是重新发送，后来 A 掉线了，重新连上 B 后，序号又从 1 开始，然后发送 2，但是压根没想发送 3，但是上次绕路的那个 3 又回来了，发给了 B，B 自然认为，这就是下一个包，于是发生了错误。</p>
</blockquote>
</li>
</ul>
<h4 id="TCP-四次挥手"><a href="#TCP-四次挥手" class="headerlink" title="TCP 四次挥手"></a>TCP 四次挥手</h4><ul>
<li>四次挥手举例<ol>
<li>A：B 啊，我不想玩了。</li>
<li>B：哦，你不想玩了啊，我知道了。</li>
<li>B：A 啊，好吧，我也不玩了，拜拜。</li>
<li>A：好的，拜拜。</li>
</ol>
</li>
<li>四次挥手可能出现的意外<ul>
<li>A 说完“不玩了”之后，直接跑路，B 就算发起结束，也得不到回答，B 就不知道该怎么办了</li>
<li>A 说完“不玩了”，B 直接跑路，因为 A 不知道 B 是还有事情要处理，还是过一会儿会发送结束</li>
<li>A 直接跑路导致 A 的端口直接空出来了，B 原来发过的很多包很可能还在路上，如果 A 的端口被一个新的应用占用了，这个新的应用会收到上个连接中 B 发过来的包。</li>
</ul>
</li>
<li>上述意外的解决方案<ul>
<li>TCP 协议专门设计了几个状态来处理可能出现的意外。参考下面的<strong>状态时序图</strong><br><img src="https://static001.geekbang.org/resource/image/1f/11/1f6a5e17b34f00d28722428b7b8ccb11.jpg" alt=""></li>
<li>MSL是Maximum Segment Lifetime，报文最大生存时间，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。</li>
</ul>
</li>
</ul>
<h4 id="TCP-状态机"><a href="#TCP-状态机" class="headerlink" title="TCP 状态机"></a>TCP 状态机</h4><p><img src="https://static001.geekbang.org/resource/image/da/ab/dab9f6ee2908b05ed6f15f3e21be88ab.jpg" alt=""></p>
<p>在这个图中，加黑加粗的部分，是上面说到的主要流程，其中阿拉伯数字的序号，是连接过程中的顺序，而大写中文数字的序号，是连接断开过程中的顺序。加粗的实线是客户端 A 的状态变迁，加粗的虚线是服务端 B 的状态变迁。</p>
<hr>
<h2 id="第12讲-TCP协议（下）：西行必定多妖孽，恒心智慧消磨难"><a href="#第12讲-TCP协议（下）：西行必定多妖孽，恒心智慧消磨难" class="headerlink" title="第12讲 | TCP协议（下）：西行必定多妖孽，恒心智慧消磨难"></a>第12讲 | TCP协议（下）：西行必定多妖孽，恒心智慧消磨难</h2><h4 id="累计确认-累计应答（cumulative-acknowledgment）"><a href="#累计确认-累计应答（cumulative-acknowledgment）" class="headerlink" title="累计确认/累计应答（cumulative acknowledgment）"></a>累计确认/累计应答（cumulative acknowledgment）</h4><ul>
<li>TCP 协议为了保证顺序性，每一个包都有一个 ID。在建立连接的时候，会商定起始的 ID 是什么，然后按照 ID 一个个发送。为了保证不丢包，对于发送的包都要进行应答，但是这个应答也不是一个一个来的，而是会应答某个之前的 ID，表示都收到了，这种模式称为累计确认或者累计应答。</li>
</ul>
<h4 id="TCP-发送端缓存"><a href="#TCP-发送端缓存" class="headerlink" title="TCP 发送端缓存"></a>TCP 发送端缓存</h4><ul>
<li>四部分缓存<ol>
<li>发送了并且已经确认的</li>
<li>发送了并且尚未确认的</li>
<li>没有发送，但是已经等待发送的</li>
<li>没有发送</li>
</ol>
</li>
<li>区分 3，4 部分的目的是实现流量控制。接收端会给发送端报一个窗口的大小，叫 Advertised window。这个窗口的大小应该等于上面的 2，3 部分之和，超出这个窗口大小的就是 4 部分</li>
<li>缓存数据结构<br>  <img src="https://static001.geekbang.org/resource/image/16/7b/16dcd6fb8105a1caa75887b5ffa0bd7b.jpg" alt=""><ul>
<li>LastByteAcked：1，2 部分的分界线</li>
<li>LastByteSent：2，3 部分的分界线</li>
<li>LastByteAcked + AdvertisedWindow：3，4 部分的分界线</li>
</ul>
</li>
</ul>
<h4 id="TCP-接收端缓存"><a href="#TCP-接收端缓存" class="headerlink" title="TCP 接收端缓存"></a>TCP 接收端缓存</h4><ul>
<li>三部分缓存<ol>
<li>接受并且确认过的</li>
<li>还没接收，但是马上就能接收的</li>
<li>还没接收，也没法接收的</li>
</ol>
</li>
<li>缓存数据结构<br>  <img src="https://static001.geekbang.org/resource/image/f7/a4/f7b1d3bc6b6d8e55f0951e82294c8ba4.jpg" alt=""><ul>
<li>MaxRcvBuffer：最大缓存的量</li>
<li>LastByteRead 之后是已经接收了，但是还没被应用层读取的</li>
<li>NextByteExpected 是 1，2 部分的分界线</li>
</ul>
</li>
</ul>
<h4 id="超时重试"><a href="#超时重试" class="headerlink" title="超时重试"></a>超时重试</h4><ul>
<li>对每一个发送了，但是没有 ACK 的包，都有设一个定时器，超过了一定的时间，就重新尝试</li>
<li>超时时间的确认: TCP 通过采样 RTT 的时间，然后进行加权平均，算出一个值，而且这个值还随网络状况不断变化。除了采样 RTT，还要采样 RTT 的波动范围，计算出一个估计的超时时间。我们称为自适应重传算法（Adaptive Retransmission Algorithm）。</li>
<li>当一个包再次超时时，TCP 的策略是超时间隔加倍</li>
<li>加快超时重试的机制<ul>
<li>当接收方收到一个序号大于下一个所期望的报文段时，就检测到了数据流中的一个间格，于是发送三个冗余的 ACK，客户端收到后，就在定时器过期之前，重传丢失的报文段。</li>
<li>还有一种方式称为 Selective Acknowledgment （SACK）。这种方式需要在 TCP 头里加一个 SACK 的东西，可以将缓存的地图发送给发送方。例如可以发送 ACK6、SACK8、SACK9，有了地图，发送方一下子就能看出来是 7 丢了。</li>
</ul>
</li>
</ul>
<h4 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h4><ul>
<li>在对于包的确认中，同时会携带一个窗口的大小<blockquote>
<p>通过上面的数据结构图，我们可以得到窗口大小的计算公式：</p>
<p>AdvertisedWindow=MaxRcvBuffer-((NextByteExpected-1)-LastByteRead)</p>
</blockquote>
</li>
<li>对于发送端来说，每收到一个确认，窗口向右滑动一格，即可以再发送一个包，直到全部未发送可发送的包发送完毕</li>
<li>接收端本地处理太慢，导致缓存中没有空间，可以通过确认信息修改窗口的大小，甚至可以设置为 0，则发送方将暂时停止发送。<ul>
<li>比如，接收端一直不读取缓存数据，则当一个包在接收端确认后，NextByteExpected 向右平移1，根据上述公式，AdvertisedWindow 会减小1，则确认包到达发送端时，发送端会修改 AdvertisedWindow，最终 AdvertisedWindow 可能减小为0，此时发送端停止发送</li>
<li>停止发送后，发送方会定时发送窗口探测数据包，看是否有机会调整窗口的大小。当接收方比较慢的时候，要防止低能窗口综合征，别空出一个字节来就赶快告诉发送方，然后马上又填满了，可以当窗口太小的时候，不更新窗口，直到达到一定大小，或者缓冲区一半为空，才更新窗口。</li>
</ul>
</li>
</ul>
<h4 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h4><ul>
<li>前面的滑动窗口 rwnd 是怕发送方把接收方缓存塞满，而拥塞窗口 cwnd，是怕把网络塞满</li>
<li>这里有一个公式 LastByteSent - LastByteAcked &lt;= min {cwnd, rwnd} ，是拥塞窗口和滑动窗口共同控制发送的速度。<blockquote>
<p>根据发送端数据结构，可以看出，LastByteSent - LastByteAcked 就是发送了并且尚未确认的部分</p>
</blockquote>
</li>
<li>网络上，通道的容量 = 带宽 × 往返延迟。网络带宽，即每秒钟能够发送多少数据。我们设置发送窗口，使得发送但未确认的包为为通道的容量，就能够撑满整个管道。</li>
<li>网络传输可能出现的问题<ul>
<li>包丢失: 一个包，从一端到达另一端，假设一共经过四个设备，每个设备处理一个包时间耗费 1s，所以到达另一端需要耗费 4s，如果发送的更加快速，则单位时间内，会有更多的包到达这些中间设备，这些设备还是只能每秒处理一个包的话，多出来的包就会被丢弃</li>
<li>超时重传: 假如这个四个设备本来每秒处理一个包，但是我们在这些设备上加缓存，处理不过来的在队列里面排着，这样包就不会丢失，但是缺点是会增加时延，这个缓存的包，4s 肯定到达不了接收端了，如果时延达到一定程度，就会超时重传</li>
</ul>
</li>
<li>慢启动: 一开始慢慢传输，然后发现总能收到确认，就可以越发越快<ul>
<li>一条 TCP 连接开始，cwnd 设置为一个报文段，一次只能发送一个；当收到这一个确认的时候，cwnd 加一，于是一次能够发送两个；当这两个的确认到来的时候，每个确认 cwnd 加一，两个确认 cwnd 加二，于是一次能够发送四个；当这四个的确认到来的时候，每个确认 cwnd 加一，四个确认 cwnd 加四，于是一次能够发送八个。可以看出这是指数性的增长。</li>
<li>每收到一个确认后，cwnd 增加 1/cwnd，我们接着上面的过程来，一次发送八个，当八个确认到来的时候，每个确认增加 1/8，八个确认一共 cwnd 增加 1，于是一次能够发送九个，变成了线性增长。</li>
</ul>
</li>
<li>慢启动，丢包与超时重传<ul>
<li>慢启动传输速度的控制: 有一个值 ssthresh 为 65535 个字节，当超过这个值的时候，传输就会放慢</li>
<li>当丢包发生时，需要超时重传，这时将 sshresh 设为 cwnd/2，将 cwnd 设为 1，重新开始慢启动。<blockquote>
<p>但是这种方式太激进了，将一个高速的传输速度一下子停了下来，会造成网络卡顿。</p>
</blockquote>
</li>
<li>快速重传算法: 参见前面阐述过的部分，TCP 认为这种情况不严重，因为大部分没丢，只丢了一小部分，cwnd 减半为 cwnd/2，然后 sshthresh = cwnd，当三个包返回的时候，cwnd = sshthresh + 3，整体上传输速度没有断崖式下跌，而是还在比较高的值，呈线性增长。</li>
</ul>
</li>
<li>拥塞控制方案可能出现的问题<ul>
<li>丢包并不代表着通道满了，也可能网络本身不稳定导致的丢包，这个时候就认为拥塞了，其实是不对的。</li>
<li>TCP 的拥塞控制要等到将中间设备都填充满了，才发生丢包，从而降低速度，这时候已经晚了。其实 TCP 只要填满管道就可以了，不应该接着填，直到连缓存也填满。</li>
</ul>
</li>
<li>为了优化上述两个问题，后来有了 TCP BBR 拥塞算法。它企图找到一个平衡点，就是通过不断的加快发送速度，将管道填满，但是不要填满中间设备的缓存，因为这样时延会增加，在这个平衡点可以很好的达到高带宽和低时延的平衡。</li>
</ul>
<hr>
<h2 id="第13讲-套接字Socket：Talk-is-cheap-show-me-the-code"><a href="#第13讲-套接字Socket：Talk-is-cheap-show-me-the-code" class="headerlink" title="第13讲 | 套接字Socket：Talk is cheap, show me the code"></a>第13讲 | 套接字Socket：Talk is cheap, show me the code</h2><h4 id="基于-TCP-协议的-Socket-程序函数调用过程"><a href="#基于-TCP-协议的-Socket-程序函数调用过程" class="headerlink" title="基于 TCP 协议的 Socket 程序函数调用过程"></a>基于 TCP 协议的 Socket 程序函数调用过程</h4><p><img src="https://static001.geekbang.org/resource/image/77/92/77d5eeb659d5347874bda5e8f711f692.jpg" alt=""></p>
<ol>
<li>TCP 的服务端要先监听一个端口，一般是先调用 bind 函数，给这个 Socket 赋予一个 IP 地址和端口。<ul>
<li>为什么需要端口呢？当一个网络包来的时候，内核要通过 TCP 头里面的这个端口，来找到你这个应用程序，把包给你。</li>
<li>为什么要 IP 地址呢？一台机器会有多个网卡，也就会有多个 IP 地址，你可以选择监听所有的网卡，也可以选择监听一个网卡，这样，只有发给这个网卡的包，才会给你。</li>
</ul>
</li>
<li>当服务端有了 IP 和端口号，就可以调用 listen 函数进行监听。这个时候客户端就可以发起连接了。</li>
<li>接下来，服务端调用 accept 函数，拿出一个已经完成的连接进行处理。如果还没有完成，就要等着。<blockquote>
<p>在内核中，为每个 Socket 维护两个队列。一个是已经建立了连接的队列，这时候连接三次握手已经完毕，处于 established 状态；一个是还没有完全建立连接的队列，这个时候三次握手还没完成，处于 syn_rcvd 的状态。</p>
</blockquote>
</li>
<li>在服务端等待的时候，客户端可以通过 connect 函数发起连接。先在参数中指明要连接的 IP 地址和端口号，然后开始发起三次握手。内核会给客户端分配一个临时的端口。一旦握手成功，服务端的 accept 就会返回另一个 Socket。<blockquote>
<p>这是一个经常考的知识点，就是监听的 Socket 和真正用来传数据的 Socket 是两个，一个叫作监听 Socket，一个叫作已连接 Socket。</p>
</blockquote>
</li>
<li>连接建立成功之后，双方开始通过 read 和 write 函数来读写数据，就像往一个文件流里面写东西一样。</li>
</ol>
<h4 id="基于-UDP-协议的-Socket-程序函数调用过程"><a href="#基于-UDP-协议的-Socket-程序函数调用过程" class="headerlink" title="基于 UDP 协议的 Socket 程序函数调用过程"></a>基于 UDP 协议的 Socket 程序函数调用过程</h4><p><img src="https://static001.geekbang.org/resource/image/77/ef/778687d1a02ffc0c24078c33be2ac1ef.jpg" alt=""></p>
<ul>
<li>一般是先调用 bind 函数，给这个 Socket 赋予一个 IP 地址和端口。<blockquote>
<p>UDP 是没有连接的，所以不需要三次握手，也就不需要调用 listen 和 connect。</p>
</blockquote>
</li>
<li>调用 sendto 和 recvfrom 读写数据。<blockquote>
<p>UDP 是没有维护连接状态的，因而不需要每对连接建立一组 Socket，而是只要有一个 Socket，就能够和多个客户端通信。也正是因为没有连接状态，每次通信的时候，都调用 sendto 和 recvfrom，都可以传入 IP 地址和端口。</p>
</blockquote>
</li>
</ul>
<h4 id="基于-TCP-协议的-Socket-的文件流数据结构"><a href="#基于-TCP-协议的-Socket-的文件流数据结构" class="headerlink" title="基于 TCP 协议的 Socket 的文件流数据结构"></a>基于 TCP 协议的 Socket 的文件流数据结构</h4><ul>
<li>说 TCP 的 Socket 就是一个文件流，是非常准确的。因为，Socket 在 Linux 中就是以文件的形式存在的。除此之外，还存在文件描述符。写入和读出，也是通过文件描述符。<br>  <img src="https://static001.geekbang.org/resource/image/60/8c/602d09290bd4f9e0183f530e9653348c.jpg" alt=""></li>
<li>在内核中，Socket 是一个文件，那对应就有文件描述符。每一个进程都有一个数据结构 task_struct，里面指向一个文件描述符数组，来列出这个进程打开的所有文件的文件描述符。文件描述符是一个整数，是这个数组的下标。</li>
<li>这个数组中的内容是一个指针，指向内核中所有打开的文件的列表。既然是一个文件，就会有一个 inode，只不过 Socket 对应的 inode 不像真正的文件系统一样，保存在硬盘上的，而是在内存中的。在这个 inode 中，指向了 Socket 在内核中的 Socket 结构。</li>
<li>在这个结构里面，主要的是两个队列，一个是发送队列，一个是接收队列。在这两个队列里面保存的是一个缓存 sk_buff。这个缓存里面能够看到完整的包的结构。<blockquote>
<p>这个包结构可以联想到之前网络层三层的内容，比如三层的 header</p>
</blockquote>
</li>
</ul>
<h4 id="最大连接数"><a href="#最大连接数" class="headerlink" title="最大连接数"></a>最大连接数</h4><ul>
<li>系统会用一个四元组来标识一个 TCP 连接。  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;本机 IP, 本机端口, 对端 IP, 对端端口&#125;</span><br></pre></td></tr></table></figure>
  服务器通常固定在某个本地端口上监听，等待客户端的连接请求。因此，服务端端 TCP 连接四元组中只有对端 IP, 也就是客户端的 IP 和对端的端口，也即客户端的端口是可变的，因此，最大 TCP 连接数 = 客户端 IP 数×客户端端口数。<blockquote>
<p>对 IPv4，客户端的 IP 数最多为 2 的 32 次方，客户端的端口数最多为 2 的 16 次方，也就是服务端单机最大 TCP 连接数，约为 2 的 48 次方。</p>
</blockquote>
</li>
<li>服务端最大并发 TCP 连接数远不能达到理论上限<ul>
<li>文件描述符限制: 按照上面的原理，Socket 都是文件，所以首先要通过 ulimit 配置文件描述符的数目</li>
<li>内存限制: 按上面的数据结构，每个 TCP 连接都要占用一定内存，操作系统是有限的。</li>
</ul>
</li>
</ul>
<h4 id="服务器如何接更多的项目？"><a href="#服务器如何接更多的项目？" class="headerlink" title="服务器如何接更多的项目？"></a>服务器如何接更多的项目？</h4><ul>
<li>多进程<br>  <img src="https://static001.geekbang.org/resource/image/d3/1c/d353eee3c387332e378c1e517c642f1c.jpg" alt=""><ul>
<li>一旦建立了一个连接，就会有一个已连接 Socket，这时候你可以创建一个子进程，然后将基于已连接 Socket 的交互交给这个新的子进程来做。</li>
<li>因为复制了文件描述符列表，而文件描述符都是指向整个内核统一的打开文件列表的，因而父进程刚才因为 accept 创建的已连接 Socket 也是一个文件描述符，同样也会被子进程获得。</li>
<li>弊端<ul>
<li>子进程每次创建和销毁的性能开销比较大，数量多后服务器无法支撑</li>
</ul>
</li>
</ul>
</li>
<li>多线程<br>  <img src="https://static001.geekbang.org/resource/image/ab/d7/ab6e0ecfee5e21f7a563999a94bd8bd7.jpg" alt=""><ul>
<li>新的线程在 task 列表会新创建一项，但是很多资源，例如文件描述符列表、进程空间，还是共享的，只不过多了一个引用而已。</li>
<li>弊端<ul>
<li>C10K 问题: 它的意思是一台机器要维护 1 万个连接，就要创建 1 万个进程或者线程，那么操作系统是无法承受的。如果维持 1 亿用户在线需要 10 万台服务器，成本也太高了。</li>
</ul>
</li>
</ul>
</li>
<li>IO 多路复用，一个线程维护多个 Socket<ul>
<li>由于 Socket 是文件描述符，因而某个线程盯的所有的 Socket，都放在一个文件描述符集合 fd_set 中，然后调用 select 函数来监听文件描述符集合是否有变化。一旦有变化，就会依次查看每个文件描述符。</li>
<li>弊端<ul>
<li>每次 Socket 所在的文件描述符集合中有 Socket 发生变化的时候，都需要通过轮询的方式，这大大影响了一个项目组能够支撑的最大的项目数量。因而使用 select，能够同时盯的项目数量由 FD_SETSIZE 限制。</li>
</ul>
</li>
</ul>
</li>
<li>IO 多路复用，从“派人盯着”到“有事通知”<br>  <img src="https://static001.geekbang.org/resource/image/cf/19/cff688ede147809da4d65fe4152ffb19.jpg" alt=""><ul>
<li>epoll 函数: 它在内核中的实现不是通过轮询的方式，而是通过注册 callback 函数的方式，当某个文件描述符发送变化的时候，就会主动通知。</li>
<li>这种通知方式使得监听的 Socket 数据增加的时候，效率不会大幅度降低，能够同时监听的 Socket 的数目也非常的多了。上限就为系统定义的、进程打开的最大文件描述符个数。因而，epoll 被称为解决 C10K 问题的利器。<ul>
<li>epoll_create 创建一个 epoll 对象，也是一个文件，也对应一个文件描述符，同样也对应着打开文件列表中的一项。在这项里面有一个红黑树，在红黑树里，要保存这个 epoll 要监听的所有 Socket。</li>
<li>epoll_ctl 添加一个 Socket 的时候，其实是加入这个红黑树，同时红黑树里面的节点指向一个结构，将这个结构挂在被监听的 Socket 的事件列表中。</li>
<li>当一个 Socket 来了一个事件的时候，可以从这个列表中得到 epoll 对象，并调用 call back 通知它。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第14讲-HTTP协议：看个新闻原来这么麻烦"><a href="#第14讲-HTTP协议：看个新闻原来这么麻烦" class="headerlink" title="第14讲 | HTTP协议：看个新闻原来这么麻烦"></a>第14讲 | HTTP协议：看个新闻原来这么麻烦</h2><p>前面章节讲述的是<strong>传输层</strong>的内容，从这章开始是<strong>应用层</strong>的协议。</p>
<p>以 <a href="http://www.baidu.com" target="_blank" rel="noopener">http://www.baidu.com</a> 举例，这是个 URL，叫作统一资源定位符。正是因为这个东西是统一的，所以当你把这样一个字符串输入到浏览器的框里的时候，浏览器才知道如何进行统一处理。</p>
<h4 id="HTTP-请求的准备"><a href="#HTTP-请求的准备" class="headerlink" title="HTTP 请求的准备"></a>HTTP 请求的准备</h4><ul>
<li>浏览器会将 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 这个域名发送给 DNS 服务器，让它解析为 IP 地址。</li>
<li>HTTP 是基于 TCP 协议的，之后要先根据 IP 地址建立 TCP 连接，即三次握手。<blockquote>
<p>目前使用的 HTTP 协议大部分都是 1.1。在 1.1 的协议里面，默认是开启了 Keep-Alive 的，这样建立的 TCP 连接，就可以在多次请求中复用。</p>
</blockquote>
</li>
</ul>
<h4 id="HTTP-请求的构建"><a href="#HTTP-请求的构建" class="headerlink" title="HTTP 请求的构建"></a>HTTP 请求的构建</h4><p><img src="https://static001.geekbang.org/resource/image/10/74/10ff27d1032bf32393195f23ef2f9874.jpg" alt=""></p>
<ul>
<li>请求行<ul>
<li>方法: GET，POST，PUT，DELETE 等</li>
</ul>
</li>
<li>首部字段: key value 字段<ul>
<li>Accept-Charset，表示客户端可以接受的字符集</li>
<li>Content-Type是指正文的格式</li>
<li>…</li>
</ul>
</li>
<li>正文实体<blockquote>
<p>接下来，浏览器会把它交给下一层传输层。其实也无非是用 Socket 这些东西，只不过用的浏览器里，这些程序不需要你自己写，有人已经帮你写好了。</p>
</blockquote>
</li>
</ul>
<h4 id="HTTP-请求的发送"><a href="#HTTP-请求的发送" class="headerlink" title="HTTP 请求的发送"></a>HTTP 请求的发送</h4><ul>
<li>HTTP 协议是基于 TCP 协议的，所以它使用面向连接的方式发送请求，通过 stream 二进制流的方式传给对方。到了 TCP 层，它会把二进制流变成一个的报文段发送给服务器。</li>
<li>在发送给每个报文段的时候，都需要对方有一个回应 ACK，来保证报文可靠地到达了对方。如果没有回应，那么 TCP 这一层会进行重新传输，直到可以到达。同一个包有可能被传了好多次，但是 HTTP 这一层不需要知道这一点，因为是 TCP 这一层在埋头苦干。</li>
<li>TCP 头里面还有端口号，HTTP 的服务器正在监听这个端口号。于是，目标机器自然知道是 HTTP 服务器这个进程想要这个包，于是将包发给 HTTP 服务器。HTTP 服务器的进程看到，原来这个请求是要访问一个网页，于是就把这个网页发给客户端。</li>
</ul>
<h4 id="HTTP-返回的构建"><a href="#HTTP-返回的构建" class="headerlink" title="HTTP 返回的构建"></a>HTTP 返回的构建</h4><p><img src="https://static001.geekbang.org/resource/image/1c/c1/1c2cfd4326d0dfca652ac8501321fac1.jpg" alt=""></p>
<ul>
<li>状态行<ul>
<li>状态码: 反应 HTTP 请求的结果，如 200，404 等。</li>
</ul>
</li>
<li>首部字段<ul>
<li>Retry-After表示，告诉客户端应该在多长时间以后再次尝试一下</li>
<li>Content-Type，表示返回的是 HTML，还是 JSON</li>
<li>…</li>
</ul>
</li>
<li>正文实体</li>
</ul>
<h4 id="HTTP-返回的发送"><a href="#HTTP-返回的发送" class="headerlink" title="HTTP 返回的发送"></a>HTTP 返回的发送</h4><ul>
<li>构造好了返回的 HTTP 报文，还是交给 Socket 去发送，还是交给 TCP 层，让 TCP 层将返回的 HTML，也分成一个个小的段，并且保证每个段都可靠到达。</li>
<li>当浏览器拿到了 HTTP 的报文。发现返回“200”，一切正常，于是就从正文中将 HTML 拿出来。HTML 是一个标准的网页格式。浏览器只要根据这个格式，展示出一个绚丽多彩的网页。</li>
</ul>
<h4 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP 2.0"></a>HTTP 2.0</h4><ul>
<li>HTTP 2.0 会对 HTTP 的头进行一定的压缩，将原来每次都要携带的大量 key value 在两端建立一个索引表，对相同的头只发送索引表中的索引。</li>
<li>HTTP 2.0 协议中数据传输的切分<ul>
<li>HTTP 2.0 协议将一个 TCP 的连接中，切分成多个流，每个流都有自己的 ID，而且流可以是客户端发往服务端，也可以是服务端发往客户端。它其实只是一个虚拟的通道。流是有优先级的。</li>
<li>HTTP 2.0 还将所有的传输信息分割为更小的消息和帧，并对它们采用二进制格式编码。常见的帧有Header 帧，用于传输 Header 内容，并且会开启一个新的流。再就是Data 帧，用来传输正文实体。多个 Data 帧属于同一个流。</li>
<li>通过这两种机制，HTTP 2.0 的客户端可以将多个请求分到不同的流中，然后将请求内容拆成帧，进行二进制传输。这些帧可以打散乱序发送， 然后根据每个帧首部的流标识符重新组装，并且可以根据优先级，决定优先处理哪个流的数据。</li>
</ul>
</li>
<li>假设我们的一个页面要发送三个独立的请求，一个获取 css，一个获取 js，一个获取图片 jpg。如果使用 HTTP 1.1 就是串行的，但是如果使用 HTTP 2.0，就可以在一个连接里，客户端和服务端都可以同时发送多个请求或回应，而且不用按照顺序一对一对应。<br>  <img src="https://static001.geekbang.org/resource/image/0b/7a/0bc51f8f887aae04ef89a1a88cb5a17a.jpg" alt=""><br>  HTTP 2.0 其实是将三个请求变成三个流，将数据分成帧，乱序发送到一个 TCP 连接中。<br>  <img src="https://static001.geekbang.org/resource/image/03/dd/03d4a216c024a9e761ed43c6787bf7dd.jpg" alt=""></li>
<li>HTTP 2.0 成功解决了 HTTP 1.1 的队首阻塞问题，同时，也不需要通过 HTTP 1.x 的 pipeline 机制用多条 TCP 连接来实现并行请求与响应；减少了 TCP 连接数对服务器性能的影响，同时将页面的多个数据 css、js、 jpg 等通过一个数据链接进行传输，能够加快页面组件的传输速度。</li>
</ul>
<h4 id="QUIC-协议"><a href="#QUIC-协议" class="headerlink" title="QUIC 协议"></a>QUIC 协议</h4><p>HTTP 2.0 虽然大大增加了并发性，但还是有问题的。因为 HTTP 2.0 也是基于 TCP 协议的，TCP 协议在处理包时是有严格顺序的。于是，就又到了从 TCP 切换到 UDP，这就是 Google 的 QUIC 协议。</p>
<ul>
<li>自定义连接机制<ul>
<li>一条 TCP 连接是由四元组标识的，分别是源 IP、源端口、目的 IP、目的端口。一旦一个元素发生变化时，就需要断开重连，重新连接。在移动互联情况下，当手机信号不稳定或者在 WIFI 和 移动网络切换时，都会导致重连，从而进行再次的三次握手，导致一定的时延。</li>
<li>基于 UDP，可以在 QUIC 自己的逻辑里面维护连接的机制，不再以四元组标识，而是以一个 64 位的随机数作为 ID 来标识，而且 UDP 是无连接的，所以当 IP 或者端口变化的时候，只要 ID 不变，就不需要重新建立连接。</li>
</ul>
</li>
<li>自定义重传机制<ul>
<li>TCP 为了保证可靠性，通过使用序号和应答机制，来解决顺序问题和丢包问题。TCP 自适应重传算法的超时是通过采样往返时间 RTT不断调整的，这个采样存在不准确的问题。<blockquote>
<p>例如，发送一个包，序号为 100，发现没有返回，于是再发送一个 100，过一阵返回一个 ACK101。这个时候客户端知道这个包肯定收到了，但是往返时间是多少呢？是 ACK 到达的时间减去后一个 100 发送的时间，还是减去前一个 100 发送的时间呢？事实是，第一种算法把时间算短了，第二种算法把时间算长了。</p>
</blockquote>
</li>
<li>QUIC 也有个序列号，是递增的。任何一个序列号的包只发送一次，下次就要加一了。<blockquote>
<p>例如，发送一个包，序号是 100，发现没有返回；再次发送的时候，序号就是 101 了；如果返回的 ACK 100，就是对第一个包的响应。如果返回 ACK 101 就是对第二个包的响应，RTT 计算相对准确。</p>
<p>怎么知道包 100 和包 101 发送的是同样的内容呢？QUIC 定义了一个 offset 概念。QUIC 既然是面向连接的，也就像 TCP 一样，是一个数据流，发送的数据在这个数据流里面有个偏移量 offset，可以通过 offset 查看数据发送到了哪里，这样只要这个 offset 的包没有来，就要重发；如果来了，按照 offset 拼接，还是能够拼成一个流。</p>
</blockquote>
</li>
</ul>
</li>
<li>无阻塞的多路复用<ul>
<li>同 HTTP 2.0 一样，同一条 QUIC 连接上可以创建多个 stream，来发送多个 HTTP 请求。但 QUIC 是基于 UDP 的，一个连接上的多个 stream 之间没有依赖。这样，假如 stream2 丢了一个 UDP 包，后面跟着 stream3 的一个 UDP 包，虽然 stream2 的那个包需要重传，但是 stream3 的包无需等待，就可以发给用户。</li>
</ul>
</li>
<li>自定义流量控制<ul>
<li>TCP 的流量控制是通过滑动窗口协议。在 TCP 协议中，接收端的窗口的起始点是下一个要接收并且 ACK 的包，即便后来的包都到了，放在缓存里面，窗口也不能右移，因为 TCP 的 ACK 机制是基于序列号的累计应答，一旦 ACK 了一个系列号，就说明前面的都到了，所以只要前面的没到，后面的到了也不能 ACK，就会导致后面的到了，也有可能超时重传，浪费带宽。</li>
<li>QUIC 的流量控制也是通过 window_update，来告诉对端它可以接受的字节数。但是 QUIC 的窗口是适应自己的多路复用机制的，不但在一个连接上控制窗口，还在一个连接中的每个 stream 控制窗口。QUIC 的 ACK 是基于 offset 的，每个 offset 的包来了，进了缓存，就可以应答，应答后就不会重发，中间的空挡会等待到来或者重发即可，而窗口的起始位置为当前收到的最大 offset，从这个 offset 到当前的 stream 所能容纳的最大缓存，是真正的窗口大小。显然，这样更加准确。</li>
<li>如图，上半部分为 TCP，下半部分为 QUIC<br>  <img src="https://static001.geekbang.org/resource/image/a6/22/a66563b46906e7708cc69a02d43afb22.jpg" alt=""></li>
</ul>
</li>
</ul>
<hr>
<h2 id="第15讲-HTTPS协议：点外卖的过程原来这么复杂"><a href="#第15讲-HTTPS协议：点外卖的过程原来这么复杂" class="headerlink" title="第15讲 | HTTPS协议：点外卖的过程原来这么复杂"></a>第15讲 | HTTPS协议：点外卖的过程原来这么复杂</h2><h4 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h4><ul>
<li>对称加密: 为保证密码安全性，只能通过线下传输。在互联网应用中，客户太多，这样是不行的。</li>
<li>非对称加密: 中间拦截拿到数据后因为没有私钥也无法解密，且公钥可以在网络上传输，公钥无法解密，服务提供商只要保证自己私钥的安全性即可。</li>
</ul>
<h4 id="数字证书-Certificate"><a href="#数字证书-Certificate" class="headerlink" title="数字证书 (Certificate)"></a>数字证书 (Certificate)</h4><ul>
<li>数字证书包含的内容<ul>
<li>公钥</li>
<li>证书的所有者</li>
<li>证书的发布机构</li>
<li>证书的有效期</li>
</ul>
</li>
<li>证书签名<ul>
<li>将证书发给权威机构 CA(Certificate Authority)，权威机构会给这个证书盖一个章，我们称为签名算法</li>
<li>只有用 CA 的私钥签名的证书，才能保证证书签名的真实性，之后可以通过 CA 的公钥进行解密以验证其真实性</li>
<li>签名证书包含的内容<ul>
<li>Issuer: 证书是谁颁发的</li>
<li>Subject: 证书颁发给谁</li>
<li>Validity: 证书期限</li>
<li>Public-key: 服务端公钥（不是证书机构的公钥，证书机构的公钥是用于验证证书真实性的）</li>
<li>Signature Algorithm: 签名算法</li>
</ul>
</li>
<li>如何确保 CA 机构的可靠，以及其公钥的可靠？<ul>
<li>找更有公信力的 CA 进行二次签名，依次类推，直到全球皆知的几个著名大 CA，称为root CA，做最后的背书。通过这种层层授信背书的方式，从而保证了非对称加密模式的正常运转。</li>
</ul>
</li>
<li>还有一种证书，称为Self-Signed Certificate，就是自己给自己签名。这个给人一种“我就是我，你爱信不信”的感觉。<blockquote>
<p>这些工作都是为了确保别人给你的公钥是对的。避免有中间拦截者冒充服务端，发给你一个它的自己的假冒公钥。否则之后你与服务端的通信都是与假冒网站通信了。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="HTTPS-的工作模式"><a href="#HTTPS-的工作模式" class="headerlink" title="HTTPS 的工作模式"></a>HTTPS 的工作模式</h4><p>HTTPS 是综合了对称加密和非对称加密算法的 HTTP 协议。既保证传输安全，也保证传输效率。<br><img src="https://static001.geekbang.org/resource/image/70/02/7042f5c3d9e3437d5b0b30b30f43c802.jpg" alt=""></p>
<ol>
<li>客户端会发送 Client Hello 消息到服务器，以明文传输 TLS 版本信息、加密套件候选列表、压缩算法候选列表等信息。另外，还会有一个随机数，用于后续的对称密钥协商。</li>
<li>服务端返回 Server Hello 消息, 告诉客户端，服务器选择使用的协议版本、加密套件、压缩算法等，还有一个随机数，用于后续的对称密钥协商。</li>
<li>服务端返回给客户端一个服务器端的证书</li>
<li>服务端返回 “Server Hello Done，我这里就这些信息了。”</li>
<li>客户端从自己信任的 CA 仓库中，拿 CA 的证书里面的公钥去解密服务端的证书。如果能够成功，则说明外卖网站是可信的。这个过程中，可能会不断往上追溯 CA、CA 的 CA、CA 的 CA 的 CA，直到一个授信的 CA。</li>
<li>客户端计算产生随机数字 Pre-master，发送 Client Key Exchange，用证书中的公钥加密，再发送给服务器，服务器可以通过私钥解密出来。</li>
<li>到目前为止，客户端与服务器都有了三个随机数，分别是：自己的、对端的，以及刚生成的 Pre-Master 随机数。通过这三个随机数，可以在客户端和服务器产生相同的对称密钥。</li>
<li>客户端发送 Change Cipher Spec，说：“咱们以后都采用协商的通信密钥和加密算法进行加密通信了。”</li>
<li>客户端发送 Encrypted Handshake Message，将已经商定好的参数等，采用协商密钥进行加密，发送给服务器用于数据与握手验证。</li>
<li>服务端发送 Change Cipher Spec，说：“没问题，咱们以后都采用协商的通信密钥和加密算法进行加密通信了”</li>
<li>服务端发送 Encrypted Handshake Message 的消息试试。当双方握手结束之后，就可以通过对称密钥进行加密传输了。</li>
</ol>
<h4 id="重放与篡改"><a href="#重放与篡改" class="headerlink" title="重放与篡改"></a>重放与篡改</h4><blockquote>
<p>虽然 https 无法被黑客解密，但是黑客可以直接复制请求包，并多次重复向服务端发送，这被称之为重放<br>可以使用 Timestamp 和 Nonce 解决重放与篡改的问题</p>
</blockquote>
<ul>
<li>Timestamp 是时间戳，Nonce 是客户端生成的随机数，Nonce 随机数保证唯一，或者 Timestamp 和 Nonce 合起来保证唯一，然后两者结合做一个不可逆的签名来保证。</li>
<li>服务端对于请求只接受一次，当服务端多次受到相同的 Timestamp 和 Nonce，则视为无效即可。</li>
<li>如果有人想篡改 Timestamp 和 Nonce，还有签名保证不可篡改性，如果改了用签名算法解出来，就对不上了，可以丢弃。</li>
</ul>
<hr>
<h2 id="第16讲-流媒体协议：如何在直播里看到美女帅哥？"><a href="#第16讲-流媒体协议：如何在直播里看到美女帅哥？" class="headerlink" title="第16讲 | 流媒体协议：如何在直播里看到美女帅哥？"></a>第16讲 | 流媒体协议：如何在直播里看到美女帅哥？</h2><p>视频编码其实就是一个压缩的过程</p>
<blockquote>
<p>如果不压缩，以一个1分钟长度，30帧，720p的视频举例，每个像素由 RGB 组成，每个数值8位，一共24位，则视频大小为 1280 * 720 * 24 * 30帧 * 60s = 39813120000 Bytes ≈ 40GB，因此需要视频压缩(编码)来减小视频大小。</p>
</blockquote>
<h4 id="视频和图片的压缩过程的特点"><a href="#视频和图片的压缩过程的特点" class="headerlink" title="视频和图片的压缩过程的特点"></a>视频和图片的压缩过程的特点</h4><ul>
<li>空间冗余：图像的相邻像素之间有较强的相关性，一张图片相邻像素往往是渐变的，不是突变的，没必要每个像素都完整地保存，可以隔几个保存一个，中间的用算法计算出来。</li>
<li>时间冗余：视频序列的相邻图像之间内容相似。一个视频中连续出现的图片也不是突变的，可以根据已有的图片进行预测和推断。</li>
<li>视觉冗余：人的视觉系统对某些细节不敏感，因此不会每一个细节都注意到，可以允许丢失一些数据。</li>
<li>编码冗余：不同像素值出现的概率不同，概率高的用的字节少，概率低的用的字节多，类似霍夫曼编码（Huffman Coding）的思路。<blockquote>
<p>视频编码流程，可以参考下图:<br><img src="https://static001.geekbang.org/resource/image/43/b4/433a51e15d0ed50e313454ceccd61cb4.jpg" alt=""></p>
</blockquote>
</li>
</ul>
<h4 id="视频编码的规范"><a href="#视频编码的规范" class="headerlink" title="视频编码的规范"></a>视频编码的规范</h4><ul>
<li>两大流派<ol>
<li>ITU（International Telecommunications Union）的 VCEG（Video Coding Experts Group），这个称为国际电联下的 VCEG。<blockquote>
<p>诸如 H.261、 H.262、H.263、H.264、H.265 就是这个组织制定的标准</p>
</blockquote>
</li>
<li>ISO（International Standards Organization）的 MPEG（Moving Picture Experts Group），这个是ISO 旗下的 MPEG。<blockquote>
<p>诸如 MPEG-1、MPEG-2、MPEG-4、MPEG-7 就是这个组织制定的标准</p>
</blockquote>
</li>
</ol>
</li>
<li>后来，ITU-T 与 MPEG 联合制定了 H.264/MPEG-4 AVC</li>
<li>经过编码之后，图像就变成了二进制数据，这个二进制可以放在一个文件里面，按照一定的格式保存起来。<blockquote>
<p>诸如 AVI、MPEG、RMVB、MP4、MOV、FLV、WebM、WMV、ASF、MKV 就是所谓的格式。例如，前几个字节是什么意义，后几个字节是什么意义，然后是数据，数据中保存的就是编码好的结果。</p>
</blockquote>
</li>
</ul>
<h4 id="直播的原理"><a href="#直播的原理" class="headerlink" title="直播的原理"></a>直播的原理</h4><ol>
<li>前提: 视频编码后的二进制数据可以通过某种网络协议进行封装，放在互联网上传输</li>
<li>接流: 网络协议将编码好的视频流，从主播端推送到服务器，在服务器上有个运行了同样协议的服务端来接收这些网络包，从而得到里面的视频流，这个过程称为接流。</li>
<li>服务端转码: 服务端接到视频流之后，可以对视频流进行一定的处理，例如转码，也即从一个编码格式，转成另一种格式。转码的目的是保证视频流在服务端的格式一致，方便服务端针对视频流做一些统一处理，以及后续的拉流等操作。</li>
<li>拉流: 流处理完毕之后，就可以等待观众的客户端来请求这些视频流。观众的客户端请求的过程称为拉流。<ul>
<li>分发: 同时看一个视频直播，那都从一个服务器上拉流，压力太大了，因而需要一个视频的分发网络，将视频预先加载到就近的边缘节点，这样大部分观众看的视频，是从边缘节点拉取的，就能降低服务器的压力。</li>
</ul>
</li>
<li>客户端解码: 当观众的客户端将视频流拉下来之后，就需要进行解码，也即通过上述过程的逆过程，将一串串看不懂的二进制，再转变成一帧帧图片，在客户端播放出来。<blockquote>
<p>整个直播流程可以用下图描述<br><img src="https://static001.geekbang.org/resource/image/e4/f8/e4d4b538c434ec0eade37028a34391f8.jpg" alt=""></p>
</blockquote>
</li>
</ol>
<h4 id="编码的原理"><a href="#编码的原理" class="headerlink" title="编码的原理"></a>编码的原理</h4><ol>
<li><p>首先将视频中的图片分为三种帧</p>
<ul>
<li>I 帧，也称关键帧。里面是完整的图片，只需要本帧数据，就可以完成解码。</li>
<li>P 帧，前向预测编码帧。P 帧表示的是这一帧跟之前的一个关键帧（或 P 帧）的差别，解码时需要用之前缓存的画面，叠加上和本帧定义的差别，生成最终画面。</li>
<li>B 帧，双向预测内插编码帧。B 帧记录的是本帧与前后帧的差别。要解码 B 帧，不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的数据与本帧数据的叠加，取得最终的画面。</li>
</ul>
</li>
<li><p>编码结构<br> <img src="!%5B%5D(https://static001.geekbang.org/resource/image/b8/70/b8f215697ce950005a532d3be341f570.jpg)" alt=""></p>
<ul>
<li>时间上的编码: I 帧最完整，B 帧压缩率最高，而压缩后帧的序列，应该是在 IBBP 的间隔出现的。这就是通过时序进行编码。</li>
<li>空间上的编码: 在一帧中，分成多个片，每个片中分成多个宏块，每个宏块分成多个子块，这样将一张大的图分解成一个个小块，可以方便进行空间上的编码。<blockquote>
<p>解码，则按照类似的下图顺序，先解码一个 I，接着是 I 之后的一个 P，然后解码 I P 之间的 B，以此类推<br><img src="http://images.cppblog.com/cppblog_com/elva/530c5a8a2cdb1936c9fc7a6a.jpg" alt=""></p>
</blockquote>
</li>
</ul>
</li>
<li><p>编码转换为二进制流<br> <img src="https://static001.geekbang.org/resource/image/42/60/42dcd0705e3b1bad05d59fd9d6707d60.jpg" alt=""><br> 这个流的结构是一个个的网络提取层单元（NALU，Network Abstraction Layer Unit）。变成这种格式就是为了传输，因为网络上的传输，默认的是一个个的包，因而这里也就分成了一个个的单元。</p>
<ul>
<li>NALU 首先是一个起始标识符，用于标识 NALU 之间的间隔</li>
<li>然后是 NALU 的头，里面主要配置了 NALU 的类型，NALU 头里面，主要的内容是类型NAL Type。<ul>
<li>0x07 表示 SPS，是序列参数集， 包括一个图像序列的所有信息，如图像尺寸、视频格式等。</li>
<li>0x08 表示 PPS，是图像参数集，包括一个图像的所有分片的所有相关信息，包括图像类型、序列号等。</li>
</ul>
</li>
<li>最终 Payload 里面是 NALU 承载的数据。</li>
</ul>
</li>
<li><p>总结: 一个视频，可以拆分成一系列的帧，每一帧拆分成一系列的片，每一片都放在一个 NALU 里面，NALU 之间都是通过特殊的起始标识符分隔，在每一个 I 帧的第一片前面，要插入单独保存 SPS 和 PPS 的 NALU，最终形成一个长长的 NALU 序列。</p>
</li>
</ol>
<h4 id="推流：如何把数据流打包传输到对端？-基于-RTMP-协议"><a href="#推流：如何把数据流打包传输到对端？-基于-RTMP-协议" class="headerlink" title="推流：如何把数据流打包传输到对端？(基于 RTMP 协议)"></a>推流：如何把数据流打包传输到对端？(基于 RTMP 协议)</h4><ul>
<li>RTMP 是基于 TCP 的，因而肯定需要双方建立一个 TCP 的连接。在有 TCP 的连接的基础上，还需要建立一个 RTMP 的连接。</li>
<li>RMTP 连接主要确认版本号与时间戳，以保证之后的传输能正常进行。如果客户端、服务器的版本号不一致，则不能工作。视频播放中，时间是很重要的，后面的数据流互通的时候，经常要带上时间戳的差值，因而一开始双方就要知道对方的时间戳。</li>
<li>RMTP 连接的建立，需要发送六条消息：客户端发送 C0、C1、 C2，服务器发送 S0、 S1、 S2。<ol>
<li>首先，客户端发送 C0 表示自己的版本号，不必等对方的回复，然后发送 C1 表示自己的时间戳。</li>
<li>服务器只有在收到 C0 的时候，才能返回 S0，表明自己的版本号，如果版本不匹配，可以断开连接。</li>
<li>服务器发送完 S0 后，无需等待，直接发送自己的时间戳 S1。客户端收到 S1 的时候，发一个知道了对方时间戳的 ACK C2。同理服务器收到 C1 的时候，发一个知道了对方时间戳的 ACK S2。</li>
</ol>
</li>
<li>RMTP 连接建立成功，之后可以开始视频流的传输<br>  <img src="https://static001.geekbang.org/resource/image/14/2e/14221e482876b0b243f5213c7a1cc62e.jpg" alt=""><ul>
<li>双方需要互相传递一些控制信息，例如 Chunk 块的大小、窗口大小等。</li>
<li>真正传输数据的时候，还是需要创建一个流 Stream，然后通过这个 Stream 来推流 publish。</li>
<li>推流的过程，就是将 NALU 放在 Message 里面发送，这个也称为RTMP Packet 包。Message 的格式就像这样。<br>  <img src="https://static001.geekbang.org/resource/image/1a/4b/1a97a0b90c2304cbdf22a2bc8a8ce94b.jpg" alt=""><blockquote>
<p>RTMP 在收发数据的时候并不是以 Message 为单位的，而是把 Message 拆分成 Chunk 发送，而且必须在一个 Chunk 发送完成之后，才能开始发送下一个 Chunk。每个 Chunk 中都带有 Message ID，表示属于哪个 Message，接收端也会按照这个 ID 将 Chunk 组装成 Message。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="拉流：观众的客户端如何看到视频？"><a href="#拉流：观众的客户端如何看到视频？" class="headerlink" title="拉流：观众的客户端如何看到视频？"></a>拉流：观众的客户端如何看到视频？</h4><p><img src="https://static001.geekbang.org/resource/image/52/ee/52d2e201f87462bc3afed8ce4d743aee.jpg" alt=""></p>
<ol>
<li>先读到的是 H.264 的解码参数，例如 SPS 和 PPS</li>
<li>然后对收到的 NALU 组成的一个个帧</li>
<li>进行解码，交给播发器播放</li>
</ol>
<hr>
<h2 id="第17讲-P2P协议：我下小电影，99-急死你"><a href="#第17讲-P2P协议：我下小电影，99-急死你" class="headerlink" title="第17讲 | P2P协议：我下小电影，99%急死你"></a>第17讲 | P2P协议：我下小电影，99%急死你</h2><h4 id="FTP（文件传输协议）"><a href="#FTP（文件传输协议）" class="headerlink" title="FTP（文件传输协议）"></a>FTP（文件传输协议）</h4><p>FTP 采用两个 TCP 连接来传输一个文件</p>
<ul>
<li>控制连接：服务器以被动的方式，打开众所周知用于 FTP 的端口 21，客户端则主动发起连接。该连接将命令从客户端传给服务器，并传回服务器的应答。常用的命令有：list——获取文件目录；reter——取一个文件；store——存一个文件。</li>
<li>数据连接：每当一个文件在客户端与服务器之间传输时，就创建一个数据连接。</li>
</ul>
<p>FTP 的两种工作模式，这两种模式都是站在 FTP 服务器的角度来说的。</p>
<ul>
<li>主动模式（PORT）：客户端随机打开一个大于 1024 的端口 N，向服务器的命令端口 21 发起连接，同时开放 N+1 端口监听，并向服务器发出 “port N+1” 命令，由服务器从自己的数据端口 20，主动连接到客户端指定的数据端口 N+1。</li>
<li>被动模式（PASV）：客户端打开两个任意的本地端口 N（大于 1024）和 N+1。第一个端口连接服务器的 21 端口，提交 PASV 命令。然后，服务器会开启一个任意的端口 P（大于 1024），返回“227 entering passive mode”消息，里面有 FTP 服务器开放的用来进行数据传输的端口。客户端收到消息取得端口号之后，会通过 N+1 号端口连接服务器的端口 P，然后在两个端口之间进行数据传输。</li>
</ul>
<h4 id="P2P"><a href="#P2P" class="headerlink" title="P2P"></a>P2P</h4><ul>
<li>P2P，即 peer-to-peer。资源开始并不集中地存储在某些设备上，而是分散地存储在多台设备上。这些设备我们姑且称为 peer。<blockquote>
<p>想要下载一个文件的时候，你只要得到那些已经存在了文件的 peer，并和这些 peer 之间，建立点对点的连接，而不需要到中心服务器上，就可以就近下载文件。一旦下载了文件，你也就成为 peer 中的一员，你旁边的那些机器，也可能会选择从你这里下载文件。</p>
</blockquote>
</li>
<li>P2P 解决了 HTTP/FTP 等方式存在的单一服务器的带宽压力问题</li>
</ul>
<h4 id="种子（-torrent）文件"><a href="#种子（-torrent）文件" class="headerlink" title="种子（.torrent）文件"></a>种子（.torrent）文件</h4><p>种子，即 .torrent 文件，由两部分组成，分别是：announce（tracker URL）和文件信息。</p>
<p>文件信息中包含如下内容</p>
<ul>
<li>info 区：这里指定的是该种子有几个文件、文件有多长、目录结构，以及目录和文件的名字。</li>
<li>Name 字段：指定顶层目录名字。</li>
<li>每个段的大小：BitTorrent（简称 BT）协议把一个文件分成很多个小段，然后分段下载。</li>
<li>段哈希值：将整个种子中，每个段的 SHA-1 哈希值拼在一起。</li>
</ul>
<p>下载流程</p>
<ul>
<li>BT 客户端首先解析.torrent 文件，得到 tracker 地址，然后连接 tracker 服务器。</li>
<li>tracker 服务器回应下载者的请求，将其他下载者（包括发布者）的 IP 提供给下载者。</li>
<li>下载者连接其他下载者，根据.torrent 文件，两者分别对方告知自己已经有的块，然后交换对方没有的数据。<blockquote>
<p>此时不需要其他服务器参与，并分散了单个线路上的数据流量，因此减轻了服务器的负担。</p>
</blockquote>
</li>
<li>下载者每得到一个块，需要算出下载块的 Hash 验证码，并与.torrent 文件中的对比。如果一样，则说明块正确，不一样则需要重新下载这个块。这种规定是为了解决下载内容的准确性问题。</li>
</ul>
<p>P2P 的弊端</p>
<ul>
<li>一旦 tracker 服务器出现故障或者线路遭到屏蔽，BT 工具就无法正常工作了。虽然下载的过程是非中心化的，但是加入这个 P2P 网络的时候，都需要借助 tracker 中心服务器，这个服务器是用来登记有哪些用户在请求哪些资源。</li>
</ul>
<h4 id="去中心化网络（DHT）"><a href="#去中心化网络（DHT）" class="headerlink" title="去中心化网络（DHT）"></a>去中心化网络（DHT）</h4><p><img src="https://static001.geekbang.org/resource/image/8e/cf/8ece62f3f99cb3fe7ee0274a1ad79fcf.jpg" alt=""></p>
<ul>
<li>每个加入这个 DHT 网络的人，都要负责存储这个网络里的资源信息和其他成员的联系信息，相当于所有人一起构成了一个庞大的分布式存储数据库。</li>
<li>有一种著名的 DHT 协议，叫Kademlia 协议。</li>
<li>任何一个 BitTorrent 启动之后，它都有两个角色<ul>
<li>一个是peer，监听一个 TCP 端口，用来上传和下载文件，这个角色表明，我这里有某个文件。</li>
<li>另一个角色DHT node，监听一个 UDP 的端口，通过这个角色，这个节点加入了一个 DHT 的网络。<ul>
<li>每一个 DHT node 都有一个 ID。每个 DHT node 都有责任掌握一些文件索引，也即它应该知道某些文件是保存在哪些节点上。但它自己本身不一定就是保存这个文件的节点。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="DHT-node-应该知道哪部分文件的索引？"><a href="#DHT-node-应该知道哪部分文件的索引？" class="headerlink" title="DHT node 应该知道哪部分文件的索引？"></a>DHT node 应该知道哪部分文件的索引？</h4><p>每个文件可以计算出一个哈希值，而DHT node 的 ID 是和哈希值相同长度的串。</p>
<p>DHT 算法是这样规定的</p>
<ul>
<li>如果一个文件计算出一个哈希值，则和这个哈希值一样的那个 DHT node，就有责任知道从哪里下载这个文件，即便它自己没保存这个文件。</li>
<li>除了一模一样的那个 DHT node 应该知道，ID 和这个哈希值非常接近的 N 个 DHT node 也应该知道。</li>
<li>举例<ul>
<li>文件 1 通过哈希运算，得到匹配 ID 的 DHT node 为 node C，当然还会有其他的，这里没有画出来。所以，node C 有责任知道文件 1 的存放地址，虽然 node C 本身没有存放文件 1。</li>
<li>文件 2 通过哈希运算，得到匹配 ID 的 DHT node 为 node E，但是 node D 和 E 的 ID 值很近，所以 node D 也知道。当然，文件 2 本身没有必要一定在 node D 和 E 里，但是碰巧这里就在 E 那有一份。</li>
</ul>
</li>
</ul>
<h4 id="DHT-node-新节点上线"><a href="#DHT-node-新节点上线" class="headerlink" title="DHT node 新节点上线"></a>DHT node 新节点上线</h4><p>这里以 node new 上线，下载文件 1 来举例</p>
<ul>
<li>DHT 网络中，种子 .torrent 文件里面就不再是 tracker 的地址了，而是一个 list 的 node 的地址，所有这些 node 都是已经在 DHT 网络里面的。当然随着时间的推移，很可能有退出的，有下线的。node new 只要在种子里面找到一个 DHT node，就加入了网络。<blockquote>
<p>这里我们假设，不会所有的都联系不上，总有一个能联系上。</p>
</blockquote>
</li>
<li>node new 会计算文件 1 的哈希值，并根据这个哈希值了解到，和这个哈希值匹配，或者很接近的 node 上知道如何下载这个文件，例如计算出来的哈希值就是 node C。</li>
<li>node new 通过 DHT 网络，询问其他 DHT node，得到 node C，或与 C 相临近的 N 个 node 之一，他们都知道文件 1 的下载方式。</li>
<li>node new 通过 node C 知道下载文件 1，要去 B、D、 F，于是 node new 选择和 node B 进行 peer 连接，开始下载，它一旦开始下载，自己本地也有文件 1 了，于是 node new 告诉 node C 以及和 node C 的 ID 很像的那些节点，我也有文件 1 了，可以加入那个文件拥有者列表了。</li>
</ul>
<h4 id="DHT-网络的节点关系是怎么规定的？"><a href="#DHT-网络的节点关系是怎么规定的？" class="headerlink" title="DHT 网络的节点关系是怎么规定的？"></a>DHT 网络的节点关系是怎么规定的？</h4><p>DHT 网络按距离分层</p>
<ul>
<li>距离的计算方法<ul>
<li>假设某个节点的 ID 为 01010，如果一个节点的 ID，前面所有位数都与它相同，只有最后 1 位不同。这样的节点只有 1 个，为 01011。与基础节点的异或值为 00001，即距离为 1；对于 01010 而言，这样的节点归为“k-bucket 1”。</li>
<li>如果一个节点的 ID，前面所有位数都相同，从倒数第 2 位开始不同，这样的节点只有 2 个，即 01000 和 01001，与基础节点的异或值为 00010 和 00011，即距离范围为 2 和 3；对于 01010 而言，这样的节点归为“k-bucket 2”。</li>
<li>如果一个节点的 ID，前面所有位数相同，从倒数第 i 位开始不同，这样的节点只有 2^(i-1) 个，与基础节点的距离范围为 [2^(i-1), 2^i)；对于 01010 而言，这样的节点归为“k-bucket i”。</li>
</ul>
</li>
<li>分层的规则: 每一层都只放 K 个，这是参数可以配置。</li>
</ul>
<h4 id="DHT-网络是如何查找节点的？"><a href="#DHT-网络是如何查找节点的？" class="headerlink" title="DHT 网络是如何查找节点的？"></a>DHT 网络是如何查找节点的？</h4><ul>
<li>以 A 查找 B 举例<ol>
<li>假设，node A 的 ID 为 00110，要找 node B ID 为 10000，异或距离为 10110，距离范围在 [2^4, 2^5)，所以这个目标节点可能在“k-bucket 5”中，这就说明 B 的 ID 与 A 的 ID 从第 5 位开始不同，所以 B 可能在“k-bucket 5”中。</li>
<li>然后，A 看看自己的 k-bucket 5 有没有 B。如果有，太好了，找到你了；如果没有，在 k-bucket 5 里随便找一个 C。因为是二进制，C、B 都和 A 的第 5 位不同，那么 C 的 ID 第 5 位肯定与 B 相同，即它与 B 的距离会小于 2^4，相当于比 A、B 之间的距离缩短了一半以上。</li>
<li>再请求 C，在它自己的通讯录里，按同样的查找方式找一下 B。如果 C 知道 B，就告诉 A；如果 C 也不知道 B，那 C 按同样的搜索方法，可以在自己的通讯录里找到一个离 B 更近的 D 朋友（D、B 之间距离小于 2^3），把 D 推荐给 A，A 请求 D 进行下一步查找。</li>
</ol>
</li>
<li>Kademlia 的这种查询机制，是通过折半查找的方式来收缩范围，对于总的节点数目为 N，最多只需要查询 log2(N) 次，就能够找到。</li>
</ul>
<h4 id="DHT-网络中，节点之间如何沟通？"><a href="#DHT-网络中，节点之间如何沟通？" class="headerlink" title="DHT 网络中，节点之间如何沟通？"></a>DHT 网络中，节点之间如何沟通？</h4><p>Kademlia 算法中，每个节点只有 4 个指令</p>
<ul>
<li>PING：测试一个节点是否在线，还活着没，相当于打个电话，看还能打通不。</li>
<li>STORE：要求一个节点存储一份数据，既然加入了组织，有义务保存一份数据。</li>
<li>FIND_NODE：根据节点 ID 查找一个节点，就是给一个 160 位的 ID，通过上面朋友圈的方式找到那个节点。</li>
<li>FIND_VALUE：根据 KEY 查找一个数据，实则上跟 FIND_NODE 非常类似。KEY 就是文件对应的 160 位的 ID，就是要找到保存了文件的节点。</li>
</ul>
<h4 id="DHT-网络中，节点关系如何更新？"><a href="#DHT-网络中，节点关系如何更新？" class="headerlink" title="DHT 网络中，节点关系如何更新？"></a>DHT 网络中，节点关系如何更新？</h4><ul>
<li>每个 bucket 里的节点，都按最后一次接触的时间倒序排列</li>
<li>每次执行四个指令中的任意一个都会触发更新。</li>
<li>举例: 当一个节点与自己接触时<ul>
<li>检查它是否已经在 k-bucket 中<ul>
<li>如果在，那么将它挪到 k-bucket 列表的最底，也就是最新的位置</li>
<li>如果不在，且节点列表没有满，则添加到 k-bucket 最底层</li>
<li>如果不在，且节点列表已满，PING 一下列表最上面，也即最旧的一个节点。如果 PING 通了，将旧节点挪到列表最底，并丢弃新节点；如果 PING 不通，删除旧节点，并将新节点加入列表。</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第18讲-DNS协议：网络世界的地址簿"><a href="#第18讲-DNS协议：网络世界的地址簿" class="headerlink" title="第18讲 | DNS协议：网络世界的地址簿"></a>第18讲 | DNS协议：网络世界的地址簿</h2><h4 id="DNS-服务器"><a href="#DNS-服务器" class="headerlink" title="DNS 服务器"></a>DNS 服务器</h4><ul>
<li>你肯定记得住网站的名称，但是很难记住网站的 IP 地址，因而也需要一个地址簿，就是DNS 服务器。</li>
<li>由此可见，每个人上网，都需要访问 DNS 服务器，因而 DNS 服务器一定要设置成高可用、高并发和分布式的。<br>  <img src="https://static001.geekbang.org/resource/image/59/a6/59f79cba26904ff721aabfcdc0c27da6.jpg" alt=""><ul>
<li>根 DNS 服务器 ：返回顶级域 DNS 服务器的 IP 地址</li>
<li>顶级域 DNS 服务器：返回权威 DNS 服务器的 IP 地址</li>
<li>权威 DNS 服务器 ：返回相应主机的 IP 地址</li>
</ul>
</li>
</ul>
<h4 id="DNS-解析流程"><a href="#DNS-解析流程" class="headerlink" title="DNS 解析流程"></a>DNS 解析流程</h4><p><img src="https://static001.geekbang.org/resource/image/ff/f2/ff7e8f824ebd1f7e16ef5d70cd79bdf2.jpg" alt=""><br>为了提高 DNS 的解析性能，很多网络都会就近部署 DNS 缓存服务器。这里以访问 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 来举例:</p>
<ol>
<li>电脑客户端会发出一个 DNS 请求，问 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 的 IP 是什么，并发给本地域名服务器 (本地 DNS)。<blockquote>
<p>如果是通过 DHCP 配置，本地 DNS 由你的网络服务商（ISP），如电信、移动等自动分配，它通常就在你网络服务商的某个机房。</p>
<p>也可以手动配置本地域名服务器，比如常见的 Google 的 8.8.8.8, 8.8.4.4</p>
</blockquote>
</li>
<li>本地 DNS 收到来自客户端的请求。如果能在 DNS 表中找到 <a href="http://www.baidu.com，它直接就返回" target="_blank" rel="noopener">www.baidu.com，它直接就返回</a> IP 地址。如果没有，本地 DNS 会去问它的根域名服务器<blockquote>
<p>根域名服务器是最高层次的，全球共有 13 套。它不直接用于域名解析，但能指明一条道路。</p>
</blockquote>
</li>
<li>根 DNS 收到来自本地 DNS 的请求，发现后缀是 .com，并返回顶级域名服务器 .com 的地址</li>
<li>本地 DNS 再将请求发向顶级域名服务器，顶级域名服务器返回 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 区域的权威 DNS 服务器的地址<blockquote>
<p>权威服务器就是保存域名及其对应 ip 的服务器，一般来说，权威 DNS 服务器可能是大公司自己组建的，专门提供自家域名解析。也可能是 DNS 解析服务提供商，如阿里云。</p>
</blockquote>
</li>
<li>本地 DNS 转向请求权威 DNS 服务器，并最终得到 <a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a> 对应的 ip 地址</li>
<li>本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接</li>
</ol>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><ul>
<li>内部负载均衡: 在域名解析的时候，我们只要配置策略，这次返回第一个 IP，下次返回第二个 IP，就可以实现负载均衡了。</li>
<li>全局负载均衡: 我们肯定希望北京的用户访问北京的数据中心，上海的用户访问上海的数据中心，这样，客户体验就会非常好，访问速度就会超快。这就是全局负载均衡的概念。</li>
<li>高可用: 为了保证我们的应用高可用，往往会部署在多个机房，每个地方都会有自己的 IP 地址。当用户访问某个域名的时候，这个 IP 地址可以轮询访问多个数据中心。如果一个数据中心因为某种原因挂了，只要在 DNS 服务器里面，将这个数据中心对应的 IP 地址删除，就可以实现一定的高可用。</li>
</ul>
<h4 id="示例：DNS-访问数据中心中对象存储上的静态资源"><a href="#示例：DNS-访问数据中心中对象存储上的静态资源" class="headerlink" title="示例：DNS 访问数据中心中对象存储上的静态资源"></a>示例：DNS 访问数据中心中对象存储上的静态资源</h4><p><img src="https://static001.geekbang.org/resource/image/56/d1/569ddad1a0c5a5f60341fbe023b47cd1.jpg" alt=""></p>
<ol>
<li>当一个客户端要访问 object.yourcompany.com 的时候，需要请求本地 DNS 解析器</li>
<li>本地 DNS 解析器先查看看本地的缓存是否有这个记录。如果有则直接使用</li>
<li>缓存中没有则请求本地的 DNS 服务器</li>
<li>本地的 DNS 服务器一般部署在你的数据中心或者你所在的运营商的网络中，本地 DNS 服务器也需要看本地是否有缓存，如果有则返回。</li>
<li>本地没有则请求根 DNS 服务器，得到顶级 DNS 服务器地址</li>
<li>请求顶级 DNS 服务器，得到权威 DNS 服务器地址</li>
<li>请求权威 DNS 服务器，获取 ip</li>
</ol>
<ul>
<li>是否需要全局负载均衡的区别<ul>
<li>对于不需要做全局负载均衡的简单应用来讲，yourcompany.com 的权威 DNS 服务器可以直接将 object.yourcompany.com 这个域名解析为一个或者多个 IP 地址，然后客户端可以通过多个 IP 地址，进行简单的轮询，实现简单的负载均衡。</li>
<li>对于需要更加复杂的全局负载均衡机制的应用，需要专门的设备或者服务器来做这件事情，这就是全局负载均衡器（GSLB，Global Server Load Balance）。<blockquote>
<p>在 yourcompany.com 的 DNS 服务器中，一般是通过配置 CNAME 的方式，给 object.yourcompany.com 起一个别名，例如 object.vip.yourcomany.com，然后告诉本地 DNS 服务器，让它请求 GSLB 解析这个域名，GSLB 就可以在解析这个域名的过程中，通过自己的策略实现负载均衡。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<ol start="8">
<li>第一层 GSLB，通过查看请求它的本地 DNS 服务器所在的运营商，就知道用户所在的运营商。假设是移动，通过 CNAME 的方式，通过另一个别名 object.yd.yourcompany.com，告诉本地 DNS 服务器去请求第二层的 GSLB。</li>
<li>第二层 GSLB，通过查看请求它的本地 DNS 服务器所在的地址，就知道用户所在的地理位置，然后将距离用户位置比较近的 Region 里面，六个内部负载均衡（SLB，Server Load Balancer）的地址，返回给本地 DNS 服务器。</li>
<li>本地 DNS 服务器将结果返回给本地 DNS 解析器。</li>
<li>本地 DNS 解析器将结果缓存后，返回给客户端。</li>
<li>客户端开始访问属于相同运营商的距离较近的 Region 1 中的对象存储，当然客户端得到了六个 IP 地址，它可以通过负载均衡的方式，随机或者轮询选择一个可用区进行访问。<blockquote>
<p>对象存储一般会有三个备份，从而可以实现对存储读写的负载均衡。</p>
</blockquote>
</li>
</ol>
<hr>
<h2 id="第19讲-HTTPDNS：网络世界的地址簿也会指错路"><a href="#第19讲-HTTPDNS：网络世界的地址簿也会指错路" class="headerlink" title="第19讲 | HTTPDNS：网络世界的地址簿也会指错路"></a>第19讲 | HTTPDNS：网络世界的地址簿也会指错路</h2><h4 id="传统-DNS-存在哪些问题？"><a href="#传统-DNS-存在哪些问题？" class="headerlink" title="传统 DNS 存在哪些问题？"></a>传统 DNS 存在哪些问题？</h4><ul>
<li>域名缓存问题<ul>
<li>可能域名对应 ip 已经更换，但是本地缓存还是解析到了之前的 ip，这就导致访问了一个失效/错误的 ip</li>
<li>有的运营商会把一些静态页面，缓存到本运营商的服务器内，这样用户请求的时候，就不用跨运营商进行访问，这样既加快了速度，也减少了运营商之间流量计算的成本。在域名解析的时候，不会将用户导向真正的网站，而是指向这个缓存的服务器。但当页面更新时，缓存服务器的更新没有那么快。这就导致访问更新内容的不及时</li>
<li>本地的缓存，往往使得全局负载均衡失败，因为上次进行缓存的时候，缓存中的地址不一定是这次访问离客户最近的地方，如果把这个地址返回给客户，那肯定就会绕远路。</li>
</ul>
</li>
<li>域名转发问题<ul>
<li>可能一些 DNS 运营商将域名直接转发到其他 DNS 运营商以提供解析，比如 A 运营商转发到 B 运营商解析，权威服务器会认为你是 B 运营商的，返回给你一个在 B 运营商处建立的网站 ip 地址，这样每次访问就需要跨运营商，速度很慢。</li>
</ul>
</li>
<li>出口 NAT 问题<ul>
<li>很多机房都会配置NAT，也即网络地址转换，使得从这个网关出去的包，都换成新的 IP 地址。一旦做了网络地址的转换，权威的 DNS 服务器，就没办法通过这个地址，来判断客户到底是来自哪个运营商，而且极有可能因为转换过后的地址，误判运营商，导致跨运营商的访问。</li>
</ul>
</li>
<li>域名更新问题<ul>
<li>本地 DNS 服务器是由不同地区、不同运营商独立部署的。对域名解析缓存的处理上，实现策略也有区别，有的会偷懒，忽略域名解析结果的 TTL 时间限制，在权威 DNS 服务器解析变更的时候，解析结果在全网生效的周期非常漫长。但是有的时候，在 DNS 的切换中，场景对生效时间要求比较高。<blockquote>
<p>例如双机房部署的时候，跨机房的负载均衡和容灾多使用 DNS 来做。当一个机房出问题之后，需要修改权威 DNS，将域名指向新的 IP 地址，但是如果更新太慢，那很多用户都会出现访问异常。</p>
</blockquote>
</li>
</ul>
</li>
<li>解析延迟问题<ul>
<li>从上一节的 DNS 查询过程来看，DNS 的查询过程需要递归遍历多个 DNS 服务器，才能获得最终的解析结果，这会带来一定的时延，甚至会解析超时。</li>
</ul>
</li>
</ul>
<h4 id="HTTPDNS-的工作模式"><a href="#HTTPDNS-的工作模式" class="headerlink" title="HTTPDNS 的工作模式"></a>HTTPDNS 的工作模式</h4><p>HTTPNDS: 不走传统的 DNS 解析，而是自己搭建基于 HTTP 协议的 DNS 服务器集群，分布在多个地点和多个运营商。当客户端需要 DNS 解析的时候，直接通过 HTTP 协议进行请求这个服务器集群，得到就近的地址。</p>
<blockquote>
<p>使用 HTTPDNS 需要绕过默认的 DNS 路径，就不能使用默认的客户端。使用 HTTPDNS 的，往往是手机应用，需要在手机端嵌入支持 HTTPDNS 的客户端 SDK。</p>
</blockquote>
<ul>
<li>在客户端的 SDK 里动态请求服务端，获取 HTTPDNS 服务器的 IP 列表，缓存到本地。随着不断地解析域名，SDK 也会在本地缓存 DNS 域名解析的结果。</li>
<li>当手机应用要访问一个地址的时候，首先看是否有本地的缓存，如果有就直接返回。这个缓存和本地 DNS 的缓存不一样的是，这个是手机应用自己做的，而非整个运营商统一做的。如何更新、何时更新，手机应用的客户端可以和服务器协调来做这件事情。</li>
<li>如果本地没有，就需要请求 HTTPDNS 的服务器，在本地 HTTPDNS 服务器的 IP 列表中，选择一个发出 HTTP 的请求，会返回一个要访问的网站的 IP 列表。<ul>
<li>请求的方式是这样的。  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;106.2.xxx.xxx&#x2F;d?dn&#x3D;c.m.163.com</span><br><span class="line">&#123;&quot;dns&quot;:[&#123;&quot;host&quot;:&quot;c.m.163.com&quot;,&quot;ips&quot;:[&quot;223.252.199.12&quot;],&quot;ttl&quot;:300,&quot;http2&quot;:0&#125;],&quot;client&quot;:&#123;&quot;ip&quot;:&quot;106.2.81.50&quot;,&quot;line&quot;:269692944&#125;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>手机客户端自然知道手机在哪个运营商、哪个地址。由于是直接的 HTTP 通信，HTTPDNS 服务器能够准确知道这些信息，因而可以做精准的全局负载均衡。<br><img src="https://static001.geekbang.org/resource/image/91/00/914d44e3d9246804b1b670b216146100.jpg" alt=""></li>
</ul>
<h4 id="HTTPDNS-的缓存设计"><a href="#HTTPDNS-的缓存设计" class="headerlink" title="HTTPDNS 的缓存设计"></a>HTTPDNS 的缓存设计</h4><p>HTTPDNS 缓存设计策略分三层，即手机客户端、DNS 缓存、HTTPDNS 服务器。</p>
<ul>
<li>概述<ul>
<li>SDK 中的缓存会严格按照缓存过期时间，如果缓存没有命中，或者已经过期，而且客户端不允许使用过期的记录，则会发起一次解析，保障记录是更新的。</li>
</ul>
</li>
<li>缓存更新<ul>
<li>同步更新<ul>
<li>优点是实时性好</li>
<li>缺点是如果有多个请求都发现过期的时候，同时会请求 HTTPDNS 多次，其实是一种浪费。</li>
</ul>
</li>
<li>异步更新<ul>
<li>优点是，可以将多个请求都发现过期的情况，合并为一个对于 HTTPDNS 的请求任务，只执行一次，减少 HTTPDNS 的压力。同时可以在即将过期的时候，就创建一个任务进行预加载，防止过期之后再刷新，称为预加载。</li>
<li>缺点是当前请求拿到过期数据的时候，如果客户端允许使用过期数据，需要冒一次风险。如果过期的数据还能请求，就没问题；如果不能请求，则失败一次，等下次缓存更新后，再请求方能成功。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="HTTPDNS-的调度设计"><a href="#HTTPDNS-的调度设计" class="headerlink" title="HTTPDNS 的调度设计"></a>HTTPDNS 的调度设计</h4><p><img src="https://static001.geekbang.org/resource/image/9e/38/9edb73c0e7b369de8784376485427e38.jpg" alt=""><br>客户端</p>
<ul>
<li>可以知道手机是哪个国家、哪个运营商、哪个省，甚至哪个市，HTTPDNS 服务端可以根据这些信息，选择最佳的服务节点返回。</li>
<li>如果有多个节点，还会考虑错误率、请求时间、服务器压力、网络状况等，进行综合选择，而非仅仅考虑地理位置。当有一个节点宕机或者性能下降的时候，可以尽快进行切换。</li>
<li>客户端的 SDK 会收集网络请求数据，如错误率、请求时间等网络请求质量数据，并发送到统计后台，进行分析、聚合，以此查看不同的 IP 的服务质量。</li>
</ul>
<p>服务端</p>
<ul>
<li>应用可以通过调用 HTTPDNS 的管理接口，配置不同服务质量的优先级、权重。HTTPDNS 会根据这些策略综合地理位置和线路状况算出一个排序，优先访问当前那些优质的、时延低的 IP 地址。</li>
</ul>
<blockquote>
<p>HTTPDNS 通过智能调度之后返回的结果，也会缓存在客户端。为了不让缓存使得调度失真，客户端可以根据不同的移动网络运营商 WIFI 的 SSID 来分维度缓存。不同的运营商或者 WIFI 解析出来的结果会不同。</p>
</blockquote>
<hr>
<h2 id="第20讲-CDN：你去小卖部取过快递么？"><a href="#第20讲-CDN：你去小卖部取过快递么？" class="headerlink" title="第20讲 | CDN：你去小卖部取过快递么？"></a>第20讲 | CDN：你去小卖部取过快递么？</h2><h4 id="CDN-的分发系统的架构"><a href="#CDN-的分发系统的架构" class="headerlink" title="CDN 的分发系统的架构"></a>CDN 的分发系统的架构</h4><p><img src="https://static001.geekbang.org/resource/image/d8/cc/d8c77f59d6b7ac894b5192252239cfcc.jpg" alt=""><br>由于边缘节点数目比较多，但是每个集群规模比较小，不可能缓存下来所有东西，因而可能无法命中，这样就会在边缘节点之上。有区域节点，规模就要更大，缓存的数据会更多，命中的概率也就更大。在区域节点之上是中心节点，规模更大，缓存数据更多。如果还不命中，就只好回源网站访问了。</p>
<h4 id="客户端如何找到相应的边缘节点进行访问呢？"><a href="#客户端如何找到相应的边缘节点进行访问呢？" class="headerlink" title="客户端如何找到相应的边缘节点进行访问呢？"></a>客户端如何找到相应的边缘节点进行访问呢？</h4><p>以 baidu.com 举例</p>
<ol>
<li>baidu.com 这个权威 DNS 服务器上，会设置一个 CNAME 别名，指向另外一个域名 baidu.cdn.com，返回给本地 DNS 服务器。</li>
<li>当本地 DNS 服务器拿到这个新的域名时，需要继续解析这个新的域名。这个时候，访问的是 baidu.cdn.com 的权威 DNS 服务器，这是 CDN 自己的权威 DNS 服务器。在这个服务器上，还是会设置一个 CNAME，指向另外一个域名，也即 CDN 网络的全局负载均衡器。</li>
<li>本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名，全局负载均衡器会为用户选择一台合适的缓存服务器提供服务(返回边缘节点的 ip)，选择的依据包括：<ul>
<li>根据用户 IP 地址，判断哪一台服务器距用户最近</li>
<li>用户所处的运营商</li>
<li>根据用户所请求的 URL 中携带的内容名称，判断哪一台服务器上有用户所需的内容</li>
<li>查询各个服务器当前的负载情况，判断哪一台服务器尚有服务能力</li>
</ul>
</li>
<li>本地 DNS 服务器缓存这个 IP 地址，然后将 IP 返回给客户端，客户端去访问这个边缘节点，下载资源。</li>
<li>如果这台缓存服务器上并没有用户想要的内容，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地。</li>
</ol>
<h4 id="CDN-可以进行缓存的内容"><a href="#CDN-可以进行缓存的内容" class="headerlink" title="CDN 可以进行缓存的内容"></a>CDN 可以进行缓存的内容</h4><ul>
<li>静态资源<ul>
<li>对于静态页面来讲，内容的分发往往采取拉取的方式，也即当发现未命中的时候，再去上一级进行拉取。</li>
</ul>
</li>
<li>流媒体<ul>
<li>CDN 支持流媒体协议，例如前面讲过的 RTMP 协议。</li>
<li>流媒体数据量大，如果出现回源，压力会比较大，所以往往采取主动推送的模式，将热点数据主动推送到边缘节点。</li>
<li>对于流媒体来讲，很多 CDN 还提供预处理服务，也即文件在分发之前，经过一定的处理。例如将视频转换为不同的码流，参考我们常见的 “标清，高清，超清”</li>
</ul>
</li>
</ul>
<h4 id="CDN-防盗链"><a href="#CDN-防盗链" class="headerlink" title="CDN 防盗链"></a>CDN 防盗链</h4><ul>
<li>HTTP 头的 refer 字段， 当浏览器发送请求的时候，一般会带上 referer，告诉服务器是从哪个页面链接过来的，服务器基于此可以获得一些信息用于处理。如果 refer 信息不是来自本站，就阻止访问或者跳到其它链接。</li>
<li>时间戳防盗链: 使用 CDN 的管理员可以在配置界面上，和 CDN 厂商约定一个加密字符串。<ul>
<li>客户端取出当前的时间戳，要访问的资源及其路径，连同加密字符串进行签名算法得到一个字符串，然后生成一个下载链接，带上这个签名字符串和截止时间戳去访问 CDN。</li>
<li>服务端，根据取出过期时间，和当前 CDN 节点时间进行比较，确认请求是否过期。然后 CDN 服务端有了资源及路径，时间戳，以及约定的加密字符串，根据相同的签名算法计算签名，如果匹配则一致，访问合法，才会将资源返回给客户。</li>
</ul>
</li>
</ul>
<h4 id="动态-CDN"><a href="#动态-CDN" class="headerlink" title="动态 CDN"></a>动态 CDN</h4><ul>
<li>边缘计算的模式。数据的逻辑计算和存储，相应的放在边缘的节点。其中定时从源数据那里同步存储的数据，然后在边缘进行计算得到结果。</li>
<li>路径优化的模式。数据不是在边缘计算生成的，而是在源站生成的，但是数据的下发则可以通过 CDN 的网络，对路径进行优化。因为 CDN 节点较多，能够找到离源站很近的边缘节点，也能找到离用户很近的边缘节点。中间的链路完全由 CDN 来规划，选择一个更加可靠的路径，使用类似专线的方式进行访问。</li>
</ul>
<hr>
<h2 id="第21讲-数据中心：我是开发商，自己拿地盖别墅"><a href="#第21讲-数据中心：我是开发商，自己拿地盖别墅" class="headerlink" title="第21讲 | 数据中心：我是开发商，自己拿地盖别墅"></a>第21讲 | 数据中心：我是开发商，自己拿地盖别墅</h2><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><ul>
<li>数据中心里面是服务器。服务器被放在一个个叫作机架（Rack）的架子上面。</li>
<li>数据中心的入口和出口也是路由器，由于在数据中心的边界，称为边界路由器（Border Router）。<ul>
<li>为了高可用，边界路由器会有多个。</li>
<li>为了高可用，边界路由器会连接多个运营商网络。</li>
</ul>
</li>
<li>数据中心里面的机器访问外网，或者提供给外网访问，都可以通过 BGP 协议，获取内外互通的路由信息。这就是多线 BGP的概念。</li>
<li>数据中心里面往往有非常多的机器，当塞满一机架的时候，需要有交换机将这些服务器连接起来，可以互相通信。这些交换机往往是放在机架顶端的，所以经常称为TOR（Top Of Rack）交换机。这一层的交换机常常称为接入层（Access Layer）。</li>
<li>当一个机架放不下的时候，就需要多个机架，还需要有交换机将多个机架连接在一起。这些交换机对性能的要求更高，带宽也更大。这些交换机称为汇聚层交换机（Aggregation Layer）。<br><img src="https://static001.geekbang.org/resource/image/8f/f8/8fdfb8d4e1cd5a9a086f99b98a7555f8.jpg" alt=""></li>
<li>单台机器的高可用: 一台机器至少要有两个网卡、两个网线插到 TOR 交换机上，但是两个网卡要工作得像一张网卡一样，这就是网卡绑定（bond）。<ul>
<li>这需要服务器和交换机都支持一种协议LACP（Link Aggregation Control Protocol）。它们互相通信，将多个网卡聚合称为一个网卡，多个网线聚合成一个网线，在网线之间可以进行负载均衡。<br><img src="https://static001.geekbang.org/resource/image/84/94/84196dedd044cc135bfc28ede4687d94.jpg" alt=""></li>
</ul>
</li>
<li>机架的高可用: 部署多个 TOR、多个汇聚交换机。服务器和多个接入交换机都连接，TOR 和多个汇聚都连接<br>  <img src="https://static001.geekbang.org/resource/image/11/50/116a168c0eb55fabd7786fca728bd850.jpg" alt=""><br>  但这样需要解决交换机环路问题<ul>
<li>方法一: STP 协议，但是这样只有一条线路起作用</li>
<li>方法二: 堆叠技术，将多个交换机形成一个逻辑的交换机，服务器通过多根线分配连到多个接入层交换机上，而接入层交换机多根线分别连接到多个交换机上，并且通过堆叠的私有协议，形成双活的连接方式。<br>  <img src="https://static001.geekbang.org/resource/image/10/3a/10aa7eac3fd38dfc2a09d6475ff4d93a.jpg" alt=""></li>
</ul>
</li>
<li>汇聚层将大量的计算节点相互连接在一起，形成一个集群。在这个集群里面，服务器之间通过二层互通，这个区域常称为一个POD（Point Of Delivery），有时候也称为一个可用区（Available Zone）。</li>
<li>当节点数目再多的时候，一个可用区放不下，需要将多个可用区连在一起，连接多个可用区的交换机称为核心交换机。<br>  <img src="https://static001.geekbang.org/resource/image/08/13/080ce3bbe673de38e196b5b741a86313.jpg" alt=""></li>
<li>核心交换机的高可用: 堆叠不足以满足核心交换机的吞吐量，因而还是需要部署多组核心交换机。核心和汇聚交换机之间为了高可用，也是全互连模式的，因此还需要解决环路问题。<ul>
<li>方法一: 不同的可用区在不同的二层网络，需要分配不同的网段。汇聚和核心之间通过三层网络互通的，二层都不在一个广播域里面，不会存在二层环路的问题。三层有环是没有问题的，核心层和汇聚层之间通过内部的路由协议 OSPF，找到最佳的路径进行访问。<blockquote>
<p>但当有了云计算、大数据，集群规模非常大，而且都要求在一个二层网络里面，就需要使用方法二了。</p>
</blockquote>
</li>
<li>方法二: 二层互连从汇聚层上升为核心层，也即在核心以下，全部是二层互连，全部在一个广播域里面，这就是常说的大二层。<br>  <img src="https://static001.geekbang.org/resource/image/2a/2c/2aa3787c31c52defc7614c53f0a71d2c.jpg" alt=""><ul>
<li>这里引入 TRILL（Transparent Interconnection of Lots of Link），即多链接透明互联协议解决问题。它的基本思想是，二层环有问题，三层环没有问题，那就把三层的路由能力模拟在二层实现。</li>
<li>运行 TRILL 协议的交换机称为RBridge，是具有路由转发特性的网桥设备，只不过这个路由是根据 MAC 地址来的，不是根据 IP 来的。Rbridage 之间通过链路状态协议运作。</li>
<li>TRILL 协议在原来的 MAC 头外面加上自己的头，以及外层的 MAC 头。TRILL 头里面的 Ingress RBridge，有点像 IP 头里面的源 IP 地址，Egress RBridge 是目标 IP 地址，这两个地址是端到端的，在中间路由的时候，不会发生改变。而外层的 MAC，可以有下一跳的 Bridge，就像路由的下一跳，也是通过 MAC 地址来呈现的一样。<blockquote>
<p>这个过程和 IP 路由很像</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li>在核心交换机上面，往往会挂一些安全设备，例如入侵检测、DDoS 防护等等。这是整个数据中心的屏障，防止来自外来的攻击。核心交换机上往往还有负载均衡器。有的数据中心里面，对于存储设备，还会有一个存储网络，最终整个数据中心的网络如下图所示。<br>  <img src="https://static001.geekbang.org/resource/image/90/eb/9002b47ad5dc7762faf37e60250211eb.jpg" alt=""><br>  这是一个典型的三层网络结构，即接入层、汇聚层、核心层三层。</li>
<li>数据中心流量类型<ul>
<li>南北流量: 这种模式非常有利于外部流量请求到内部应用。对应到上面那张图里，就是上下流通，所以称为南北流量。</li>
<li>东西流量: 大数据计算经常要在不同的节点将数据拷贝来拷贝去，这样需要经过交换机，使得数据从左右流通，所以称为东西流量。  </li>
</ul>
</li>
<li>叶脊网络（Spine/Leaf）: 为了解决东西流量的问题而演进出的网络。传统的三层网络架构是垂直的结构，而叶脊网络架构是扁平的结构，更易于水平扩展。<br>  <img src="https://static001.geekbang.org/resource/image/99/92/99f86d113a629d81bb52786d80ca5c92.jpg" alt=""><ul>
<li>叶子交换机（leaf），直接连接物理服务器。L2/L3 网络的分界点在叶子交换机上，叶子交换机之上是三层网络。</li>
<li>脊交换机（spine switch），相当于核心交换机。叶脊之间通过 ECMP 动态选择多条路径。脊交换机现在只是为叶子交换机提供一个弹性的 L3 路由网络。南北流量可以不用直接从脊交换机发出，而是通过与 leaf 交换机并行的交换机，再接到边界路由器出去。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第22讲-VPN：朝中有人好做官"><a href="#第22讲-VPN：朝中有人好做官" class="headerlink" title="第22讲 | VPN：朝中有人好做官"></a>第22讲 | VPN：朝中有人好做官</h2><p>将多个多个数据中心连接起来的方法</p>
<ul>
<li>走公网，但是公网太不安全，隐私可能会被别人偷窥</li>
<li>租用专线的方式把它们连起来，但需要花很多钱</li>
<li>用 VPN 来连接，这种方法比较折中，安全又不贵</li>
</ul>
<p>VPN，全名Virtual Private Network，虚拟专用网，就是利用开放的公众网络，建立专用数据传输通道，将远程的分支机构、移动办公人员等连接起来。</p>
<h4 id="VPN-是如何工作的？"><a href="#VPN-是如何工作的？" class="headerlink" title="VPN 是如何工作的？"></a>VPN 是如何工作的？</h4><p>VPN 通过隧道技术在公众网络上仿真一条点到点的专线，是通过利用一种协议来传输另外一种协议的技术，这里面涉及三种协议</p>
<ul>
<li>乘客协议</li>
<li>隧道协议</li>
<li>承载协议</li>
</ul>
<h4 id="IPsec"><a href="#IPsec" class="headerlink" title="IPsec"></a>IPsec</h4><p>IPsec 是基于 IP 协议的安全隧道协议，为了保证在公网上面信息的安全，因而采取了一定的机制保证安全性。<br><img src="https://static001.geekbang.org/resource/image/a7/f1/a7c0a7fd2334d7145d093cf24bc6d7f1.jpg" alt=""></p>
<ul>
<li>私密性，防止信息泄漏给未经授权的个人，通过加密把数据从明文变成无法读懂的密文，从而确保数据的私密性。<blockquote>
<p>这里使用的是对称加密，其中秘钥的传输使用了 IKE 协议，即 Internet Key Exchange，因特网密钥交换协议。</p>
</blockquote>
</li>
<li>完整性，数据没有被非法篡改，通过对数据进行 hash 运算，产生类似于指纹的数据摘要，以保证数据的完整性。</li>
<li>真实性，数据确实是由特定的对端发出，通过身份认证可以保证数据的真实性。<ul>
<li>方法一: 通过预共享密钥来确保真实性</li>
<li>方法二: 用数字签名来验证。使用私钥进行签名，私钥只有我自己有，所以如果对方能用我的数字证书里面的公钥解开，就说明我是我</li>
</ul>
</li>
</ul>
<h4 id="IPsec-VPN-的协议簇"><a href="#IPsec-VPN-的协议簇" class="headerlink" title="IPsec VPN 的协议簇"></a>IPsec VPN 的协议簇</h4><p>基于以上三个特性（私密性，完整性，真实性），组成了IPsec VPN 的协议簇。<br><img src="https://static001.geekbang.org/resource/image/34/af/34a952bd1abeec19460b8d5dca5cd0af.jpg" alt=""></p>
<ul>
<li>两种协议<ul>
<li>AH（Authentication Header），只能进行数据摘要，不能实现数据加密</li>
<li>ESP（Encapsulating Security Payload），能够进行数据加密和数据摘要</li>
</ul>
</li>
<li>两种算法<ul>
<li>加密算法</li>
<li>摘要算法</li>
</ul>
</li>
<li>两大组件<ul>
<li>VPN 的双方要进行对称密钥的交换的 IKE 组件</li>
<li>VPN 的双方要对连接进行维护的 SA（Security Association）组件</li>
</ul>
</li>
</ul>
<h4 id="IPsec-VPN-的建立过程"><a href="#IPsec-VPN-的建立过程" class="headerlink" title="IPsec VPN 的建立过程"></a>IPsec VPN 的建立过程</h4><ol>
<li>建立 IKE 自己的 SA。这个 SA 用来维护一个通过身份认证和安全保护的通道，为第二个阶段提供服务。在这个阶段，通过 DH（Diffie-Hellman）算法计算出一个对称密钥 K。<br> <img src="https://static001.geekbang.org/resource/image/28/78/28a3938ab8efaf9fa7f313a46d0e1478.jpg" alt=""><blockquote>
<p>可以看出，这里巧妙的利用了一些数学原理，使得客户端，服务端双方都能计算出对称密钥 K，但中间拦截者因为没有 a,b 的数值，无法计算出 K。</p>
</blockquote>
</li>
<li>建立 IPsec SA。在这个 SA 里面，双方会生成一个随机的对称密钥 M，由 K 加密传给对方，然后使用 M 进行双方接下来通信的数据。对称密钥 M 是有过期时间的，会过一段时间，重新生成一次，从而防止被破解。IPsec SA 中包含如下内容：<br> <img src="https://static001.geekbang.org/resource/image/87/59/87a34817f22ed4a2afb58e8f6496f159.jpg" alt=""><ul>
<li>SPI（Security Parameter Index），用于标识不同的连接</li>
<li>双方商量好的加密算法、哈希算法和封装模式</li>
<li>生存周期，超过这个周期，就需要重新生成一个 IPsec SA，重新生成对称密钥</li>
</ul>
</li>
<li>打包封装传输<br> <img src="https://static001.geekbang.org/resource/image/71/ca/71fa17f5bb21c12aec1234eec85a6dca.jpg" alt=""><ul>
<li>ESP 要对 IP 包进行封装，因而 IP 头里面的上一层协议为 ESP。在 ESP 的正文里面，ESP 的头部有双方商讨好的 SPI，以及这次传输的序列号。</li>
<li>接下来全部是加密的内容。可以通过对称密钥进行解密，解密后在正文的最后，指明了里面的协议是什么。如果是 IP，则需要先解析 IP 头，然后解析 TCP 头，这是从隧道出来后解封装的过程。<br><img src="https://static001.geekbang.org/resource/image/df/b5/dfc5a7934added3cc11d9c95a69a9bb5.jpg" alt=""></li>
</ul>
</li>
</ol>
<h4 id="ATM"><a href="#ATM" class="headerlink" title="ATM"></a>ATM</h4><p>ATM 是与 IP 同一层的协议，与 IP 不同的是，ATM 是面向连接的。</p>
<p>IP 与 ATM 的对比：</p>
<ul>
<li>IP<ul>
<li>IP 基于 TCP 来保证重试成功，TCP 虽然是面向连接的，但是与 IP 不处于同一层，IP 层还是不面向连接的。</li>
<li>优势: 包可以选择不同的道路，一条道路崩溃时，可以选择其他道路，保证到达</li>
<li>劣势: 不断的路由查找，效率比较差</li>
</ul>
</li>
<li>ATM<ul>
<li>ATM 在传输之前先建立一个连接，形成一个虚拟的通路，一旦连接建立了，所有的包都按照相同的路径走。</li>
<li>优势: 不许查找路由，虚拟路径已经建立，打上了标签，传输效率更高</li>
<li>劣势: 一旦道路断了，则连接直接崩溃，后续所有的包都无法达到</li>
</ul>
</li>
</ul>
<h4 id="多协议标签交换（MPLS，Multi-Protocol-Label-Switching）"><a href="#多协议标签交换（MPLS，Multi-Protocol-Label-Switching）" class="headerlink" title="多协议标签交换（MPLS，Multi-Protocol Label Switching）"></a>多协议标签交换（MPLS，Multi-Protocol Label Switching）</h4><p>MPLS 结合了 IP 与 ATM 两者的优势，既保证了达到，又有较高的传输效率。</p>
<ul>
<li>MPLS 的格式如图所示，在原始的 IP 头之外，多了 MPLS 的头，里面可以打标签。<br>  <img src="https://static001.geekbang.org/resource/image/ab/32/ab77ad0cec6a26f43bacb3f51b0c8d32.jpg" alt=""><ul>
<li>在二层头里面，有类型字段，0x0800 表示 IP，0x8847 表示 MPLS Label。</li>
<li>在 MPLS 头里面，首先是标签值占 20 位，接着是 3 位实验位，再接下来是 1 位栈底标志位，表示当前标签是否位于栈底了。这样就允许多个标签被编码到同一个数据包中，形成标签栈。最后是 8 位 TTL 存活时间字段，0 即代表过期。</li>
</ul>
</li>
<li>标签交换路由器（LSR，Label Switching Router）: 能认这个标签，并且能够根据这个标签转发的路由器<br>  <img src="https://static001.geekbang.org/resource/image/78/ee/782742e09ddddcef169c9982b65c69ee.jpg" alt=""><ul>
<li>这种路由器会有两个表格，一个就是传统的 FIB，也即路由表，另一个就是 LFIB，标签转发表。有了这两个表，既可以进行普通的路由转发，也可以进行基于标签的转发。</li>
<li>在 MPLS 区域中间，使用标签进行转发，非 MPLS 区域，使用普通路由转发。</li>
<li>在边缘节点上，需要有能力将对于普通路由的转发，变成对于标签的转发。</li>
<li>这样一个通过标签转换而建立的路径称为 LSP，标签交换路径。在一条 LSP 上，沿数据包传送的方向，相邻的 LSR 分别叫上游 LSR（upstream LSR）和下游 LSR（downstream LSR）。</li>
</ul>
</li>
<li>LDP（Label Distribution Protocol），一个动态的生成标签的协议。<br>  <img src="https://static001.geekbang.org/resource/image/94/84/947e2fece5e3b2750b0b73c9458f3784.jpg" alt=""><ul>
<li>如果有一个边缘节点发现自己的路由表中出现了新的目的地址，同时此边缘节点存在上游 LSR，上游 LSR 尚有可供分配的标签，则边缘节点为新的路径分配标签，并向上游发出标签映射消息，其中包含分配的标签等信息。</li>
<li>收到标签映射消息的 LSR 记录相应的标签映射信息，在其标签转发表中增加相应的条目。之后继续按照上述规则向上游 LSR 分配标签。</li>
<li>当入口 LSR 收到标签映射消息时，在标签转发表中增加相应的条目。这时，就完成了 LSP 的建立。</li>
</ul>
</li>
</ul>
<h4 id="MPLS-VPN"><a href="#MPLS-VPN" class="headerlink" title="MPLS VPN"></a>MPLS VPN</h4><p>在 MPLS VPN 中，网络中的路由器分成以下几类：<br><img src="https://static001.geekbang.org/resource/image/ba/ec/bae67c4e3f4a4127bad07de4bb577bec.jpg" alt=""></p>
<ul>
<li>PE（Provider Edge）：运营商网络与客户网络相连的边缘网络设备</li>
<li>CE（Customer Edge）：客户网络与 PE 相连接的边缘设备</li>
<li>P（Provider）：这里特指运营商网络中除 PE 之外的其他运营商网络设备</li>
</ul>
<p>两个问题与解决方案</p>
<ul>
<li>传统 BGP 无法正确处理地址空间重叠的 VPN 的路由。<blockquote>
<p>如上图，假设机构 A 和机构 B 都使用了 192.168.101.0/24 网段的地址，并各自发布了一条去往此网段的路由，BGP 将只会选择其中一条路由，从而导致去往另一个 VPN 的路由丢失。</p>
</blockquote>
<ul>
<li>PE 路由器之间使用特殊的 MP-BGP 来发布 VPN 路由，在相互沟通的消息中，在一般 32 位 IPv4 的地址之前加上一个客户标示的区分符用于客户地址的区分，这种称为 VPN-IPv4 地址族。</li>
</ul>
</li>
<li>路由表无法处理网段重叠的地址，当两个客户的 IP 包到达 PE 的时候，PE 就困惑了，因为网段是重复的。<ul>
<li>在 PE 上，可以通过 VRF（VPN Routing&amp;Forwarding Instance）建立每个客户一个路由表，与其它 VPN 客户路由和普通路由相互区分。</li>
</ul>
</li>
</ul>
<p>远端 PE 通过 MP-BGP 协议把业务路由放到近端 PE，近端 PE 根据不同的客户选择出相关客户的业务路由放到相应的 VRF 路由表中。因此，VPN 报文转发采用两层标签方式：</p>
<ul>
<li>第一层（外层）标签在骨干网内部进行交换，指示从 PE 到对端 PE 的一条 LSP。VPN 报文利用这层标签，可以沿 LSP 到达对端 PE。</li>
<li>第二层（内层）标签在从对端 PE 到达 CE 时使用，在 PE 上，通过查找 VRF 表项，指示报文应被送到哪个 VPN 用户，或者更具体一些，到达哪一个 CE。这样，对端 PE 根据内层标签可以找到转发报文的接口。</li>
</ul>
<h4 id="MPLS-VPN-发包过程"><a href="#MPLS-VPN-发包过程" class="headerlink" title="MPLS VPN 发包过程"></a>MPLS VPN 发包过程</h4><p><img src="https://static001.geekbang.org/resource/image/3c/dd/3cd18d212bf76e7151ea73aa65ef48dd.jpg" alt=""></p>
<ol>
<li>机构 A 和机构 B 都发出一个目的地址为 192.168.101.0/24 的 IP 报文，分别由各自的 CE 将报文发送至 PE。</li>
<li>PE 会根据报文到达的接口及目的地址查找 VPN 实例表项 VRF，匹配后将报文转发出去，同时打上内层和外层两个标签。假设通过 MP-BGP 配置的路由，两个报文在骨干网走相同的路径。</li>
<li>MPLS 网络利用报文的外层标签，将报文传送到出口 PE，报文在到达出口 PE 2 前一跳时已经被剥离外层标签，仅含内层标签。</li>
<li>出口 PE 根据内层标签和目的地址查找 VPN 实例表项 VRF，确定报文的出接口，将报文转发至各自的 CE。</li>
<li>CE 根据正常的 IP 转发过程将报文传送到目的地。</li>
</ol>
<hr>
<h2 id="第23讲-移动网络：去巴塞罗那，手机也上不了脸书"><a href="#第23讲-移动网络：去巴塞罗那，手机也上不了脸书" class="headerlink" title="第23讲 | 移动网络：去巴塞罗那，手机也上不了脸书"></a>第23讲 | 移动网络：去巴塞罗那，手机也上不了脸书</h2><h4 id="2G-网络"><a href="#2G-网络" class="headerlink" title="2G 网络"></a>2G 网络</h4><p><img src="https://static001.geekbang.org/resource/image/c0/e2/c065c4f15421c7fd9924c472948aa8e2.jpg" alt=""></p>
<ol>
<li>在 2G 时代，上网使用的不是 IP 网络，而是电话网络，走模拟信号，专业名称为公共交换电话网（PSTN，Public Switched Telephone Network）。</li>
<li>手机是通过收发无线信号来通信的，专业名称是 Mobile Station，简称 MS，需要嵌入 SIM。手机是客户端，而无线信号的服务端，就是基站子系统（BSS，Base Station SubsystemBSS）。</li>
<li>基站子系统分两部分，一部分对外提供无线通信，叫作基站收发信台（BTS，Base Transceiver Station），另一部分对内连接有线网络，叫作基站控制器（BSC，Base Station Controller）。基站收发信台通过无线收到数据后，转发给基站控制器。<blockquote>
<p>2,3 两部分属于无线的部分，统称为无线接入网（RAN，Radio Access Network）。</p>
</blockquote>
</li>
<li>基站控制器通过有线网络，连接到提供手机业务的运营商的数据中心，这部分称为核心网（CN，Core Network）。</li>
<li>基站数据的首先进入移动业务交换中心（MSC，Mobile Service Switching Center），它是进入核心网的入口，但是它不会让你直接连接到互联网上。<ul>
<li>在让你的手机真正进入互联网之前，提供手机业务的运营商，需要认证是不是合法的手机接入。鉴权中心（AUC，Authentication Center）和设备识别寄存器（EIR，Equipment Identity Register）主要是负责安全性的。</li>
<li>需要看你是本地的号，还是外地的号，这个牵扯到计费的问题。访问位置寄存器（VLR，Visit Location Register）是看你目前在的地方，归属位置寄存器（HLR，Home Location Register）是看你的号码归属地。</li>
</ul>
</li>
<li>当你的手机卡既合法又有钱的时候，才允许你上网，这个时候需要一个网关，连接核心网和真正的互联网。网关移动交换中心（GMSC ，Gateway Mobile Switching Center）就是干这个的，然后是真正的互连网。在 2G 时代，还是电话网络 PSTN。<blockquote>
<p>数据中心里面的这些模块统称为网络子系统（NSS，Network and Switching Subsystem）。</p>
</blockquote>
</li>
</ol>
<p>2G 时代总结：</p>
<ul>
<li>手机通过无线信号连接基站；</li>
<li>基站一面朝前接无线，一面朝后接核心网；</li>
<li>核心网一面朝前接到基站请求，一是判断你是否合法，二是判断你是不是本地号，还有没有钱，一面通过网关连接电话网络。</li>
</ul>
<h4 id="2-5G-网络"><a href="#2-5G-网络" class="headerlink" title="2.5G 网络"></a>2.5G 网络</h4><p><img src="https://static001.geekbang.org/resource/image/39/90/39fa17696761d28f2f04c8555041aa90.jpg" alt=""><br>在原来 2G 电路交换的基础上，加入了分组交换业务，支持 Packet 的转发，从而支持 IP 网络。</p>
<ul>
<li>在上述网络的基础上，基站一面朝前接无线，一面朝后接核心网。在朝后的组件中，多了一个分组控制单元（PCU，Packet Control Unit），用以提供分组交换通道。</li>
<li>在核心网里面，有个朝前的接待员（SGSN，Service GPRS Supported Node）和朝后连接 IP 网络的网关型 GPRS 支持节点（GGSN，Gateway GPRS Supported Node）。</li>
</ul>
<h4 id="3G-网络"><a href="#3G-网络" class="headerlink" title="3G 网络"></a>3G 网络</h4><p><img src="https://static001.geekbang.org/resource/image/94/18/9453ee22b697455ba3f2c4f89936b018.jpg" alt=""><br>3G 时代，主要是无线通信技术有了改进，大大增加了无线的带宽。</p>
<ul>
<li>以 W-CDMA 为例，理论最高 2M 的下行速度，因而基站改变了。一面朝外的是 Node B，一面朝内连接核心网的是无线网络控制器（RNC，Radio Network Controller）。</li>
<li>核心网以及连接的 IP 网络没有什么变化。</li>
</ul>
<h4 id="4G-网络"><a href="#4G-网络" class="headerlink" title="4G 网络"></a>4G 网络</h4><ul>
<li>基站为 eNodeB，包含了原来 Node B 和 RNC 的功能，下行速度向百兆级别迈进。</li>
<li>核心网实现了控制面和数据面的分离<ul>
<li>HSS 用于存储用户签约信息的数据库，其实就是你这个号码归属地是哪里的，以及一些认证信息。</li>
<li>MME 是核心控制网元，是控制面的核心，当手机通过 eNodeB 连上的时候，MME 会根据 HSS 的信息，判断你是否合法。如果允许连上来，MME 不负责具体的数据的流量，而是 MME 会选择数据面的 SGW 和 PGW，然后告诉 eNodeB 允许设备连接。</li>
<li>之后手机直接通过 eNodeB 连接 SGW，连上核心网，SGW 相当于数据面的接待员，并通过 PGW 连到 IP 网络。PGW 就是出口网关。在出口网关，有一个组件 PCRF，称为策略和计费控制单元，用来控制上网策略和流量的计费。<blockquote>
<p>在前面的核心网里面，有接待员 MSC 或者 SGSN，你会发现检查是否合法是它负责，转发数据也是它负责，也即控制面和数据面是合二为一的，这样灵活性比较差，因为控制面主要是指令，多是小包，往往需要高的及时性；数据面主要是流量，多是大包，往往需要吞吐量。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="4G-网络协议解析"><a href="#4G-网络协议解析" class="headerlink" title="4G 网络协议解析"></a>4G 网络协议解析</h4><p><img src="https://static001.geekbang.org/resource/image/e4/50/e40f7cb5754e01ed82ae120d8d571f50.jpg" alt=""></p>
<p>控制面协议（上图中虚线部分是控制面的协议）</p>
<ul>
<li>当一个手机想上网的时候，先要连接 eNodeB，并通过 S1-MME 接口，请求 MME 对这个手机进行认证和鉴权。</li>
<li>eNodeB 和 MME 之间的连接就是很正常的 IP 网络，但在传输层使用的是 SCTP 协议。<ul>
<li>SCTP 继承了 TCP 较为完善的拥塞控制并改进 TCP 的一些不足之处。</li>
<li>SCTP 的第一个特点是多宿主，一台机器可以有多个网卡。SCTP 引入了联合（association）的概念，将多个接口、多条路径放到一个联合中来。当检测到一条路径失效时，协议就会通过另外一条路径来发送通信数据。<blockquote>
<p>TCP 虽然服务端可以监听 0.0.0.0，也就是从哪个网卡来的连接都能接受，但是一旦建立了连接，就建立了四元组，也就选定了某个网卡。</p>
</blockquote>
</li>
<li>SCTP 的第二个特点是将一个联合分成多个流。一个联合中的所有流都是独立的，但均与该联合相关。每个流都给定了一个流编号，它被编码到 SCTP 报文中，通过联合在网络上传送。SCTP 的多个流不会相互阻塞。</li>
<li>SCTP 的第三个特点是四次握手，防止 SYN 攻击。<blockquote>
<p>在 TCP 中是三次握手，当服务端收到客户的 SYN 之后，返回一个 SYN-ACK 之前，就建立数据结构，并记录下状态，等待客户端发送 ACK 的 ACK。当恶意客户端使用虚假的源地址来伪造大量 SYN 报文时，服务端需要分配大量的资源，最终耗尽资源，无法处理新的请求。<br>SCTP 可以通过四次握手引入 Cookie 的概念，来有效地防止这种攻击的产生。在 SCTP 中，客户机使用一个 INIT 报文发起一个连接。服务器使用一个 INIT-ACK 报文进行响应，其中就包括了 Cookie。然后客户端就使用一个 COOKIE-ECHO 报文进行响应，其中包含了服务器所发送的 Cookie。这个时候，服务器为这个连接分配资源，并通过向客户机发送一个 COOKIE-ACK 报文对其进行响应。</p>
</blockquote>
</li>
<li>SCTP 的第四个特点是将消息分帧。SCTP 借鉴了 UDP 的机制，在数据传输中提供了消息分帧功能。当一端对一个套接字执行写操作时，可确保对等端读出的数据大小与此相同。<blockquote>
<p>TCP 是面向流的，也即发送的数据没头没尾，没有明显的界限。这对于发送一个个消息类型的数据会不太方便。有可能客户端写入 10 个字节，然后再写入 20 个字节。二服务端读入 25 个字节，再读入 5 个字节，需要业务层去组合成消息。</p>
</blockquote>
</li>
<li>SCTP 的第五个特点是断开连接是三次挥手。在 TCP 里面，断开连接是四次挥手，允许另一端处于半关闭的状态。SCTP 选择放弃这种状态，当一端关闭自己的套接字时，对等的两端全部需要关闭，将来任何一端都不允许再进行数据的移动了。</li>
</ul>
</li>
<li>MME 通过认证鉴权后，需要建立一个数据面的数据通路。建立通路的过程还是控制面的事情，使用的是控制面的协议 GTP-C。<blockquote>
<p>建设的数据通路分两段路，其实是两个隧道。一段是从 eNodeB 到 SGW，这个数据通路由 MME 通过 S1-MME 协议告诉 eNodeB，它是隧道的一端，通过 S11 告诉 SGW，它是隧道的另一端。第二端是从 SGW 到 PGW，SGW 通过 S11 协议知道自己是其中一端，并主动通过 S5 协议，告诉 PGW 它是隧道的另一端。</p>
</blockquote>
<ul>
<li>GTP-C 协议是基于 UDP 的。如果看 GTP 头，我们可以看到，这里面有隧道的 ID，还有序列号。</li>
<li>通过序列号，不用 TCP，GTP-C 自己就可以实现可靠性，为每个输出信令消息分配一个依次递增的序列号，以确保信令消息的按序传递，并便于检测重复包。对于每个输出信令消息启动定时器，在定时器超时前未接收到响应消息则进行重发。</li>
</ul>
</li>
</ul>
<p>数据面协议<br><img src="https://static001.geekbang.org/resource/image/03/29/0397a72d0c5d76d4e3591cbe61eef729.jpg" alt=""></p>
<ul>
<li>当两个隧道都打通，接在一起的时候，PGW 会给手机分配一个 IP 地址，这个 IP 地址是隧道内部的 IP 地址，可以类比为 IPsec 协议里面的 IP 地址。这个 IP 地址是归手机运营商管理的。</li>
<li>手机使用这个 IP 地址，连接 eNodeB，从 eNodeB 经过 S1-U 协议，通过第一段隧道到达 SGW，再从 SGW 经过 S8 协议，通过第二段隧道到达 PGW，然后通过 PGW 连接到互联网。</li>
<li>数据面都是通过 GTP-U 隧道协议封装起来，其格式如下<br>  <img src="https://static001.geekbang.org/resource/image/84/32/84c128c408ac748f1206b9b4d4500132.jpg" alt=""><ul>
<li>乘客协议: 数据是手机发出来的包，IP 是手机的 IP</li>
<li>隧道协议: 隧道协议里面有隧道 ID，不同的手机上线会建立不同的隧道，因而需要隧道 ID 来标识</li>
<li>承载协议: 承载协议的 IP 地址是 SGW 和 PGW 的 IP 地址</li>
</ul>
</li>
</ul>
<h4 id="手机上网流程"><a href="#手机上网流程" class="headerlink" title="手机上网流程"></a>手机上网流程</h4><p>一个手机开机之后上网的过程称为Attach。<br><img src="https://static001.geekbang.org/resource/image/4d/d2/4d3e9282b00410a28e77f91f9375f4d2.jpg" alt=""></p>
<ol>
<li>手机开机以后，在附近寻找基站 eNodeB，找到后给 eNodeB 发送 Attach Request，说“我来啦，我要上网”。</li>
<li>eNodeB 将请求发给 MME，说“有个手机要上网”。</li>
<li>MME 去请求手机，一是认证，二是鉴权，还会请求 HSS 看看有没有钱，看看是在哪里上网。</li>
<li>当 MME 通过了手机的认证之后，开始分配隧道，先告诉 SGW，说要创建一个会话（Create Session）。在这里面，会给 SGW 分配一个隧道 ID t1，并且请求 SGW 给自己也分配一个隧道 ID。</li>
<li>SGW 转头向 PGW 请求建立一个会话，为 PGW 的控制面分配一个隧道 ID t2，也给 PGW 的数据面分配一个隧道 ID t3，并且请求 PGW 给自己的控制面和数据面分配隧道 ID。</li>
<li>PGW 回复 SGW 说“创建会话成功”，使用自己的控制面隧道 ID t2，回复里面携带着给 SGW 控制面分配的隧道 ID t4 和控制面的隧道 ID t5，至此 SGW 和 PGW 直接的隧道建设完成。双方请求对方，都要带着对方给自己分配的隧道 ID，从而标志是这个手机的请求。</li>
<li>接下来 SGW 回复 MME 说“创建会话成功”，使用自己的隧道 ID t1 访问 MME，回复里面有给 MME 分配隧道 ID t6，也有 SGW 给 eNodeB 分配的隧道 ID t7。</li>
<li>当 MME 发现后面的隧道都建设成功之后，就告诉 eNodeB，“后面的隧道已经建设完毕，SGW 给你分配的隧道 ID 是 t7，你可以开始连上来了，但是你也要给 SGW 分配一个隧道 ID”。</li>
<li>eNodeB 告诉 MME 自己给 SGW 分配一个隧道，ID 为 t8。</li>
<li>MME 将 eNodeB 给 SGW 分配的隧道 ID t8 告知 SGW，从而前面的隧道也建设完毕。</li>
</ol>
<h4 id="异地上网问题"><a href="#异地上网问题" class="headerlink" title="异地上网问题"></a>异地上网问题</h4><ul>
<li>如果你在巴塞罗那，周围搜寻到的肯定是巴塞罗那的 eNodeB。</li>
<li>通过 MME 去查寻国内运营商的 HSS，看你是否合法，是否还有钱。</li>
<li>如果允许上网，你的手机和巴塞罗那的 SGW 会建立一个隧道，然后巴塞罗那的 SGW 和国内运营商的 PGW 建立一个隧道，然后通过国内运营商的 PGW 上网。</li>
<li>判断你是否能上网的在国内运营商的 HSS，控制你上网策略的是国内运营商的 PCRF，给手机分配的 IP 地址也是国内运营商的 PGW 负责的，给手机分配的 IP 地址也是国内运营商里统计的。</li>
<li>运营商由于是在 PGW 里面统计的，这样你的上网流量全部通过国内运营商即可，只不过巴塞罗那运营商也要和国内运营商进行流量结算。<blockquote>
<p>综上，因此需要分 SGW 和 PGW 两个 GW。</p>
<p>由于你的上网策略是由国内运营商在 PCRF 中控制的，因而你还是上不了脸书。</p>
</blockquote>
</li>
</ul>
<hr>
<h2 id="第24讲-云中网络：自己拿地成本高，购买公寓更灵活"><a href="#第24讲-云中网络：自己拿地成本高，购买公寓更灵活" class="headerlink" title="第24讲 | 云中网络：自己拿地成本高，购买公寓更灵活"></a>第24讲 | 云中网络：自己拿地成本高，购买公寓更灵活</h2><h4 id="传统数据中心的问题"><a href="#传统数据中心的问题" class="headerlink" title="传统数据中心的问题"></a>传统数据中心的问题</h4><ul>
<li>采购不灵活：如果客户需要一台电脑，那就需要自己采购、上架、插网线、安装操作系统，周期非常长。一旦采购了，一用就 N 年，不能退货，哪怕业务不做了，机器还在数据中心里留着。</li>
<li>运维不灵活：一旦需要扩容 CPU、内存、硬盘，都需要去机房手动弄，非常麻烦。</li>
<li>规格不灵活：采购的机器往往动不动几百 G 的内存，而每个应用往往可能只需要 4 核 8G，所以很多应用混合部署在上面，端口各种冲突，容易相互影响。</li>
<li>复用不灵活：一台机器，一旦一个用户不用了，给另外一个用户，那就需要重装操作系统。因为原来的操作系统可能遗留很多数据，非常麻烦。</li>
</ul>
<h4 id="从物理机到虚拟机"><a href="#从物理机到虚拟机" class="headerlink" title="从物理机到虚拟机"></a>从物理机到虚拟机</h4><p>为了解决上述这些问题，人们发明了一种叫虚拟机的东西，并基于它产生了云计算技术。</p>
<ul>
<li>个人桌面系统有一些虚拟机软件，可以方便的创建虚拟机</li>
<li>在数据中心中，有一种类似的开源技术 qemu-kvm，能让你在一台巨大的物理机里，掏出一台台小小的虚拟机，它用的是软件模拟硬件的方式。</li>
</ul>
<h4 id="虚拟网卡的原理"><a href="#虚拟网卡的原理" class="headerlink" title="虚拟网卡的原理"></a>虚拟网卡的原理</h4><p><img src="https://static001.geekbang.org/resource/image/9a/7e/9a257afaa9c8a158a5a99e2df00dcf7e.jpg" alt=""><br>虚拟机要有一张网卡。对于 qemu-kvm 来说，这是通过 Linux 上的一种 TUN/TAP 技术来实现的。</p>
<ol>
<li>虚拟机软件打开一个称为 TUN/TAP 的 Char Dev（字符设备文件）。打开了这个字符设备文件之后，在物理机上就能看到一张虚拟 TAP 网卡。</li>
<li>虚拟化软件会将打开的这个文件，在虚拟机里面虚拟出一张网卡，让虚拟机里面的应用觉得它们真有一张网卡。于是，所有的网络包都往这里发。</li>
<li>网络包会到虚拟化软件这里，它会将网络包转换成为文件流，写入字符设备。</li>
<li>内核中 TUN/TAP 字符设备驱动会收到这个写入的文件流，交给 TUN/TAP 的虚拟网卡驱动。</li>
<li>虚拟网卡驱动将文件流再次转成网络包，交给 TCP/IP 协议栈，最终从虚拟 TAP 网卡发出来，成为标准的网络包。至此，网络包就从虚拟机里面发到了虚拟机外面。</li>
</ol>
<h4 id="虚拟网卡连接到数据中心（云中），需要注意的问题"><a href="#虚拟网卡连接到数据中心（云中），需要注意的问题" class="headerlink" title="虚拟网卡连接到数据中心（云中），需要注意的问题"></a>虚拟网卡连接到数据中心（云中），需要注意的问题</h4><ul>
<li>共享<ul>
<li>尽管每个虚拟机都会有一个或者多个虚拟网卡，但是物理机上可能只有有限的网卡。那这么多虚拟网卡如何共享同一个出口？</li>
</ul>
</li>
<li>隔离<ul>
<li>安全隔离，两个虚拟机可能属于两个用户，那怎么保证一个用户的数据不被另一个用户窃听？</li>
<li>流量隔离，两个虚拟机，如果有一个疯狂下片，会不会导致另外一个上不了网？</li>
</ul>
</li>
<li>互通<ul>
<li>如果同一台机器上的两个虚拟机，属于同一个用户的话，这两个如何相互通信？</li>
<li>如果不同物理机上的两个虚拟机，属于同一个用户的话，这两个如何相互通信？</li>
</ul>
</li>
<li>灵活<ul>
<li>虚拟机和物理不同，会经常创建、删除，从一个机器漂移到另一台机器，有的互通、有的不通等等，灵活性比物理网络要好得多，需要能够灵活配置。</li>
</ul>
</li>
</ul>
<h4 id="共享与互通问题"><a href="#共享与互通问题" class="headerlink" title="共享与互通问题"></a>共享与互通问题</h4><ul>
<li>通过虚拟交换机连接虚拟交换机。在 Linux 上有一个命令叫作 brctl，可以创建虚拟的网桥 brctl addbr br0。将两个虚拟机的虚拟网卡，都连接到虚拟网桥 brctl addif br0 tap0 上，再将两个虚拟机配置相同的子网网段，两台虚拟机就能够相互通信了。</li>
<li>虚拟机网络访问外部的方式<ul>
<li>桥接<ul>
<li>桥接结构如下，虚拟交换机将虚拟机连接在一起，物理网卡也连接到这个虚拟交换机上。<br>  <img src="https://static001.geekbang.org/resource/image/93/f4/9347b67409e26924ea9358f052f2e9f4.jpg" alt=""></li>
<li>相当于将物理机和虚拟机放在同一个网桥上，是一个网段的，如下图。<br>  <img src="https://static001.geekbang.org/resource/image/e5/07/e55e9a85106d9086e51cd649a182d707.jpg" alt=""></li>
<li>在数据中心里面，采取的也是类似的技术，只不过都是 Linux，在每台机器上都创建网桥 br0，虚拟机的网卡都连到 br0 上，物理网卡也连到 br0 上，所有的 br0 都通过物理网卡出来连接到物理交换机上。<br>  <img src="https://static001.geekbang.org/resource/image/a1/b7/a145ea19a844b3e38834efbf0f4cedb7.jpg" alt=""></li>
<li>优劣: 这种方式不但解决了同一台机器的互通问题，也解决了跨物理机的互通问题，因为都在一个二层网络里面。</li>
<li>劣势: 在一个二层网络里面，当虚拟机数量非常多时，广播会很严重。</li>
</ul>
</li>
<li>NAT<ul>
<li>NAT 模式的网络结构如下。它会在你的笔记本电脑里内置一个 DHCP 服务器，为笔记本电脑上的虚拟机动态分配 IP 地址。<br>  <img src="https://static001.geekbang.org/resource/image/2d/c4/2dd447992fbf4901f92a3dfdf8086bc4.jpg" alt=""></li>
<li>虚拟机与物理机分属不同网段，虚拟机要想访问物理机的时候，需要将地址 NAT 成为物理机的地址。</li>
<li>在数据中心里面，也是使用类似的方式。所有电脑都通过内网网口连接到一个网桥 br0 上，虚拟机要想访问互联网，需要通过 br0 连到路由器上，然后通过路由器将请求 NAT 成为物理网络的地址，转发到物理网络。<br>  <img src="https://static001.geekbang.org/resource/image/72/8b/72b49cdeeb8846025f310a1f59b6b88b.jpg" alt=""></li>
<li>优势: 一台物理上的虚拟机在同一个网段中，可以直接互通；跨物理机可以通过路由器互通；且虚拟机非常多时，不会有广播问题。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="隔离问题"><a href="#隔离问题" class="headerlink" title="隔离问题"></a>隔离问题</h4><ul>
<li>一台物理机上的两台虚拟机的隔离<ul>
<li>brctl 创建的网桥支持 VLAN 功能，可以设置两个虚拟机的 tag，这样在这个虚拟网桥上，两个虚拟机是不互通的。</li>
</ul>
</li>
<li>跨物理机的虚拟机隔离<ul>
<li>有一个命令vconfig，可以基于物理网卡 eth0 创建带 VLAN 的虚拟网卡，所有从这个虚拟网卡出去的包，都带这个 VLAN，如果这样，跨物理机的互通和隔离就可以通过这个网卡来实现。</li>
</ul>
</li>
<li>遗留问题（改进空间）<ul>
<li>VLAN 的隔离，数目太少，VLAN ID 只有 4096 个，在机器数多了之后，明显不够用。</li>
<li>这个配置不够灵活。谁和谁通，谁和谁不通，流量的隔离也没有实现。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第25讲-软件定义网络：共享基础设施的小区物业管理办法"><a href="#第25讲-软件定义网络：共享基础设施的小区物业管理办法" class="headerlink" title="第25讲 | 软件定义网络：共享基础设施的小区物业管理办法"></a>第25讲 | 软件定义网络：共享基础设施的小区物业管理办法</h2><h4 id="软件定义网络（SDN）"><a href="#软件定义网络（SDN）" class="headerlink" title="软件定义网络（SDN）"></a>软件定义网络（SDN）</h4><p>传统配置的问题: 灵活性差，且缺少统一的视图，统一的管理。配置整个云平台的网络通路，你需要登录到这台机器上配置这个，再登录到另外一个设备配置那个，才能成功。</p>
<p>SDN 则解决了上述问题。它有三个特点。<br><img src="https://static001.geekbang.org/resource/image/34/f9/346fe3b3dbe1024e7119ec4ffa9377f9.jpg" alt=""></p>
<ul>
<li>控制与转发分离：转发平面就是一个个虚拟或者物理的网络设备，控制平面就是统一的控制中心。</li>
<li>控制平面与转发平面之间的开放接口：控制器向上提供接口，被应用层调用，被称为北向接口。控制器向下调用接口，来控制网络设备，被称为南向接口。</li>
<li>逻辑上的集中控制：逻辑上集中的控制平面可以控制多个转发面设备，也就是控制整个物理网络，因而可以获得全局的网络状态视图，并根据该全局网络状态视图实现对网络的优化控制。</li>
</ul>
<h4 id="OpenFlow-和-OpenvSwitch"><a href="#OpenFlow-和-OpenvSwitch" class="headerlink" title="OpenFlow 和 OpenvSwitch"></a>OpenFlow 和 OpenvSwitch</h4><p>SDN 有很多种实现方式，OpenFlow 是 SDN 控制器和网络设备之间互通的南向接口协议的一个开源实现，OpenvSwitch 用于创建软件的虚拟交换机。OpenvSwitch 是支持 OpenFlow 协议的。它们都可以被统一的 SDN 控制器管理，从而实现物理机和虚拟机的网络连通。<br><img src="https://static001.geekbang.org/resource/image/38/d0/383710afd8e2b7e99ba8ccfef69c02d0.jpg" alt=""></p>
<p>在 OpenvSwitch 里面，有一个流表规则，任何通过这个交换机的包，都会经过这些规则进行处理，从而接收、转发、放弃。<br><img src="https://static001.geekbang.org/resource/image/ed/f7/ed8939e33728c6118db3c0283b1dbdf7.jpg" alt=""></p>
<p>流表其实就是一个个表格，每个表格好多行，每行都是一条规则。每条规则都有优先级，先看高优先级的规则，再看低优先级的规则。<br><img src="https://static001.geekbang.org/resource/image/91/77/91a7f011885ec48ca57d61940b748477.jpg" alt=""></p>
<p>具体来说，流表的处理可以覆盖 TCP/IP 协议栈的四层。<br><img src="https://static001.geekbang.org/resource/image/34/22/342ac21bda24e20d8d78f47ca8415a22.jpg" alt=""></p>
<ul>
<li>物理层<ul>
<li>匹配规则<ul>
<li>从哪个口进来</li>
</ul>
</li>
<li>执行动作<ul>
<li>从哪个口出去</li>
</ul>
</li>
</ul>
</li>
<li>MAC 层<ul>
<li>匹配规则<ul>
<li>源 MAC（dl_src）</li>
<li>目标 MAC（dl_dst）</li>
<li>所属 vlan（dl_vlan）</li>
</ul>
</li>
<li>执行动作<ul>
<li>修改源 MAC（mod_dl_src）</li>
<li>修改目标 MAC（mod_dl_dst）</li>
<li>修改 VLAN（mod_vlan_vid）</li>
<li>删除 VLAN（strip_vlan）</li>
<li>MAC 地址学习（learn）</li>
</ul>
</li>
</ul>
</li>
<li>网络层<ul>
<li>匹配规则<ul>
<li>源 IP（nw_src）</li>
<li>目标 IP（nw_dst）</li>
</ul>
</li>
<li>执行动作<ul>
<li>修改源 IP（mod_nw_src）</li>
<li>修改目标 IP（mod_nw_dst）</li>
</ul>
</li>
</ul>
</li>
<li>传输层<ul>
<li>匹配规则<ul>
<li>源端口（tp_src）</li>
<li>目标端口（tp_dst）</li>
</ul>
</li>
<li>执行动作<ul>
<li>修改源端口（mod_tp_src）</li>
<li>修改目标端口（mod_tp_dst）</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="实验一：用-OpenvSwitch-实现-VLAN-的功能"><a href="#实验一：用-OpenvSwitch-实现-VLAN-的功能" class="headerlink" title="实验一：用 OpenvSwitch 实现 VLAN 的功能"></a>实验一：用 OpenvSwitch 实现 VLAN 的功能</h4><p>在 OpenvSwitch 中端口 port 分两种。</p>
<ul>
<li>access port<ul>
<li>这个端口配置 tag，从这个端口进来的包会被打上这个 tag</li>
<li>如果网络包本身带有的 VLAN ID 等于 tag，则会从这个 port 发出</li>
<li>从 access port 发出的包不带 VLAN ID</li>
</ul>
</li>
<li>trunk port<ul>
<li>这个 port 不配置 tag，配置 trunks</li>
<li>如果 trunks 为空，则所有的 VLAN 都 trunk，也就意味着对于所有 VLAN 的包，本身带什么 VLAN ID，就是携带着什么 VLAN ID，如果没有设置 VLAN，就属于 VLAN 0，全部允许通过</li>
<li>如果 trunks 不为空，则仅仅带着这些 VLAN ID 的包通过</li>
</ul>
</li>
</ul>
<p>我们创建一个如下的网络进行说明（注意这里禁止了 MAC 地址学习）<br><img src="https://static001.geekbang.org/resource/image/6e/b4/6e1ddc1eb92c85cda32f40b62dd9fcb4.jpg" alt=""></p>
<ul>
<li>从 192.168.100.102 来 ping 192.168.100.103<ul>
<li>first_if 收到包了，从 first_br 出来的包头是没有 VLAN ID 的。因为从 vnet 2 中出来的包被打上了 VLAN ID 103，匹配了 first_br 的 tag，之后通过 first_br 后 VLAN ID 被删除。</li>
<li>second_if 收到包了，且带有 VLAN ID。因为 second_br 是 trunk port，因而出来的包头是有 VLAN ID 的，这个 VLAN ID 是在通过 vnet 2 时被加上的。</li>
<li>third_if 收不到包。因为 trunks 不匹配网络包的 VLAN ID=103。</li>
</ul>
</li>
<li>从 192.168.100.100 来 ping 192.168.100.105,<ul>
<li>first_if 收不到包。</li>
<li>second_if 收到包了，且带有 VLAN ID=101。</li>
<li>third_if 收到包了，且带有 VLAN ID=101。</li>
</ul>
</li>
<li>从 192.168.100.101 来 ping 192.168.100.104<ul>
<li>first_if 收不到包。</li>
<li>second_if 收到包了，且带有 VLAN ID=102。</li>
<li>third_if 收到包了，且带有 VLAN ID=102。</li>
</ul>
</li>
</ul>
<h4 id="实验二：用-OpenvSwitch-模拟网卡绑定，连接交换机"><a href="#实验二：用-OpenvSwitch-模拟网卡绑定，连接交换机" class="headerlink" title="实验二：用 OpenvSwitch 模拟网卡绑定，连接交换机"></a>实验二：用 OpenvSwitch 模拟网卡绑定，连接交换机</h4><p>在 OpenvSwitch 里面，有个 bond_mode，可以设置为以下三个值：</p>
<ul>
<li>active-backup：一个连接是 active，其他的是 backup，当 active 失效的时候，backup 顶上</li>
<li>balance-slb：流量安装源 MAC 和 output VLAN 进行负载均衡</li>
<li>balance-tcp：必须在支持 LACP 协议的情况下才可以，可根据 L2, L3, L4 进行负载均衡</li>
</ul>
<p>我们搭建一个如下的环境进行说明<br><img src="https://static001.geekbang.org/resource/image/8a/6c/8a1956cb5bbf03de7d6cbaa2e706046c.jpg" alt=""></p>
<ul>
<li>默认情况下 bond_mode 是 active-backup 模式，一开始 active 的是 first_br 和 first_if。<ul>
<li>从 192.168.100.100 ping 192.168.100.102，以及从 192.168.100.101 ping 192.168.100.103 的时候，所有的包都是从 first_if 通过。</li>
<li>把 first_if 设成 down，则 second_if 开始有流量，对于 192.168.100.100 和 192.168.100.101 是没有受到影响的。</li>
</ul>
</li>
<li>把 bond_mode 设为 balance-slb。<ul>
<li>同时在 192.168.100.100 ping 192.168.100.102，在 192.168.100.101 ping 192.168.100.103，则包会被分流。</li>
</ul>
</li>
</ul>
<h4 id="OpenvSwitch-架构"><a href="#OpenvSwitch-架构" class="headerlink" title="OpenvSwitch 架构"></a>OpenvSwitch 架构</h4><p><img src="https://static001.geekbang.org/resource/image/d8/14/d870e5bfcad8ec45d146c3226cdccb14.jpg" alt=""></p>
<ul>
<li>在用户态有两个重要的进程，也有两个重要的命令行工具。<ul>
<li>OVSDB 进程。ovs-vsctl 命令行会和这个进程通信，去创建虚拟交换机，创建端口，将端口添加到虚拟交换机上，OVSDB 会将这些拓扑信息保存在一个本地的文件中。</li>
<li>vswitchd 进程。ovs-ofctl 命令行会和这个进程通信，去下发流表规则，规则里面会规定如何对网络包进行处理，vswitchd 会将流表放在用户态 Flow Table 中。</li>
</ul>
</li>
<li>在内核态，有内核模块 OpenvSwitch.ko，对应图中的 Datapath 部分。在网卡上注册一个函数，每当有网络包到达网卡的时候，这个函数就会被调用。并在这个函数中拿到网络包，将各个层次的重要信息拿出来，例如：<ul>
<li>在物理层，in_port 即包进入的网口的 ID</li>
<li>在 MAC 层，源和目的 MAC 地址</li>
<li>在 IP 层，源和目的 IP 地址</li>
<li>在传输层，源和目的端口号</li>
</ul>
</li>
<li>在内核中，有一个内核态 Flow Table。接下来内核模块在这个内核流表中匹配规则，如果匹配上了，则执行操作、修改包，或者转发或者放弃。如果内核没有匹配上，则需要进入用户态，用户态和内核态之间通过 Linux 的一个机制 Netlink 相互通信。<ul>
<li>内核通过 upcall，告知用户态进程 vswitchd 在用户态 Flow Table 里面去匹配规则，这里面的规则是全量的流表规则，而内核 Flow Table 里面的只是为了快速处理，保留了部分规则，内核里面的规则过一阵就会过期。</li>
<li>当在用户态匹配到了流表规则之后，就在用户态执行操作，同时将这个匹配成功的流表通过 reinject 下发到内核，从而接下来的包都能在内核找到这个规则。</li>
</ul>
</li>
<li>这里调用 openflow 协议的，是本地的命令行工具，也可以是远程的 SDN 控制器，一个重要的 SDN 控制器是 OpenDaylight。如下图所示：<br>  <img src="https://static001.geekbang.org/resource/image/27/a8/274442ba251fdc63c88bc5dbfc6183a8.jpg" alt=""></li>
</ul>
<h4 id="如何在云计算中使用-OpenvSwitch？"><a href="#如何在云计算中使用-OpenvSwitch？" class="headerlink" title="如何在云计算中使用 OpenvSwitch？"></a>如何在云计算中使用 OpenvSwitch？</h4><p><img src="https://static001.geekbang.org/resource/image/24/59/24b09861632f7ba7211073e2829d4f59.jpg" alt=""></p>
<ul>
<li>左边是传统场景<ul>
<li>如果要使用一个新的 VLAN，还需要创建一个属于新的 VLAN 的虚拟网卡，并且为这个租户创建一个单独的虚拟网桥，这样用户越来越多的时候，虚拟网卡和虚拟网桥会越来越多，管理非常复杂。</li>
<li>虚拟机的 VLAN 和物理环境的 VLAN 是透传的，也即从一开始规划的时候，就需要匹配起来，将物理环境和虚拟环境强绑定，本来就不灵活。</li>
</ul>
</li>
<li>右边是基于 OpenvSwitch 的场景<ul>
<li>所有的虚拟机都可以放在一个网桥 br0 上，通过不同的用户配置不同的 tag，就能够实现隔离。</li>
<li>还可以创建一个虚拟交换机 br1，将物理网络和虚拟网络进行隔离。物理网络有物理网络的 VLAN 规划，虚拟机在一台物理机上，所有的 VLAN 都是从 1 开始的。由于一台机器上的虚拟机不会超过 4096 个，所以 VLAN 在一台物理机上如果从 1 开始，肯定够用了。</li>
<li>OpenvSwitch 可以对包的内容进行修改。例如通过匹配 dl_vlan，然后执行 mod_vlan_vid 来改进进出出物理机的网络包。以此可以实现物理机的网络和虚拟机的网络的解耦与分别管理。<blockquote>
<p>尽管租户多了，物理环境的 VLAN 还是不够用，但是有了 OpenvSwitch 的映射，将物理和虚拟解耦，从而可以让物理环境使用其他技术，而不影响虚拟机环境，这个我们后面再讲。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第26讲-云中的网络安全：虽然不是土豪，也需要基本安全和保障"><a href="#第26讲-云中的网络安全：虽然不是土豪，也需要基本安全和保障" class="headerlink" title="第26讲 | 云中的网络安全：虽然不是土豪，也需要基本安全和保障"></a>第26讲 | 云中的网络安全：虽然不是土豪，也需要基本安全和保障</h2><p>对于公有云上的虚拟机，建议仅仅开放需要的端口，而将其他的端口一概关闭。</p>
<ul>
<li>采用的方式常常是用ACL（Access Control List，访问控制列表）来控制 IP 和端口。</li>
<li>设置好了这些规则，只有指定的 IP 段能够访问指定的开放接口，在云平台上，这些规则的集合常称为安全组。</li>
</ul>
<h4 id="Netfilter-与-ip-tables"><a href="#Netfilter-与-ip-tables" class="headerlink" title="Netfilter 与 ip_tables"></a>Netfilter 与 ip_tables</h4><p>在 Linux 内核中，有一个框架叫 Netfilter。它可以在一些网络层节点插入 hook 函数。这些函数可以截获数据包，对数据包进行干预。</p>
<ul>
<li>节点分类如图<br>  <img src="https://static001.geekbang.org/resource/image/a9/fc/a924ccda5d54bcad6f67fdebe0a6c1fc.jpg" alt=""><ol>
<li>首先拿下 MAC 头看看，是不是我的。如果是，则拿下 IP 头来。得到目标 IP 之后呢，就开始进行路由判断。在路由判断之前，这个节点我们称为PREROUTING。</li>
<li>如果发现 IP 是我的，包就应该是我的，就发给上面的传输层，这个节点叫作INPUT。</li>
<li>如果发现 IP 不是我的，就需要转发出去，这个节点称为FORWARD。</li>
<li>如果是我的，上层处理完毕完毕后，一般会返回一个处理结果，这个处理结果会发出去，这个节点称为OUTPUT。<blockquote>
<p>无论是 FORWARD 还是 OUTPUT，都是路由判断之后发生的</p>
</blockquote>
</li>
<li>最后一个节点是POSTROUTING。</li>
</ol>
</li>
<li>可以做的干预如下<ul>
<li>做一定的修改，然后决策是否接着交给 TCP/IP 协议栈处理；或者可以交回给协议栈，那就是ACCEPT</li>
<li>过滤掉，不再传输，就是DROP</li>
<li>发送给某个用户态进程处理，就是QUEUE</li>
</ul>
</li>
</ul>
<p>Netfilter 的一个著名的实现，就是内核模块 ip_tables。<br><img src="https://static001.geekbang.org/resource/image/89/fd/897618c5f5b65e8c35ef5f20a731cdfd.jpg" alt=""></p>
<ul>
<li>内核模块 ip_tables 在上述五个节点上埋下函数，从而可以根据规则进行包的处理。按功能可分为四大类：<ul>
<li>连接跟踪（conntrack）</li>
<li>数据包的过滤（filter）</li>
<li>网络地址转换（nat）</li>
<li>数据包的修改（mangle）<blockquote>
<p>其中连接跟踪是基础功能，被其他功能所依赖。</p>
</blockquote>
</li>
</ul>
</li>
<li>在用户态，有一个客户端程序 iptables，用命令行来干预内核模块 ip_tables 的规则。内核的功能对应 iptables 的命令行来讲，就是表和链的概念。</li>
<li>iptables 的表分为四种：raw–&gt;mangle–&gt;nat–&gt;filter。这四个优先级依次降低，raw 不常用，所以主要功能都在其他三种表里实现。每个表可以设置多个链。<ul>
<li>filter 表处理过滤功能，主要包含三个链：<ul>
<li>INPUT 链：过滤所有目标地址是本机的数据包</li>
<li>FORWARD 链：过滤所有路过本机的数据包</li>
<li>OUTPUT 链：过滤所有由本机产生的数据包</li>
</ul>
</li>
<li>nat 表主要是处理网络地址转换，可以进行 Snat（改变数据包的源地址）、Dnat（改变数据包的目标地址），包含三个链：<ul>
<li>PREROUTING 链：可以在数据包到达防火墙时改变目标地址</li>
<li>OUTPUT 链：可以改变本地产生的数据包的目标地址</li>
<li>POSTROUTING 链：在数据包离开防火墙时改变数据包的源地址</li>
</ul>
</li>
<li>mangle 表主要是修改数据包，包含：<ul>
<li>PREROUTING 链</li>
<li>INPUT 链</li>
<li>FORWARD 链</li>
<li>OUTPUT 链</li>
<li>POSTROUTING 链</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>最终，基于 iptables 实现的 Netfilter 框架如下。<br><img src="https://static001.geekbang.org/resource/image/1a/17/1a0ba797b9a0f0e32c9e561b97955917.jpg" alt=""></p>
<ol>
<li>数据包进入的时候，先进 mangle 表的 PREROUTING 链。在这里可以根据需要，改变数据包头内容之后，进入 nat 表的 PREROUTING 链，在这里可以根据需要做 Dnat，也就是目标地址转换。</li>
<li>进入路由判断，要判断是进入本地的还是转发的。<ul>
<li>进入本地<ul>
<li>先进入 INPUT 链，之后按条件过滤限制进入。</li>
<li>之后进入本机，再进入 OUTPUT 链，按条件过滤限制出去，离开本地。</li>
</ul>
</li>
<li>转发<ul>
<li>就进入 FORWARD 链，根据条件过滤限制转发。</li>
</ul>
</li>
</ul>
</li>
<li>之后进入 POSTROUTING 链，这里可以做 Snat，离开网络接口。</li>
</ol>
<h4 id="安全组"><a href="#安全组" class="headerlink" title="安全组"></a>安全组</h4><p>在云平台上，一般允许一个或者多个虚拟机属于某个安全组，而属于不同安全组的虚拟机之间的访问以及外网访问虚拟机，都需要通过安全组进行过滤。</p>
<p>举例，我们会创建一系列的网站，都是前端在 Tomcat 里面，对外开放 8080 端口。数据库使用 MySQL，开放 3306 端口。则可以按照下图配置安全组。<br><img src="https://static001.geekbang.org/resource/image/93/a3/93aa707cb55c47023ae958d6cadde8a3.jpg" alt=""><br>我们创建两个安全组</p>
<ul>
<li>将 Tomcat 所在的虚拟机放在安全组 A 里面。在安全组 A 里面，允许任意 IP 地址 0.0.0.0/0 访问 8080 端口，但是对于 ssh 的 22 端口，仅仅允许管理员网段 203.0.113.0/24 访问。</li>
<li>我们将 MySQL 所在的虚拟机在安全组 B 里面。在安全组 B 里面，仅仅允许来自安全组 A 的机器访问 3306 端口，但是对于 ssh 的 22 端口，同样允许管理员网段 203.0.113.0/24 访问。</li>
</ul>
<h4 id="基于-iptables-的安全组的实现"><a href="#基于-iptables-的安全组的实现" class="headerlink" title="基于 iptables 的安全组的实现"></a>基于 iptables 的安全组的实现</h4><p><img src="https://static001.geekbang.org/resource/image/24/24/246db57c915d9ccf6e0d66182de0fe24.jpg" alt=""><br>如上图，两个 VM 都通过 tap 网卡连接到一个网桥上，但是网桥是二层的，两个 VM 之间是可以随意互通的，因而需要有一个地方统一配置这些 iptables 规则。</p>
<ul>
<li>可以多加一个网桥，在这个网桥上配置 iptables 规则，将在用户在界面上配置的规则，放到这个网桥上。</li>
<li>然后在每台机器上跑一个 Agent，将用户配置的安全组变成 iptables 规则，配置在这个网桥上。</li>
</ul>
<h4 id="基于-iptables-解决外网访问问题"><a href="#基于-iptables-解决外网访问问题" class="headerlink" title="基于 iptables 解决外网访问问题"></a>基于 iptables 解决外网访问问题</h4><p><img src="https://static001.geekbang.org/resource/image/1a/1a/1a5d299c2eb5480eda93a8f8e3b3ca1a.jpg" alt=""><br>上图是虚拟机做客户端的场景，云平台里面的虚拟机只有私网 IP 地址，到达外网网口要做一次 Snat，转换成为机房网 IP，然后出数据中心的时候，再转换为公网 IP。</p>
<ul>
<li>这里的 Snat 是一种特殊的 Snat，称为 MASQUERADE（地址伪装）。这种方式下，所有的虚拟机共享一个机房网和公网的 IP 地址，所有从外网网口出去的，都转换成为这个 IP 地址。</li>
<li>Netfilter 的连接跟踪（conntrack）功能会用 “源 / 目的 IP+ 源 / 目的端口” 唯一标识一条连接，并将它放在 conntrack 表里面。当时是这台机器去请求网站的，虽然源地址已经 Snat 成公网 IP 地址了，但是 conntrack 表里面还是有这个连接的记录的。当网站返回数据的时候，会找到记录，从而找到正确的私网 IP 地址。</li>
</ul>
<p>当虚拟机做服务端时，需要给这个网站配置固定的物理网的 IP 地址和公网 IP 地址。这时候就需要显示的配置 Snat 规则和 Dnat 规则了。</p>
<ul>
<li>当外部访问进来的时候，外网网口会通过 Dnat 规则将公网 IP 地址转换为私网 IP 地址，到达虚拟机，虚拟机里面是网站。</li>
<li>返回结果时，外网网口会通过 Snat 规则，将私网 IP 地址转换为那个分配给它的固定的公网 IP 地址。</li>
</ul>
<hr>
<h2 id="第27讲-云中的网络QoS：邻居疯狂下电影，我该怎么办？"><a href="#第27讲-云中的网络QoS：邻居疯狂下电影，我该怎么办？" class="headerlink" title="第27讲 | 云中的网络QoS：邻居疯狂下电影，我该怎么办？"></a>第27讲 | 云中的网络QoS：邻居疯狂下电影，我该怎么办？</h2><p>在云平台上，有一种流量控制的技术，可以实现 QoS（Quality of Service），从而保障大多数用户的服务质量。</p>
<p><img src="https://static001.geekbang.org/resource/image/e7/a6/e7eda457d064071bcfa92219e6aefaa6.jpg" alt=""><br>对于控制一台机器的网络的 QoS，分两个方向：</p>
<ul>
<li>一个是入方向，流量无法控制，只能通过 Policy 将包丢弃。</li>
<li>一个是出方向，通过 Shaping，将出的流量控制成自己想要的模样。</li>
</ul>
<h4 id="控制网络的-QoS-有哪些方式？"><a href="#控制网络的-QoS-有哪些方式？" class="headerlink" title="控制网络的 QoS 有哪些方式？"></a>控制网络的 QoS 有哪些方式？</h4><p>在 Linux 下，可以通过 TC 控制网络的 QoS，主要就是通过队列的方式。</p>
<ul>
<li>无类别排队规则<ul>
<li>pfifo_fast，这是一种不把网络包分类的技术<br>  <img src="https://static001.geekbang.org/resource/image/7e/3e/7e3218260e75bb9f18d68641928ff33e.jpg" alt=""><ul>
<li>pfifo_fast 分为三个先入先出的队列，称为三个 Band。优先级为 Band0，Band1，Band2。</li>
<li>根据网络包里面 TOS，看这个包到底应该进入哪个队列。TOS 总共四位，每一位表示的意思不同，总共十六种类型。</li>
<li>通过命令行 tc qdisc show dev eth0，可以输出结果 priomap，也是十六个数字。在 0 到 2 之间，和 TOS 的十六种类型对应起来，表示不同的 TOS 对应的不同的队列。</li>
</ul>
</li>
<li>随机公平队列（Stochastic Fair Queuing）<br>  <img src="https://static001.geekbang.org/resource/image/da/71/da3a4653469877d9d98f1610ccaefd71.jpg" alt=""><ul>
<li>它会建立很多的 FIFO 的队列，TCP Session 会计算 hash 值，通过 hash 值分配到某个队列。</li>
<li>在队列的另一端，网络包会通过轮询策略从各个队列中取出发送。这样不会有一个 Session 占据所有的流量。</li>
<li>当然如果两个 Session 的 hash 是一样的，会共享一个队列，也有可能互相影响。hash 函数会经常改变，从而 session 不会总是相互影响。</li>
</ul>
</li>
<li>令牌桶规则（TBF，Token Bucket Filte）<br>  <img src="https://static001.geekbang.org/resource/image/c2/15/c2170423769b8dfb6e6ff854287ab115.jpg" alt=""><ul>
<li>所有的网络包排成队列进行发送，但是需要拿到令牌才能发送。</li>
<li>令牌根据设定的速度生成，所以即便队列很长，也是按照一定的速度进行发送的。</li>
<li>当没有包在队列中的时候，令牌还是以既定的速度生成，但是不是无限累积的，而是放满了桶为止。<blockquote>
<p>设置桶的大小为了避免下面的情况：当长时间没有网络包发送的时候，积累了大量的令牌，突然来了大量的网络包，每个都能得到令牌，造成瞬间流量大增。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li>基于类别的队列规则<ul>
<li>分层令牌桶规则（HTB， Hierarchical Token Bucket）<br>  <img src="https://static001.geekbang.org/resource/image/9a/b5/9a1b8a7c0c5403a2b4b3c277545991b5.jpg" alt=""><ul>
<li>HTB 往往是一棵树。使用 TC 可以为某个网卡 eth0 创建一个 HTB 的队列规则，需要付给它一个句柄为（1:），这是整棵树的根节点。接下来会有分支。例如图中有三个分支，句柄分别为（:10）、（:11）、（:12）。最后的参数 default 12，表示默认发送给 1:12，也即发送给第三个分支。</li>
<li>速度配置<ul>
<li>类型<ul>
<li>rate，表示一般情况下的速度</li>
<li>ceil，表示最高情况下的速度</li>
</ul>
</li>
<li>效果<ul>
<li>对于根节点来讲，这两个速度是一样的</li>
<li>对于子节点来讲，同一个根节点下的子节点可以相互借流量，从而不浪费带宽，使带宽发挥最大的作用</li>
</ul>
</li>
</ul>
</li>
<li>子节点规则配置<ul>
<li>fifo</li>
<li>sfq（随机公平队列）<blockquote>
<p>参考上面的无类别排队规则</p>
</blockquote>
</li>
</ul>
</li>
<li>发送规则配置: 基于子节点规则，还可以设定发送规则。比如，从 1.2.3.4 来的，发送给 port 80 的包，从第一个分支 1:10 走；其他从 1.2.3.4 发送来的包从第二个分支 1:11 走；其他的走默认分支。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="OpenvSwitch-中的-QoS"><a href="#OpenvSwitch-中的-QoS" class="headerlink" title="OpenvSwitch 中的 QoS"></a>OpenvSwitch 中的 QoS</h4><p>可以通过 OpenvSwitch 中 ovs-vsctl 与 ovs-ofctl 提供的相关指令进行配置，以实现OpenvSwitch 中的 QoS</p>
<hr>
<h2 id="第28讲-云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私"><a href="#第28讲-云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私" class="headerlink" title="第28讲 | 云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私"></a>第28讲 | 云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私</h2><h4 id="VLAN-数量不够用怎么办？"><a href="#VLAN-数量不够用怎么办？" class="headerlink" title="VLAN 数量不够用怎么办？"></a>VLAN 数量不够用怎么办？</h4><ul>
<li>一种方式是修改这个协议。但当协议形成一定标准后，设备上跑的程序都要按这个规则来，这样修改协议往往不可行。</li>
<li>另一种方式是扩展，在原来包的格式的基础上扩展出一个头，里面包含足够用于区分租户的 ID。<ul>
<li>外层的包的格式尽量和传统的一样，依然兼容原来的格式。</li>
<li>在需要区分用户的地方，用特殊的程序，来处理特殊的包的格式。</li>
</ul>
</li>
</ul>
<h4 id="GRE"><a href="#GRE" class="headerlink" title="GRE"></a>GRE</h4><p>GRE，全称 Generic Routing Encapsulation，它是一种 IP-over-IP 的隧道技术。它将 IP 包封装在 GRE 包里，外面加上 IP 头，在隧道的一端封装数据包，并在通路上进行传输，到另外一端的时候解封装。<br><img src="https://static001.geekbang.org/resource/image/b1/31/b189df0a6ee4b0462818bf2f154c9531.jpg" alt=""><br>在一个 GRE 头中：</p>
<ul>
<li>前 32 位是一定会有的，后面的都是可选的</li>
<li>前 4 位标识位里面，有标识后面到底有没有可选项</li>
<li>key 字段是一个 32 位的字段，里面存放的往往就是用于区分用户的 32 位的 Tunnel ID</li>
<li>下面的格式类型专门用于网络虚拟化的 GRE 包头格式，称为NVGRE，给网络 ID 号 24 位。</li>
</ul>
<p>GRE 还需要有一个地方来封装和解封装 GRE 的包，这个地方往往是路由器或者有路由功能的 Linux 机器。</p>
<p>使用 GRE 隧道，传输的过程就像下面这张图。这里面有两个网段、两个路由器，中间要通过 GRE 隧道进行通信。当隧道建立之后，会多出两个 Tunnel 端口，用于封包、解封包。<br><img src="https://static001.geekbang.org/resource/image/76/ce/76298ce51d349bc9805fbf317312e4ce.jpg" alt="">  </p>
<ol>
<li>主机 A 在左边的网络，IP 地址为 192.168.1.102，主机 B 在右边的网络，IP 地址为 192.168.2.115。A 发送一个包至 B，源地址为 192.168.1.102，目标地址为 192.168.2.115。</li>
<li>因为要跨网段访问，于是根据默认的 default 路由表规则，要发给默认的网关 192.168.1.1，也即左边的路由器。</li>
<li>根据路由表，从左边的路由器，去 192.168.2.0/24 这个网段，应该走一条 GRE 的隧道，从隧道一端的网卡 Tunnel0 进入隧道。</li>
<li>在 Tunnel 隧道的端点进行包的封装，在内部的 IP 头之外加上 GRE 头，然后从 E1 的物理网卡发送到公共网络里。<ul>
<li>对于 NVGRE 来讲，是在 MAC 头之外加上 GRE 头，然后加上外部的 IP 地址，也即路由器的外网 IP 地址。源 IP 地址为 172.17.10.10，目标 IP 地址为 172.16.11.10。</li>
</ul>
</li>
<li>在公共网络里面，沿着路由器一跳一跳地走，全部都按照外部的公网 IP 地址进行。</li>
<li>当网络包到达对端路由器的时候，也要到达对端的 Tunnel0，然后开始解封装，将外层的 IP 头取下来，然后根据里面的网络包，根据路由表，从 E3 口转发出去到达服务器 B。</li>
</ol>
<p>GRE 的弊端</p>
<ul>
<li>Tunnel 的数量问题。GRE 是一种点对点隧道，如果有三个网络，就需要在每两个网络之间建立一个隧道。如果网络数目增多，这样隧道的数目会呈指数性增长。</li>
<li>GRE 不支持组播。一个网络中的一个虚机发出一个广播帧后，GRE 会将其广播到所有与该节点有隧道连接的节点。</li>
<li>实用性问题。目前还是有很多防火墙和三层网络设备无法解析 GRE，因此它们无法对 GRE 封装包做合适地过滤和负载均衡。</li>
</ul>
<h4 id="VXLAN"><a href="#VXLAN" class="headerlink" title="VXLAN"></a>VXLAN</h4><p>VXLAN 是在二层外面套了一个 VXLAN 的头。<br><img src="https://static001.geekbang.org/resource/image/3b/0f/3b02d54c9093e3de6d1a847dd0eb060f.jpg" alt="">  </p>
<ul>
<li>VXLAN ID 为 24 位。</li>
<li>在 VXLAN 头外面还封装了 UDP、IP，以及外层的 MAC 头。<blockquote>
<p>与 GRE 对比，GRE 是三层外面再套三层，VXLAN 是二层外面套二层。</p>
</blockquote>
</li>
</ul>
<p>VXLAN 作为扩展性协议，也需要一个地方对 VXLAN 的包进行封装和解封装，实现这个功能的点称为VTEP（VXLAN Tunnel Endpoint）。</p>
<ul>
<li>每台物理机上都可以有一个 VTEP。</li>
<li>每个虚拟机启动的时候，都需要向这个 VTEP 注册，每个 VTEP 都知道自己上面注册了多少个虚拟机。</li>
<li>当虚拟机要跨 VTEP 进行通信的时候，需要通过 VTEP 代理进行，由 VTEP 进行包的封装和解封装。</li>
<li>VXLAN 支持通过组播的来定位目标机器。当一个 VTEP 启动的时候，它们都需要通过 IGMP 协议，加入一个组播组。就像加入一个邮件列表，所有发到这个邮件列表里面的邮件，大家都能收到。</li>
</ul>
<p>如图，虚拟机 1、2、3 属于云中同一个用户的虚拟机，因而需要分配相同的 VXLAN ID=101。在云的界面上，就可以知道它们的 IP 地址。<br><img src="https://static001.geekbang.org/resource/image/e4/77/e4541dfd1571aab11694343520970a77.jpg" alt=""><br>这里以在虚拟机 1 上 ping 虚拟机 2 举例</p>
<ol>
<li>虚拟机 1 发现，它不知道虚拟机 2 的 MAC 地址，因而包没办法发出去，于是要发送 ARP 广播。<br> <img src="https://static001.geekbang.org/resource/image/27/79/27b0f23c0e94c10bac63d2ec6401e079.jpg" alt=""></li>
<li>ARP 请求到达 VTEP1 的时候，VTEP1 知道，我这里有一台虚拟机，要访问一台不归我管的虚拟机，需要知道 MAC 地址，于是 VTEP1 将 ARP 请求封装在 VXLAN 里面，组播出去。</li>
<li>VTEP2 和 VTEP3 都收到了消息，因而都会解开 VXLAN 包看，里面是一个 ARP。<ul>
<li>VTEP3 在本地广播后，没有收到回复。</li>
<li>VTEP2 在本地广播后，虚拟机 2 回了，说虚拟机 2 归我管，MAC 地址是这个。<blockquote>
<p>通过这次通信，VTEP2 也学到了，虚拟机 1 归 VTEP1 管，以后要找虚拟机 1，去找 VTEP1 就可以了。</p>
</blockquote>
</li>
</ul>
</li>
<li>VTEP2 将 ARP 的回复封装在 VXLAN 里面，直接发回给 VTEP1。<br> <img src="https://static001.geekbang.org/resource/image/37/6c/377070660f2474b90489b0f10f8f686c.jpg" alt=""></li>
<li>VTEP1 解开 VXLAN 的包，发现是 ARP 的回复，于是发给虚拟机 1。<blockquote>
<p>通过这次通信，VTEP1 也学到了，虚拟机 2 归 VTEP2 管，以后找虚拟机 2，去找 VTEP2 就可以了。</p>
</blockquote>
</li>
<li>虚拟机 1 的 ARP 得到了回复，知道了虚拟机 2 的 MAC 地址，于是就可以发送包了。<br> <img src="https://static001.geekbang.org/resource/image/5b/6e/5ba8f197a682de2539594ef5d7e7d56e.jpg" alt=""></li>
<li>虚拟机 1 发给虚拟机 2 的包到达 VTEP1，它在上次通信中已经学习到虚拟机 2 在 VTEP2 组中，于是将包封装在 VXLAN 里面，外层加上 VTEP1 和 VTEP2 的 IP 地址，发送出去。</li>
<li>网络包到达 VTEP2 之后，VTEP2 解开 VXLAN 封装，将包转发给虚拟机 2。</li>
<li>虚拟机 2 回复的包，到达 VTEP2 的时候，它在上次通信中已经学习到虚拟机 1 在 VTEP1 组中，于是将包封装在 VXLAN 里面，外层加上 VTEP1 和 VTEP2 的 IP 地址，也发送出去。<br> <img src="https://static001.geekbang.org/resource/image/b4/19/b4d39cfc833be380be67eeee8019d319.jpg" alt=""></li>
<li>网络包到达 VTEP1 之后，VTEP1 解开 VXLAN 封装，将包转发给虚拟机 1。<blockquote>
<p>和 GRE 端到端的隧道不同，VXLAN 不是点对点的，而是支持通过组播的来定位目标机器的，而非一定是这一端发出，另一端接收。</p>
</blockquote>
</li>
</ol>
<h4 id="OpenvSwitch-中的隧道"><a href="#OpenvSwitch-中的隧道" class="headerlink" title="OpenvSwitch 中的隧道"></a>OpenvSwitch 中的隧道</h4><p>OpenvSwitch 支持三类隧道：</p>
<ul>
<li>GRE</li>
<li>VXLAN</li>
<li>IPsec_GRE</li>
</ul>
<p>在使用 OpenvSwitch 的时候，虚拟交换机就相当于 GRE 和 VXLAN 封装的端点。</p>
<hr>
<h2 id="第29讲-容器网络：来去自由的日子，不买公寓去合租"><a href="#第29讲-容器网络：来去自由的日子，不买公寓去合租" class="headerlink" title="第29讲 | 容器网络：来去自由的日子，不买公寓去合租"></a>第29讲 | 容器网络：来去自由的日子，不买公寓去合租</h2><p>容器的思想就是要变成软件交付的集装箱。它有两个特点：</p>
<ul>
<li>打包</li>
<li>标准</li>
</ul>
<h4 id="实现容器的两种主要技术"><a href="#实现容器的两种主要技术" class="headerlink" title="实现容器的两种主要技术"></a>实现容器的两种主要技术</h4><ul>
<li>命名空间（namespace）。这是一种看起来是隔离的技术，也即每个 namespace 中的应用看到的是不同的 IP 地址、用户空间、程号等。<ul>
<li>Linux 上允许将进程放在独立的 namespace 里面，这样就可以独立配置网络了。</li>
<li>网络的 namespace 由 ip netns 命令操作。它可以创建、删除、查询 namespace。</li>
</ul>
</li>
<li>机制网络（cgroup）。这是一种用起来是隔离的技术，也即明明整台机器有很多的 CPU、内存，而一个应用只能用其中的一部分。cgroup 有很多子系统：<ul>
<li>CPU 子系统使用调度程序为进程控制 CPU 的访问</li>
<li>cpuset，如果是多核心的 CPU，这个子系统会为进程分配单独的 CPU 和内存</li>
<li>memory 子系统，设置进程的内存限制以及产生内存资源报告</li>
<li>blkio 子系统，设置限制每个块设备的输入输出控制</li>
<li>net_cls，这个子系统使用等级识别符（classid）标记网络数据包，可允许 Linux 流量控制程序（tc）识别从具体 cgroup 中生成的数据包</li>
</ul>
</li>
</ul>
<h4 id="容器网络内部如何实现互通"><a href="#容器网络内部如何实现互通" class="headerlink" title="容器网络内部如何实现互通"></a>容器网络内部如何实现互通</h4><p>如果你使用 docker run 运行一个容器，你应该能看到这样一个拓扑结构。<br><img src="https://static001.geekbang.org/resource/image/20/d2/20e87bc215b9d049a4a504d775d26dd2.jpg" alt=""></p>
<ul>
<li>在 Linux 下，可以创建一对 veth pair 的网卡，从一边发送包，另一边就能收到。<ul>
<li>一张网卡绑定至容器（通过 namespace）</li>
<li>另一张网卡连接至网桥</li>
</ul>
</li>
<li>网桥实现了两边网卡的互通，即容器的互通</li>
</ul>
<h4 id="容器网络中如何融入物理网络？"><a href="#容器网络中如何融入物理网络？" class="headerlink" title="容器网络中如何融入物理网络？"></a>容器网络中如何融入物理网络？</h4><p>Docker 支持桥接模式和 NAT 模式，默认使用 NAT 模式。NAT 模式分为 SNAT 和 DNAT，如果是容器内部访问外部，就需要通过 SNAT。</p>
<p><img src="https://static001.geekbang.org/resource/image/49/bb/49bb6b2a30fe76b124182980da935ebb.jpg" alt=""></p>
<ol>
<li>所有从容器内部发出来的包，都要做地址伪装，将源 IP 地址，转换为物理网卡的 IP 地址。如果有多个容器，所有的容器共享一个外网的 IP 地址，但是在 conntrack 表中，记录下这个出去的连接。</li>
<li>当服务器返回结果的时候，到达物理机，会根据 conntrack 表中的规则，取出原来的私网 IP，通过 DNAT 将地址转换为私网 IP 地址，通过网桥 docker0 实现对内的访问。</li>
<li>如果在容器内部属于一个服务，例如部署一个网站，提供给外部进行访问，需要通过 Docker 的端口映射技术，将容器内部的端口映射到物理机上来。Docker 支持两种端口映射的方式：<ul>
<li>通过一个进程docker-proxy的方式，监听 10080，转换为 80 端口。</li>
<li>通过DNAT方式，在 -A PREROUTING 阶段加一个规则，将到端口 10080 的 DNAT 称为容器的私有网络。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="第30讲-容器网络之Flannel：每人一亩三分地"><a href="#第30讲-容器网络之Flannel：每人一亩三分地" class="headerlink" title="第30讲 | 容器网络之Flannel：每人一亩三分地"></a>第30讲 | 容器网络之Flannel：每人一亩三分地</h2><p>Kubernetes 可以灵活地将一个容器调度到任何一台机器上，并且当某个应用扛不住的时候，只要在 Kubernetes 上修改容器的副本数，一个应用马上就能变八个，而且都能提供服务。</p>
<p>Kubernetes 要解决的两个问题：</p>
<ul>
<li>各应用之间如何知道对方的位置<ul>
<li>有一个被称为注册中心的地方可以统一管理应用。当一个应用启动时，将自己所在环境的 IPp 和端口，注册到注册中心。当应用挂了，容器要迁移到另一台机器时，会重新启动，也会重新注册。各个应用之间互相访问时，能够从注册中心得到其位置。</li>
</ul>
</li>
<li>各应用之间如何通信<ul>
<li>Flannel 是一种解决方案<blockquote>
<p>Kubernetes 平台只提出说网络模型要变平，但是没说怎么实现，因此业界涌现了大量的方案。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="Flannel-解决的两个问题"><a href="#Flannel-解决的两个问题" class="headerlink" title="Flannel 解决的两个问题"></a>Flannel 解决的两个问题</h4><ul>
<li>IP 冲突问题<ul>
<li>从大网段中分出一个个小网段，每一台物理机使用一个网段。<blockquote>
<p>例如物理机 A 是网段 172.17.8.0/24，物理机 B 是网段 172.17.9.0/24，这样两台机器上启动的容器 IP 肯定不一样，而且就看 IP 地址，我们就一下子识别出，这个容器是本机的，还是远程的，如果是远程的，也能从网段一下子就识别出它归哪台物理机管。</p>
</blockquote>
</li>
</ul>
</li>
<li>两台物理机上的容器应用跨物理机互通的问题<ul>
<li>方案1: Flannel 使用 UDP 实现 Overlay 网络的方案，在每台物理机上，都会跑一个 flanneld 进程，这个进程打开一个 /dev/net/tun 字符设备的时候，就出现了一个网卡 flannel.1，由这张网卡实现路由策略。<br>  <img src="https://static001.geekbang.org/resource/image/01/c8/01ee306698c7dd6207e80fea0a8238c8.jpg" alt=""><ol>
<li>在物理机 A 上的容器 A 里面，能看到的容器的 IP 地址是 172.17.8.2/24，里面设置了默认的路由规则 default via 172.17.8.1 dev eth0。</li>
<li>如果容器 A 要访问 172.17.9.2，就会发往这个默认的网关 172.17.8.1。172.17.8.1 就是物理机上面 docker0 网桥的 IP 地址，这台物理机上的所有容器都是连接到这个网桥的。</li>
<li>在物理机上面，查看路由策略，会有这样一条 172.17.0.0/24 via 172.17.0.0 dev flannel.1，也就是说发往 172.17.9.2 的网络包会被转发到 flannel.1 这个网卡。</li>
<li>物理机 A 上的 flanneld 进程会将网络包封装在 UDP 包里面，然后外层加上物理机 A 和物理机 B 的 IP 地址，发送给物理机 B 上的 flanneld 进程。<blockquote>
<p>为什么是 UDP 呢？因为不想在 flanneld 之间建立两两连接，而 UDP 没有连接的概念，任何一台机器都能发给另一台。</p>
</blockquote>
</li>
<li>物理机 B 上的 flanneld 收到包之后，解开 UDP 的包，将里面的网络包拿出来，从物理机 B 的 flannel.1 网卡发出去。</li>
<li>在物理机 B 上，有路由规则 172.17.9.0/24 dev docker0 proto kernel scope link src 172.17.9.1。</li>
<li>将包发给 docker0，docker0 将包转给容器 B。通信成功。<blockquote>
<p>上面的过程全部在用户态，所以性能差了一些。</p>
</blockquote>
</li>
</ol>
</li>
<li>方案2: 使用 Flannel + VXLAN，可以通过 netlink 通知内核建立一个 VTEP 的网卡 flannel.1。<br>  <img src="https://static001.geekbang.org/resource/image/a5/01/a568cb08c615b351e871bd981541a201.jpg" alt=""><ol>
<li>当网络包从物理机 A 上的容器 A 发送给物理机 B 上的容器 B，在容器 A 里面通过默认路由到达物理机 A 上的 docker0 网卡，然后根据路由规则，在物理机 A 上，将包转发给 flannel.1。</li>
<li>flannel.1 是一个 VXLAN 的 VTEP，它将网络包进行封装。<ul>
<li>内部的 MAC 地址这样写：源为物理机 A 的 flannel.1 的 MAC 地址，目标为物理机 B 的 flannel.1 的 MAC 地址，在外面加上 VXLAN 的头。</li>
<li>外层的 IP 地址这样写：源为物理机 A 的 IP 地址，目标为物理机 B 的 IP 地址，外面加上物理机的 MAC 地址。</li>
</ul>
</li>
<li>这样就能通过 VXLAN 将包转发到另一台机器，从物理机 B 的 flannel.1 上解包，变成内部的网络包，通过物理机 B 上的路由转发到 docker0，然后转发到容器 B 里面。通信成功。</li>
</ol>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第31讲-容器网络之Calico：为高效说出善意的谎言"><a href="#第31讲-容器网络之Calico：为高效说出善意的谎言" class="headerlink" title="第31讲 | 容器网络之Calico：为高效说出善意的谎言"></a>第31讲 | 容器网络之Calico：为高效说出善意的谎言</h2><p>Calico 网络的大概思路，即不走 Overlay 网络，不引入另外的网络性能损耗，而是将转发全部用三层网络的路由转发来实现。</p>
<h4 id="Calico-网络的转发细节"><a href="#Calico-网络的转发细节" class="headerlink" title="Calico 网络的转发细节"></a>Calico 网络的转发细节</h4><p>以下图为例。<br><img src="https://static001.geekbang.org/resource/image/c3/9c/c3e999c033a0417df98c0bcc34c9349c.jpg" alt=""></p>
<ul>
<li>容器 A1 的 IP 地址为 172.17.8.2/32，不是 /24，即将容器 A1 作为一个单点的局域网了。</li>
<li>容器 A1 里面的默认路由，Calico 的配置如下。  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">default via 169.254.1.1 dev eth0 </span><br><span class="line">169.254.1.1 dev eth0 scope link</span><br></pre></td></tr></table></figure>
  这个 IP 地址 169.254.1.1 是默认的网关，但是整个拓扑图中没有一张网卡是这个地址，它的作用只是 Calico 插入的一个可以响应 ARP 的节点。它对应的 MAC 地址可以通过 ARP 本地缓存查看（ip neigh 命令）  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">169.254.1.1 dev eth0 lladdr ee:ee:ee:ee:ee:ee STALE</span><br></pre></td></tr></table></figure>
  这个 MAC 地址是 Calico 硬塞进去的，它能响应 ARP。</li>
<li>在物理机 A 上查看所有网卡的 MAC 地址的时候，我们会发现 veth1 就是上述这个 MAC 地址。所以容器 A1 里发出的网络包，第一跳就是这个 veth1 这个网卡，也就到达了物理机 A 这个路由器。</li>
<li>物理机上的路由规则配置<ul>
<li>物理机 A 上有三条路由规则，分别是去两个本机的容器的路由，以及去 172.17.9.0/24，下一跳为物理机 B。</li>
<li>物理机 B 上也有三条路由规则，分别是去两个本机的容器的路由，以及去 172.17.8.0/24，下一跳为物理机 A。</li>
</ul>
</li>
<li>最终上面的拓扑结构图可以转换为下图，物理机当做路由器使用，直接将包转发至目的地。在这个过程中，没有隧道封装解封装，仅仅是单纯的路由转发，性能会好很多。<br>  <img src="https://static001.geekbang.org/resource/image/e5/7d/e59559ad7b46b9811553b6b0a85e8e7d.jpg" alt=""></li>
</ul>
<h4 id="Calico-的架构"><a href="#Calico-的架构" class="headerlink" title="Calico 的架构"></a>Calico 的架构</h4><p><img src="https://static001.geekbang.org/resource/image/df/b2/df8d92d84af55369055738283339d6b2.jpg" alt=""></p>
<ul>
<li>路由配置组件 Felix<ul>
<li>每台物理机上有一个 agent，当创建和删除容器的时候，自动做路由配置的事情。这个 agent 在 Calico 中称为 Felix。</li>
</ul>
</li>
<li>路由广播组件 BGP Speaker<ul>
<li>在 Calico 中，每个 Node 上运行一个软件 BIRD，作为 BGP 的客户端，或者叫作 BGP Speaker，将“如何到达我这个 Node，访问我这个 Node 上的容器”的路由信息广播出去。所有 Node 上的 BGP Speaker 都互相建立连接，就形成了全互连的情况，这样每当路由有所变化的时候，所有节点就都能够收到了。</li>
</ul>
</li>
<li>安全策略组件<ul>
<li>Calico 中也是用 iptables 实现的。因此在 iptables 在内核处理网络包的过程中嵌入的处理点，Calico 也可以设置相应的规则，当然也可以设置安全组。</li>
</ul>
</li>
</ul>
<h4 id="全连接复杂性与规模问题"><a href="#全连接复杂性与规模问题" class="headerlink" title="全连接复杂性与规模问题"></a>全连接复杂性与规模问题</h4><p><img src="https://static001.geekbang.org/resource/image/f7/ff/f7e9467901ccb4b7e8039c53314244ff.jpg" alt=""><br>BGP Route Reflector 组件，它也是用 BIRD 实现的。</p>
<ul>
<li>BGP Speaker 都直连它，它负责将全网的路由信息广播出去。</li>
<li>一个网络中有多个 BGP Router Reflector，每个 BGP Router Reflector 管一部分。<ul>
<li>每个机架作为一个单元，由一个 BGP Router Reflector 来管理。</li>
<li>一个机架就像一个数据中心，可以把它设置为一个自治系统（AS，Autonomous System）。BGP Router Reflector 有点儿像数据中心的边界路由器。<ul>
<li>在一个 AS 内部，也即服务器和 BGP Router Reflector 之间使用的是数据中心内部的路由协议 iBGP。</li>
<li>BGP Router Reflector 之间使用的是数据中心之间的路由协议 eBGP。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="跨网段访问问题"><a href="#跨网段访问问题" class="headerlink" title="跨网段访问问题"></a>跨网段访问问题</h4><p><img src="https://static001.geekbang.org/resource/image/88/84/88a1817b32c3c364fbbdf50b05d49e84.jpg" alt=""><br>在物理机 A 和物理机 B 之间打一个隧道，这个隧道有两个端点，在端点上进行封装，将容器的 IP 作为乘客协议放在隧道里面，而物理主机的 IP 放在外面作为承载协议。这样不管外层的 IP 通过传统的物理网络，走多少跳到达目标物理机，从隧道两端看起来，物理机 A 的下一跳就是物理机 B。</p>
<p>这就是 Calico 的IPIP 模式。使用了 IPIP 模式之后，在物理机 A 上，我们能看到这样的路由表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">172.17.8.2 dev veth1 scope link </span><br><span class="line">172.17.8.3 dev veth2 scope link </span><br><span class="line">172.17.9.0&#x2F;24 via 192.168.200.101 dev tun0 proto bird onlink</span><br></pre></td></tr></table></figure>
<p>和原来的区别在于，下一跳不再是同一个网段的物理机 B 了，IP 为 192.168.200.101，并且不是从 eth0 跳，而是建立一个隧道的端点 tun0，从这里才是下一跳。</p>
<p>以容器 A1 中的 172.17.8.2，去 ping 容器 B1 中的 172.17.9.2 举例</p>
<ol>
<li>首先会到物理机 A。在物理机 A 上根据上面的规则，会转发给 tun0，并在这里对包做封装。<ul>
<li>内层源 IP 为 172.17.8.2；</li>
<li>内层目标 IP 为 172.17.9.2；</li>
<li>外层源 IP 为 192.168.100.100；</li>
<li>外层目标 IP 为 192.168.200.101。</li>
</ul>
</li>
<li>将这个包从 eth0 发出去，在物理网络上会使用外层的 IP 进行路由，最终到达物理机 B。</li>
<li>在物理机 B 上，tun0 会解封装，将内层的源 IP 和目标 IP 拿出来，转发给相应的容器。</li>
</ol>
<hr>
<h2 id="第32讲-RPC协议综述：远在天边，近在眼前"><a href="#第32讲-RPC协议综述：远在天边，近在眼前" class="headerlink" title="第32讲 | RPC协议综述：远在天边，近在眼前"></a>第32讲 | RPC协议综述：远在天边，近在眼前</h2><h4 id="容器应用之间相互调用的五个问题"><a href="#容器应用之间相互调用的五个问题" class="headerlink" title="容器应用之间相互调用的五个问题"></a>容器应用之间相互调用的五个问题</h4><ul>
<li>如何规定远程调用的语法？</li>
<li>如何传递参数？</li>
<li>如何表示数据？</li>
<li>如何知道一个服务端都实现了哪些远程调用？从哪个端口可以访问这个远程调用？</li>
<li>发生了错误、重传、丢包、性能等问题怎么办？</li>
</ul>
<h4 id="协议约定问题"><a href="#协议约定问题" class="headerlink" title="协议约定问题"></a>协议约定问题</h4><p>上述的前三个问题统称为协议约定问题，解决方案有如下两个思路。</p>
<ul>
<li>方法1：定制化，自己实现一个统一的库，让其他业务来调用，业务开发人员不需要知道中间传输的细节。<ul>
<li>弊端<ul>
<li>通信双方的语法、语义、格式、端口、错误处理等，都需要调用方和被调用方开会商量，双方达成一致。一旦有一方改变，要及时通知对方，否则通信就会有问题。</li>
<li>这样的实现需要较高的技术门槛，并不是每一个公司都有这种大牛团队。</li>
</ul>
</li>
</ul>
</li>
<li>方法2：使用成熟的框架，比如使用基于 RPC 的调用标准实现的 RPC 框架。<br>  <img src="https://static001.geekbang.org/resource/image/85/25/8534c52daf3682cd1cfe5a3375ec9525.jpg" alt=""><ul>
<li>RPC 调用流程<ol>
<li>当客户端的应用想发起一个远程调用时，它实际是通过本地调用本地调用方的 Stub。</li>
<li>本地方 Stub 负责将调用的接口、方法和参数，通过约定的协议规范进行编码，并通过本地的 RPCRuntime 进行传输，将调用网络包发送到服务器。</li>
<li>服务器端的 RPCRuntime 收到请求后，交给提供方 Stub。</li>
<li>提供方 Stub 进行解码，然后调用服务端的方法，服务端执行方法，返回结果。</li>
<li>提供方 Stub 将返回结果编码后，发送给客户端。</li>
<li>客户端的 RPCRuntime 收到结果，发给调用方 Stub。</li>
<li>调用方 Stub 解码得到结果，返回给客户端。</li>
</ol>
</li>
<li>RPC 三层结构<ul>
<li>对于用户层和服务端，都像是本地调用一样，专注于业务逻辑的处理就可以了。</li>
<li>对于 Stub 层，处理双方约定好的语法、语义、封装、解封装。</li>
<li>对于 RPCRuntime，主要处理高性能的传输，以及网络的错误和异常。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>接下来以 ONC RPC（也叫 Sun RPC）下，实现一个加法操作的调用来举例<br><img src="https://static001.geekbang.org/resource/image/2a/eb/2a0fd84c2d3dced623511e2a5226d0eb.jpg" alt=""></p>
<ul>
<li>NFS（Network File System）就是网络文件系统。要使 NFS 成功运行，要启动两个服务端，一个是 mountd，用来挂载文件路径；一个是 nfsd，用来读写文件。NFS 可以在本地 mount 一个远程的目录到本地的一个目录，从而本地的用户在这个目录里面写入、读出任何文件的时候，其实操作的是远程另一台机器上的文件。<blockquote>
<p>NFS 协议就是基于 RPC 实现的</p>
</blockquote>
</li>
<li>XDR（External Data Representation，外部数据表示法）是一个标准的数据压缩格式，可以表示基本的数据类型，也可以表示结构体。如图是几种基本数据类型，在 RPC 的调用过程中，所有的数据类型都要封装成类似的格式。<br>  <img src="https://static001.geekbang.org/resource/image/4a/af/4a649954fea1cee22fcfa8bdb34c03af.jpg" alt=""></li>
<li>无论是什么 RPC，底层都是 Socket 编程。</li>
<li>RPC 的调用和结果返回，也有严格的格式。<br>  <img src="https://static001.geekbang.org/resource/image/c7/65/c724675527afdbd43964bdf24684fa65.jpg" alt=""><ul>
<li>XID 唯一标识一对请求和回复。请求为 0，回复为 1。</li>
<li>RPC 有版本号，两端要匹配 RPC 协议的版本号。如果不匹配，就会返回 Deny，原因就是 RPC_MISMATCH。</li>
<li>程序有编号。如果服务端找不到这个程序，就会返回 PROG_UNAVAIL。</li>
<li>程序有版本号。如果程序的版本号不匹配，就会返回 PROG_MISMATCH。</li>
<li>一个程序可以有多个方法，方法也有编号，如果找不到方法，就会返回 PROC_UNAVAIL。</li>
<li>调用需要认证鉴权，如果不通过，则 Deny。</li>
<li>最后是参数列表，如果参数无法解析，则返回 GABAGE_ARGS。</li>
</ul>
</li>
<li>在客户端和服务端实现 RPC 的时候，首先要定义一个双方都认可的程序、版本、方法、参数等。下图是一个加法操作的协定。<br>  <img src="https://static001.geekbang.org/resource/image/5c/58/5c3ebb31ac4415d7895247bf8758fa58.jpg" alt=""></li>
<li>有了协议定义文件，ONC RPC 会提供一个工具，根据这个文件生成客户端和服务器端的 Stub 程序。<br>  <img src="https://static001.geekbang.org/resource/image/27/b9/27dc1ccd0481408055c87e0e5d8b02b9.jpg" alt=""></li>
<li>最下层的是 XDR 文件，用于编码和解码参数。这个文件是客户端和服务端共享的，因为只有双方一致才能成功通信。</li>
<li>最后依照本例中的加法操作说明一下调用流程<ol>
<li>在客户端，会调用 clnt_create 创建一个连接，然后调用 add_1，这是一个 Stub 函数，感觉是在调用本地一样。</li>
<li>Stub 函数 add_1 发起了一个 RPC 调用，通过调用 clnt_call 来调用 ONC RPC 的类库，来真正发送请求。</li>
<li>服务端也有一个 Stub 程序，监听客户端的请求，当调用到达的时候，判断如果是 add，则调用真正的服务端逻辑，也即将两个数加起来。</li>
<li>服务端将结果返回服务端的 Stub，这个 Stub 程序发送结果给客户端。</li>
<li>当结果到达客户端 Stub，就将结果返回给客户端的应用程序，从而完成整个调用过程。</li>
</ol>
</li>
</ul>
<h4 id="服务发现问题"><a href="#服务发现问题" class="headerlink" title="服务发现问题"></a>服务发现问题</h4><p><img src="https://static001.geekbang.org/resource/image/2a/7c/2aff190d1f878749d2a5bd73228ca37c.jpg" alt=""><br>在 ONC RPC 中，服务发现是通过 portmapper 实现的。</p>
<ul>
<li>portmapper 会启动在一个众所周知的端口上。</li>
<li>RPC 程序启动的时候，会向 portmapper 注册。<blockquote>
<p>RPC 程序由于是用户自己写的，会监听在一个随机端口上。</p>
</blockquote>
</li>
<li>客户端要访问 RPC 服务端这个程序的时候，首先查询 portmapper，获取 RPC 服务端程序的端口，然后向这个随机端口建立连接，开始 RPC 调用。<blockquote>
<p>从图中可以看出，mount 命令的 RPC 调用，就是这样实现的。</p>
</blockquote>
</li>
</ul>
<h4 id="传输问题"><a href="#传输问题" class="headerlink" title="传输问题"></a>传输问题</h4><p><img src="https://static001.geekbang.org/resource/image/33/e4/33e1afe4a79e81096e09b850424930e4.jpg" alt=""><br>ONC RPC 的类库实现了错误、重传、丢包、性能等功能，只需调用即可。在这个类库中，为了解决传输问题，对于每一个客户端，都会创建一个传输管理层，而每一次 RPC 调用，都会是一个任务，在传输管理层，你可以看到熟悉的队列机制、拥塞窗口机制等。</p>
<hr>
<h2 id="第33讲-基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛"><a href="#第33讲-基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛" class="headerlink" title="第33讲 | 基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛"></a>第33讲 | 基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛</h2><h4 id="ONC-RPC-存在哪些问题？"><a href="#ONC-RPC-存在哪些问题？" class="headerlink" title="ONC RPC 存在哪些问题？"></a>ONC RPC 存在哪些问题？</h4><ul>
<li>需要双方的压缩格式完全一致</li>
<li>协议修改不灵活<ul>
<li>业务逻辑变化后，需要双方都知晓，并重新生成 Stub 程序。</li>
</ul>
</li>
<li>版本问题<ul>
<li>一旦某个用户有新的需求，则整个服务端的程序也要做对应的调整，同时，已经部署的其他用户（客户端）也需要升级到新版本。</li>
</ul>
</li>
<li>ONC RPC 的设计明显是面向函数的，而非面向对象<ul>
<li>这需要客户端和服务端的开发人员密切沟通，相互合作，有大量的共同语言，才能按照既定的协议顺畅地进行工作。</li>
<li>对于面向过程与面向对象的区别，这里以 XML 格式来举例  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">order</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">date</span>&gt;</span>2018-07-01<span class="tag">&lt;/<span class="name">date</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">className</span>&gt;</span> 趣谈网络协议 <span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Author</span>&gt;</span> 刘超 <span class="tag">&lt;/<span class="name">Author</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">price</span>&gt;</span>68<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>date，className 等参数的顺序没有固定要求</li>
<li>如果需要添加参数 count，值为 10，只需要添加一行 <code>&lt;count&gt;10&lt;/count&gt;</code> 即可，而且对于不需要该参数的客户端，不解析这个参数即可。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="传输协议问题与-SOAP"><a href="#传输协议问题与-SOAP" class="headerlink" title="传输协议问题与 SOAP"></a>传输协议问题与 SOAP</h4><p>SOAP 是一个基于 XML 的通信协议，全称简单对象访问协议（Simple Object Access Protocol）。它使用 XML 编写简单的请求和回复消息，并用 HTTP 协议进行传输。</p>
<p>SOAP 将请求和回复放在一个信封里面，就像传递一个邮件一样。信封里面的信分抬头和正文。</p>
<ul>
<li>抬头  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /purchaseOrder HTTP/1.1</span><br><span class="line">Host: www.geektime.com</span><br><span class="line">Content-Type: application/soap+xml; charset=utf-8</span><br><span class="line">Content-Length: nnn</span><br></pre></td></tr></table></figure></li>
<li>正文  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:Envelope</span> <span class="attr">xmlns:soap</span>=<span class="string">"http://www.w3.org/2001/12/soap-envelope"</span></span></span><br><span class="line"><span class="tag"><span class="attr">soap:encodingStyle</span>=<span class="string">"http://www.w3.org/2001/12/soap-encoding"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soap:Header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m:Trans</span> <span class="attr">xmlns:m</span>=<span class="string">"http://www.w3schools.com/transaction/"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">soap:mustUnderstand</span>=<span class="string">"1"</span>&gt;</span>1234</span><br><span class="line">        <span class="tag">&lt;/<span class="name">m:Trans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soap:Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soap:Body</span> <span class="attr">xmlns:m</span>=<span class="string">"http://www.geektime.com/perchaseOrder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">m:purchaseOrder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">order</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">date</span>&gt;</span>2018-07-01<span class="tag">&lt;/<span class="name">date</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">className</span>&gt;</span> 趣谈网络协议 <span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Author</span>&gt;</span> 刘超 <span class="tag">&lt;/<span class="name">Author</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">price</span>&gt;</span>68<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">m:purchaseOrder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="协议约定问题-1"><a href="#协议约定问题-1" class="headerlink" title="协议约定问题"></a>协议约定问题</h4><p>可以通过 Web 服务描述语言，WSDL（Web Service Description Languages）来说明协议约定。WSDL 也是一个 XML 文件。</p>
<ul>
<li>WSDL 的优点<ul>
<li>对于某个服务，可以通过在服务地址后面加上“?wsdl”来获取到这个文件。</li>
<li>WSDL 可以通过工具生成</li>
<li>也有工具可以根据 WSDL 生成客户端 Stub，让客户端通过 Stub 进行远程调用，就跟调用本地的方法一样。</li>
</ul>
</li>
<li>WSDL 的格式如下<ul>
<li>定义一个类型 order，与上面的 XML 对应起来  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wsdl:types</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">targetNamespace</span>=<span class="string">"http://www.example.org/geektime"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsd:complexType</span> <span class="attr">name</span>=<span class="string">"order"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"date"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>&gt;</span><span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"className"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>&gt;</span><span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"Author"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>&gt;</span><span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"price"</span> <span class="attr">type</span>=<span class="string">"xsd:int"</span>&gt;</span><span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:types</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>定义一个 message 的结构  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wsdl:message</span> <span class="attr">name</span>=<span class="string">"purchase"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:part</span> <span class="attr">name</span>=<span class="string">"purchaseOrder"</span> <span class="attr">element</span>=<span class="string">"tns:order"</span>&gt;</span><span class="tag">&lt;/<span class="name">wsdl:part</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:message</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>暴露一个端口  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wsdl:portType</span> <span class="attr">name</span>=<span class="string">"PurchaseOrderService"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"purchase"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:input</span> <span class="attr">message</span>=<span class="string">"tns:purchase"</span>&gt;</span><span class="tag">&lt;/<span class="name">wsdl:input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:output</span> <span class="attr">message</span>=<span class="string">"......"</span>&gt;</span><span class="tag">&lt;/<span class="name">wsdl:output</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:portType</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>编写一个 binding，将上面定义的信息绑定到 SOAP 请求的 body 里面  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wsdl:binding</span> <span class="attr">name</span>=<span class="string">"purchaseOrderServiceSOAP"</span> <span class="attr">type</span>=<span class="string">"tns:PurchaseOrderService"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:binding</span> <span class="attr">style</span>=<span class="string">"rpc"</span></span></span><br><span class="line"><span class="tag"><span class="attr">transport</span>=<span class="string">"http://schemas.xmlsoap.org/soap/http"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:operation</span> <span class="attr">name</span>=<span class="string">"purchase"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:input</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:input</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:output</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">soap:body</span> <span class="attr">use</span>=<span class="string">"literal"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:output</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:operation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:binding</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>编写 service  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">wsdl:service</span> <span class="attr">name</span>=<span class="string">"PurchaseOrderServiceImplService"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">wsdl:port</span> <span class="attr">binding</span>=<span class="string">"tns:purchaseOrderServiceSOAP"</span> <span class="attr">name</span>=<span class="string">"PurchaseOrderServiceImplPort"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:address</span> <span class="attr">location</span>=<span class="string">"http://www.geektime.com:8080/purchaseOrder"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">wsdl:service</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h4 id="服务发现问题-1"><a href="#服务发现问题-1" class="headerlink" title="服务发现问题"></a>服务发现问题</h4><p>UDDI（Universal Description, Discovery, and Integration），也即统一描述、发现和集成协议。它其实是一个注册中心，服务提供方可以将上面的 WSDL 描述文件，发布到这个注册中心，注册完毕后，服务使用方可以查找到服务的描述，封装为本地的客户端进行调用。</p>
<hr>
<h2 id="第34讲-基于JSON的RESTful接口协议：我不关心过程，请给我结果"><a href="#第34讲-基于JSON的RESTful接口协议：我不关心过程，请给我结果" class="headerlink" title="第34讲 | 基于JSON的RESTful接口协议：我不关心过程，请给我结果"></a>第34讲 | 基于JSON的RESTful接口协议：我不关心过程，请给我结果</h2><h4 id="SOAP-的问题"><a href="#SOAP-的问题" class="headerlink" title="SOAP 的问题"></a>SOAP 的问题</h4><p>无论 XML 中调用的是什么函数，多是通过 HTTP 的 POST 方法发送的。这就浪费了 HTTP 其他方法以及他们本身附带的意义。</p>
<h4 id="传输协议问题与-RESTful-格式的-API"><a href="#传输协议问题与-RESTful-格式的-API" class="headerlink" title="传输协议问题与 RESTful 格式的 API"></a>传输协议问题与 RESTful 格式的 API</h4><p>RESTful 是一种架构风格，全称 Representational State Transfer，表述性状态转移。</p>
<p>对于之前 SOAP 中的提交订单操作，使用 RESTful 风格 API 可以改写为如下的形式。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /purchaseOrder HTTP/1.1</span><br><span class="line">Host: www.geektime.com</span><br><span class="line">Content-Type: application/xml; charset=utf-8</span><br><span class="line">Content-Length: nnn</span><br><span class="line"> </span><br><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">order</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">date</span>&gt;</span>2018-07-01<span class="tag">&lt;/<span class="name">date</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">className</span>&gt;</span> 趣谈网络协议 <span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">Author</span>&gt;</span> 刘超 <span class="tag">&lt;/<span class="name">Author</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">price</span>&gt;</span>68<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">order</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="协议约定问题（对比-REST-RESTful-与-SOAP）"><a href="#协议约定问题（对比-REST-RESTful-与-SOAP）" class="headerlink" title="协议约定问题（对比 REST/RESTful 与 SOAP）"></a>协议约定问题（对比 REST/RESTful 与 SOAP）</h4><p>RESTful API 使用 JSON 进行协议约定。如上的请求可以改写为如下的形式。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /purchaseOrder HTTP/1.1</span><br><span class="line">Host: www.geektime.com</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Content-Length: nnn</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line"> "order": &#123;</span><br><span class="line">  "date": "2018-07-01",</span><br><span class="line">  "className": " 趣谈网络协议 ",</span><br><span class="line">  "Author": " 刘超 ",</span><br><span class="line">  "price": "68"</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面对比一下 REST 与 SOAP</p>
<ul>
<li>REST 是一种设计风格，一种架构，SOAP 是一种严格规定的标准<ul>
<li>如果按照 REST 风格进行设计，RESTful 接口和 SOAP 接口都能做到，只不过后面的架构是 REST 倡导的，而 SOAP 相对比较关注前面的接口。</li>
</ul>
</li>
<li>REST 倾向于客户端记录业务状态，SOAP 则并不关心谁来记录状态<ul>
<li>SOAP 在设计之初便能够通过 WSDL 生成客户端的 Stub，因而 SOAP 常常被用于类似传统的 RPC 方式，也即调用远端和调用本地是一样的。这就导致 SOAP 并不太关心谁来记录状态。这在 SOAP 出现的年代是可以的，因为服务端与客户端的比例并未失衡。但在互联网时代，服务端可能需要记录数以千万记的客户端的状态。</li>
<li>REST 倾向于服务端的无状态化，即让客户端记录状态。<blockquote>
<p>比如要访问一个当前文件夹下的文件列表，服务端记录状态则是服务端记录客户端当前所在的文件夹路径；客户端记录状态则是自己记录当前所在的文件夹路径，并将之提交给服务端。</p>
<p>这里需要区分资源状态与业务逻辑状态，上述的例子是业务逻辑状态，交由客户端自己处理，而资源状态，比如文件夹有哪些，结构如何，还是需要服务端来记录。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="服务发现问题-2"><a href="#服务发现问题-2" class="headerlink" title="服务发现问题"></a>服务发现问题</h4><p>我们可以使用一些框架来解决服务发现的问题，这里以 Spring Cloud 举例。Spring Cloud 是一个基于 RESTful API 的跨系统调用框架。</p>
<ul>
<li>在 Spring Cloud 中有一个组件叫 Eureka，用来实现注册中心，负责维护注册的服务列表。<ul>
<li>服务提供方向 Eureka 做服务注册、续约和下线等操作，注册的主要数据包括服务名、机器 IP、端口号、域名等等。为了实现负载均衡和容错，服务提供方可以注册多个。</li>
<li>服务消费方向 Eureka 获取服务提供方的注册信息，即获取可以调用的服务。</li>
</ul>
</li>
<li>服务消费方可以使用 RestTemplate 工具进行服务调用。RestTemplate 是 Spring Cloud 提供的一个工具，用于将请求对象转换为 JSON，并发起 Rest 调用，RestTemplate 的调用也是分 POST、PUT、GET、 DELETE 的，当结果返回的时候，根据返回的 JSON 解析成对象。</li>
</ul>
<hr>
<h2 id="第35讲-二进制类RPC协议：还是叫NBA吧，总说全称多费劲"><a href="#第35讲-二进制类RPC协议：还是叫NBA吧，总说全称多费劲" class="headerlink" title="第35讲 | 二进制类RPC协议：还是叫NBA吧，总说全称多费劲"></a>第35讲 | 二进制类RPC协议：还是叫NBA吧，总说全称多费劲</h2><h4 id="数据中心内部是如何相互调用的？"><a href="#数据中心内部是如何相互调用的？" class="headerlink" title="数据中心内部是如何相互调用的？"></a>数据中心内部是如何相互调用的？</h4><p><img src="https://static001.geekbang.org/resource/image/f0/b8/f08ef51889add2c26c57c9edd3db93b8.jpg" alt=""></p>
<ul>
<li>数据中心架构<ul>
<li>对于微服务的架构，API 需要一个 API 网关统一的管理。API 的实现一般在一个叫作Controller 层的地方。这一层对外提供 API。在 Controller 之内，就是互联网应用的业务逻辑实现。<blockquote>
<p>由于是让陌生人访问的，我们能看到目前业界主流的，基本都是 RESTful 的 API，是面向大规模互联网应用的。</p>
</blockquote>
</li>
<li>资源的状态应该维护在最底层的持久化层，一般会使用分布式数据库和 ElasticSearch。</li>
<li>由于硬盘读写性能差，因而持久化层往往吞吐量不能达到互联网应用要求的吞吐量，因而前面要有一层缓存层，使用 Redis 或者 memcached 将请求拦截一道。</li>
<li>缓存和持久化层之上一般是基础服务层，这里面提供一些原子化的接口。例如，对于用户、商品、订单、库存的增删查改，将缓存和数据库对再上层的业务逻辑屏蔽一道。<ul>
<li>有了这一层，上层业务逻辑看到的都是接口，而不会调用数据库和缓存。</li>
<li>对于缓存层的扩容，数据库的分库分表，所有的改变，都截止到这一层，这样有利于将来对于缓存和数据库的运维。</li>
</ul>
</li>
<li>再往上就是组合层。因为基础服务层只是提供简单的接口，实现简单的业务逻辑，而复杂的业务逻辑，比如下单，要扣优惠券，扣减库存等，就要在组合服务层实现。</li>
</ul>
</li>
<li>数据中心内部的调用<ul>
<li>按照上面的结构，Controller 层、组合服务层、基础服务层就会相互调用，这个调用是在数据中心内部的，量也会比较大，还是使用 RPC 的机制实现的。</li>
<li>由于服务比较多，需要一个单独的注册中心来做服务发现。服务提供方会将自己提供哪些服务注册到注册中心中去，同时服务消费方订阅这个服务，从而可以对这个服务进行调用。</li>
<li>这里的 RPC 调用，大多数的选择是使用二进制的方案。因为二进制方案相比文本方案更加省空间和带宽，相应的效能也更好。</li>
</ul>
</li>
</ul>
<h4 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h4><p>Dubbo 是一个服务框架，其内部实现使用了二进制的 RPC 方式。<br><img src="https://static001.geekbang.org/resource/image/c6/c2/c622af64f47e264453088e79c3e631c2.jpg" alt=""></p>
<ul>
<li>Dubbo 会在客户端的本地启动一个 Proxy，其实就是客户端的 Stub，对于远程的调用都通过这个 Stub 进行封装。</li>
<li>接下来，Dubbo 会从注册中心获取服务端的列表，根据路由规则和负载均衡规则，在多个服务端中选择一个最合适的服务端进行调用。</li>
<li>调用服务端的时候，首先要进行编码和序列化，形成 Dubbo 头和序列化的方法和参数。将编码好的数据，交给网络客户端进行发送。</li>
<li>网络服务端收到消息后，进行解码。然后将任务分发给某个线程进行处理，在线程中会调用服务端的代码逻辑，然后返回结果。</li>
</ul>
<h4 id="Dubbo-如何解决-RPC-三大问题？"><a href="#Dubbo-如何解决-RPC-三大问题？" class="headerlink" title="Dubbo 如何解决 RPC 三大问题？"></a>Dubbo 如何解决 RPC 三大问题？</h4><ul>
<li>协议约定问题: Dubbo 中默认的 RPC 协议是 Hessian2<ul>
<li>Hessian2 将远程调用序列化为二进制进行传输，并且可以进行一定的压缩。</li>
<li>Hessian2 不需要定义这个协议文件，而是自描述的。<ul>
<li>原来要定义一个协议文件，然后通过这个文件生成客户端和服务端的 Stub，才能进行相互调用，这样使得修改就会不方便。</li>
<li>所谓自描述就是，关于调用哪个函数，参数是什么，另一方不需要拿到某个协议文件、拿到二进制，靠它本身根据 Hessian2 的规则，就能解析出来。<blockquote>
<p>这其实相当于综合了 XML 和二进制的共同优势。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li>RPC 传输问题: Dubbo 默认使用 Netty 的网络传输框架。<ul>
<li>Netty 是一个非阻塞的基于事件的网络传输框架，在服务端启动的时候，会监听一个端口，并注册以下的事件。<ul>
<li>连接事件：当收到客户端的连接事件时，会调用 void connected(Channel channel) 方法。</li>
<li>可写事件：当可写事件触发时，会调用 void sent(Channel channel, Object message)，服务端向客户端返回响应数据。</li>
<li>可读事件：当可读事件触发时，会调用 void received(Channel channel, Object message) ，服务端在收到客户端的请求数据。</li>
<li>发生异常：当发生异常时，会调用 void caught(Channel channel, Throwable exception)。</li>
</ul>
</li>
<li>当事件触发之后，服务端可以选择直接在这个函数里面进行操作，还是将请求分发到线程池去处理。一般异步的数据读写都需要另外的线程池参与，在线程池中会调用真正的服务端业务代码逻辑，返回结果。<blockquote>
<p>Dubbox 还有其他的 RPC 协议选择，例如从 Spark 那里借鉴 Kryo，实现高性能的序列化。</p>
</blockquote>
</li>
</ul>
</li>
<li>注册发现问题: 通过注册中心解决</li>
</ul>
<h4 id="为何-Spring-Cloud-又兴起了？"><a href="#为何-Spring-Cloud-又兴起了？" class="headerlink" title="为何 Spring Cloud 又兴起了？"></a>为何 Spring Cloud 又兴起了？</h4><p>Dubbox 等基于二进制 RPC 协议的服务端框架存在的问题</p>
<ul>
<li>Dubbox 等方案，接口的定义，以及传的对象 DTO，还是需要共享 JAR。因为只有客户端和服务端都有这个 JAR，才能成功地序列化和反序列化。</li>
<li>并发量越来越大，微服务粒度更细，模块之间的关系更加复杂，JAR 的依赖也变得异常复杂，难以维护。</li>
</ul>
<p>上述问题的解决方案主要有以下两种，一般结合实际场景进行选择。</p>
<ul>
<li>方案1: 建立严格的项目管理流程<ul>
<li>不允许循环调用，不允许跨层调用，只准上层调用下层，不允许下层调用上层。</li>
<li>接口要保持兼容性，不兼容的接口新添加而非改原来的，当接口通过监控，发现不用的时候，再下掉。</li>
<li>升级的时候，先升级服务提供端，再升级服务消费端。</li>
</ul>
</li>
<li>方案2: 改用 RESTful 的方式<ul>
<li>使用 Spring Cloud，消费端和提供端不用共享 JAR，各声明各的，只要能变成 JSON 就行，而且 JSON 也是比较灵活的。</li>
<li>使用 RESTful 的方式，性能会降低，所以需要通过横向扩展来抵消单机的性能损耗。</li>
</ul>
</li>
</ul>
<hr>
<h2 id="第36讲-跨语言类RPC协议：交流之前，双方先来个专业术语表"><a href="#第36讲-跨语言类RPC协议：交流之前，双方先来个专业术语表" class="headerlink" title="第36讲 | 跨语言类RPC协议：交流之前，双方先来个专业术语表"></a>第36讲 | 跨语言类RPC协议：交流之前，双方先来个专业术语表</h2><h4 id="前文-RPC-内容总结"><a href="#前文-RPC-内容总结" class="headerlink" title="前文 RPC 内容总结"></a>前文 RPC 内容总结</h4><p>四种框架</p>
<ul>
<li>ONC RPC</li>
<li>基于 XML 的 SOAP</li>
<li>基于 JSON 的 RESTful</li>
<li>基于 JSON 的 Hessian2</li>
</ul>
<p>一个 RPC 框架中，各处细节实现的选择与差别</p>
<ul>
<li>传输数据格式<ul>
<li>二进制的性能好，但难以跨语言</li>
<li>文本的性能差，但可以跨语言</li>
</ul>
</li>
<li>是否需要文件协议<ul>
<li>写文件协议的严谨一些，但不灵活</li>
<li>不写文件协议的不太严谨，但灵活</li>
</ul>
</li>
<li>服务发现机制<ul>
<li>有些可以服务治理</li>
<li>有些不能服务治理</li>
</ul>
</li>
</ul>
<p>对 RPC 框架的要求越来越多，具体细节如下</p>
<ul>
<li>传输性能很重要。还是二进制的越快越好。</li>
<li>跨语言很重要。服务多了，什么语言写成的都有，而且不同的场景适宜用不同的语言，不能一个语言走到底。</li>
<li>最好既严谨又灵活，添加个字段不用重新编译和发布程序。</li>
<li>最好既有服务发现，也有服务治理。就像 Dubbo 和 Spring Cloud 一样。</li>
</ul>
<h4 id="Protocol-Buffers"><a href="#Protocol-Buffers" class="headerlink" title="Protocol Buffers"></a>Protocol Buffers</h4><p>GRPC 满足二进制和跨语言这两条，它通过一个协议约定文件来实现这两点的共存。对于 GRPC 来讲，二进制序列化协议是 Protocol Buffers。</p>
<p>这里以购买极客时间专栏来举例说明 Protocol Buffers 格式，其协议文件后缀名为 .proto。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax &#x3D; “proto3”;</span><br><span class="line">package com.geektime.grpc</span><br><span class="line">option java_package &#x3D; “com.geektime.grpc”;</span><br><span class="line">message Order &#123;</span><br><span class="line">required string date &#x3D; 1;</span><br><span class="line">required string classname &#x3D; 2;</span><br><span class="line">required string author &#x3D; 3;</span><br><span class="line">required int price &#x3D; 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message OrderResponse &#123;</span><br><span class="line">required string message &#x3D; 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service PurchaseOrder &#123;</span><br><span class="line">rpc Purchase (Order) returns (OrderResponse) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>首先指定使用 proto3 的语法</li>
<li>使用 Protocol Buffers 的语法，定义两个消息的类型<ul>
<li>一个是发出去的参数，一个是返回的结果</li>
<li>里面的每一个字段，例如 date、classname、author、price 都有唯一的一个数字标识，这样在压缩的时候，就不用传输字段名称了，只传输这个数字标识就行了，能节省很多空间。</li>
</ul>
</li>
<li>定义一个 Service，里面会有一个 RPC 调用的声明。<blockquote>
<p>无论使用什么语言，都有相应的工具生成客户端和服务端的 Stub 程序，这样客户端就可以像调用本地一样，调用远程的服务了。</p>
</blockquote>
</li>
</ul>
<h4 id="协议约定问题-2"><a href="#协议约定问题-2" class="headerlink" title="协议约定问题"></a>协议约定问题</h4><p>Protocol Buffers 考虑了兼容性。在协议文件中，每一个字段都有修饰符。比如：</p>
<ul>
<li>required：这个值不能为空，一定要有这么一个字段出现</li>
<li>optional：可选字段，可以设置，也可以不设置，如果不设置，则使用默认值</li>
<li>repeated：可以重复 0 到多次</li>
</ul>
<p>如果我们想修改协议文件</p>
<ul>
<li>对于赋给某个标签的数字，不允许改变，改变了就不认了</li>
<li>不能添加或者删除 required 字段，因为解析的时候，发现没有这个字段就会报错</li>
<li>对于 optional 和 repeated 字段，可以删除，也可以添加。这就给了客户端和服务端升级的可能性。</li>
</ul>
<p>例如，我们在协议里面新增一个 string recommended 字段，表示这个课程是谁推荐的，就将这个字段设置为 optional。</p>
<ul>
<li>可以先升级服务端，当客户端发过来消息的时候，是没有这个值的，将它设置为一个默认值。</li>
<li>也可以先升级客户端，当客户端发过来消息的时候，是有这个值的，那它将被服务端忽略。</li>
</ul>
<h4 id="网络传输问题"><a href="#网络传输问题" class="headerlink" title="网络传输问题"></a>网络传输问题</h4><p>如果是 Java 技术栈，GRPC 的客户端和服务器之间通过 Netty Channel 作为数据通道，每个请求都被封装成 HTTP 2.0 的 Stream。</p>
<p>由于基于 HTTP 2.0，GRPC 和其他的 RPC 不同，可以定义四种服务方法。</p>
<ul>
<li>单向 RPC，即客户端发送一个请求给服务端，从服务端获取一个应答。</li>
<li>服务端流式 RPC，即服务端返回的不是一个结果，而是一批。客户端发送一个请求给服务端，可获取一个数据流用来读取一系列消息。客户端从返回的数据流里一直读取，直到没有更多消息为止。</li>
<li>客户端流式 RPC，也即客户端的请求不是一个，而是一批。客户端用提供的一个数据流写入并发送一系列消息给服务端。一旦客户端完成消息写入，就等待服务端读取这些消息并返回应答。</li>
<li>双向流式 RPC，即两边都可以分别通过一个读写数据流来发送一系列消息。这两个数据流操作是相互独立的，所以客户端和服务端能按其希望的任意顺序读写，服务端可以在写应答前等待所有的客户端消息，或者它可以先读一个消息再写一个消息，或者读写相结合的其他方式。每个数据流里消息的顺序会被保持。</li>
</ul>
<h4 id="服务发现与治理问题"><a href="#服务发现与治理问题" class="headerlink" title="服务发现与治理问题"></a>服务发现与治理问题</h4><p>GRPC 本身没有提供服务发现的机制，需要借助其他的组件，发现要访问的服务端，在多个服务端之间进行容错和负载均衡，比如 Envoy。</p>
<p>Envoy 不仅仅是负载均衡器，它还是一个高性能的 C++ 写的 Proxy 转发器，可以配置非常灵活的转发规则。</p>
<ul>
<li>Envoy 支持两种规则配置方式<ul>
<li>静态配置规则<ul>
<li>规则放在配置文件中的，在启动的时候加载。要想重新加载，一般需要重新启动，但是 Envoy 支持热加载和热重启，这在一定程度上缓解了这个问题。</li>
<li>使用方式: 将后端的服务端的 IP 地址拿到，然后放在配置文件里面就可以了。</li>
</ul>
</li>
<li>动态配置规则<ul>
<li>规则放在统一的地方维护，这个统一的地方在 Envoy 眼中被称为服务发现（Discovery Service），过一段时间去这里拿一下配置，就修改了转发策略。</li>
<li>使用方式: 需要配置一个服务发现中心，这个服务发现中心要实现 Envoy 的 API，Envoy 可以主动去服务发现中心拉取转发策略。<br>  <img src="https://static001.geekbang.org/resource/image/ef/ce/ef916f46dc293ac2d5739b496f0b27ce.jpg" alt=""></li>
</ul>
</li>
</ul>
</li>
<li>无论是静态的，还是动态的，在配置里面往往会配置四个东西。<ul>
<li>listener。Envoy 既然是 Proxy，专门做转发，就得监听一个端口，接入请求，然后才能够根据策略转发，这个监听的端口就称为 listener。</li>
<li>endpoint，是目标的 IP 地址和端口。这个是 Proxy 最终将请求转发到的地方。</li>
<li>cluster。一个 cluster 是具有完全相同行为的多个 endpoint，也即如果有三个服务端在运行，就会有三个 IP 和端口，但是部署的是完全相同的三个服务，它们组成一个 cluster，从 cluster 到 endpoint 的过程称为负载均衡，可以轮询。</li>
<li>第四个是 route。有时候多个 cluster 具有类似的功能，但是是不同的版本号，可以通过 route 规则，选择将请求路由到某一个版本号，也即某一个 cluster。</li>
</ul>
</li>
<li>常见的几种 Envoy 配置使用场景<ul>
<li>配置路由策略。例如后端的服务有两个版本，可以通过配置 Envoy 的 route，来设置两个版本之间，也即两个 cluster 之间的 route 规则，一个占 99% 的流量，一个占 1% 的流量。</li>
<li>负载均衡策略。对于一个 cluster 下的多个 endpoint，可以配置负载均衡机制和健康检查机制，当服务端新增了一个，或者挂了一个，都能够及时配置 Envoy，进行负载均衡。<br>  <img src="https://static001.geekbang.org/resource/image/50/3c/50443d6848f890e475e71be11489d33c.jpg" alt=""><blockquote>
<p>所有这些节点的变化都会上传到注册中心，所有这些策略都可以通过注册中心进行下发，所以，更严格的意义上讲，注册中心可以称为注册治理中心。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p>Envoy 能够将服务之间的相互调用全部由它代理，这就是未来服务治理的趋势Serivce Mesh。<br><img src="https://static001.geekbang.org/resource/image/15/02/15e254a8e92e031b20feb6ebdcc32402.jpg" alt=""></p>
<ul>
<li>服务不需要自己感知到注册中心，自己注册，自己治理，这对应用干预比较大。</li>
<li>应用能够意识不到服务治理的存在，就是直接进行 GRPC 的调用就可以了。</li>
</ul>
<hr>
<h2 id="第37讲-知识串讲：用双十一的故事串起碎片的网络协议（上）"><a href="#第37讲-知识串讲：用双十一的故事串起碎片的网络协议（上）" class="headerlink" title="第37讲 | 知识串讲：用双十一的故事串起碎片的网络协议（上）"></a>第37讲 | 知识串讲：用双十一的故事串起碎片的网络协议（上）</h2><h4 id="一-部署一个高可用高并发的电商平台"><a href="#一-部署一个高可用高并发的电商平台" class="headerlink" title="一. 部署一个高可用高并发的电商平台"></a>一. 部署一个高可用高并发的电商平台</h4><p>首先，要有个电商平台。这里假设已经有了一个特别大的电商平台。</p>
<ol>
<li>为了高可用性，需要在公有云上部署多个机房，形成多个可用区（Available Zone）。<br> <img src="https://static001.geekbang.org/resource/image/ed/20/eddde5929de2a72b197321e5ad87e120.jpg" alt=""></li>
<li>每个可用区里有一片一片的机柜，每个机柜上有一排一排的服务器，每个机柜都有一个接入交换机，有一个汇聚交换机将多个机柜连在一起。这些服务器里面部署的都是计算节点，每台上面都有 Open vSwitch 创建的虚拟交换机，将来在这台机器上创建的虚拟机，都会连到 Open vSwitch 上。<br> <img src="https://static001.geekbang.org/resource/image/d6/a7/d66c01c39e911e784525a118c37b50a7.jpg" alt=""></li>
<li>在云计算的界面上创建一个 VPC（Virtual Private Cloud，虚拟私有网络），指定一个 IP 段，以后部署的所有应用都会在这个虚拟网络里，使用分配的这个 IP 段。<ul>
<li>为了不同的 VPC 相互隔离，每个 VPC 都会被分配一个 VXLAN 的 ID。尽管不同用户的虚拟机有可能在同一个物理机上，但是不同的 VPC 二层压根儿是不通的。</li>
<li>由于有两个可用区，在这个 VPC 里面，要为每一个可用区分配一个 Subnet，也就是在大的网段里分配两个小的网段。当两个可用区里面网段不同的时候，就可以配置路由策略，访问另外一个可用区，走某一条路由了。</li>
</ul>
</li>
<li>创建数据库持久化层。大部分云平台都会提供 PaaS 服务，不需要自己搭建数据库，而是采用直接提供数据库的服务，并且单机房的主备切换都是默认做好的，数据库也是部署在虚拟机里面的，只不过从界面上，你看不到数据库所在的虚拟机而已。<ul>
<li>云平台会给每个 Subnet 的数据库实例分配一个域名。创建数据库实例的时候，需要你指定可用区和 Subnet，这样创建出来的数据库实例可以通过这个 Subnet 的私网 IP 进行访问。</li>
<li>为了分库分表实现高并发的读写，在创建的多个数据库实例之上，会创建一个分布式数据库的实例，也需要指定可用区和 Subnet，还会为分布式数据库分配一个私网 IP 和域名。</li>
<li>对于数据库这种高可用性比较高的，需要进行跨机房高可用，因而两个可用区都要部署一套，但是只有一个是主，另外一个是备，云平台往往会提供数据库同步工具，将应用写入主的数据同步给备数据库集群。</li>
</ul>
</li>
<li>创建缓存集群。云平台也会提供 PaaS 服务，也需要每个可用区和 Subnet 创建一套，缓存的数据在内存中，由于读写性能要求高，一般不要求跨可用区读写。</li>
<li>自己编写的程序。基础服务层、组合服务层、Controller 层，以及 Nginx 层、API 网关等等，这些都是部署在虚拟机里面的。它们之间通过 RPC 相互调用，需要到注册中心进行注册。<ul>
<li>它们之间的网络通信是虚拟机和虚拟机之间的。如果是同一台物理机，则那台物理机上的 OVS 就能转发过去；如果是不同的物理机，这台物理机的 OVS 和另一台物理机的 OVS 中间有一个 VXLAN 的隧道，将请求转发过去。</li>
</ul>
</li>
<li>负载均衡，也是云平台提供的 PaaS 服务。<ul>
<li>负载均衡也是部署在虚拟机里面的，属于 VPC。<ul>
<li>负载均衡有个外网的 IP，这个外网的 IP 地址在网关节点的外网网口上。</li>
<li>在网关节点上，会有 NAT 规则，将外网 IP 地址转换为 VPC 里面的私网 IP 地址，通过这些私网 IP 地址访问到虚拟机上的负载均衡节点，然后通过负载均衡节点转发到 API 网关的节点。</li>
<li>网关节点的外网网口是带公网 IP 地址的，里面有一个虚拟网关转发模块，还会有一个 OVS，将私网 IP 地址放到 VXLAN 隧道里面，转发到虚拟机上，从而实现外网和虚拟机网络之间的互通。</li>
</ul>
</li>
<li>不同的可用区之间，通过核心交换机连在一起，核心交换机之外是边界路由器。在华北、华东、华南同样也部署了一整套，每个地区都创建了 VPC，这就需要有一种机制将 VPC 连接到一起。<ul>
<li>云平台一般会提供硬件的 VPC 互连的方式，当然也可以使用软件互连的方式，也就是使用 VPN 网关，通过 IPsec VPN 将不同地区的不同 VPC 通过 VPN 连接起来。</li>
<li>对于不同地区和不同运营商的用户，我们希望他能够就近访问到网站，而且当一个点出了故障之后，我们希望能够在不同的地区之间切换，这就需要有智能 DNS，这个也是云平台提供的。</li>
<li>对于一些静态资源，可以保持在对象存储里面，通过 CDN 下发到边缘节点，这样客户端就能尽快加载出来。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="二-大声告诉全世界，可以到我这里买东西"><a href="#二-大声告诉全世界，可以到我这里买东西" class="headerlink" title="二. 大声告诉全世界，可以到我这里买东西"></a>二. 大声告诉全世界，可以到我这里买东西</h4><p>当电商应用搭建完毕之后，接下来需要将如何访问到这个电商网站广播给全网。</p>
<p>对于多个可用区的情况，我们可以隐去计算节点的情况，将外网访问区域放大。外网 IP 是放在虚拟网关的外网网口上的，这个 IP 通过 BGP 路由协议让全世界知道。<br><img src="https://static001.geekbang.org/resource/image/e1/24/e132bc3ba500b1197139f30c02e20124.jpg" alt=""></p>
<ol>
<li>每个可用区都有自己的汇聚交换机，如果机器数目比较多，可以直接用核心交换机，每个 Region 也有自己的核心交换区域。</li>
<li>在核心交换外面是安全设备，然后就是边界路由器。</li>
<li>边界路由器会和多个运营商连接，从而每个运营商都能够访问到这个网站。边界路由器可以通过 BGP 协议，将自己数据中心里面的外网 IP 向外广播。<blockquote>
<p>每个运营商也有很多的路由器、很多的点，于是就可以将如何到达这些 IP 地址的路由信息，广播到全国乃至全世界。</p>
</blockquote>
</li>
</ol>
<h4 id="三-打开手机来上网，域名解析得地址"><a href="#三-打开手机来上网，域名解析得地址" class="headerlink" title="三. 打开手机来上网，域名解析得地址"></a>三. 打开手机来上网，域名解析得地址</h4><p><img src="https://static001.geekbang.org/resource/image/85/fc/85c125c225faba29c0f374e18ea8c6fc.jpg" alt=""></p>
<ol>
<li>客户的手机开机以后，在附近寻找基站 eNodeB，发送请求，申请上网。<ol>
<li>基站将请求发给 MME，MME 对手机进行认证和鉴权，还会请求 HSS 看有没有钱，看看是在哪里上网。</li>
<li>当 MME 通过了手机的认证之后，开始建立隧道，建设的数据通路分两段路，其实是两个隧道。一段是从 eNodeB 到 SGW，第二段是从 SGW 到 PGW，在 PGW 之外，就是互联网。</li>
<li>PGW 会为手机分配一个 IP 地址，手机上网都是带着这个 IP 地址的。</li>
</ol>
</li>
<li>当在手机上面打开一个 App 的时候，首先要做的事情就是解析这个网站的域名。<ul>
<li>在手机运营商所在的互联网区域里，有一个本地的 DNS，手机会向这个 DNS 请求解析 DNS。当这个 DNS 本地有缓存，则直接返回；如果没有缓存，本地 DNS 才需要递归地从根 DNS 服务器，查到.com 的顶级域名服务器，最终查到权威 DNS 服务器。</li>
<li>如果使用云平台，配置了智能 DNS 和全局负载均衡，在权威 DNS 服务中，一般是通过配置 CNAME 的方式，我们可以起一个别名，例如 vip.yourcomany.com ，然后告诉本地 DNS 服务器，让它请求 GSLB 解析这个域名，GSLB 就可以在解析这个域名的过程中，通过自己的策略实现负载均衡。</li>
<li>GSLB 通过查看请求它的本地 DNS 服务器所在的运营商和地址，就知道用户所在的运营商和地址，然后将距离用户位置比较近的 Region 里面，三个负载均衡 SLB 的公网 IP 地址，返回给本地 DNS 服务器。本地 DNS 解析器将结果缓存后，返回给客户端。</li>
<li>对于手机 App 来说，可以绕过刚才的传统 DNS 解析机制，直接只要 HTTPDNS 服务，通过直接调用 HTTPDNS 服务器，得到这三个 SLB 的公网 IP 地址。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="第38讲-知识串讲：用双十一的故事串起碎片的网络协议（中）"><a href="#第38讲-知识串讲：用双十一的故事串起碎片的网络协议（中）" class="headerlink" title="第38讲 | 知识串讲：用双十一的故事串起碎片的网络协议（中）"></a>第38讲 | 知识串讲：用双十一的故事串起碎片的网络协议（中）</h2><h4 id="四-购物之前看图片，静态资源-CDN"><a href="#四-购物之前看图片，静态资源-CDN" class="headerlink" title="四. 购物之前看图片，静态资源 CDN"></a>四. 购物之前看图片，静态资源 CDN</h4><p>我们部署电商应用的时候，一般会把静态资源保存在两个地方。</p>
<ul>
<li>接入层 nginx 后面的 varnish 缓存里面，一般是静态页面</li>
<li>对于比较大的、不经常更新的静态图片，会保存在对象存储里面</li>
</ul>
<p>这两个地方的静态资源都会配置 CDN，将资源下发到边缘节点。</p>
<ol>
<li>配置了 CDN 之后，权威 DNS 服务器上，会为静态资源设置一个 CNAME 别名，指向另外一个域名 cdn.com ，返回给本地 DNS 服务器。</li>
<li>本地 DNS 服务器拿到 cdn.com，继续请求 cdn.com 的权威 DNS 服务器。这是 CDN 自己的权威 DNS 服务器。</li>
<li>在 cdn.com 的权威服务器上，还是会设置一个 CNAME，指向另外一个域名，也即 CDN 网络的全局负载均衡器。</li>
<li>本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名，全局负载均衡器会为用户选择一台合适的缓存服务器提供服务，将 IP 返回给客户端，客户端去访问这个边缘节点，下载资源。缓存服务器响应用户请求，将用户所需内容传送到用户终端。<ul>
<li>如果这台缓存服务器上并没有用户想要的内容，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器，将内容拉到本地。</li>
</ul>
</li>
</ol>
<h4 id="五-看上宝贝点下单，双方开始建连接"><a href="#五-看上宝贝点下单，双方开始建连接" class="headerlink" title="五. 看上宝贝点下单，双方开始建连接"></a>五. 看上宝贝点下单，双方开始建连接</h4><p>电商网站会对下单的情况提供 RESTful 的下单接口，而对于下单这种需要保密的操作，需要通过 HTTPS 协议进行请求。</p>
<p>在所有这些操作之前，首先要做的事情是建立连接。<br><img src="https://static001.geekbang.org/resource/image/70/83/705e4cc5acc7b364bdf015f333d40783.jpg" alt=""></p>
<ol>
<li>HTTPS 协议是基于 TCP 协议的，因而要先建立 TCP 的连接。<blockquote>
<p>在这个例子中，TCP 的连接是从手机上的 App 和负载均衡器 SLB 之间的。</p>
</blockquote>
<ol>
<li>一开始，客户端和服务端都处于 CLOSED 状态。</li>
<li>服务端先主动监听某个端口，处于 LISTEN 状态。</li>
<li>客户端主动发起连接 SYN，之后处于 SYN-SENT 状态。</li>
<li>服务端收到发起的连接，返回 SYN，并且 ACK 客户端的 SYN，之后处于 SYN-RCVD 状态。</li>
<li>客户端收到服务端发送的 SYN 和 ACK 之后，发送 ACK 的 ACK，之后处于 ESTABLISHED 状态。</li>
<li>服务端收到 ACK 的 ACK 之后，处于 ESTABLISHED 状态。至此，TPC 层连接简历完毕。</li>
</ol>
</li>
<li>当 TCP 层的连接建立完毕之后，接下来轮到HTTPS 层建立连接了，在 HTTPS 的交换过程中，TCP 层始终处于 ESTABLISHED。<ol>
<li>客户端会发送 Client Hello 消息到服务器，用明文传输 TLS 版本信息、加密套件候选列表、压缩算法候选列表等信息。还会有一个随机数，在协商对称密钥的时候使用。</li>
<li>服务器会返回 Server Hello 消息，告诉客户端，服务器选择使用的协议版本、加密套件、压缩算法等。这也有一个随机数，用于后续的密钥协商。</li>
<li>服务器发送 Server Hello Done，包含一个服务器端的证书。</li>
<li>客户端需要验证这个证书，于是从自己信任的 CA 仓库中，拿 CA 的证书里面的公钥去解密电商网站的证书。如果能够成功，则说明电商网站是可信的。这个过程中，你可能会不断往上追溯 CA、CA 的 CA、CA 的 CA 的 CA，直到一个授信的 CA。</li>
<li>证书验证完毕之后，客户端计算产生随机数字 Pre-master，发送 Client Key Exchange，用证书中的公钥加密，再发送给服务器，服务器可以通过私钥解密出来。</li>
<li>接下来，无论是客户端还是服务器，都有了三个随机数，分别是：自己的、对端的，以及刚生成的 Pre-Master 随机数。通过这三个随机数，可以在客户端和服务器产生相同的对称密钥。</li>
<li>客户端发送 Change Cipher Spec，声明之后的通信采用协商的通信密钥和加密算法进行加密通信。</li>
<li>然后客户端发送一个 Encrypted Handshake Message，将已经商定好的参数等，采用协商密钥进行加密，发送给服务器用于数据与握手验证。</li>
<li>服务器也可以发送 Change Cipher Spec，确认之后的通信规则，并且也发送 Encrypted Handshake Message 消息。至此，HTTPS 连接建立完毕。</li>
</ol>
</li>
</ol>
<h4 id="六-发送下单请求网络包，西行需要出网关"><a href="#六-发送下单请求网络包，西行需要出网关" class="headerlink" title="六. 发送下单请求网络包，西行需要出网关"></a>六. 发送下单请求网络包，西行需要出网关</h4><p>当客户端和服务端之间建立了连接后，接下来就要发送下单请求的网络包了。</p>
<p><img src="https://static001.geekbang.org/resource/image/99/49/99c282efaca15deb79c7821c9c577349.jpg" alt=""></p>
<ol>
<li>在用户层发送的是 HTTP 的网络包，因为服务端提供的是 RESTful API，因而 HTTP 层发送的就是一个请求。首先组装 HTTP 报文。 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /purchaseOrder HTTP/1.1</span><br><span class="line">Host: www.geektime.com</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Content-Length: nnn</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">"order": &#123;</span><br><span class="line">"date": "2018-07-01",</span><br><span class="line">"className": " 趣谈网络协议 ",</span><br><span class="line">"Author": " 刘超 ",</span><br><span class="line">"price": "68"</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>请求行<ul>
<li>URL 是 <a href="http://www.geektime.com/purchaseOrder" target="_blank" rel="noopener">www.geektime.com/purchaseOrder</a></li>
<li>版本为 HTTP 1.1</li>
<li>请求的类型为 POST</li>
</ul>
</li>
<li>首部<ul>
<li>Content-Type 指明正文的格式，这里设置为 json，编码 utf-8</li>
<li>还有其他的首部 key-value 参数，这里略去</li>
</ul>
</li>
<li>正文实体<ul>
<li>这里是一个 JSON 字符串，因为我们在首部中指明了正文格式为 json。</li>
<li>里面通过文本的形式描述了，要买一个课程，作者是谁，多少钱。</li>
</ul>
</li>
</ul>
</li>
<li>HTTP 请求的报文组装好了，接下来浏览器或者移动 App 会把它交给下一层 TCP 传输层。<ul>
<li>交付传输层即通过 Socket 进行程序设计。<ul>
<li>浏览器端已有 Socket 实现，直接调用即可。</li>
<li>移动 APP 端，一般会用一个 HTTP 的客户端工具来发送，并且帮你封装好。</li>
</ul>
</li>
<li>Socket 会将数据封装为二进制流，交付 TCP 层。TCP 层会把二进制流变成一个一个的报文段发送给服务器。<ul>
<li>在 TCP 头里面，会有源端口号和目标端口号，目标端口号一般是服务端监听的端口号，源端口号在手机端，往往是随机分配一个端口号。这个端口号在客户端和服务端用于区分请求和返回，发给那个应用。</li>
</ul>
</li>
</ul>
</li>
<li>接下来是 IP 层<ul>
<li>在 IP 头里面，包含源地址与目标地址。<ul>
<li>对于手机来说，源地址是 PGW 给这个手机分配的 IP 地址，目标地址则是云平台的负载均衡器的外网 IP 地址。</li>
</ul>
</li>
<li>在 IP 层，客户端需要查看目标地址和自己是否是在同一个局域网，计算是否是同一个网段，往往需要通过 CIDR 子网掩码来计算。<ul>
<li>对于这个下单场景，目标 IP 和源 IP 不会在同一个网段，因而需要发送到默认的网关。一般通过 DHCP 分配 IP 地址的时候，同时配置默认网关的 IP 地址。</li>
</ul>
</li>
</ul>
</li>
<li>最后是 MAC 层<ul>
<li>客户端发送 ARP 协议，来获取网关的 MAC 地址，然后将网关 MAC 作为目标 MAC，自己的 MAC 作为源 MAC，放入 MAC 头，发送出去。</li>
</ul>
</li>
</ol>
<hr>
<h2 id="第39讲-知识串讲：用双十一的故事串起碎片的网络协议（下）"><a href="#第39讲-知识串讲：用双十一的故事串起碎片的网络协议（下）" class="headerlink" title="第39讲 | 知识串讲：用双十一的故事串起碎片的网络协议（下）"></a>第39讲 | 知识串讲：用双十一的故事串起碎片的网络协议（下）</h2><h4 id="七-一座座城池一道道关，流控拥塞与重传"><a href="#七-一座座城池一道道关，流控拥塞与重传" class="headerlink" title="七. 一座座城池一道道关，流控拥塞与重传"></a>七. 一座座城池一道道关，流控拥塞与重传</h4><p>对于手机来讲，默认的网关在 PGW 上。在移动网络里面，从手机到 SGW，到 PGW 是有一条隧道的。也有相应的隧道协议。</p>
<p><img src="https://static001.geekbang.org/resource/image/8e/5a/8edfb048b27aed3cc2eeb892ae22175a.jpg" alt=""></p>
<ol>
<li>从手机发送出来的时候，网络包的结构为：<ul>
<li>源 MAC：手机也即 UE 的 MAC</li>
<li>目标 MAC：网关 PGW 上面的隧道端点的 MAC</li>
<li>源 IP：UE 的 IP 地址</li>
<li>目标 IP：SLB 的公网 IP 地址</li>
</ul>
</li>
<li>网络包进入手机端与 SGW 的隧道，封装隧道协议，因而网络包的格式为：<ul>
<li>外层源 MAC：E-NodeB 的 MAC</li>
<li>外层目标 MAC：SGW 的 MAC</li>
<li>外层源 IP：E-NodeB 的 IP</li>
<li>外层目标 IP：SGW 的 IP</li>
<li>内层源 MAC：手机也即 UE 的 MAC</li>
<li>内层目标 MAC：网关 PGW 上面的隧道端点的 MAC</li>
<li>内层源 IP：UE 的 IP 地址</li>
<li>内层目标 IP：SLB 的公网 IP 地址</li>
</ul>
</li>
<li>网络包抵达 SGW，进入 SGW 到 PGW 的隧道，因而网络包的格式为：<ul>
<li>外层源 MAC：SGW 的 MAC</li>
<li>外层目标 MAC：PGW 的 MAC</li>
<li>外层源 IP：SGW 的 IP</li>
<li>外层目标 IP：PGW 的 IP</li>
<li>内层源 MAC：手机也即 UE 的 MAC</li>
<li>内层目标 MAC：网关 PGW 上面的隧道端点的 MAC</li>
<li>内层源 IP：UE 的 IP 地址</li>
<li>内层目标 IP：SLB 的公网 IP 地址</li>
</ul>
</li>
<li>在 PGW 的隧道端点将包解出来，然后转发出去。一般在 PGW 出外部网络的路由器上，会部署 NAT 服务，将手机的 IP 地址转换为公网 IP 地址，当请求返回的时候，再 NAT 回来。因而在 PGW 之后，会将网络包发送至 NAT 网关，网络包的格式为：<ul>
<li>源 MAC：PGW 出口的 MAC</li>
<li>目标 MAC：NAT 网关的 MAC</li>
<li>源 IP：UE 的 IP 地址</li>
<li>目标 IP：SLB 的公网 IP 地址</li>
</ul>
</li>
<li>在 NAT 网关，需要穿越一个一个的 AS，通过各种路由一次一次的转发，最终抵达目标，也即 SLB 的公网 IP 地址。这里以 NAT 发出到第一个边界路由器为例，网络包的格式变成：<ul>
<li>源 MAC：NAT 网关的 MAC</li>
<li>目标 MAC：A2 路由器的 MAC</li>
<li>源 IP：UE 的公网 IP 地址</li>
<li>目标 IP：SLB 的公网 IP 地址</li>
</ul>
</li>
<li>出了 NAT 网关，就从核心网到达了互联网。之后会通过一个一个的路由器不停的下一跳，跨越一个一个的 AS，最终抵达目标。<ul>
<li>AS 分类<ul>
<li>公网中，每一个运营商的网络成为自治系统 AS。每个自治系统都有边界路由器，通过它和外面的世界建立联系。</li>
<li>对于云平台来讲，它可以被称为 Multihomed AS，有多个连接连到其他的 AS，但是大多拒绝帮其他的 AS 传输包。</li>
<li>一些大公司的网络，对于运营商来说，它可以被称为 Transit AS，有多个连接连到其他的 AS，并且可以帮助其他的 AS 传输包，比如主干网。</li>
</ul>
</li>
<li>在路由器之间需要通过 BGP 协议实现，BGP 又分为两类，eBGP 和 iBGP。<ul>
<li>自治系统之间、边界路由器之间使用 eBGP 广播路由。内部网络也需要访问其他的自治系统。</li>
<li>边界路由器通过运行 iBGP 将 BGP 学习到的路由导入到内部网络，使内部的路由器能够找到到达外网目的地最好的边界路由器。</li>
</ul>
</li>
<li>对于我们这个例子，它的跳转路线如下：<ol>
<li>NAT 网关的下一跳是 A2，也即将 A2 的 MAC 地址放在目标 MAC 地址中。</li>
<li>到达 A2 之后，从路由表中找到下一跳是路由器 C1，于是将目标 MAC 换成 C1 的 MAC 地址。</li>
<li>到达 C1 之后，找到下一跳是 C2，将目标 MAC 地址设置为 C2 的 MAC。</li>
<li>到达 C2 后，找到下一跳是云平台的边界路由器，于是将目标 MAC 设置为边界路由器的 MAC 地址。<blockquote>
<p>这一路，都是只换 MAC，不换目标 IP 地址。这就是所谓下一跳的概念。</p>
</blockquote>
</li>
<li>在云平台的边界路由器，会将下单的包转发进来，经过核心交换，汇聚交换，到达外网网关节点上的 SLB 的公网 IP 地址。</li>
</ol>
</li>
</ul>
</li>
</ol>
<p>在整个传输过程中，很可能出现错误，因此需要通过各种方式来保证其可靠性。</p>
<ul>
<li>包在传输过程中可能因为某些原因失败，因此需要 TCP 的重发机制保证包完整发送至目标。而重发规则的制定则是通过 TCP 的滑动窗口协议。<br>  <img src="https://static001.geekbang.org/resource/image/48/24/4879c63596736cc91dbb696046e95024.jpg" alt=""><ul>
<li>整个 TCP 的发送，一开始会协商一个 Sequence Number，从这个 Sequence Number 开始，每个包都有编号。滑动窗口将接收方的网络包分成四个部分：<ul>
<li>已经接收，已经 ACK，已经交给应用层的包</li>
<li>已经接收，已经 ACK，未发送给应用层</li>
<li>已经接收，尚未发送 ACK</li>
<li>未接收，尚有空闲的缓存区域</li>
</ul>
</li>
<li>如果发送方超过一定的时间没有收到 ACK，就会重新发送。只有 TCP 层 ACK 过的包，才会发给应用层，并且只会发送一份，对于下单的场景，应用层是 HTTP 层。</li>
</ul>
</li>
<li>TCP 连接可能因为某种原因中断，这个时候手机把所有的动作重新做一遍，建立一个新的 TCP 连接，在 HTTP 层调用两次 RESTful API。这个时候可能会导致两遍下单的情况，因而 RESTful API 需要实现幂等。</li>
</ul>
<h4 id="八-从数据中心进网关，公网-NAT-成私网"><a href="#八-从数据中心进网关，公网-NAT-成私网" class="headerlink" title="八. 从数据中心进网关，公网 NAT 成私网"></a>八. 从数据中心进网关，公网 NAT 成私网</h4><p><img src="https://static001.geekbang.org/resource/image/ab/52/ab5b03ebf7facf71721566165f921252.jpg" alt=""></p>
<ol>
<li>包从手机端经历千难万险，终于到了 SLB 的公网 IP 所在的公网网口。由于匹配上了 MAC 地址和 IP 地址，因而将网络包收了进来。</li>
<li>在虚拟网关节点的外网网口上，会有一个 NAT 规则，将公网 IP 地址转换为 VPC 里面的私网 IP 地址，这个私网 IP 地址就是 SLB 的 HAProxy 所在的虚拟机的私网 IP 地址。<ul>
<li>为了承载比较大的吞吐量，虚拟网关节点会有多个，物理网络会将流量分发到不同的虚拟网关节点。</li>
<li>同样 HAProxy 也会是一个大的集群，虚拟网关会选择某个负载均衡节点，将某个请求分发给它，负载均衡之后是 Controller 层，也是部署在虚拟机里面的。</li>
</ul>
</li>
<li>当网络包里面的目标 IP 变成私有 IP 地址之后，虚拟路由会查找路由规则，将网络包从下方的私网网口发出来。这个时候包的格式为：<ul>
<li>源 MAC：网关 MAC</li>
<li>目标 MAC：HAProxy 虚拟机的 MAC</li>
<li>源 IP：UE 的公网 IP</li>
<li>目标 IP：HAProxy 虚拟机的私网 IP</li>
</ul>
</li>
</ol>
<h4 id="九-进入隧道打标签，RPC-远程调用下单"><a href="#九-进入隧道打标签，RPC-远程调用下单" class="headerlink" title="九. 进入隧道打标签，RPC 远程调用下单"></a>九. 进入隧道打标签，RPC 远程调用下单</h4><ol>
<li>在虚拟路由节点上，也会有 OVS，将网络包封装在 VXLAN 隧道里面，VXLAN ID 就是给你的租户创建 VPC 的时候分配的。包的格式为：<ul>
<li>外层源 MAC：网关物理机 MAC</li>
<li>外层目标 MAC：物理机 A 的 MAC</li>
<li>外层源 IP：网关物理机 IP</li>
<li>外层目标 IP：物理机 A 的 IP</li>
<li>内层源 MAC：网关 MAC</li>
<li>内层目标 MAC：HAProxy 虚拟机的 MAC</li>
<li>内层源 IP：UE 的公网 IP</li>
<li>内层目标 IP：HAProxy 虚拟机的私网 IP</li>
</ul>
</li>
<li>在物理机 A 上，OVS 会将包从 VXLAN 隧道里面解出来，发给 HAProxy 所在的虚拟机。</li>
<li>HAProxy 所在的虚拟机发现 MAC 地址匹配，目标 IP 地址匹配，就根据 TCP 端口，将包发给 HAProxy 进程，因为 HAProxy 是在监听这个 TCP 端口的。<ul>
<li>HAProxy 就是这个 TCP 连接的服务端，客户端是手机。对于 TCP 的连接状态、滑动窗口等，都是在 HAProxy 上维护的。</li>
</ul>
</li>
<li>在这里 HAProxy 是一个四层负载均衡，也即它只解析到 TCP 层，里面的 HTTP 协议它不关心，就将请求转发给后端的多个 Controller 层的一个。HAProxy 发出去的网络包就认为 HAProxy 是客户端了，看不到手机端了。网络包格式如下：<ul>
<li>源 MAC：HAProxy 所在虚拟机的 MAC</li>
<li>目标 MAC：Controller 层所在虚拟机的 MAC</li>
<li>源 IP：HAProxy 所在虚拟机的私网 IP</li>
<li>目标 IP：Controller 层所在虚拟机的私网 IP</li>
</ul>
</li>
<li>这个包发出去之后，会被物理机上的 OVS 放入 VXLAN 隧道里面，网络包格式为：<ul>
<li>外层源 MAC：物理机 A 的 MAC</li>
<li>外层目标 MAC：物理机 B 的 MAC</li>
<li>外层源 IP：物理机 A 的 IP</li>
<li>外层目标 IP：物理机 B 的 IP</li>
<li>内层源 MAC：HAProxy 所在虚拟机的 MAC</li>
<li>内层目标 MAC：Controller 层所在虚拟机的 MAC</li>
<li>内层源 IP：HAProxy 所在虚拟机的私网 IP</li>
<li>内层目标 IP：Controller 层所在虚拟机的私网 IP</li>
</ul>
</li>
<li>在物理机 B 上，OVS 会将包从 VXLAN 隧道里面解出来，发给 Controller 层所在的虚拟机。</li>
<li>Controller 层所在的虚拟机发现 MAC 地址匹配，目标 IP 地址匹配，就根据 TCP 端口，将包发给 Controller 层的进程，因为它在监听这个 TCP 端口。<ul>
<li>在 HAProxy 和 Controller 层之间，维护一个 TCP 的连接。</li>
</ul>
</li>
<li>Controller 层收到包之后，它是关心 HTTP 里面是什么的，于是解开 HTTP 的包，发现是一个 POST 请求，内容是下单购买一个课程。</li>
</ol>
<h4 id="十-下单扣减库存优惠券，数据入库返回成功"><a href="#十-下单扣减库存优惠券，数据入库返回成功" class="headerlink" title="十. 下单扣减库存优惠券，数据入库返回成功"></a>十. 下单扣减库存优惠券，数据入库返回成功</h4><p>下单是一个复杂的过程，因而往往在组合服务层会有一个专门管理下单的服务，Controller 层会通过 RPC 调用这个组合服务层。</p>
<p>假设我们使用的是 Dubbo。</p>
<ol>
<li>Controller 层需要读取注册中心，将下单服务的进程列表拿出来，选出一个来调用。</li>
<li>Dubbo 中默认的 RPC 协议是 Hessian2。Hessian2 将下单的远程调用序列化为二进制进行传输。</li>
<li>Controller 层和下单服务之间，使用了 Netty 的网络传输框架。有了 Netty，就不用自己编写复杂的异步 Socket 程序了。Netty 使用的方式，是 Socket 结构中一个 IO 多路复用，等待通知的方式。<ul>
<li>Socket 基于 TCP 层发送网络包，下层还是需要封装上 IP 头和 MAC 头。如果跨物理机通信，还是需要封装的外层的 VXLAN 隧道里面。当然底层的这些封装，Netty 都不感知，它只要做好它的异步通信即可。</li>
</ul>
</li>
<li>在 Netty 的服务端，也即下单服务中，收到请求后，先用 Hessian2 的格式进行解压缩。然后将请求分发到线程中进行处理，在线程中，会调用下单的业务逻辑。<blockquote>
<p>下单的业务逻辑比较复杂，往往要调用基础服务层里面的库存服务、优惠券服务等，将多个服务调用完毕，才算下单成功。</p>
</blockquote>
</li>
<li>下单服务调用库存服务和优惠券服务，也是通过 Dubbo 的框架，通过注册中心拿到库存服务和优惠券服务的列表，然后选一个调用。<ul>
<li>调用的时候，统一使用 Hessian2 进行序列化，使用 Netty 进行传输，底层如果跨物理机，仍然需要通过 VXLAN 的封装和解封装。</li>
</ul>
</li>
<li>当下单更新到分布式数据库中之后，整个下单过程才算真正告一段落。</li>
</ol>
<hr>
<h2 id="协议专栏特别福利-答疑解惑第一期"><a href="#协议专栏特别福利-答疑解惑第一期" class="headerlink" title="协议专栏特别福利 | 答疑解惑第一期"></a>协议专栏特别福利 | 答疑解惑第一期</h2><p><strong>当网络包到达一个城关的时候，可以通过路由表得到下一个城关的 IP 地址，直接通过 IP 地址找就可以了，为什么还要通过本地的 MAC 地址呢？</strong></p>
<p>在网络包里，有源 IP 地址和目标 IP 地址、源 MAC 地址和目标 MAC 地址。从路由表中取得下一跳的 IP 地址后，应该把这个地址放在哪里呢？如果放在目标 IP 地址里面，到了城关，谁知道最终的目标在哪里呢？所以要用 MAC 地址。</p>
<p>所谓的下一跳，看起来是 IP 地址，其实是要通过 ARP 得到 MAC 地址，将下一跳的 MAC 地址放在目标 MAC 地址里面。</p>
<br>

<p><strong>MAC 地址可以修改吗？</strong></p>
<p>MAC（Media Access Control，介质访问控制）地址，也叫硬件地址，长度是 48 比特（6 字节），由 16 进制的数字组成，分为前 24 位和后 24 位。</p>
<ul>
<li>前 24 位叫作组织唯一标志符（Organizationally Unique Identifier，OUI），是由 IEEE 的注册管理机构给不同厂家分配的代码，用于区分不同的厂家。</li>
<li>后 24 位是厂家自己分配的，称为扩展标识符。同一个厂家生产的网卡中 MAC 地址后 24 位是不同的。</li>
</ul>
<p>MAC 本来设计为唯一性的，但是后来设备越来越多，而且还有虚拟化的设备和网卡，有很多工具可以修改，就很难保证不冲突了。但是至少应该保持一个局域网内是唯一的。这样，一台机器启动的时候，就能够在没有 IP 地址的情况下，先用 MAC 地址进行通信，获得 IP 地址。</p>
<p>MAC 地址是工作在一个局域网中的，因而即便出现了冲突，网络工程师也能够在自己的范围内很快定位并解决这个问题。</p>
<br>

<p><strong>TCP 重试有没有可能导致重复下单？</strong></p>
<p>答案是不会的。因为 TCP 层收到了重复包之后，TCP 层自己会进行去重，发给应用层、HTTP 层。还是一个唯一的下单请求，所以不会重复下单。</p>
<p>但仍有一些情况会导致重复下单</p>
<ul>
<li>TCP 断线重连会导致重复下单，这样会重新发送应用层的请求，也即 HTTP 的请求会重新发送一遍。</li>
<li>请求被黑客拦截并重放会导致重复下单，这在 HTTPS 层可以有很多种机制，例如通过 Timestamp 和 Nonce 随机数联合起来，然后做一个不可逆的签名来保证。</li>
</ul>
<p>如果服务端设计的是无状态的，它记不住上一次已经发送了一次请求。如果处理不好，就会导致重复下单，这就需要服务端除了实现无状态，还需要根据传过来的订单号实现幂等，同一个订单只处理一次。</p>
<br>

<p><strong>IP 地址和 MAC 地址的关系？</strong></p>
<p>IP 是有远程定位功能的，MAC 是没有远程定位功能的，只能通过本地 ARP 的方式找到。</p>
<br>

<p><strong>如果最后一跳的时候，IP 改变了怎么办？</strong></p>
<p>对于 IP 层来讲，当包到达最后一跳的时候，原来的 IP 不存在了。比如网线拔掉了，或者服务器直接宕机了，则 ARP 就找不到了，所以这个包就会发送失败了。对于 IP 层的工作就结束了。但是 IP 层之上还有 TCP 层，TCP 会重试的，包还是会重新发送。</p>
<ul>
<li>如果服务器没有启动起来，超过一定的次数，最终放弃。</li>
<li>如果服务器重启了，IP 还是原来的 IP 地址，这个时候 TCP 重新发送的一个包的时候，ARP 是能够得到这个地址的，因而会发到这台机器上来，但是机器上面没有启动服务端监听那个端口，于是会发送 ICMP 端口不可达。</li>
<li>如果服务器重启了，服务端也重新启动了，也在监听那个端口了，这个时候 TCP 的服务端由于是新的，Sequence Number 根本对不上，说明不是原来的连接，会发送 RST。<blockquote>
<p>按照 Sequence Number 的生成算法，是不存在对的上的可能的。</p>
</blockquote>
</li>
<li>有一个非常特殊的方式，就是虚拟机的热迁移，从一台物理机迁移到另外一台物理机，IP 不变，MAC 不变，内存也拷贝过去，Sequence Number 在内存里面也保持住了，在迁移的过程中会丢失一两个包，但是从 TCP 来看，最终还是能够连接成功的。</li>
</ul>
<br>

<p><strong>ARP 协议属于哪一层？</strong></p>
<p>ARP 属于哪个层，一直是有争议的。比如《TCP/IP 详解》把它放在了二层和三层之间，但是既然是协议，只要大家都遵守相同的格式、流程就可以了，在实际应用的时候，不会有歧义的。</p>
<blockquote>
<p>唯一有歧义的是参加各种考试，让你做选择题，ARP 属于哪一层？平时工作中咱不用纠结这个。</p>
</blockquote>
<br>

<p><strong>为什么要分层？</strong></p>
<p>其实这是一个架构设计的通用问题，不仅仅是网络协议的问题。一旦涉及到复杂的逻辑，或者软件需求需要经常变动，一般都会通过分层来解决问题。</p>
<br>

<p><strong>什么情况下会有下层没上层？</strong></p>
<p>有时候我们自己写应用的时候，不一定是直接调用应用层协议的接口，例如 HTTP 等，而是自己写 Socket 编程，来约定应用层的协议。再如，ping 也是一个应用，但是它没有用传输层的协议，而是用了 ICMP 的协议。</p>
<br>

<h2 id="协议专栏特别福利-答疑解惑第二期"><a href="#协议专栏特别福利-答疑解惑第二期" class="headerlink" title="协议专栏特别福利 | 答疑解惑第二期"></a>协议专栏特别福利 | 答疑解惑第二期</h2><p><strong>你知道 net-tools 和 iproute2 的“历史”故事吗？</strong></p>
<ul>
<li>net-tools<ul>
<li>net-tools 起源于 BSD，自 2001 年起，Linux 社区已经对其停止维护</li>
<li>net-tools通过procfs(/proc)和ioctl系统调用去访问和改变内核网络配置</li>
<li>net-tools中工具的名字比较杂乱</li>
</ul>
</li>
<li>iproute2<ul>
<li>iproute2 旨在取代 net-tools，并提供了一些新功能</li>
<li>iproute2则通过netlink套接字接口与内核通讯</li>
<li>iproute2则相对整齐和直观，基本是ip命令加后面的子命令</li>
</ul>
</li>
</ul>
<p>一些Linux发行版已经停止支持net-tools，只支持iproute2。虽然取代意图很明显，但是这么多年过去了，net-tool依然还在被广泛使用，最好还是两套命令都掌握吧。</p>
<br>

<p><strong>网络号、IP 地址、子网掩码和广播地址的先后关系是什么？</strong></p>
<p>一般选择来说，在一个小的局域网环境下，私有地址使用 192.168.0.0/24 就可以了。</p>
<ol>
<li>先有的是网络号。192.168.0 就是网络号。<ul>
<li>有了网络号，子网掩码同时也就有了，就是前面都是网络号的是 1，其他的是 0。</li>
<li>有了网络号，广播地址也有了，除了网络号之外都是 1。</li>
</ul>
</li>
<li>最后确定的是 IP 地址。当规划完网络的时候，一般这个网络里面的第一个、第二个地址被默认网关 DHCP 服务器占用，你自己创建的机器，只要和其他的不冲突就可以了，当然你也可以让 DHCP 服务自动配置。</li>
</ol>
<br>

<p><strong>组播和广播的意义和原理是什么？</strong></p>
<ul>
<li>广播相对比较简单<ul>
<li>MAC 层的广播为 ff:ff:ff:ff:ff:ff</li>
<li>IP 层指向子网的广播地址为主机号为全 1 且有特定子网号的地址。</li>
</ul>
</li>
<li>组播复杂一些<ul>
<li>MAC 层中，当地址中最高字节的最低位设置为 1 时，表示该地址是一个组播地址，用十六进制可表示为 01:00:00:00:00:00</li>
<li>IP 层中，组播地址为 D 类 IP 地址，当 IP 地址为组播地址的时候，有一个算法可以计算出对应的 MAC 层地址。</li>
</ul>
</li>
</ul>
<br>

<p><strong>MTU 1500 的具体含义是什么？</strong></p>
<p>MTU（Maximum Transmission Unit，最大传输单元）是二层的一个定义。以以太网为例，MTU 为 1500 个 Byte，前面有 6 个 Byte 的目标 MAC 地址，6 个 Byte 的源 MAC 地址，2 个 Byte 的类型，后面有 4 个 Byte 的 CRC 校验，共 1518 个 Byte。</p>
<ul>
<li>在 IP 层，一个 IP 数据报在以太网中传输。如果它的长度大于该 MTU 值，就要进行分片传输。如果不允许分片 DF，就会发送 ICMP 包，这个在ICMP那一节讲过。</li>
<li>在 TCP 层有个 MSS（Maximum Segment Size，最大分段大小），它等于 MTU 减去 IP 头，再减去 TCP 头。即在不分片的情况下，TCP 里面放的最大内容。</li>
<li>在 HTTP 层看来，它的 body 没有限制，而且在应用层看来，下层的 TCP 是一个流，可以一直发送，但其实是会被分成一个个段的。</li>
</ul>
<br>

<p><strong>PXE 协议可以用来安装操作系统，但是如果每次重启都安装操作系统，就会很麻烦。你知道如何使得第一次安装操作系统，后面就正常启动吗？</strong></p>
<p>一般如果咱们手动安装一台电脑的时候，都是有启动顺序的。在通过 PXE 安装操作系统后，再改为硬盘启动，就没有问题了。</p>
<br>

<p><strong>在 DHCP 网络里面，手动配置 IP 地址会冲突吗?</strong></p>
<ul>
<li>IP 地址会冲突<ul>
<li>在一个 DHCP 网络里面，如果某一台机器手动配置了一个 IP 地址，并且在 DHCP 管理的网段里的话，DHCP 服务器是会将这个地址分配给其他机器的。一旦分配了，ARP 的时候，就会收到两个应答，IP 地址就冲突了。</li>
</ul>
</li>
<li>DHCP 的客户端和服务器都可以添加相应的机制来检测冲突。<ul>
<li>如果由客户端来检测冲突，一般情况是，客户端在接受分配的 IP 之前，先发送一个 ARP，看是否有应答，有就说明冲突了，于是发送一个 DHCPDECLINE，放弃这个 IP 地址。</li>
<li>如果由服务器来检测冲突，DHCP 服务器会发送 ping，来看某个 IP 是否已经被使用。如果被使用了，它就不再将这个 IP 分配给其他的客户端了。</li>
</ul>
</li>
</ul>
<br>

<p><strong>DHCP 的 Offer 和 ACK 应该是单播还是广播呢？</strong></p>
<p>这取决于客户端的协议栈的能力</p>
<ul>
<li>如果没配置好 IP，就不能接收单播的包，那就将 BROADCAST 设为 1，以广播的形式进行交互。</li>
<li>如果客户端的协议栈实现很厉害，即便是没有配置好 IP，仍然能够接受单播的包，那就将 BROADCAST 位设置为 0，就以单播的形式交互。</li>
</ul>
<br>

<p><strong>DHCP 如何解决内网安全问题?</strong></p>
<p>DHCP 协议的设计是基于内网互信的基础来设计的，而且是基于 UDP 协议。但这里面的确是有风险的。</p>
<ul>
<li>两种风险<ul>
<li>例如一个普通用户无意地或者恶意地安装一台 DHCP 服务器，发放一些错误或者冲突的配置。</li>
<li>再如，有恶意的用户发出很多的 DHCP 请求，让 DHCP 服务器给他分配大量的 IP。</li>
</ul>
</li>
<li>两种风险对应的解决方案<ul>
<li>对于第一种情况，DHCP 服务器和二层网络都是由网管管理的，可以在交换机配置只有来自某个 DHCP 服务器的包才是可信的，其他全部丢弃。如果有 SDN，或者在云中，非法的 DHCP 包根本就拦截到虚拟机或者物理机的出口。</li>
<li>对于第二种情况，一方面进行监控，对 DHCP 报文进行限速，并且异常的端口可以关闭，一方面还是 SDN 或者在云中，除了被 SDN 管控端登记过的 IP 和 MAC 地址，其他的地址是不允许出现在虚拟机和物理机出口的，也就无法模拟大量的客户端。</li>
</ul>
</li>
</ul>
<br>

<p><strong>在二层中我们讲了 ARP 协议，即已知 IP 地址求 MAC；还有一种 RARP 协议，即已知 MAC 求 IP 的，你知道它可以用来干什么吗？</strong></p>
<p>之前有无盘工作站，即没有硬盘的机器，无法持久化 IP 到本地，但有网卡，所以可以通过 RARP 协议来获取 IP 地址到本地。</p>
<p>RARP 可以用于局域网管理员想指定机器 IP（与机器绑定，不可变），又不想每台机器去设置静态 IP 的情况。可以在 RARP 服务器上配置 MAC 与 IP 对应的 ARP 表。</p>
<blockquote>
<p>但获取每台机器的 MAC 地址也挺麻烦的，所以现在这个协议用的已经不多了，都换用 BOOTP 或 DHCP。</p>
</blockquote>
<br>

<p><strong>如果一个局域网里面有多个交换机，ARP 广播的模式会出现什么问题呢？</strong></p>
<p>多个交换机可能形成环，导致广播不停被转发，形成广播风暴</p>
<br>

<p><strong>STP 协议能够很好地解决环路问题，但是也有它的缺点，你能举几个例子吗？</strong></p>
<p>STP 的主要问题在于，当拓扑发生变化，新的配置消息要经过一定的时延才能传播到整个网络。</p>
<ul>
<li>由于整个交换网络只有一棵生成树，在网络规模比较大的时候会导致较长的收敛时间，拓扑改变的影响面也较大</li>
<li>当链路被阻塞后将不承载任何流量，造成了极大带宽浪费。</li>
</ul>
<br>

<p><strong>在 MAC 地址已经学习的情况下，ARP 会广播到没有 IP 的物理段吗？</strong></p>
<p>这里 ARP 的目标地址是广播的，所以无论是否进行地址学习，都会广播，而对于某个 MAC 的访问。</p>
<ul>
<li>在没有地址学习的时候，是转发到所有的端口的</li>
<li>学习之后，只会转发到有这个 MAC 的端口</li>
</ul>
<br>

<p><strong>802.1Q VLAN 和 Port-based VLAN 有什么区别？</strong></p>
<ul>
<li>Port-based VLAN 一般只在一台交换机上起作用，比如一台交换机，10 个口，1、3、5、7、9 属于 VLAN 10。1 发出的包，只有 3、5、7、9 能够收到，但是从这些口转发出去的包头中，并不带 VLAN ID。</li>
<li>802.1Q 的 VLAN，出了交换机也起作用，也就是说，一旦打上某个 VLAN，则出去的包都带这个 VLAN，也需要链路上的交换机能够识别这个 VLAN，进行转发。</li>
</ul>
<br>

<h2 id="协议专栏特别福利-答疑解惑第三期"><a href="#协议专栏特别福利-答疑解惑第三期" class="headerlink" title="协议专栏特别福利 | 答疑解惑第三期"></a>协议专栏特别福利 | 答疑解惑第三期</h2><p><strong>当发送的报文出问题的时候，会发送一个 ICMP 的差错报文来报告错误，但是如果 ICMP 的差错报文也出问题了呢？</strong></p>
<ul>
<li>不发 ICMP 差错报文的一种情况就是 ICMP 的差错报文出错</li>
<li>ICMP 一般认为属于网络层的，和 IP 同一层，是管理和控制 IP 的一种协议，而 UDP 和 TCP 是传输层，所以 UDP 出错可以返回 ICMP 差错报文</li>
</ul>
<br>

<p><strong>ping 使用的是什么网络编程接口？</strong></p>
<p>咱们使用的网络编程接口是 Socket</p>
<ul>
<li>对于 ping 来讲，使用的是 ICMP，创建 Socket 如下，SOCK_RAW 就是基于 IP 层协议建立通信机制：  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(AF_INET, SOCK_RAW, IPPROTO_ICMP)</span><br></pre></td></tr></table></figure></li>
<li>如果是 TCP，则建立下面的 Socket：  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)</span><br></pre></td></tr></table></figure></li>
<li>如果是 UDP，则建立下面的 Socket：  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<br>

<p><strong>NAT 能建立多少连接？</strong></p>
<p>SNAT 多用于内网访问外网的场景，鉴于 conntrack 是由{源 IP，源端口，目标 IP，目标端口}，hash 后确定的。</p>
<ul>
<li>如果内网机器很多，但是访问的是不同的外网，也即目标 IP 和目标端口很多，这样内网可承载的数量就非常大，可不止 65535 个。</li>
<li>如果内网所有的机器，都一定要访问同一个目标 IP 和目标端口，这样源 IP 如果只有一个，这样的情况下，才受 65535 的端口数目限制。<ul>
<li>一种解决方法是多个源 IP</li>
<li>另一种解决方法是多个 NAT 网关，来分摊不同的内网机器访问<blockquote>
<p>如果你使用的是公有云，65535 台机器，应该放在一个 VPC 里面，可以放在多个 VPC 里面，每个 VPC 都可以有自己的 NAT 网关。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<br>

<p><strong>公网 IP 和私网 IP 需要一一绑定吗？</strong></p>
<ul>
<li>公网 IP 是有限的，如果使用公有云，需要花钱去买。但是不是每一个虚拟机都要有一个公网 IP 的，只有需要对外提供服务的机器，也即接入层的那些 nginx 需要公网 IP</li>
<li>没有公网 IP，使用 SNAT，大家共享 SNAT 网关的公网 IP 地址，也是能够访问的外网的</li>
</ul>
<br>

<p><strong>路由协议要在路由器之间交换信息，这些信息的交换还需要走路由吗？不是死锁了吗？</strong></p>
<ul>
<li>OSPF 是直接基于 IP 协议发送的，而且 OSPF 的包都是发给邻居的，也即只有一跳，不会中间经过路由设备。</li>
<li>BGP 是基于 TCP 协议的，在 BGP peer 之间交换信息。</li>
</ul>
<br>

<p><strong>多线 BGP 机房是怎么回事儿？</strong></p>
<ul>
<li>前提概念<ul>
<li>BGP 主要用于互联网 AS 自治系统之间的互联，BGP 的最主要功能在于控制路由的传播和选择最好的路由。</li>
<li>各大运营商都具有 AS 号，全国各大网络运营商多数都是通过 BGP 协议与自身的 AS 来实现多线互联的。</li>
</ul>
</li>
<li>多线 BGP 机房原理<ul>
<li>使用此方案来实现多线路互联，IDC 需要在 CNNIC（中国互联网信息中心）或 APNIC（亚太网络信息中心）申请自己的 IP 地址段和 AS 号，然后通过 BGP 协议将此段 IP 地址广播到其它的网络运营商的网络中。</li>
<li>使用 BGP 协议互联后，网络运营商的所有骨干路由设备将会判断到 IDC 机房 IP 段的最佳路由，以保证不同网络运营商用户的高速访问。</li>
</ul>
</li>
</ul>
<br>

<p><strong>都说 TCP 是面向连接的，在计算机看来，怎么样才算一个连接呢？</strong></p>
<p>TCP 连接时通过三次握手建立的，四次挥手释放连接，这里的连接是指彼此可以感知到对方的存在，计算机两端表现为 socket，有对应的接受缓存和发送缓存，有相应的拥塞控制策略。</p>
<br>

<p><strong>TCP 的连接有这么多的状态，你知道如何在系统中查看某个连接的状态吗？</strong></p>
<p>netstat 或 lsof 命令 grep 一下 TCP 状态进行查看，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat grep establish</span><br></pre></td></tr></table></figure>

<br>

<p><strong>TIME_WAIT 状态太多是怎么回事儿？</strong></p>
<p><img src="https://static001.geekbang.org/resource/image/1f/11/1f6a5e17b34f00d28722428b7b8ccb11.jpg" alt=""><br>如果处于 TIMEWAIT 状态，说明双方建立成功过连接，而且已经发送了最后的 ACK 之后，才会处于这个状态，而且是主动发起关闭的一方处于这个状态。</p>
<p>如果存在大量的 TIMEWAIT，往往是因为短连接太多，不断的创建连接，然后释放连接，从而导致很多连接在这个状态，可能会导致无法发起新的连接。</p>
<br>

<p><strong>起始序列号是怎么计算的，会冲突吗？</strong></p>
<ul>
<li>起始 ISN 是基于时钟的，每 4 毫秒加一，转一圈要 4.55 个小时。</li>
<li>TCP 初始化序列号不能设置为一个固定值，因为这样容易被攻击者猜出后续序列号，从而遭到攻击。 RFC1948 中提出了一个较好的初始化序列号 ISN 随机生成算法。  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ISN &#x3D; M + F (localhost, localport, remotehost, remoteport)</span><br></pre></td></tr></table></figure>
  M 是一个计时器，这个计时器每隔 4 毫秒加 1。F 是一个 Hash 算法，根据源 IP、目的 IP、源端口、目的端口生成一个随机数值。要保证 Hash 算法不能被外部轻易推算得出，用 MD5 算法是一个比较好的选择。</li>
</ul>
<br>

<p><strong>TCP 的 BBR 听起来很牛，你知道它是如何达到这个最优点的嘛？</strong></p>
<ol>
<li>设备缓存会导致延时？<ul>
<li>假如经过设备的包都不需要进入缓存，那么速度是最快的。进入缓存且等待，等待的时间就是额外的延时。BBR 就是为了避免这些问题，即充分利用带宽，降低 buffer 占用率。</li>
</ul>
</li>
<li>降低 packet 的速度，为何反而提速了？<ul>
<li>标注的 TCP 拥塞算法是遇到丢包的数据时快速下降发送速度，因为算法假设丢包都是因为过程设备存满了。快速下降再重新慢启动，这个过程对于带宽来说是浪费的。</li>
<li>通过 packet 速度 - 时间的图来看，从积分上来说，BBR 充分利用带宽时发送效率才最高。</li>
</ul>
</li>
</ol>
<br>

<p><strong>epoll 是 Linux 上的函数，那你知道 Windows 上对应的机制是什么吗？如果想实现一个跨平台的程序，你知道应该怎么办吗？</strong></p>
<p>如果跨平台，推荐使用 libevent 库，它是一个事件通知库，适用于 Windows、Linux、BSD 等多种平台，内部使用 select、epoll、kqueue、IOCP 等系统调用管理事件机制。</p>
<br>

<h2 id="协议专栏特别福利-答疑解惑第四期"><a href="#协议专栏特别福利-答疑解惑第四期" class="headerlink" title="协议专栏特别福利 | 答疑解惑第四期"></a>协议专栏特别福利 | 答疑解惑第四期</h2><p><strong>QUIC 是一个精巧的协议，所以它肯定不止今天我提到的四种机制，你知道还有哪些吗？</strong></p>
<p>QUIC 还有其他特性</p>
<ul>
<li>快速建立连接。以 HTTPS 举例，如果使用基于 UDP 的 QUIC。<ul>
<li>可以省略掉 TCP 的三次握手。</li>
<li>至于 TLS 的建立，对于 QUIC 来讲，当客户端首次发起 QUIC 连接时，会发送一个 client hello 消息，服务器会回复一个消息，里面包括 server config，类似于 TLS1.3 中的 key_share 交换。当客户端获取到 server config 以后，就可以直接计算出密钥，发送应用数据了。</li>
</ul>
</li>
<li>拥塞控制。QUIC 协议当前默认使用了 TCP 协议的 CUBIC（拥塞控制算法）。<br>  <img src="https://static001.geekbang.org/resource/image/fe/5f/fe9fb6d6e9deea8c3543f54572ec765f.jpg" alt=""><ul>
<li>CUBIC 的窗口增长函数仅仅取决于连续两次拥塞事件的时间间隔值，窗口增长完全独立于网络的时延 RTT。CUBIC 的窗口大小以及变化过程如图所示。</li>
<li>当出现丢包事件时，CUBIC 会记录这时的拥塞窗口大小，把它作为 Wmax。接着，CUBIC 会通过某个因子执行拥塞窗口的乘法减小，然后，沿着立方函数进行窗口的恢复。</li>
<li>从图中可以看出，一开始恢复的速度是比较快的，后来便从快速恢复阶段进入拥塞避免阶段，也即当窗口接近 Wmax 的时候，增加速度变慢；立方函数在 Wmax 处达到稳定点，增长速度为零，之后，在平稳期慢慢增长，沿着立方函数的开始探索新的最大窗口。</li>
</ul>
</li>
</ul>
<br>

<p><strong>HTTP 的 keepalive 模式是什么样？</strong></p>
<ul>
<li>在没有 keepalive 模式下，每个 HTTP 请求都要建立一个 TCP 连接，并且使用一次之后就断开这个 TCP 连接。</li>
<li>使用 keepalive 之后，在一次 TCP 连接中可以持续发送多份数据而不会断开连接，可以减少 TCP 连接建立次数，减少 TIME_WAIT 状态连接。<ul>
<li>长时间的 TCP 连接容易导致系统资源无效占用，因而需要设置正确的 keepalive timeout 时间。当一个 HTTP 产生的 TCP 连接在传送完最后一个响应后，还需要等待 keepalive timeout 秒后，才能关闭这个连接。如果这个期间又有新的请求过来，可以复用 TCP 连接。</li>
</ul>
</li>
</ul>
<br>

<p><strong>HTTPS 协议比较复杂，沟通过程太繁复，这样会导致效率问题，那你知道有哪些手段可以解决这些问题吗？</strong></p>
<p>使用基于 UDP 的 QUIC。</p>
<blockquote>
<p>参考上面的问题『QUIC 是一个精巧的协议，所以它肯定不止今天我提到的四种机制，你知道还有哪些吗？』</p>
</blockquote>
<br>

<p><strong>你觉得基于 RTMP 的视频流传输的机制存在什么问题？如何进行优化？</strong></p>
<p>RTMP 是基于 TCP 的，并不适合做实时流传输，可以换用基于 UDP 的方案</p>
<ul>
<li>基于自研 UDP 的协议传输</li>
<li>基于 QUIC 的协议传输</li>
</ul>
<br>

<p><strong>99% 卡住的原因是什么？</strong></p>
<p>99.99%的定义，是最后校验出了错误，漏失某个文件。</p>
<ul>
<li>漏失的原因可能是 client 因为流量压力过大而下线了，其他人就无法找到这个文件了，顶多DHT网络告诉每个client，漏失的文件在某个下线的人手上。你们就乖乖等他上线，并且把手上的99.99%分享给其他新来的new node吧。</li>
<li>不论是依赖 tracker，还是分布式哈希算法，p2p 开宗明义就是要减轻 server 压力，把压力转嫁给 client。</li>
</ul>
<p>解决方案</p>
<ul>
<li>比如迅雷，提供了 p2sp，长效种子，让 server 也有义务承担一些压力。<blockquote>
<p>至于迅雷为什么也会99.99%，应该是更进阶的技术问题了。比如下载网站专门防止迅雷盗链。</p>
</blockquote>
</li>
</ul>
<br>

<p><strong>全局负载均衡使用过程中，常常遇到失灵的情况，你知道具体有哪些情况吗？对应应该怎么来解决呢？</strong></p>
<ul>
<li>全局负载均衡器因为流量过大，而导致的失灵，<ul>
<li>此情况，是因为流量已经超过了当前机器的极限所导致的，针对此只能通过扩容来解决。</li>
</ul>
</li>
<li>全局负载均衡器因为机器故障了，导致的失灵。<ul>
<li>此情况的发生，说明机器存在负载均衡器有单点问题，须通过增加备机，或者更为可靠的集群来解决。</li>
</ul>
</li>
<li>全局负载均衡器因为网络故障，导致的失灵。<ul>
<li>此情况，案例莫过于支付宝的光纤被挖掘机挖断，此问题可通过接入更多的线路来解决，</li>
</ul>
</li>
</ul>
<br>

<p><strong>如果权威 DNS 连不上，怎么办？</strong></p>
<p>一般情况下，DNS 是基于 UDP 协议的。在应用层设置一个超时器，如果 UDP 发出没有回应，则会进行重试。</p>
<ul>
<li>DNS 服务器一般也是高可用的，很少情况下会挂。即便挂了，也会很快切换，重试一般就会成功。</li>
<li>对于客户端来讲，为了 DNS 解析能够成功，也会配置多个 DNS 服务器，当一个不成功的时候，可以选择另一个来尝试。</li>
</ul>
<br>

<p><strong>使用 HTTPDNS，需要向 HTTPDNS 服务器请求解析域名，可是客户端怎么知道 HTTPDNS 服务器的地址或者域名呢？</strong></p>
<p>HTTPDNS 服务器的地址一般不变，可以使用 DNS 的方式获取 HTTPDNS 服务器 IP 地址，也可以直接把 HTTPDNS 服务器的 IP 地址写死在客户端中。</p>
<br>

<p><strong>这一节讲了 CDN 使用 DNS 进行全局负载均衡的例子，CDN 如何使用 HTTPDNS 呢？</strong></p>
<p>参照阿里云 CDN HTTPDNS 的方式</p>
<ol>
<li>客户端请求服务端 umc.danuoyi.alicdn.com xxx，参数是客户端 IP 地址和待解析的域名</li>
<li>服务端返回多个 IP 地址，也就是一组 CDN 服务器地址</li>
<li>客户端轮训这些 IP 地址，以实现负载均衡</li>
</ol>
<br>

<p><strong>对于数据中心来讲，高可用是非常重要的，每个设备都要考虑高可用，那跨机房的高可用，你知道应该怎么做吗？</strong></p>
<p>跨机房的高可用分两个级别</p>
<ul>
<li>同城双活，就是在同一个城市，距离大概 30km 到 100km 的两个数据中心之间，通过高速专线互联的方式，让两个数据中心形成一个大二层网络。<br>  <img src="https://static001.geekbang.org/resource/image/8a/71/8af9a0a7c1d24b73d26ab0ef5f54b071.jpg" alt=""><ul>
<li>同城双活最重要的是<ul>
<li>数据如何从一个数据中心同步到另一个数据中心</li>
<li>在一个数据中心故障的时候，实现存储设备的切换，保证状态能够快速切换到另一个数据中心。</li>
</ul>
</li>
<li>在高速光纤互联情况下，主流的存储厂商都可以做到在一定距离之内的两台存储设备的近实时同步。数据双活是一切双活的基础。基于双数据中心的数据同步，可以形成一个统一的存储池，从而数据库层在共享存储池的情况下可以近实时的切换，例如 Oracle RAC。</li>
<li>虚拟机在统一的存储池的情况下，也可以实现跨机房的 HA，在一个机房切换到另一个机房。</li>
<li>SLB 负载均衡实现同一机房的各个虚拟机之间的负载均衡。GSLB 可以实现跨机房的负载均衡，实现外部访问的切换。</li>
<li>如果在两个数据中心距离很近，并且大二层可通的情况下，也可以使用 VRRP 协议，通过 VIP 方式进行外部访问的切换。</li>
</ul>
</li>
<li>异地灾备<br>  <img src="https://static001.geekbang.org/resource/image/e5/94/e561d8a5ec5842a67513ba42bda09494.jpg" alt=""><ul>
<li>异地灾备的第一大问题还是数据的问题，也即生产数据中心的数据如何备份到容灾数据中心。<ul>
<li>由于异地距离比较远，不可能像双活一样采取近同步的方式，只能通过异步的方式进行同步。</li>
<li>可以预见的问题是，容灾切换的时候，数据会丢失一部分。</li>
</ul>
</li>
<li>由于容灾数据中心平时是不用的，不是所有的数据都会进行容灾，否则成本太高。<ul>
<li>建议从业务层面进行容灾。由于数据同步会比较慢，可以根据业务需求高优先级同步重要的数据，因而容灾的层次越高越好。<ul>
<li>对业务来讲，如果用户可以根据业务层情况，在更细的粒度上区分数据是否重要。重要的数据，例如交易数据，需要优先同步；不重要的数据，例如日志数据，就不需要优先同步。</li>
</ul>
</li>
<li>有的用户完全不想操心，直接使用存储层面的异步复制。<ul>
<li>对于存储设备来讲，它是无法区分放在存储上的虚拟机，哪台是重要的，哪台是不重要的，只会完全根据块进行复制，很可能就会先复制了不重要的虚拟机。</li>
<li>如果用户想对虚拟机做区分，则可以使用虚拟机层面的异步复制。用户知道哪些虚拟机更重要一些，哪些虚拟机不重要，则可以先同步重要的虚拟机。</li>
</ul>
</li>
</ul>
</li>
<li>在有异地容灾的情况下，可以平时进行容灾演练，看容灾数据中心是否能够真正起作用，别容灾了半天，最后用的时候掉链子。</li>
</ul>
</li>
</ul>
<br>

<h2 id="协议专栏特别福利-答疑解惑第五期"><a href="#协议专栏特别福利-答疑解惑第五期" class="headerlink" title="协议专栏特别福利 | 答疑解惑第五期"></a>协议专栏特别福利 | 答疑解惑第五期</h2><p><strong>当前业务的高可用性和弹性伸缩很重要，所以很多机构都会在自建私有云之外，采购公有云，你知道私有云和公有云应该如何打通吗？</strong></p>
<p>公有云和私有云之间打通主要通过两种方式</p>
<ul>
<li>专线，这个需要跟运营商购买，而且需要花时间搭建。</li>
<li>VPN，包括 IPSec VPN 和 MPLS VPN。这个还需要在公有云厂商那边购买VPN 网关，将其和私有云的网关联通。</li>
</ul>
<br>

<p><strong>咱们上网都有套餐，有交钱多的，有交钱少的，你知道移动网络是如何控制不同优先级的用户的上网流量的吗？</strong></p>
<p>这个其实是 PCRF 协议进行控制的，它可以下发命令给 PGW 来控制上网的行为和特性。</p>
<br>

<p><strong>为了直观，这一节的内容我们以桌面虚拟化系统举例。在数据中心里面，有一款著名的开源软件 OpenStack，这一节讲的网络连通方式对应 OpenStack 中的哪些模型呢？</strong></p>
<p>openstack网络模式有三种</p>
<ul>
<li>flat</li>
<li>flat dhcp</li>
<li>vlan</li>
</ul>
<p>实际上对应到kvm的两种模式</p>
<ul>
<li>nat</li>
<li>桥接</li>
</ul>
<p>openstack 的 vlan 模式等 = kvm 的桥接模式 + vlan。</p>
<br>

<p><strong>在这一节中，提到了通过 VIP 可以通过流表在不同的机器之间实现负载均衡，你知道怎样才能做到吗？</strong></p>
<p>可以通过 ovs-ofctl 下发流表规则，创建 group，并把端口加入 group 中，所有发现某个地址的包在两个端口之间进行负载均衡。</p>
<br>

<p><strong>SDN 控制器是什么东西？</strong></p>
<p>SDN 控制器是一个独立的集群，主要是在管控面，因为要实现一定的高可用性。</p>
<ul>
<li>主流的开源控制器有 OpenContrail、OpenDaylight 等</li>
<li>每个网络硬件厂商都有自己的控制器，而且可以实现自己的私有协议，进行更加细粒度的控制<blockquote>
<p>所以江湖一直没有办法统一</p>
</blockquote>
</li>
</ul>
<br>

<p><strong>这一节中提到，入口流量其实没有办法控制，出口流量是可以很好控制的，你能想出一个控制云中的虚拟机的入口流量的方式吗？</strong></p>
<p>在云平台中，我们可以限制一个租户的默认带宽</p>
<ul>
<li>我们仍然可以配置点对点的流量控制<ul>
<li>在发送方的 OVS 上，我们可以统计发送方虚拟机的网络统计数据，上报给管理面。</li>
<li>在接收方的 OVS 上，我们同样可以收集接收方虚拟机的网络统计数据，上报给管理面。</li>
</ul>
</li>
<li>当流量过大的时候，我们虽然不能控制接收方的入口流量，但是我们可以在管理面下发一个策略，控制发送方的出口流量。</li>
</ul>
<br>

<p><strong>对于 HTB 借流量的情况，借出去的流量能够抢回来吗？</strong></p>
<p>借出去的流量，当自己使用的时候，是能够抢回来的。</p>
<p><img src="https://static001.geekbang.org/resource/image/2b/0b/2bf7de23e5bda856c606a73f66dd050b.jpg" alt=""><br>这是一棵 HTB 树</p>
<ul>
<li>有三个分支<ul>
<li>A 用户使用 www 访问网页</li>
<li>A 用户使用 SMTP 协议发送邮件</li>
<li>B 用户不限协议。</li>
</ul>
</li>
<li>图示分析<ol>
<li>在时间 0 的时候，0、1、2 都以 90k 的速度发送数据，也即 A 用户在访问网页，同时发送邮件；B 也在上网，干啥都行。</li>
<li>在时间 3 的时候，将 0 的发送停止，A 不再访问网页了，红色的线归零，A 的总速率下来了，剩余的流量按照比例分给了蓝色的和绿色的线，也即分给了 A 发邮件和 B 上网。</li>
<li>在时间 6 的时候，将 0 的发送重启为 90k，也即 A 重新开始访问网页，则蓝色和绿色的流量返还给红色的流量。</li>
<li>在时间 9 的时候，将 1 的发送停止，A 不再发送邮件了，绿色的流量为零，A 的总速率也下来了，剩余的流量按照比例分给了蓝色和红色。</li>
<li>在时间 12，将 1 的发送恢复，A 又开始发送邮件了，红色和蓝色返还流量。</li>
<li>在时间 15，将 2 的发送停止，B 不再上网了，啥也不干了，蓝色流量为零，剩余的流量按照比例分给红色和绿色。</li>
<li>在时间 19，将 1 的发送停止，A 不再发送邮件了，绿色的流量为零，所有的流量都归了红色，所有的带宽都用于 A 来访问网页。</li>
</ol>
</li>
</ul>
<br>

<p><strong>虽然 VXLAN 可以支持组播，但是如果虚拟机数目比较多，在 Overlay 网络里面，广播风暴问题依然会很严重，你能想到什么办法解决这个问题吗？</strong></p>
<p>很多情况下，物理机可以提前知道对端虚拟机的 MAC 地址，因而当发起 ARP 请求的时候，不用广播全网，只要本地返回就可以了，在 Openstack 里面称为 L2Population。</p>
<br>

<p><strong>容器内的网络和物理机网络可以使用 NAT 的方式相互访问，如果这种方式用于部署应用，有什么问题呢？</strong></p>
<ul>
<li>NAT 导致网络性能有损耗</li>
<li>NAT 导致看不到真实 IP</li>
<li>物理机端口被占用，当容器多的时候对于物理机端口的占用更加明显</li>
</ul>
<br>

<p><strong>通过 Flannel 的网络模型可以实现容器与容器直接跨主机的互相访问，那你知道如果容器内部访问外部的服务应该怎么融合到这个网络模型中吗？</strong></p>
<p>Pod 内到外部网络是通过 docker 引擎在 iptables 的 POSTROUTING 中的 MASQUERADE 规则实现的</p>
<ul>
<li>将容器的地址伪装为 node IP 出去</li>
<li>回来时再把包 nat 回容器的地址</li>
</ul>
<p>有的时候，我们想给外部的一个服务使用一个固定的域名，这就需要用到 Kubernetes 里 headless service 的 ExternalName。</p>
<ul>
<li>我们可以将某个外部的地址赋给一个 Service 的名称，当容器内访问这个名字的时候，就会访问一个虚拟的 IP。</li>
<li>在容器所在的节点上，由 iptables 规则映射到外部的 IP 地址。</li>
</ul>
<br>

<p><strong>将 Calico 部署在公有云上的时候，经常会选择使用 IPIP 模式，你知道这是为什么吗？</strong></p>
<p>如果 VPC 网络是平的，中间有路由，但是公有云经常会有一个限制，那就是容器的 IP 段是用户自己定义的，一旦出虚拟机的时候，云平台发现不是它分配的 IP，很多情况下直接就丢弃了。如果是 IPIP，出虚拟机之后，IP 还是虚拟机的 IP，就没有问题。</p>
<br>

<p><strong>在这篇文章中，mount 的过程是通过系统调用，最终调用到 RPC 层。一旦 mount 完毕之后，客户端就像写入本地文件一样写入 NFS 了，这个过程是如何触发 RPC 层的呢？</strong></p>
<p>是通过 VFS 实现的。在 Linux 里面，很多东西都是文件，因而内核中有一个打开的文件列表 File list，每个打开的文件都有一项。</p>
<ul>
<li>对于 Socket 来讲，in-core inode 就是内存中的 inode。</li>
<li>对于 nfs 来讲，也有一个 inode，这个 inode 里面有一个成员变量 file_operations，这里面是这个文件系统的操作函数，有 nfs_file_read、nfs_file_write，所以在一个 mount 的路径中读取某个文件的时候，就会调用这两个函数，触发 RPC，远程调用服务端。</li>
</ul>
<br>

<p><strong>对于 HTTP 协议来讲，有多种方法，但是 SOAP 只用了 POST，这样会有什么问题吗？</strong></p>
<p>虽然 HTTP 协议有多种方法，但是平常来说 POST，GET 基本足够用。</p>
<ul>
<li>SOAP 协议规范上是支持 GET 的，但是由于一般 XML 比较复杂，不适合放在 GET 请求的查询参数里，所以 SOAP 协议的服务多采用 POST 请求方法。</li>
<li>SOAP 只支持 POST 方法，缺少 GET 方法，GET 方法可以浏览器直接跳转，POST 必须借助表单或者 ajax 等提交，也就限制了 SOAP 请求只能在页面内获取或者提交数据。 </li>
</ul>
<br>

<p><strong>对于微服务模式下的 RPC 框架的选择，Dubbo 和 SpringCloud 各有优缺点，你能做个详细的对比吗？</strong></p>
<ul>
<li>实现方案<ul>
<li>Dubbo 只实现了服务治理</li>
<li>Spring Cloud 子项目分别覆盖了微服务架构下的众多部件</li>
</ul>
</li>
<li>协议<ul>
<li>Dubbo 使用 RPC 通讯协议</li>
<li>Spring Cloud使用 HTTP 协议 REST API</li>
</ul>
</li>
<li>性能：Dubbo 通信性能略胜于 Spring Cloud</li>
<li>组件依赖关系<ul>
<li>Dubbo通过接口的方式相互依赖，强依赖关系，需要严格的版本控制，对程序无入侵</li>
<li>Spring Cloud 无接口依赖，定义好相关的json字段即可，对程序有一定入侵性</li>
</ul>
</li>
</ul>
<br>

<p><strong>在讲述 Service Mesh 的时候，我们说了，希望 Envoy 能够在服务不感知的情况下，将服务之间的调用全部代理了，你知道怎么做到这一点吗？</strong></p>
<p><img src="https://static001.geekbang.org/resource/image/56/f8/56e282315a2ef361aa0a8bb1cf0b38f8.jpg" alt=""><br>iptables 规则可以这样来设置：</p>
<ol>
<li>定义的一条规则是 ISTIO_REDIRECT 转发链。这条链不管三七二十一，都将网络包转发给 envoy 的 15000 端口。但是一开始这条链没有被挂到 iptables 默认的几条链中，所以不起作用。</li>
<li>在 PREROUTING 规则中使用这个转发链。从而，进入容器的所有流量都被先转发到 envoy 的 15000 端口。而 envoy 作为一个代理，已经被配置好了，将请求转发给 productpage 程序。</li>
<li>当 productpage 往后端进行调用的时候，就碰到了 output 链。这个链会使用转发链，将所有出容器的请求都转发到 envoy 的 15000 端口。</li>
<li>这样，无论是入口的流量，还是出口的流量，全部用 envoy 做成了“汉堡包”。envoy 根据服务发现的配置，做最终的对外调用。</li>
<li>这个时候，iptables 规则会对从 envoy 出去的流量做一个特殊处理，允许它发出去，不再使用上面的 output 规则。</li>
</ol>
<!-- flag of hidden posts -->
    

    

    

  </div>
  <div class="article-info article-info-index">
    
    
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color3">笔记</a>
        		</li>
      		
		</ul>
	</div>

    

    

    
    
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <!-- <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a> -->
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
     <!-- <img src="//pan.baidu.com/share/qrcode?url=http://yueban.github.io/2019/03/12/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4-%E3%80%8A%E8%B6%A3%E8%B0%88%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E3%80%8B%E7%AC%94%E8%AE%B0/" alt="微信分享二维码"> -->
    </div>
</div>

<div class="mask js-mask"></div>

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>



<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
        <div class="toc-container tooltip-left">
            <i class="icon-font icon-category"></i>
            <div class="tooltip tooltip-east">
                <span class="tooltip-item">
                </span>
                <span class="tooltip-content">
                    <div class="toc-article">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#第1讲-为什么要学习网络协议？"><span class="toc-number">1.</span> <span class="toc-text">第1讲 | 为什么要学习网络协议？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#协议举例-HTTP"><span class="toc-number">1.0.1.</span> <span class="toc-text">协议举例: HTTP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第2讲-网络分层的真实含义是什么？"><span class="toc-number">2.</span> <span class="toc-text">第2讲 | 网络分层的真实含义是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#网络为什么要分层"><span class="toc-number">2.0.1.</span> <span class="toc-text">网络为什么要分层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#揭秘层与层之间的关系"><span class="toc-number">2.0.2.</span> <span class="toc-text">揭秘层与层之间的关系</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第3讲-ifconfig：最熟悉又陌生的命令行"><span class="toc-number">3.</span> <span class="toc-text">第3讲 | ifconfig：最熟悉又陌生的命令行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MAC-地址与-IP-地址"><span class="toc-number">3.0.1.</span> <span class="toc-text">MAC 地址与 IP 地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IP-地址分类"><span class="toc-number">3.0.2.</span> <span class="toc-text">IP 地址分类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第4讲-DHCP与PXE：IP是怎么来的，又是怎么没的？"><span class="toc-number">4.</span> <span class="toc-text">第4讲 | DHCP与PXE：IP是怎么来的，又是怎么没的？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#动态主机配置协议（DHCP）"><span class="toc-number">4.0.1.</span> <span class="toc-text">动态主机配置协议（DHCP）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#预启动执行环境（Pre-boot-Execution-Environment），简称PXE。"><span class="toc-number">4.0.2.</span> <span class="toc-text">预启动执行环境（Pre-boot Execution Environment），简称PXE。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PXE-的工作过程"><span class="toc-number">4.0.3.</span> <span class="toc-text">PXE 的工作过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第5讲-从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？"><span class="toc-number">5.</span> <span class="toc-text">第5讲 | 从物理层到MAC层：如何在宿舍里自己组网玩联机游戏？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#数据链路层解决的三个问题"><span class="toc-number">5.0.1.</span> <span class="toc-text">数据链路层解决的三个问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据链路层解决的三个问题的解决方案"><span class="toc-number">5.0.2.</span> <span class="toc-text">数据链路层解决的三个问题的解决方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ARP-协议"><span class="toc-number">5.0.3.</span> <span class="toc-text">ARP 协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#集线器-Hub-与-交换机-Switcher"><span class="toc-number">5.0.4.</span> <span class="toc-text">集线器(Hub) 与 交换机(Switcher)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第6讲-交换机与VLAN：办公室太复杂，我要回学校"><span class="toc-number">6.</span> <span class="toc-text">第6讲 | 交换机与VLAN：办公室太复杂，我要回学校</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#环路问题"><span class="toc-number">6.0.1.</span> <span class="toc-text">环路问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#STP-Spanning-Tree-Protocol"><span class="toc-number">6.0.2.</span> <span class="toc-text">STP (Spanning Tree Protocol)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如何解决广播问题和安全问题？"><span class="toc-number">6.0.3.</span> <span class="toc-text">如何解决广播问题和安全问题？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第7讲-ICMP与ping：投石问路的侦察兵"><span class="toc-number">7.</span> <span class="toc-text">第7讲 | ICMP与ping：投石问路的侦察兵</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ICMP-协议的格式"><span class="toc-number">7.0.1.</span> <span class="toc-text">ICMP 协议的格式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ICMP-报文类型"><span class="toc-number">7.0.2.</span> <span class="toc-text">ICMP 报文类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第8讲-世界这么大，我想出网关：欧洲十国游与玄奘西行"><span class="toc-number">8.</span> <span class="toc-text">第8讲 | 世界这么大，我想出网关：欧洲十国游与玄奘西行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#请求目标-ip-的两种场景"><span class="toc-number">8.0.1.</span> <span class="toc-text">请求目标 ip 的两种场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#静态路由下，通过网关转发的两种场景"><span class="toc-number">8.0.2.</span> <span class="toc-text">静态路由下，通过网关转发的两种场景</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第9讲-路由协议：西出网关无故人，敢问路在何方"><span class="toc-number">9.</span> <span class="toc-text">第9讲 | 路由协议：西出网关无故人，敢问路在何方</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#如何确定下一个转发目标？"><span class="toc-number">9.0.1.</span> <span class="toc-text">如何确定下一个转发目标？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#策略路由-仅用于静态路由"><span class="toc-number">9.0.2.</span> <span class="toc-text">策略路由 (仅用于静态路由)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态路由"><span class="toc-number">9.0.3.</span> <span class="toc-text">动态路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态路由算法"><span class="toc-number">9.0.4.</span> <span class="toc-text">动态路由算法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态路由协议"><span class="toc-number">9.0.5.</span> <span class="toc-text">动态路由协议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第10讲-UDP协议：因性善而简单，难免碰到“城会玩”"><span class="toc-number">10.</span> <span class="toc-text">第10讲 | UDP协议：因性善而简单，难免碰到“城会玩”</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-和-UDP-有哪些区别？"><span class="toc-number">10.0.1.</span> <span class="toc-text">TCP 和 UDP 有哪些区别？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UDP-的三大使用场景"><span class="toc-number">10.0.2.</span> <span class="toc-text">UDP 的三大使用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于-UDP-的五个例子"><span class="toc-number">10.0.3.</span> <span class="toc-text">基于 UDP 的五个例子</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第11讲-TCP协议（上）：因性恶而复杂，先恶后善反轻松"><span class="toc-number">11.</span> <span class="toc-text">第11讲 | TCP协议（上）：因性恶而复杂，先恶后善反轻松</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-包头主要关注的5个问题"><span class="toc-number">11.0.1.</span> <span class="toc-text">TCP 包头主要关注的5个问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-的三次握手"><span class="toc-number">11.0.2.</span> <span class="toc-text">TCP 的三次握手</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-四次挥手"><span class="toc-number">11.0.3.</span> <span class="toc-text">TCP 四次挥手</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-状态机"><span class="toc-number">11.0.4.</span> <span class="toc-text">TCP 状态机</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第12讲-TCP协议（下）：西行必定多妖孽，恒心智慧消磨难"><span class="toc-number">12.</span> <span class="toc-text">第12讲 | TCP协议（下）：西行必定多妖孽，恒心智慧消磨难</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#累计确认-累计应答（cumulative-acknowledgment）"><span class="toc-number">12.0.1.</span> <span class="toc-text">累计确认&#x2F;累计应答（cumulative acknowledgment）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-发送端缓存"><span class="toc-number">12.0.2.</span> <span class="toc-text">TCP 发送端缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TCP-接收端缓存"><span class="toc-number">12.0.3.</span> <span class="toc-text">TCP 接收端缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#超时重试"><span class="toc-number">12.0.4.</span> <span class="toc-text">超时重试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#流量控制"><span class="toc-number">12.0.5.</span> <span class="toc-text">流量控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拥塞控制"><span class="toc-number">12.0.6.</span> <span class="toc-text">拥塞控制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第13讲-套接字Socket：Talk-is-cheap-show-me-the-code"><span class="toc-number">13.</span> <span class="toc-text">第13讲 | 套接字Socket：Talk is cheap, show me the code</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基于-TCP-协议的-Socket-程序函数调用过程"><span class="toc-number">13.0.1.</span> <span class="toc-text">基于 TCP 协议的 Socket 程序函数调用过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于-UDP-协议的-Socket-程序函数调用过程"><span class="toc-number">13.0.2.</span> <span class="toc-text">基于 UDP 协议的 Socket 程序函数调用过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于-TCP-协议的-Socket-的文件流数据结构"><span class="toc-number">13.0.3.</span> <span class="toc-text">基于 TCP 协议的 Socket 的文件流数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#最大连接数"><span class="toc-number">13.0.4.</span> <span class="toc-text">最大连接数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务器如何接更多的项目？"><span class="toc-number">13.0.5.</span> <span class="toc-text">服务器如何接更多的项目？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第14讲-HTTP协议：看个新闻原来这么麻烦"><span class="toc-number">14.</span> <span class="toc-text">第14讲 | HTTP协议：看个新闻原来这么麻烦</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-请求的准备"><span class="toc-number">14.0.1.</span> <span class="toc-text">HTTP 请求的准备</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-请求的构建"><span class="toc-number">14.0.2.</span> <span class="toc-text">HTTP 请求的构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-请求的发送"><span class="toc-number">14.0.3.</span> <span class="toc-text">HTTP 请求的发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-返回的构建"><span class="toc-number">14.0.4.</span> <span class="toc-text">HTTP 返回的构建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-返回的发送"><span class="toc-number">14.0.5.</span> <span class="toc-text">HTTP 返回的发送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTP-2-0"><span class="toc-number">14.0.6.</span> <span class="toc-text">HTTP 2.0</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#QUIC-协议"><span class="toc-number">14.0.7.</span> <span class="toc-text">QUIC 协议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第15讲-HTTPS协议：点外卖的过程原来这么复杂"><span class="toc-number">15.</span> <span class="toc-text">第15讲 | HTTPS协议：点外卖的过程原来这么复杂</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#加密方式"><span class="toc-number">15.0.1.</span> <span class="toc-text">加密方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数字证书-Certificate"><span class="toc-number">15.0.2.</span> <span class="toc-text">数字证书 (Certificate)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPS-的工作模式"><span class="toc-number">15.0.3.</span> <span class="toc-text">HTTPS 的工作模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重放与篡改"><span class="toc-number">15.0.4.</span> <span class="toc-text">重放与篡改</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第16讲-流媒体协议：如何在直播里看到美女帅哥？"><span class="toc-number">16.</span> <span class="toc-text">第16讲 | 流媒体协议：如何在直播里看到美女帅哥？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#视频和图片的压缩过程的特点"><span class="toc-number">16.0.1.</span> <span class="toc-text">视频和图片的压缩过程的特点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#视频编码的规范"><span class="toc-number">16.0.2.</span> <span class="toc-text">视频编码的规范</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#直播的原理"><span class="toc-number">16.0.3.</span> <span class="toc-text">直播的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#编码的原理"><span class="toc-number">16.0.4.</span> <span class="toc-text">编码的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#推流：如何把数据流打包传输到对端？-基于-RTMP-协议"><span class="toc-number">16.0.5.</span> <span class="toc-text">推流：如何把数据流打包传输到对端？(基于 RTMP 协议)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拉流：观众的客户端如何看到视频？"><span class="toc-number">16.0.6.</span> <span class="toc-text">拉流：观众的客户端如何看到视频？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第17讲-P2P协议：我下小电影，99-急死你"><span class="toc-number">17.</span> <span class="toc-text">第17讲 | P2P协议：我下小电影，99%急死你</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#FTP（文件传输协议）"><span class="toc-number">17.0.1.</span> <span class="toc-text">FTP（文件传输协议）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#P2P"><span class="toc-number">17.0.2.</span> <span class="toc-text">P2P</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#种子（-torrent）文件"><span class="toc-number">17.0.3.</span> <span class="toc-text">种子（.torrent）文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#去中心化网络（DHT）"><span class="toc-number">17.0.4.</span> <span class="toc-text">去中心化网络（DHT）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHT-node-应该知道哪部分文件的索引？"><span class="toc-number">17.0.5.</span> <span class="toc-text">DHT node 应该知道哪部分文件的索引？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHT-node-新节点上线"><span class="toc-number">17.0.6.</span> <span class="toc-text">DHT node 新节点上线</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHT-网络的节点关系是怎么规定的？"><span class="toc-number">17.0.7.</span> <span class="toc-text">DHT 网络的节点关系是怎么规定的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHT-网络是如何查找节点的？"><span class="toc-number">17.0.8.</span> <span class="toc-text">DHT 网络是如何查找节点的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHT-网络中，节点之间如何沟通？"><span class="toc-number">17.0.9.</span> <span class="toc-text">DHT 网络中，节点之间如何沟通？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DHT-网络中，节点关系如何更新？"><span class="toc-number">17.0.10.</span> <span class="toc-text">DHT 网络中，节点关系如何更新？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第18讲-DNS协议：网络世界的地址簿"><span class="toc-number">18.</span> <span class="toc-text">第18讲 | DNS协议：网络世界的地址簿</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#DNS-服务器"><span class="toc-number">18.0.1.</span> <span class="toc-text">DNS 服务器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DNS-解析流程"><span class="toc-number">18.0.2.</span> <span class="toc-text">DNS 解析流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#负载均衡"><span class="toc-number">18.0.3.</span> <span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#示例：DNS-访问数据中心中对象存储上的静态资源"><span class="toc-number">18.0.4.</span> <span class="toc-text">示例：DNS 访问数据中心中对象存储上的静态资源</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第19讲-HTTPDNS：网络世界的地址簿也会指错路"><span class="toc-number">19.</span> <span class="toc-text">第19讲 | HTTPDNS：网络世界的地址簿也会指错路</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#传统-DNS-存在哪些问题？"><span class="toc-number">19.0.1.</span> <span class="toc-text">传统 DNS 存在哪些问题？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPDNS-的工作模式"><span class="toc-number">19.0.2.</span> <span class="toc-text">HTTPDNS 的工作模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPDNS-的缓存设计"><span class="toc-number">19.0.3.</span> <span class="toc-text">HTTPDNS 的缓存设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HTTPDNS-的调度设计"><span class="toc-number">19.0.4.</span> <span class="toc-text">HTTPDNS 的调度设计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第20讲-CDN：你去小卖部取过快递么？"><span class="toc-number">20.</span> <span class="toc-text">第20讲 | CDN：你去小卖部取过快递么？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CDN-的分发系统的架构"><span class="toc-number">20.0.1.</span> <span class="toc-text">CDN 的分发系统的架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#客户端如何找到相应的边缘节点进行访问呢？"><span class="toc-number">20.0.2.</span> <span class="toc-text">客户端如何找到相应的边缘节点进行访问呢？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CDN-可以进行缓存的内容"><span class="toc-number">20.0.3.</span> <span class="toc-text">CDN 可以进行缓存的内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CDN-防盗链"><span class="toc-number">20.0.4.</span> <span class="toc-text">CDN 防盗链</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#动态-CDN"><span class="toc-number">20.0.5.</span> <span class="toc-text">动态 CDN</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第21讲-数据中心：我是开发商，自己拿地盖别墅"><span class="toc-number">21.</span> <span class="toc-text">第21讲 | 数据中心：我是开发商，自己拿地盖别墅</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#概述"><span class="toc-number">21.0.1.</span> <span class="toc-text">概述</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第22讲-VPN：朝中有人好做官"><span class="toc-number">22.</span> <span class="toc-text">第22讲 | VPN：朝中有人好做官</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VPN-是如何工作的？"><span class="toc-number">22.0.1.</span> <span class="toc-text">VPN 是如何工作的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPsec"><span class="toc-number">22.0.2.</span> <span class="toc-text">IPsec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPsec-VPN-的协议簇"><span class="toc-number">22.0.3.</span> <span class="toc-text">IPsec VPN 的协议簇</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IPsec-VPN-的建立过程"><span class="toc-number">22.0.4.</span> <span class="toc-text">IPsec VPN 的建立过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ATM"><span class="toc-number">22.0.5.</span> <span class="toc-text">ATM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#多协议标签交换（MPLS，Multi-Protocol-Label-Switching）"><span class="toc-number">22.0.6.</span> <span class="toc-text">多协议标签交换（MPLS，Multi-Protocol Label Switching）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MPLS-VPN"><span class="toc-number">22.0.7.</span> <span class="toc-text">MPLS VPN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MPLS-VPN-发包过程"><span class="toc-number">22.0.8.</span> <span class="toc-text">MPLS VPN 发包过程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第23讲-移动网络：去巴塞罗那，手机也上不了脸书"><span class="toc-number">23.</span> <span class="toc-text">第23讲 | 移动网络：去巴塞罗那，手机也上不了脸书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2G-网络"><span class="toc-number">23.0.1.</span> <span class="toc-text">2G 网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5G-网络"><span class="toc-number">23.0.2.</span> <span class="toc-text">2.5G 网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3G-网络"><span class="toc-number">23.0.3.</span> <span class="toc-text">3G 网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4G-网络"><span class="toc-number">23.0.4.</span> <span class="toc-text">4G 网络</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4G-网络协议解析"><span class="toc-number">23.0.5.</span> <span class="toc-text">4G 网络协议解析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#手机上网流程"><span class="toc-number">23.0.6.</span> <span class="toc-text">手机上网流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#异地上网问题"><span class="toc-number">23.0.7.</span> <span class="toc-text">异地上网问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第24讲-云中网络：自己拿地成本高，购买公寓更灵活"><span class="toc-number">24.</span> <span class="toc-text">第24讲 | 云中网络：自己拿地成本高，购买公寓更灵活</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#传统数据中心的问题"><span class="toc-number">24.0.1.</span> <span class="toc-text">传统数据中心的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#从物理机到虚拟机"><span class="toc-number">24.0.2.</span> <span class="toc-text">从物理机到虚拟机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#虚拟网卡的原理"><span class="toc-number">24.0.3.</span> <span class="toc-text">虚拟网卡的原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#虚拟网卡连接到数据中心（云中），需要注意的问题"><span class="toc-number">24.0.4.</span> <span class="toc-text">虚拟网卡连接到数据中心（云中），需要注意的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#共享与互通问题"><span class="toc-number">24.0.5.</span> <span class="toc-text">共享与互通问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#隔离问题"><span class="toc-number">24.0.6.</span> <span class="toc-text">隔离问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第25讲-软件定义网络：共享基础设施的小区物业管理办法"><span class="toc-number">25.</span> <span class="toc-text">第25讲 | 软件定义网络：共享基础设施的小区物业管理办法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#软件定义网络（SDN）"><span class="toc-number">25.0.1.</span> <span class="toc-text">软件定义网络（SDN）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenFlow-和-OpenvSwitch"><span class="toc-number">25.0.2.</span> <span class="toc-text">OpenFlow 和 OpenvSwitch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验一：用-OpenvSwitch-实现-VLAN-的功能"><span class="toc-number">25.0.3.</span> <span class="toc-text">实验一：用 OpenvSwitch 实现 VLAN 的功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#实验二：用-OpenvSwitch-模拟网卡绑定，连接交换机"><span class="toc-number">25.0.4.</span> <span class="toc-text">实验二：用 OpenvSwitch 模拟网卡绑定，连接交换机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenvSwitch-架构"><span class="toc-number">25.0.5.</span> <span class="toc-text">OpenvSwitch 架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#如何在云计算中使用-OpenvSwitch？"><span class="toc-number">25.0.6.</span> <span class="toc-text">如何在云计算中使用 OpenvSwitch？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第26讲-云中的网络安全：虽然不是土豪，也需要基本安全和保障"><span class="toc-number">26.</span> <span class="toc-text">第26讲 | 云中的网络安全：虽然不是土豪，也需要基本安全和保障</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Netfilter-与-ip-tables"><span class="toc-number">26.0.1.</span> <span class="toc-text">Netfilter 与 ip_tables</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安全组"><span class="toc-number">26.0.2.</span> <span class="toc-text">安全组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于-iptables-的安全组的实现"><span class="toc-number">26.0.3.</span> <span class="toc-text">基于 iptables 的安全组的实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于-iptables-解决外网访问问题"><span class="toc-number">26.0.4.</span> <span class="toc-text">基于 iptables 解决外网访问问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第27讲-云中的网络QoS：邻居疯狂下电影，我该怎么办？"><span class="toc-number">27.</span> <span class="toc-text">第27讲 | 云中的网络QoS：邻居疯狂下电影，我该怎么办？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#控制网络的-QoS-有哪些方式？"><span class="toc-number">27.0.1.</span> <span class="toc-text">控制网络的 QoS 有哪些方式？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenvSwitch-中的-QoS"><span class="toc-number">27.0.2.</span> <span class="toc-text">OpenvSwitch 中的 QoS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第28讲-云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私"><span class="toc-number">28.</span> <span class="toc-text">第28讲 | 云中网络的隔离GRE、VXLAN：虽然住一个小区，也要保护隐私</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#VLAN-数量不够用怎么办？"><span class="toc-number">28.0.1.</span> <span class="toc-text">VLAN 数量不够用怎么办？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GRE"><span class="toc-number">28.0.2.</span> <span class="toc-text">GRE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VXLAN"><span class="toc-number">28.0.3.</span> <span class="toc-text">VXLAN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OpenvSwitch-中的隧道"><span class="toc-number">28.0.4.</span> <span class="toc-text">OpenvSwitch 中的隧道</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第29讲-容器网络：来去自由的日子，不买公寓去合租"><span class="toc-number">29.</span> <span class="toc-text">第29讲 | 容器网络：来去自由的日子，不买公寓去合租</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实现容器的两种主要技术"><span class="toc-number">29.0.1.</span> <span class="toc-text">实现容器的两种主要技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#容器网络内部如何实现互通"><span class="toc-number">29.0.2.</span> <span class="toc-text">容器网络内部如何实现互通</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#容器网络中如何融入物理网络？"><span class="toc-number">29.0.3.</span> <span class="toc-text">容器网络中如何融入物理网络？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第30讲-容器网络之Flannel：每人一亩三分地"><span class="toc-number">30.</span> <span class="toc-text">第30讲 | 容器网络之Flannel：每人一亩三分地</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Flannel-解决的两个问题"><span class="toc-number">30.0.1.</span> <span class="toc-text">Flannel 解决的两个问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第31讲-容器网络之Calico：为高效说出善意的谎言"><span class="toc-number">31.</span> <span class="toc-text">第31讲 | 容器网络之Calico：为高效说出善意的谎言</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Calico-网络的转发细节"><span class="toc-number">31.0.1.</span> <span class="toc-text">Calico 网络的转发细节</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Calico-的架构"><span class="toc-number">31.0.2.</span> <span class="toc-text">Calico 的架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#全连接复杂性与规模问题"><span class="toc-number">31.0.3.</span> <span class="toc-text">全连接复杂性与规模问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#跨网段访问问题"><span class="toc-number">31.0.4.</span> <span class="toc-text">跨网段访问问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第32讲-RPC协议综述：远在天边，近在眼前"><span class="toc-number">32.</span> <span class="toc-text">第32讲 | RPC协议综述：远在天边，近在眼前</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#容器应用之间相互调用的五个问题"><span class="toc-number">32.0.1.</span> <span class="toc-text">容器应用之间相互调用的五个问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#协议约定问题"><span class="toc-number">32.0.2.</span> <span class="toc-text">协议约定问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务发现问题"><span class="toc-number">32.0.3.</span> <span class="toc-text">服务发现问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#传输问题"><span class="toc-number">32.0.4.</span> <span class="toc-text">传输问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第33讲-基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛"><span class="toc-number">33.</span> <span class="toc-text">第33讲 | 基于XML的SOAP协议：不要说NBA，请说美国职业篮球联赛</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ONC-RPC-存在哪些问题？"><span class="toc-number">33.0.1.</span> <span class="toc-text">ONC RPC 存在哪些问题？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#传输协议问题与-SOAP"><span class="toc-number">33.0.2.</span> <span class="toc-text">传输协议问题与 SOAP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#协议约定问题-1"><span class="toc-number">33.0.3.</span> <span class="toc-text">协议约定问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务发现问题-1"><span class="toc-number">33.0.4.</span> <span class="toc-text">服务发现问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第34讲-基于JSON的RESTful接口协议：我不关心过程，请给我结果"><span class="toc-number">34.</span> <span class="toc-text">第34讲 | 基于JSON的RESTful接口协议：我不关心过程，请给我结果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SOAP-的问题"><span class="toc-number">34.0.1.</span> <span class="toc-text">SOAP 的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#传输协议问题与-RESTful-格式的-API"><span class="toc-number">34.0.2.</span> <span class="toc-text">传输协议问题与 RESTful 格式的 API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#协议约定问题（对比-REST-RESTful-与-SOAP）"><span class="toc-number">34.0.3.</span> <span class="toc-text">协议约定问题（对比 REST&#x2F;RESTful 与 SOAP）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务发现问题-2"><span class="toc-number">34.0.4.</span> <span class="toc-text">服务发现问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第35讲-二进制类RPC协议：还是叫NBA吧，总说全称多费劲"><span class="toc-number">35.</span> <span class="toc-text">第35讲 | 二进制类RPC协议：还是叫NBA吧，总说全称多费劲</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#数据中心内部是如何相互调用的？"><span class="toc-number">35.0.1.</span> <span class="toc-text">数据中心内部是如何相互调用的？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dubbo"><span class="toc-number">35.0.2.</span> <span class="toc-text">Dubbo</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dubbo-如何解决-RPC-三大问题？"><span class="toc-number">35.0.3.</span> <span class="toc-text">Dubbo 如何解决 RPC 三大问题？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为何-Spring-Cloud-又兴起了？"><span class="toc-number">35.0.4.</span> <span class="toc-text">为何 Spring Cloud 又兴起了？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第36讲-跨语言类RPC协议：交流之前，双方先来个专业术语表"><span class="toc-number">36.</span> <span class="toc-text">第36讲 | 跨语言类RPC协议：交流之前，双方先来个专业术语表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#前文-RPC-内容总结"><span class="toc-number">36.0.1.</span> <span class="toc-text">前文 RPC 内容总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Protocol-Buffers"><span class="toc-number">36.0.2.</span> <span class="toc-text">Protocol Buffers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#协议约定问题-2"><span class="toc-number">36.0.3.</span> <span class="toc-text">协议约定问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#网络传输问题"><span class="toc-number">36.0.4.</span> <span class="toc-text">网络传输问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务发现与治理问题"><span class="toc-number">36.0.5.</span> <span class="toc-text">服务发现与治理问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第37讲-知识串讲：用双十一的故事串起碎片的网络协议（上）"><span class="toc-number">37.</span> <span class="toc-text">第37讲 | 知识串讲：用双十一的故事串起碎片的网络协议（上）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#一-部署一个高可用高并发的电商平台"><span class="toc-number">37.0.1.</span> <span class="toc-text">一. 部署一个高可用高并发的电商平台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#二-大声告诉全世界，可以到我这里买东西"><span class="toc-number">37.0.2.</span> <span class="toc-text">二. 大声告诉全世界，可以到我这里买东西</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三-打开手机来上网，域名解析得地址"><span class="toc-number">37.0.3.</span> <span class="toc-text">三. 打开手机来上网，域名解析得地址</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第38讲-知识串讲：用双十一的故事串起碎片的网络协议（中）"><span class="toc-number">38.</span> <span class="toc-text">第38讲 | 知识串讲：用双十一的故事串起碎片的网络协议（中）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#四-购物之前看图片，静态资源-CDN"><span class="toc-number">38.0.1.</span> <span class="toc-text">四. 购物之前看图片，静态资源 CDN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#五-看上宝贝点下单，双方开始建连接"><span class="toc-number">38.0.2.</span> <span class="toc-text">五. 看上宝贝点下单，双方开始建连接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#六-发送下单请求网络包，西行需要出网关"><span class="toc-number">38.0.3.</span> <span class="toc-text">六. 发送下单请求网络包，西行需要出网关</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第39讲-知识串讲：用双十一的故事串起碎片的网络协议（下）"><span class="toc-number">39.</span> <span class="toc-text">第39讲 | 知识串讲：用双十一的故事串起碎片的网络协议（下）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#七-一座座城池一道道关，流控拥塞与重传"><span class="toc-number">39.0.1.</span> <span class="toc-text">七. 一座座城池一道道关，流控拥塞与重传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#八-从数据中心进网关，公网-NAT-成私网"><span class="toc-number">39.0.2.</span> <span class="toc-text">八. 从数据中心进网关，公网 NAT 成私网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#九-进入隧道打标签，RPC-远程调用下单"><span class="toc-number">39.0.3.</span> <span class="toc-text">九. 进入隧道打标签，RPC 远程调用下单</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#十-下单扣减库存优惠券，数据入库返回成功"><span class="toc-number">39.0.4.</span> <span class="toc-text">十. 下单扣减库存优惠券，数据入库返回成功</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#协议专栏特别福利-答疑解惑第一期"><span class="toc-number">40.</span> <span class="toc-text">协议专栏特别福利 | 答疑解惑第一期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#协议专栏特别福利-答疑解惑第二期"><span class="toc-number">41.</span> <span class="toc-text">协议专栏特别福利 | 答疑解惑第二期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#协议专栏特别福利-答疑解惑第三期"><span class="toc-number">42.</span> <span class="toc-text">协议专栏特别福利 | 答疑解惑第三期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#协议专栏特别福利-答疑解惑第四期"><span class="toc-number">43.</span> <span class="toc-text">协议专栏特别福利 | 答疑解惑第四期</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#协议专栏特别福利-答疑解惑第五期"><span class="toc-number">44.</span> <span class="toc-text">协议专栏特别福利 | 答疑解惑第五期</span></a></li></ol>
                    </div>
                </span>
            </div>
        </div>
        
    </div>
</aside>











  
  <div id="gitment-ctn"></div>
  
    <!-- 中文 -->
    <link rel="stylesheet" href="/lib/gitment.css">
    <script src="/lib/gitment.js"></script>
  
  <script>
    <!-- id: "极客时间 - 《趣谈网络协议》笔记" -->
    var gitment = new Gitment({
      id: "20190312200453",
      owner: 'yueban',
      repo: 'yueban.github.com',
      oauth: {
        client_id: '0f00df319b4700319525',
        client_secret: '231161c65ada7d4d4da3329ea2e97b3bc7523d5a',
      },
    })
    gitment.render('gitment-ctn')
  </script>


  



          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2014-2020 <a href="http://yueban.github.io/" target="_blank">月半兄</a>
    	</div>
      	<div class="footer-right">
			
			
      		GitHub:<a href="https://github.com/JoeyBling/hexo-theme-yilia-plus" target="_blank">hexo-theme-yilia-plus</a> by Litten
      	</div>
    </div>
  </div>
  
  
	<script src="/lib/busuanzi.pure.js"></script>
	
  
  
	
	<span id="busuanzi_container_site_pv" style="display:none">
		本站总访问量<span id="busuanzi_value_site_pv"></span>次	
	        <span class="post-meta-divider" >|</span>
	</span>
  	<span id="busuanzi_container_site_uv" style='display:none'>
  		本站访客数<span id="busuanzi_value_site_uv"></span>人
  	</span>
  
</footer>

    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>!function(r){function e(t){if(i[t])return i[t].exports;var n=i[t]={exports:{},id:t,loaded:!1};return r[t].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var i={};e.m=r,e.c=i,e.p="./",e(0)}([function(t,n,r){r(208),t.exports=r(205)},function(t,n,r){var d=r(3),y=r(46),g=r(26),b=r(27),x=r(47),m="prototype",S=function(t,n,r){var e,i,o,u,c=t&S.F,f=t&S.G,a=t&S.S,s=t&S.P,l=t&S.B,h=f?d:a?d[n]||(d[n]={}):(d[n]||{})[m],v=f?y:y[n]||(y[n]={}),p=v[m]||(v[m]={});for(e in f&&(r=n),r)o=((i=!c&&h&&void 0!==h[e])?h:r)[e],u=l&&i?x(o,d):s&&"function"==typeof o?x(Function.call,o):o,h&&b(h,e,o,t&S.U),v[e]!=o&&g(v,e,u),s&&p[e]!=o&&(p[e]=o)};d.core=y,S.F=1,S.G=2,S.S=4,S.P=8,S.B=16,S.W=32,S.U=64,S.R=128,t.exports=S},function(t,n,r){var e=r(5);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n,r){var e=r(118)("wks"),i=r(79),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(49),i=Math.min;t.exports=function(t){return 0<t?i(e(t),9007199254740991):0}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(174),o=r(53),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(20)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(24);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(22),i=r(60),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(96),i=r(34);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(40)("wks"),i=r(25),o=r(6).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(51);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){var r=t.exports={version:"2.6.9"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(18);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=!0},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(11),i=r(75);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var o=r(3),u=r(26),c=r(30),f=r(79)("src"),e=r(219),i="toString",a=(""+e).split(i);r(46).inspectSource=function(t){return e.call(t)},(t.exports=function(t,n,r,e){var i="function"==typeof r;i&&(c(r,"name")||u(r,"name",n)),t[n]!==r&&(i&&(c(r,f)||u(r,f,t[n]?""+t[n]:a.join(String(n)))),t===o?t[n]=r:e?t[n]?t[n]=r:u(t,n,r):(delete t[n],u(t,n,r)))})(Function.prototype,i,function(){return"function"==typeof this&&this[f]||e.call(this)})},function(t,n,r){var e=r(1),i=r(4),u=r(51),c=/"/g,o=function(t,n,r,e){var i=String(u(t)),o="<"+n;return""!==r&&(o+=" "+r+'="'+String(e).replace(c,"&quot;")+'"'),o+">"+i+"</"+n+">"};t.exports=function(n,t){var r={};r[n]=t(o),e(e.P+e.F*i(function(){var t=""[n]('"');return t!==t.toLowerCase()||3<t.split('"').length}),"String",r)}},function(t,n,r){var e=r(65),i=r(35);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(117),i=r(75),o=r(33),u=r(53),c=r(30),f=r(174),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(30),i=r(17),o=r(154)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(116),i=r(51);t.exports=function(t){return e(i(t))}},function(t,n){t.exports=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(9),o=r(16)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(25);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(19),i=r(6),o="__core-js_shared__",u=i[o]||(i[o]={});(t.exports=function(t,n){return u[t]||(u[t]=void 0!==n?n:{})})("versions",[]).push({version:e.version,mode:r(23)?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(0<t?e:r)(t)}},function(t,n,r){var i=r(18);t.exports=function(t,n){if(!i(t))return t;var r,e;if(n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;if("function"==typeof(r=t.valueOf)&&!i(e=r.call(t)))return e;if(!n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(6),i=r(19),o=r(23),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(16)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){var r=t.exports={version:"2.6.9"};"number"==typeof __e&&(__e=r)},function(t,n,r){var o=r(21);t.exports=function(e,i,t){if(o(e),void 0===i)return e;switch(t){case 1:return function(t){return e.call(i,t)};case 2:return function(t,n){return e.call(i,t,n)};case 3:return function(t,n,r){return e.call(i,t,n,r)}}return function(){return e.apply(i,arguments)}}},function(t,n,r){"use strict";var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(0<t?e:r)(t)}},function(t,n,r){var x=r(47),m=r(116),S=r(17),w=r(8),e=r(138);t.exports=function(l,t){var h=1==l,v=2==l,p=3==l,d=4==l,y=6==l,g=5==l||y,b=t||e;return function(t,n,r){for(var e,i,o=S(t),u=m(o),c=x(n,r,3),f=w(u.length),a=0,s=h?b(t,f):v?b(t,0):void 0;a<f;a++)if((g||a in u)&&(i=c(e=u[a],a,o),l))if(h)s[a]=i;else if(i)switch(l){case 3:return!0;case 5:return e;case 6:return a;case 2:s.push(e)}else if(d)return!1;return y?-1:p||d?d:s}}},function(t,n){t.exports=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var i=r(1),o=r(46),u=r(4);t.exports=function(t,n){var r=(o.Object||{})[t]||Object[t],e={};e[t]=n(r),i(i.S+i.F*u(function(){r(1)}),"Object",e)}},function(t,n,r){var i=r(5);t.exports=function(t,n){if(!i(t))return t;var r,e;if(n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;if("function"==typeof(r=t.valueOf)&&!i(e=r.call(t)))return e;if(!n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var d=r(6),y=r(19),g=r(93),b=r(13),x=r(9),m="prototype",S=function(t,n,r){var e,i,o,u=t&S.F,c=t&S.G,f=t&S.S,a=t&S.P,s=t&S.B,l=t&S.W,h=c?y:y[n]||(y[n]={}),v=h[m],p=c?d:f?d[n]:(d[n]||{})[m];for(e in c&&(r=n),r)(i=!u&&p&&void 0!==p[e])&&x(h,e)||(o=i?p[e]:r[e],h[e]=c&&"function"!=typeof p[e]?r[e]:s&&i?g(o,d):l&&p[e]==o?function(e){var t=function(t,n,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,r)}return e.apply(this,arguments)};return t[m]=e[m],t}(o):a&&"function"==typeof o?g(Function.call,o):o,a&&((h.virtual||(h.virtual={}))[e]=o,t&S.R&&v&&!v[e]&&b(v,e,o)))};S.F=1,S.G=2,S.S=4,S.P=8,S.B=16,S.W=32,S.U=64,S.R=128,t.exports=S},function(t,n,r){var e=r(34);t.exports=function(t){return Object(e(t))}},function(t,n,r){var o=r(196),e=r(1),i=r(118)("metadata"),u=i.store||(i.store=new(r(200))),c=function(t,n,r){var e=u.get(t);if(!e){if(!r)return;u.set(t,e=new o)}var i=e.get(n);if(!i){if(!r)return;e.set(n,i=new o)}return i};t.exports={store:u,map:c,has:function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},get:function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},set:function(t,n,r,e){c(r,e,!0).set(t,n)},keys:function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},key:function(t){return void 0===t||"symbol"==typeof t?t:String(t)},exp:function(t){e(e.S,"Reflect",t)}}},function(t,n,r){"use strict";if(r(10)){var g=r(68),b=r(3),x=r(4),m=r(1),S=r(132),e=r(159),h=r(47),w=r(70),i=r(75),_=r(26),o=r(76),u=r(49),O=r(8),E=r(194),c=r(78),f=r(53),a=r(30),M=r(81),P=r(5),v=r(17),p=r(145),j=r(72),F=r(32),A=r(73).f,d=r(161),s=r(79),l=r(7),y=r(50),I=r(120),L=r(119),N=r(162),T=r(82),k=r(125),R=r(77),C=r(137),D=r(166),G=r(11),W=r(31),U=G.f,V=W.f,B=b.RangeError,q=b.TypeError,z=b.Uint8Array,K="ArrayBuffer",H="Shared"+K,J="BYTES_PER_ELEMENT",$="prototype",Y=Array[$],X=e.ArrayBuffer,Q=e.DataView,Z=y(0),tt=y(2),nt=y(3),rt=y(4),et=y(5),it=y(6),ot=I(!0),ut=I(!1),ct=N.values,ft=N.keys,at=N.entries,st=Y.lastIndexOf,lt=Y.reduce,ht=Y.reduceRight,vt=Y.join,pt=Y.sort,dt=Y.slice,yt=Y.toString,gt=Y.toLocaleString,bt=l("iterator"),xt=l("toStringTag"),mt=s("typed_constructor"),St=s("def_constructor"),wt=S.CONSTR,_t=S.TYPED,Ot=S.VIEW,Et="Wrong length!",Mt=y(1,function(t,n){return It(L(t,t[St]),n)}),Pt=x(function(){return 1===new z(new Uint16Array([1]).buffer)[0]}),jt=!!z&&!!z[$].set&&x(function(){new z(1).set({})}),Ft=function(t,n){var r=u(t);if(r<0||r%n)throw B("Wrong offset!");return r},At=function(t){if(P(t)&&_t in t)return t;throw q(t+" is not a typed array!")},It=function(t,n){if(!(P(t)&&mt in t))throw q("It is not a typed array constructor!");return new t(n)},Lt=function(t,n){return Nt(L(t,t[St]),n)},Nt=function(t,n){for(var r=0,e=n.length,i=It(t,e);r<e;)i[r]=n[r++];return i},Tt=function(t,n,r){U(t,n,{get:function(){return this._d[r]}})},kt=function(t){var n,r,e,i,o,u,c=v(t),f=arguments.length,a=1<f?arguments[1]:void 0,s=void 0!==a,l=d(c);if(null!=l&&!p(l)){for(u=l.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(s&&2<f&&(a=h(a,arguments[2],2)),n=0,r=O(c.length),i=It(this,r);n<r;n++)i[n]=s?a(c[n],n):c[n];return i},Rt=function(){for(var t=0,n=arguments.length,r=It(this,n);t<n;)r[t]=arguments[t++];return r},Ct=!!z&&x(function(){gt.call(new z(1))}),Dt=function(){return gt.apply(Ct?dt.call(At(this)):At(this),arguments)},Gt={copyWithin:function(t,n){return D.call(At(this),t,n,2<arguments.length?arguments[2]:void 0)},every:function(t){return rt(At(this),t,1<arguments.length?arguments[1]:void 0)},fill:function(t){return C.apply(At(this),arguments)},filter:function(t){return Lt(this,tt(At(this),t,1<arguments.length?arguments[1]:void 0))},find:function(t){return et(At(this),t,1<arguments.length?arguments[1]:void 0)},findIndex:function(t){return it(At(this),t,1<arguments.length?arguments[1]:void 0)},forEach:function(t){Z(At(this),t,1<arguments.length?arguments[1]:void 0)},indexOf:function(t){return ut(At(this),t,1<arguments.length?arguments[1]:void 0)},includes:function(t){return ot(At(this),t,1<arguments.length?arguments[1]:void 0)},join:function(t){return vt.apply(At(this),arguments)},lastIndexOf:function(t){return st.apply(At(this),arguments)},map:function(t){return Mt(At(this),t,1<arguments.length?arguments[1]:void 0)},reduce:function(t){return lt.apply(At(this),arguments)},reduceRight:function(t){return ht.apply(At(this),arguments)},reverse:function(){for(var t,n=this,r=At(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(At(this),t,1<arguments.length?arguments[1]:void 0)},sort:function(t){return pt.call(At(this),t)},subarray:function(t,n){var r=At(this),e=r.length,i=c(t,e);return new(L(r,r[St]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,O((void 0===n?e:c(n,e))-i))}},Wt=function(t,n){return Lt(this,dt.call(At(this),t,n))},Ut=function(t){At(this);var n=Ft(arguments[1],1),r=this.length,e=v(t),i=O(e.length),o=0;if(r<i+n)throw B(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(At(this))},keys:function(){return ft.call(At(this))},values:function(){return ct.call(At(this))}},Bt=function(t,n){return P(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return Bt(t,n=f(n,!0))?i(2,t[n]):V(t,n)},zt=function(t,n,r){return!(Bt(t,n=f(n,!0))&&P(r)&&a(r,"value"))||a(r,"get")||a(r,"set")||r.configurable||a(r,"writable")&&!r.writable||a(r,"enumerable")&&!r.enumerable?U(t,n,r):(t[n]=r.value,t)};wt||(W.f=qt,G.f=zt),m(m.S+m.F*!wt,"Object",{getOwnPropertyDescriptor:qt,defineProperty:zt}),x(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Kt=o({},Gt);o(Kt,Vt),_(Kt,bt,Vt.values),o(Kt,{slice:Wt,set:Ut,constructor:function(){},toString:yt,toLocaleString:Dt}),Tt(Kt,"buffer","b"),Tt(Kt,"byteOffset","o"),Tt(Kt,"byteLength","l"),Tt(Kt,"length","e"),U(Kt,xt,{get:function(){return this[_t]}}),t.exports=function(t,l,n,o){var h=t+((o=!!o)?"Clamped":"")+"Array",r="get"+t,u="set"+t,v=b[h],c=v||{},e=v&&F(v),i=!v||!S.ABV,f={},a=v&&v[$],p=function(t,i){U(t,i,{get:function(){return t=i,(n=this._d).v[r](t*l+n.o,Pt);var t,n},set:function(t){return n=i,r=t,e=this._d,o&&(r=(r=Math.round(r))<0?0:255<r?255:255&r),void e.v[u](n*l+e.o,r,Pt);var n,r,e},enumerable:!0})};i?(v=n(function(t,n,r,e){w(t,v,h,"_d");var i,o,u,c,f=0,a=0;if(P(n)){if(!(n instanceof X||(c=M(n))==K||c==H))return _t in n?Nt(v,n):kt.call(v,n);i=n,a=Ft(r,l);var s=n.byteLength;if(void 0===e){if(s%l)throw B(Et);if((o=s-a)<0)throw B(Et)}else if(s<(o=O(e)*l)+a)throw B(Et);u=o/l}else u=E(n),i=new X(o=u*l);for(_(t,"_d",{b:i,o:a,l:o,e:u,v:new Q(i)});f<u;)p(t,f++)}),a=v[$]=j(Kt),_(a,"constructor",v)):x(function(){v(1)})&&x(function(){new v(-1)})&&k(function(t){new v,new v(null),new v(1.5),new v(t)},!0)||(v=n(function(t,n,r,e){var i;return w(t,v,h),P(n)?n instanceof X||(i=M(n))==K||i==H?void 0!==e?new c(n,Ft(r,l),e):void 0!==r?new c(n,Ft(r,l)):new c(n):_t in n?Nt(v,n):kt.call(v,n):new c(E(n))}),Z(e!==Function.prototype?A(c).concat(A(e)):A(c),function(t){t in v||_(v,t,c[t])}),v[$]=a,g||(a.constructor=v));var s=a[bt],d=!!s&&("values"==s.name||null==s.name),y=Vt.values;_(v,mt,!0),_(a,_t,h),_(a,Ot,!0),_(a,St,v),(o?new v(1)[xt]==h:xt in a)||U(a,xt,{get:function(){return h}}),f[h]=v,m(m.G+m.W+m.F*(v!=c),f),m(m.S,h,{BYTES_PER_ELEMENT:l}),m(m.S+m.F*x(function(){c.of.call(v,1)}),h,{from:kt,of:Rt}),J in a||_(a,J,l),m(m.P,h,Gt),R(h),m(m.P+m.F*jt,h,{set:Ut}),m(m.P+m.F*!d,h,Vt),g||a.toString==yt||(a.toString=yt),m(m.P+m.F*x(function(){new v(1).slice()}),h,{slice:Wt}),m(m.P+m.F*(x(function(){return[1,2].toLocaleString()!=new v([1,2]).toLocaleString()})||!x(function(){a.toLocaleString.call([1,2])})),h,{toLocaleString:Dt}),T[h]=d?s:y,g||d||_(a,bt,y)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(18),i=r(6).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(20)(function(){return 7!=Object.defineProperty(r(59)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var x=r(23),m=r(54),S=r(66),w=r(13),_=r(36),O=r(98),E=r(38),M=r(104),P=r(16)("iterator"),j=!([].keys&&"next"in[].keys()),F="values",A=function(){return this};t.exports=function(t,n,r,e,i,o,u){O(r,n,e);var c,f,a,s=function(t){if(!j&&t in p)return p[t];switch(t){case"keys":case F:return function(){return new r(this,t)}}return function(){return new r(this,t)}},l=n+" Iterator",h=i==F,v=!1,p=t.prototype,d=p[P]||p["@@iterator"]||i&&p[i],y=d||s(i),g=i?h?s("entries"):y:void 0,b="Array"==n&&p.entries||d;if(b&&((a=M(b.call(new t)))!==Object.prototype&&a.next&&(E(a,l,!0),x||"function"==typeof a[P]||w(a,P,A))),h&&d&&d.name!==F&&(v=!0,y=function(){return d.call(this)}),x&&!u||!j&&!v&&p[P]||w(p,P,y),_[n]=y,_[l]=A,i)if(c={values:h?y:s(F),keys:o?y:s("keys"),entries:g},u)for(f in c)f in p||S(p,f,c[f]);else m(m.P+m.F*(j||v),n,c);return c}},function(t,n,e){var i=e(22),o=e(101),u=e(35),c=e(39)("IE_PROTO"),f=function(){},a="prototype",s=function(){var t,n=e(59)("iframe"),r=u.length;for(n.style.display="none",e(95).appendChild(n),n.src="javascript:",(t=n.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),s=t.F;r--;)delete s[a][u[r]];return s()};t.exports=Object.create||function(t,n){var r;return null!==t?(f[a]=i(t),r=new f,f[a]=null,r[c]=t):r=s(),void 0===n?r:o(r,n)}},function(t,n,r){var e=r(65),i=r(35).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var u=r(9),c=r(15),f=r(92)(!1),a=r(39)("IE_PROTO");t.exports=function(t,n){var r,e=c(t),i=0,o=[];for(r in e)r!=a&&u(e,r)&&o.push(r);for(;n.length>i;)u(e,r=n[i++])&&(~f(o,r)||o.push(r));return o}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;null==i[e]&&r(26)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n){t.exports=!1},function(t,n,r){var e=r(79)("meta"),i=r(5),o=r(30),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=t.exports={KEY:e,NEED:!1,fastKey:function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},getWeak:function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},onFreeze:function(t){return a&&l.NEED&&f(t)&&!o(t,e)&&s(t),t}}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n,r){var h=r(47),v=r(177),p=r(145),d=r(2),y=r(8),g=r(161),b={},x={};(n=t.exports=function(t,n,r,e,i){var o,u,c,f,a=i?function(){return t}:g(t),s=h(r,e,n?2:1),l=0;if("function"!=typeof a)throw TypeError(t+" is not iterable!");if(p(a)){for(o=y(t.length);l<o;l++)if((f=n?s(d(u=t[l])[0],u[1]):s(t[l]))===b||f===x)return f}else for(c=a.call(t);!(u=c.next()).done;)if((f=v(c,s,u.value,n))===b||f===x)return f}).BREAK=b,n.RETURN=x},function(t,n,e){var i=e(2),o=e(183),u=e(141),c=e(154)("IE_PROTO"),f=function(){},a="prototype",s=function(){var t,n=e(140)("iframe"),r=u.length;for(n.style.display="none",e(143).appendChild(n),n.src="javascript:",(t=n.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),s=t.F;r--;)delete s[a][u[r]];return s()};t.exports=Object.create||function(t,n){var r;return null!==t?(f[a]=i(t),r=new f,f[a]=null,r[c]=t):r=s(),void 0===n?r:o(r,n)}},function(t,n,r){var e=r(185),i=r(141).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(185),i=r(141);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n,r){var i=r(27);t.exports=function(t,n,r){for(var e in n)i(t,e,n[e],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(49),i=Math.max,o=Math.min;t.exports=function(t,n){return(t=e(t))<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(5);t.exports=function(t,n){if(!e(t)||t._t!==n)throw TypeError("Incompatible receiver, "+n+" required!");return t}},function(t,n,r){var i=r(45),o=r(7)("toStringTag"),u="Arguments"==i(function(){return arguments}());t.exports=function(t){var n,r,e;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=function(t,n){try{return t[n]}catch(t){}}(n=Object(t),o))?r:u?i(n):"Object"==(e=i(n))&&"function"==typeof n.callee?"Arguments":e}},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(30),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var u=r(1),e=r(51),c=r(4),f=r(157),i="["+f+"]",o=RegExp("^"+i+i+"*"),a=RegExp(i+i+"*$"),s=function(t,n,r){var e={},i=c(function(){return!!f[t]()||"​"!="​"[t]()}),o=e[t]=i?n(l):f[t];r&&(e[r]=o),u(u.P+u.F*i,"String",e)},l=s.trim=function(t,n){return t=String(e(t)),1&n&&(t=t.replace(o,"")),2&n&&(t=t.replace(a,"")),t};t.exports=s},function(t,n,r){t.exports={default:r(88),__esModule:!0}},function(t,n,r){t.exports={default:r(89),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=e(r(86)),o=e(r(85)),u="function"==typeof o.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof o.default&&t.constructor===o.default&&t!==o.default.prototype?"symbol":typeof t};n.default="function"==typeof o.default&&"symbol"===u(i.default)?function(t){return void 0===t?"undefined":u(t)}:function(t){return t&&"function"==typeof o.default&&t.constructor===o.default&&t!==o.default.prototype?"symbol":void 0===t?"undefined":u(t)}},function(t,n,r){r(111),r(109),r(112),r(113),t.exports=r(19).Symbol},function(t,n,r){r(110),r(114),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var f=r(15),a=r(107),s=r(106);t.exports=function(c){return function(t,n,r){var e,i=f(t),o=a(i.length),u=s(r,o);if(c&&n!=n){for(;u<o;)if((e=i[u++])!=e)return!0}else for(;u<o;u++)if((c||u in i)&&i[u]===n)return c||u||0;return!c&&-1}}},function(t,n,r){var o=r(90);t.exports=function(e,i,t){if(o(e),void 0===i)return e;switch(t){case 1:return function(t){return e.call(i,t)};case 2:return function(t,n){return e.call(i,t,n)};case 3:return function(t,n,r){return e.call(i,t,n,r)}}return function(){return e.apply(i,arguments)}}},function(t,n,r){var c=r(29),f=r(64),a=r(37);t.exports=function(t){var n=c(t),r=f.f;if(r)for(var e,i=r(t),o=a.f,u=0;i.length>u;)o.call(t,e=i[u++])&&n.push(e);return n}},function(t,n,r){var e=r(6).document;t.exports=e&&e.documentElement},function(t,n,r){var e=r(58);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(58);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(62),i=r(24),o=r(38),u={};r(13)(u,r(16)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(25)("meta"),i=r(18),o=r(9),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(20)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=t.exports={KEY:e,NEED:!1,fastKey:function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},getWeak:function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},onFreeze:function(t){return a&&l.NEED&&f(t)&&!o(t,e)&&s(t),t}}},function(t,n,r){var u=r(14),c=r(22),f=r(29);t.exports=r(12)?Object.defineProperties:function(t,n){c(t);for(var r,e=f(n),i=e.length,o=0;o<i;)u.f(t,r=e[o++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(24),o=r(15),u=r(42),c=r(9),f=r(60),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(15),i=r(63).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?function(t){try{return i(t)}catch(t){return u.slice()}}(t):i(e(t))}},function(t,n,r){var e=r(9),i=r(55),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var f=r(41),a=r(34);t.exports=function(c){return function(t,n){var r,e,i=String(a(t)),o=f(n),u=i.length;return o<0||u<=o?c?"":void 0:(r=i.charCodeAt(o))<55296||56319<r||o+1===u||(e=i.charCodeAt(o+1))<56320||57343<e?c?i.charAt(o):r:c?i.slice(o,o+2):e-56320+(r-55296<<10)+65536}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return(t=e(t))<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return 0<t?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(91),i=r(99),o=r(36),u=r(15);t.exports=r(61)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):i(0,"keys"==n?r:"values"==n?t[r]:[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(105)(!0);r(61)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(6),u=r(9),i=r(12),o=r(54),c=r(66),f=r(100).KEY,a=r(20),s=r(40),l=r(38),h=r(25),v=r(16),p=r(44),d=r(43),y=r(94),g=r(97),b=r(22),x=r(18),m=r(55),S=r(15),w=r(42),_=r(24),O=r(62),E=r(103),M=r(102),P=r(64),j=r(14),F=r(29),A=M.f,I=j.f,L=E.f,N=e.Symbol,T=e.JSON,k=T&&T.stringify,R="prototype",C=v("_hidden"),D=v("toPrimitive"),G={}.propertyIsEnumerable,W=s("symbol-registry"),U=s("symbols"),V=s("op-symbols"),B=Object[R],q="function"==typeof N&&!!P.f,z=e.QObject,K=!z||!z[R]||!z[R].findChild,H=i&&a(function(){return 7!=O(I({},"a",{get:function(){return I(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=A(B,n);e&&delete B[n],I(t,n,r),e&&t!==B&&I(B,n,e)}:I,J=function(t){var n=U[t]=O(N[R]);return n._k=t,n},$=q&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===B&&Y(V,n,r),b(t),n=w(n,!0),b(r),u(U,n)?(r.enumerable?(u(t,C)&&t[C][n]&&(t[C][n]=!1),r=O(r,{enumerable:_(0,!1)})):(u(t,C)||I(t,C,_(1,{})),t[C][n]=!0),H(t,n,r)):I(t,n,r)},X=function(t,n){b(t);for(var r,e=y(n=S(n)),i=0,o=e.length;i<o;)Y(t,r=e[i++],n[r]);return t},Q=function(t){var n=G.call(this,t=w(t,!0));return!(this===B&&u(U,t)&&!u(V,t))&&(!(n||!u(this,t)||!u(U,t)||u(this,C)&&this[C][t])||n)},Z=function(t,n){if(t=S(t),n=w(n,!0),t!==B||!u(U,n)||u(V,n)){var r=A(t,n);return!r||!u(U,n)||u(t,C)&&t[C][n]||(r.enumerable=!0),r}},tt=function(t){for(var n,r=L(S(t)),e=[],i=0;r.length>i;)u(U,n=r[i++])||n==C||n==f||e.push(n);return e},nt=function(t){for(var n,r=t===B,e=L(r?V:S(t)),i=[],o=0;e.length>o;)!u(U,n=e[o++])||r&&!u(B,n)||i.push(U[n]);return i};q||(c((N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var n=h(0<arguments.length?arguments[0]:void 0),r=function(t){this===B&&r.call(V,t),u(this,C)&&u(this[C],n)&&(this[C][n]=!1),H(this,n,_(1,t))};return i&&K&&H(B,n,{configurable:!0,set:r}),J(n)})[R],"toString",function(){return this._k}),M.f=Z,j.f=Y,r(63).f=E.f=tt,r(37).f=Q,P.f=nt,i&&!r(23)&&c(B,"propertyIsEnumerable",Q,!0),p.f=function(t){return J(v(t))}),o(o.G+o.W+o.F*!q,{Symbol:N});for(var rt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;rt.length>et;)v(rt[et++]);for(var it=F(v.store),ot=0;it.length>ot;)d(it[ot++]);o(o.S+o.F*!q,"Symbol",{for:function(t){return u(W,t+="")?W[t]:W[t]=N(t)},keyFor:function(t){if(!$(t))throw TypeError(t+" is not a symbol!");for(var n in W)if(W[n]===t)return n},useSetter:function(){K=!0},useSimple:function(){K=!1}}),o(o.S+o.F*!q,"Object",{create:function(t,n){return void 0===n?O(t):X(O(t),n)},defineProperty:Y,defineProperties:X,getOwnPropertyDescriptor:Z,getOwnPropertyNames:tt,getOwnPropertySymbols:nt});var ut=a(function(){P.f(1)});o(o.S+o.F*ut,"Object",{getOwnPropertySymbols:function(t){return P.f(m(t))}}),T&&o(o.S+o.F*(!q||a(function(){var t=N();return"[null]"!=k([t])||"{}"!=k({a:t})||"{}"!=k(Object(t))})),"JSON",{stringify:function(t){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);if(r=n=e[1],(x(n)||void 0!==t)&&!$(t))return g(n)||(n=function(t,n){if("function"==typeof r&&(n=r.call(this,t,n)),!$(n))return n}),e[1]=n,k.apply(T,e)}}),N[R][D]||r(13)(N[R],D,N[R].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(108);for(var e=r(6),i=r(13),o=r(36),u=r(16)("toStringTag"),c="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),f=0;f<c.length;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(46),i=r(3),o="__core-js_shared__",u=i[o]||(i[o]={});(t.exports=function(t,n){return u[t]||(u[t]=void 0!==n?n:{})})("versions",[]).push({version:e.version,mode:r(68)?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},function(t,n,r){var i=r(2),o=r(21),u=r(7)("species");t.exports=function(t,n){var r,e=i(t).constructor;return void 0===e||null==(r=i(e)[u])?n:o(r)}},function(t,n,r){var f=r(33),a=r(8),s=r(78);t.exports=function(c){return function(t,n,r){var e,i=f(t),o=a(i.length),u=s(r,o);if(c&&n!=n){for(;u<o;)if((e=i[u++])!=e)return!0}else for(;u<o;u++)if((c||u in i)&&i[u]===n)return c||u||0;return!c&&-1}}},function(t,n,r){"use strict";var g=r(3),b=r(1),x=r(27),m=r(76),S=r(69),w=r(71),_=r(70),O=r(5),E=r(4),M=r(125),P=r(83),j=r(144);t.exports=function(e,t,n,r,i,o){var u=g[e],c=u,f=i?"set":"add",a=c&&c.prototype,s={},l=function(t){var r=a[t];x(a,t,"delete"==t?function(t){return!(o&&!O(t))&&r.call(this,0===t?0:t)}:"has"==t?function(t){return!(o&&!O(t))&&r.call(this,0===t?0:t)}:"get"==t?function(t){return o&&!O(t)?void 0:r.call(this,0===t?0:t)}:"add"==t?function(t){return r.call(this,0===t?0:t),this}:function(t,n){return r.call(this,0===t?0:t,n),this})};if("function"==typeof c&&(o||a.forEach&&!E(function(){(new c).entries().next()}))){var h=new c,v=h[f](o?{}:-0,1)!=h,p=E(function(){h.has(1)}),d=M(function(t){new c(t)}),y=!o&&E(function(){for(var t=new c,n=5;n--;)t[f](n,n);return!t.has(-0)});d||(((c=t(function(t,n){_(t,c,e);var r=j(new u,t,c);return null!=n&&w(n,i,r[f],r),r})).prototype=a).constructor=c),(p||y)&&(l("delete"),l("has"),i&&l("get")),(y||v)&&l(f),o&&a.clear&&delete a.clear}else c=r.getConstructor(t,e,i,f),m(c.prototype,n),S.NEED=!0;return P(c,e),s[e]=c,b(b.G+b.W+b.F*(c!=u),s),o||r.setStrong(c,e,i),c}},function(t,n,r){"use strict";r(197);var s=r(27),l=r(26),h=r(4),v=r(51),p=r(7),d=r(152),y=p("species"),g=!h(function(){var t=/./;return t.exec=function(){var t=[];return t.groups={a:"7"},t},"7"!=="".replace(t,"$<a>")}),b=function(){var t=/(?:)/,n=t.exec;t.exec=function(){return n.apply(this,arguments)};var r="ab".split(t);return 2===r.length&&"a"===r[0]&&"b"===r[1]}();t.exports=function(r,t,n){var e=p(r),o=!h(function(){var t={};return t[e]=function(){return 7},7!=""[r](t)}),i=o?!h(function(){var t=!1,n=/a/;return n.exec=function(){return t=!0,null},"split"===r&&(n.constructor={},n.constructor[y]=function(){return n}),n[e](""),!t}):void 0;if(!o||!i||"replace"===r&&!g||"split"===r&&!b){var u=/./[e],c=n(v,e,""[r],function(t,n,r,e,i){return n.exec===d?o&&!i?{done:!0,value:u.call(n,r,e)}:{done:!0,value:t.call(r,n,e)}:{done:!1}}),f=c[0],a=c[1];s(String.prototype,r,f),l(RegExp.prototype,e,2==t?function(t,n){return a.call(t,this,n)}:function(t){return a.call(t,this)})}}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){var e=r(5),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var o=r(7)("iterator"),u=!1;try{var e=[7][o]();e.return=function(){u=!0},Array.from(e,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!u)return!1;var r=!1;try{var e=[7],i=e[o]();i.next=function(){return{done:r=!0}},e[o]=function(){return i},t(e)}catch(t){}return r}},function(t,n,r){"use strict";t.exports=r(68)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){"use strict";var i=r(81),o=RegExp.prototype.exec;t.exports=function(t,n){var r=t.exec;if("function"==typeof r){var e=r.call(t,n);if("object"!=typeof e)throw new TypeError("RegExp exec method returned something other than an Object or null");return e}if("RegExp"!==i(t))throw new TypeError("RegExp#exec called on incompatible receiver");return o.call(t,n)}},function(t,n,r){"use strict";var e=r(1),u=r(21),c=r(47),f=r(71);t.exports=function(t){e(e.S,t,{from:function(t){var n,r,e,i,o=arguments[1];return u(this),(n=void 0!==o)&&u(o),null==t?new this:(r=[],n?(e=0,i=c(o,arguments[2],2),f(t,!1,function(t){r.push(i(t,e++))})):f(t,!1,r.push,r),new this(r))}})}},function(t,n,r){"use strict";var e=r(1);t.exports=function(t){e(e.S,t,{of:function(){for(var t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return new this(n)}})}},function(t,n,r){var f=r(49),a=r(51);t.exports=function(c){return function(t,n){var r,e,i=String(a(t)),o=f(n),u=i.length;return o<0||u<=o?c?"":void 0:(r=i.charCodeAt(o))<55296||56319<r||o+1===u||(e=i.charCodeAt(o+1))<56320||57343<e?c?i.charAt(o):r:c?i.slice(o,o+2):e-56320+(r-55296<<10)+65536}}},function(t,n,r){for(var e,i=r(3),o=r(26),u=r(79),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n,r){var e=r(3).navigator;t.exports=e&&e.userAgent||""},function(t,n){"use strict";var r,e={versions:(r=window.navigator.userAgent,{trident:-1<r.indexOf("Trident"),presto:-1<r.indexOf("Presto"),webKit:-1<r.indexOf("AppleWebKit"),gecko:-1<r.indexOf("Gecko")&&-1==r.indexOf("KHTML"),mobile:!!r.match(/AppleWebKit.*Mobile.*/),ios:!!r.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:-1<r.indexOf("Android")||-1<r.indexOf("Linux"),iPhone:-1<r.indexOf("iPhone")||-1<r.indexOf("Mac"),iPad:-1<r.indexOf("iPad"),webApp:-1==r.indexOf("Safari"),weixin:-1==r.indexOf("MicroMessenger")})};t.exports=e},function(t,n,r){"use strict";var e,i=r(87),l=(e=i)&&e.__esModule?e:{default:e},h=function(){function n(t,n,r){return n||r?String.fromCharCode(n||r):o[t]||t}function r(t){return s[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,i=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},u=/\u00a0/g,c=/<br\s*\/?>/gi,f=/\r?\n/g,a=/\s/g,s={};for(var t in o)s[o[t]]=t;return o["&apos;"]="'",s["'"]="&#39;",{encode:function(t){return t?(""+t).replace(i,r).replace(f,"<br/>").replace(a,"&nbsp;"):""},decode:function(t){return t?(""+t).replace(c,"\n").replace(e,n).replace(u," "):""},encodeBase16:function(t){if(!t)return t;for(var n=[],r=0,e=(t+="").length;r<e;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;for(var n=[],r=0,e=(t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")})).length;r<e;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;for(var n=[],r=0,e=(t+="").length;r<e;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;n<r;n++)t[n]=h.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,l.default)(t)))for(var e in t)t[e]=h.encodeObject(t[e]);else if("string"==typeof t)return h.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=h},function(t,n,r){"use strict";var e=r(131)(!0);t.exports=function(t,n,r){return n+(r?e(t,n).length:1)}},function(t,n,r){"use strict";var c=r(17),f=r(78),a=r(8);t.exports=function(t){for(var n=c(this),r=a(n.length),e=arguments.length,i=f(1<e?arguments[1]:void 0,r),o=2<e?arguments[2]:void 0,u=void 0===o?r:f(o,r);i<u;)n[i++]=t;return n}},function(t,n,r){var e=r(215);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(11),i=r(75);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(5),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(n){var r=/./;try{"/./"[n](r)}catch(t){try{return r[e]=!1,!"/./"[n](r)}catch(n){}}return!0}},function(t,n,r){var e=r(3).document;t.exports=e&&e.documentElement},function(t,n,r){var o=r(5),u=r(153).set;t.exports=function(t,n,r){var e,i=n.constructor;return i!==r&&"function"==typeof i&&(e=i.prototype)!==r.prototype&&o(e)&&u&&u(t,e),t}},function(t,n,r){var e=r(82),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){"use strict";var e=r(72),i=r(75),o=r(83),u={};r(26)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var x=r(68),m=r(1),S=r(27),w=r(26),_=r(82),O=r(146),E=r(83),M=r(32),P=r(7)("iterator"),j=!([].keys&&"next"in[].keys()),F="values",A=function(){return this};t.exports=function(t,n,r,e,i,o,u){O(r,n,e);var c,f,a,s=function(t){if(!j&&t in p)return p[t];switch(t){case"keys":case F:return function(){return new r(this,t)}}return function(){return new r(this,t)}},l=n+" Iterator",h=i==F,v=!1,p=t.prototype,d=p[P]||p["@@iterator"]||i&&p[i],y=d||s(i),g=i?h?s("entries"):y:void 0,b="Array"==n&&p.entries||d;if(b&&((a=M(b.call(new t)))!==Object.prototype&&a.next&&(E(a,l,!0),x||"function"==typeof a[P]||w(a,P,A))),h&&d&&d.name!==F&&(v=!0,y=function(){return d.call(this)}),x&&!u||!j&&!v&&p[P]||w(p,P,y),_[n]=y,_[l]=A,i)if(c={values:h?y:s(F),keys:o?y:s("keys"),entries:g},u)for(f in c)f in p||S(p,f,c[f]);else m(m.P+m.F*(j||v),n,c);return c}},function(t,n){var r=Math.expm1;t.exports=!r||22025.465794806718<r(10)||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:-1e-6<t&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var c=r(3),f=r(158).set,a=c.MutationObserver||c.WebKitMutationObserver,s=c.process,l=c.Promise,h="process"==r(45)(s);t.exports=function(){var r,e,i,t=function(){var t,n;for(h&&(t=s.domain)&&t.exit();r;){n=r.fn,r=r.next;try{n()}catch(t){throw r?i():e=void 0,t}}e=void 0,t&&t.enter()};if(h)i=function(){s.nextTick(t)};else if(!a||c.navigator&&c.navigator.standalone)if(l&&l.resolve){var n=l.resolve(void 0);i=function(){n.then(t)}}else i=function(){f.call(c,t)};else{var o=!0,u=document.createTextNode("");new a(t).observe(u,{characterData:!0}),i=function(){u.data=o=!o}}return function(t){var n={fn:t,next:void 0};e&&(e.next=n),r||(r=n,i()),e=n}}},function(t,n,r){"use strict";function e(t){var r,e;this.promise=new t(function(t,n){if(void 0!==r||void 0!==e)throw TypeError("Bad Promise constructor");r=t,e=n}),this.resolve=i(r),this.reject=i(e)}var i=r(21);t.exports.f=function(t){return new e(t)}},function(t,n,r){"use strict";var e,i,u=r(115),c=RegExp.prototype.exec,f=String.prototype.replace,o=c,a="lastIndex",s=(e=/a/,i=/b*/g,c.call(e,"a"),c.call(i,"a"),0!==e[a]||0!==i[a]),l=void 0!==/()??/.exec("")[1];(s||l)&&(o=function(t){var n,r,e,i,o=this;return l&&(r=new RegExp("^"+o.source+"$(?!\\s)",u.call(o))),s&&(n=o[a]),e=c.call(o,t),s&&e&&(o[a]=o.global?e.index+e[0].length:n),l&&e&&1<e.length&&f.call(e[0],r,function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(e[i]=void 0)}),e}),t.exports=o},function(t,n,i){var r=i(5),e=i(2),o=function(t,n){if(e(t),!r(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,r,e){try{(e=i(47)(Function.call,i(31).f(Object.prototype,"__proto__").set,2))(t,[]),r=!(t instanceof Array)}catch(t){r=!0}return function(t,n){return o(t,n),r?t.__proto__=n:e(t,n),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(118)("keys"),i=r(79);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(124),i=r(51);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var i=r(49),o=r(51);t.exports=function(t){var n=String(o(this)),r="",e=i(t);if(e<0||e==1/0)throw RangeError("Count can't be negative");for(;0<e;(e>>>=1)&&(n+=n))1&e&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(47),c=r(175),f=r(143),a=r(140),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=s.Dispatch,y=0,g={},b="onreadystatechange",x=function(){var t=+this;if(g.hasOwnProperty(t)){var n=g[t];delete g[t],n()}},m=function(t){x.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return g[++y]=function(){c("function"==typeof t?t:Function(t),n)},e(y),y},v=function(t){delete g[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(x,t,1))}:d&&d.now?e=function(t){d.now(u(x,t,1))}:p?(o=(i=new p).port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=b in a("script")?function(t){f.appendChild(a("script"))[b]=function(){f.removeChild(this),x.call(t)}}:function(t){setTimeout(u(x,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";function e(t,n,r){var e,i,o,u=new Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?W(2,-24)-W(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for((t=G(t))!=t||t===C?(i=t!=t?1:0,e=f):(e=U(V(t)/B),t*(o=W(2,-e))<1&&(e--,o*=2),2<=(t+=1<=e+a?s/o:s*W(2,1-a))*o&&(e++,o/=2),f<=e+a?(i=0,e=f):1<=e+a?(i=(t*o-1)*W(2,n),e+=a):(i=t*W(2,a-1)*W(2,n),e=0));8<=n;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;0<c;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u}function i(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;0<c;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;0<c;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-C:C;e+=W(2,n),s-=u}return(a?-1:1)*e*W(2,s-n)}function o(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]}function u(t){return[255&t]}function c(t){return[255&t,t>>8&255]}function f(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]}function a(t){return e(t,52,8)}function s(t){return e(t,23,4)}function l(t,n,r){M(t[I],n,{get:function(){return this[r]}})}function h(t,n,r,e){var i=O(+r);if(i+n>t[H])throw R(L);var o=t[K]._b,u=i+t[J],c=o.slice(u,u+n);return e?c:c.reverse()}function v(t,n,r,e,i,o){var u=O(+r);if(u+n>t[H])throw R(L);for(var c=t[K]._b,f=u+t[J],a=e(+i),s=0;s<n;s++)c[f+s]=a[o?s:n-s-1]}var p=r(3),d=r(10),y=r(68),g=r(132),b=r(26),x=r(76),m=r(4),S=r(70),w=r(49),_=r(8),O=r(194),E=r(73).f,M=r(11).f,P=r(137),j=r(83),F="ArrayBuffer",A="DataView",I="prototype",L="Wrong index!",N=p[F],T=p[A],k=p.Math,R=p.RangeError,C=p.Infinity,D=N,G=k.abs,W=k.pow,U=k.floor,V=k.log,B=k.LN2,q="byteLength",z="byteOffset",K=d?"_b":"buffer",H=d?"_l":q,J=d?"_o":z;if(g.ABV){if(!m(function(){N(1)})||!m(function(){new N(-1)})||m(function(){return new N,new N(1.5),new N(NaN),N.name!=F})){for(var $,Y=(N=function(t){return S(this,N),new D(O(t))})[I]=D[I],X=E(D),Q=0;X.length>Q;)($=X[Q++])in N||b(N,$,D[$]);y||(Y.constructor=N)}var Z=new T(new N(2)),tt=T[I].setInt8;Z.setInt8(0,2147483648),Z.setInt8(1,2147483649),!Z.getInt8(0)&&Z.getInt8(1)||x(T[I],{setInt8:function(t,n){tt.call(this,t,n<<24>>24)},setUint8:function(t,n){tt.call(this,t,n<<24>>24)}},!0)}else N=function(t){S(this,N,F);var n=O(t);this._b=P.call(new Array(n),0),this[H]=n},T=function(t,n,r){S(this,T,A),S(t,N,A);var e=t[H],i=w(n);if(i<0||e<i)throw R("Wrong offset!");if(e<i+(r=void 0===r?e-i:_(r)))throw R("Wrong length!");this[K]=t,this[J]=i,this[H]=r},d&&(l(N,q,"_l"),l(T,"buffer","_b"),l(T,q,"_l"),l(T,z,"_o")),x(T[I],{getInt8:function(t){return h(this,1,t)[0]<<24>>24},getUint8:function(t){return h(this,1,t)[0]},getInt16:function(t){var n=h(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=h(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return o(h(this,4,t,arguments[1]))},getUint32:function(t){return o(h(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return i(h(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return i(h(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){v(this,1,t,u,n)},setUint8:function(t,n){v(this,1,t,u,n)},setInt16:function(t,n){v(this,2,t,c,n,arguments[2])},setUint16:function(t,n){v(this,2,t,c,n,arguments[2])},setInt32:function(t,n){v(this,4,t,f,n,arguments[2])},setUint32:function(t,n){v(this,4,t,f,n,arguments[2])},setFloat32:function(t,n){v(this,4,t,s,n,arguments[2])},setFloat64:function(t,n){v(this,8,t,a,n,arguments[2])}});j(N,F),j(T,A),b(T[I],g.VIEW,!0),n[F]=N,n[A]=T},function(t,n,r){var e=r(3),i=r(46),o=r(68),u=r(195),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(81),i=r(7)("iterator"),o=r(82);t.exports=r(46).getIteratorMethod=function(t){if(null!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(67),i=r(178),o=r(82),u=r(33);t.exports=r(147)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):i(0,"keys"==n?r:"values"==n?t[r]:[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){t.exports=function(t,n){t.classList?t.classList.add(n):t.className+=" "+n}},function(t,n){t.exports=function(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var a=r(17),s=r(78),l=r(8);t.exports=[].copyWithin||function(t,n){var r=a(this),e=l(r.length),i=s(t,e),o=s(n,e),u=2<arguments.length?arguments[2]:void 0,c=Math.min((void 0===u?e:s(u,e))-o,e-i),f=1;for(o<i&&i<o+c&&(f=-1,o+=c-1,i+=c-1);0<c--;)o in r?r[i]=r[o]:delete r[i],i+=f,o+=f;return r}},function(t,n,r){var e=r(71);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var s=r(21),l=r(17),h=r(116),v=r(8);t.exports=function(t,n,r,e,i){s(n);var o=l(t),u=h(o),c=v(o.length),f=i?c-1:0,a=i?-1:1;if(r<2)for(;;){if(f in u){e=u[f],f+=a;break}if(f+=a,i?f<0:c<=f)throw TypeError("Reduce of empty array with no initial value")}for(;i?0<=f:f<c;f+=a)f in u&&(e=n(e,u[f],f,o));return e}},function(t,n,r){"use strict";var o=r(21),u=r(5),c=r(175),f=[].slice,a={};t.exports=Function.bind||function(n){var r=o(this),e=f.call(arguments,1),i=function(){var t=e.concat(f.call(arguments));return this instanceof i?function(t,n,r){if(!(n in a)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";a[n]=Function("F,a","return new F("+e.join(",")+")")}return a[n](t,r)}(r,t.length,t):c(r,t,n)};return u(r.prototype)&&(i.prototype=r.prototype),i}},function(t,n,r){"use strict";var u=r(11).f,c=r(72),f=r(76),a=r(47),s=r(70),l=r(71),e=r(147),i=r(178),o=r(77),h=r(10),v=r(69).fastKey,p=r(80),d=h?"_s":"size",y=function(t,n){var r,e=v(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,o,r,e){var i=t(function(t,n){s(t,i,o,"_i"),t._t=o,t._i=c(null),t._f=void 0,t._l=void 0,t[d]=0,null!=n&&l(n,r,t[e],t)});return f(i.prototype,{clear:function(){for(var t=p(this,o),n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=p(this,o),r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){p(this,o);for(var n,r=a(t,1<arguments.length?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(p(this,o),t)}}),h&&u(i.prototype,"size",{get:function(){return p(this,o)[d]}}),i},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=v(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,r,n){e(t,r,function(t,n){this._t=p(t,r),this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?i(0,"keys"==n?r.k:"values"==n?r.v:[r.k,r.v]):(t._t=void 0,i(1))},n?"entries":"values",!n,!0),o(r)}}},function(t,n,r){var e=r(81),i=r(167);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var u=r(76),c=r(69).getWeak,i=r(2),f=r(5),a=r(70),s=r(71),e=r(50),l=r(30),h=r(80),o=e(5),v=e(6),p=0,d=function(t){return t._l||(t._l=new y)},y=function(){this.a=[]},g=function(t,n){return o(t.a,function(t){return t[0]===n})};y.prototype={get:function(t){var n=g(this,t);if(n)return n[1]},has:function(t){return!!g(this,t)},set:function(t,n){var r=g(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(n){var t=v(this.a,function(t){return t[0]===n});return~t&&this.a.splice(t,1),!!~t}},t.exports={getConstructor:function(t,r,e,i){var o=t(function(t,n){a(t,o,r,"_i"),t._t=r,t._i=p++,t._l=void 0,null!=n&&s(n,e,t[i],t)});return u(o.prototype,{delete:function(t){if(!f(t))return!1;var n=c(t);return!0===n?d(h(this,r)).delete(t):n&&l(n,this._i)&&delete n[this._i]},has:function(t){if(!f(t))return!1;var n=c(t);return!0===n?d(h(this,r)).has(t):n&&l(n,this._i)}}),o},def:function(t,n,r){var e=c(i(n),!0);return!0===e?d(t).set(n,r):e[t._i]=r,t},ufstore:d}},function(t,n,r){"use strict";var p=r(123),d=r(5),y=r(8),g=r(47),b=r(7)("isConcatSpreadable");t.exports=function t(n,r,e,i,o,u,c,f){for(var a,s,l=o,h=0,v=!!c&&g(c,f,3);h<i;){if(h in e){if(a=v?v(e[h],h,r):e[h],s=!1,d(a)&&(s=void 0!==(s=a[b])?!!s:p(a)),s&&0<u)l=t(n,r,a,y(a.length),l,u-1)-1;else{if(9007199254740991<=l)throw TypeError();n[l]=a}l++}h++}return l}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(140)("div"),"a",{get:function(){return 7}}).a})},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(5),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var o=r(2);t.exports=function(t,n,r,e){try{return e?n(o(r)[0],r[1]):n(r)}catch(n){var i=t.return;throw void 0!==i&&o(i.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var o=r(149),e=Math.pow,u=e(2,-52),c=e(2,-23),f=e(2,127)*(2-c),a=e(2,-126);t.exports=Math.fround||function(t){var n,r,e=Math.abs(t),i=o(t);return e<a?i*(e/a/c+1/u-1/u)*a*c:f<(r=(n=(1+c/u)*e)-(n-e))||r!=r?i*(1/0):i*r}},function(t,n){t.exports=Math.log1p||function(t){return-1e-8<(t=+t)&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n){t.exports=Math.scale||function(t,n,r,e,i){return 0===arguments.length||t!=t||n!=n||r!=r||e!=e||i!=i?NaN:t===1/0||t===-1/0?t:(t-n)*(i-e)/(r-n)+e}},function(t,n,r){"use strict";var h=r(10),v=r(74),p=r(127),d=r(117),y=r(17),g=r(116),i=Object.assign;t.exports=!i||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=i({},t)[r]||Object.keys(i({},n)).join("")!=e})?function(t,n){for(var r=y(t),e=arguments.length,i=1,o=p.f,u=d.f;i<e;)for(var c,f=g(arguments[i++]),a=o?v(f).concat(o(f)):v(f),s=a.length,l=0;l<s;)c=a[l++],h&&!u.call(f,c)||(r[c]=f[c]);return r}:i},function(t,n,r){var u=r(11),c=r(2),f=r(74);t.exports=r(10)?Object.defineProperties:function(t,n){c(t);for(var r,e=f(n),i=e.length,o=0;o<i;)u.f(t,r=e[o++],n[r]);return t}},function(t,n,r){var e=r(33),i=r(73).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?function(t){try{return i(t)}catch(t){return u.slice()}}(t):i(e(t))}},function(t,n,r){var u=r(30),c=r(33),f=r(120)(!1),a=r(154)("IE_PROTO");t.exports=function(t,n){var r,e=c(t),i=0,o=[];for(r in e)r!=a&&u(e,r)&&o.push(r);for(;n.length>i;)u(e,r=n[i++])&&(~f(o,r)||o.push(r));return o}},function(t,n,r){var f=r(10),a=r(74),s=r(33),l=r(117).f;t.exports=function(c){return function(t){for(var n,r=s(t),e=a(r),i=e.length,o=0,u=[];o<i;)n=e[o++],f&&!l.call(r,n)||u.push(c?[n,r[n]]:r[n]);return u}}},function(t,n,r){var e=r(73),i=r(127),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(84).trim;t.exports=1/e(r(157)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(84).trim,o=r(157),u=/^[-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=function(t){try{return{e:!1,v:t()}}catch(t){return{e:!0,v:t}}}},function(t,n,r){var e=r(2),i=r(5),o=r(151);t.exports=function(t,n){if(e(t),i(n)&&n.constructor===t)return n;var r=o.f(t);return(0,r.resolve)(n),r.promise}},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var s=r(8),l=r(156),h=r(51);t.exports=function(t,n,r,e){var i=String(h(t)),o=i.length,u=void 0===r?" ":String(r),c=s(n);if(c<=o||""==u)return i;var f=c-o,a=l.call(u,Math.ceil(f/u.length));return a.length>f&&(a=a.slice(0,f)),e?a+i:i+a}},function(t,n,r){var e=r(49),i=r(8);t.exports=function(t){if(void 0===t)return 0;var n=e(t),r=i(n);if(n!==r)throw RangeError("Wrong length!");return r}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(170),i=r(80);t.exports=r(121)("Map",function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(i(this,"Map"),t);return n&&n.v},set:function(t,n){return e.def(i(this,"Map"),0===t?0:t,n)}},e,!0)},function(t,n,r){"use strict";var e=r(152);r(1)({target:"RegExp",proto:!0,forced:e!==/./.exec},{exec:e})},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(115)})},function(t,n,r){"use strict";var e=r(170),i=r(80);t.exports=r(121)("Set",function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},{add:function(t){return e.def(i(this,"Set"),t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var o,e=r(3),i=r(50)(0),u=r(27),c=r(69),f=r(182),a=r(172),s=r(5),l=r(80),h=r(80),v=!e.ActiveXObject&&"ActiveXObject"in e,p="WeakMap",d=c.getWeak,y=Object.isExtensible,g=a.ufstore,b=function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},x={get:function(t){if(s(t)){var n=d(t);return!0===n?g(l(this,p)).get(t):n?n[this._i]:void 0}},set:function(t,n){return a.def(l(this,p),t,n)}},m=t.exports=r(121)(p,b,x,a,!0,!0);h&&v&&(f((o=a.getConstructor(b,p)).prototype,x),c.NEED=!0,i(["delete","has","get","set"],function(e){var t=m.prototype,i=t[e];u(t,e,function(t,n){if(!s(t)||y(t))return i.call(this,t,n);this._f||(this._f=new o);var r=this._f[e](t,n);return"set"==e?this:r})}))},,,,function(t,n){"use strict";t.exports={init:function(){var t=document.querySelector("#page-nav");t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new&&document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")}),yiliaConfig&&yiliaConfig.toc_hide_index&&document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n,r,e,i){var o=function(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}(t),u=function(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}(t)-n;if(u-r<=i){var c=t.$newDom;c||(c=t.cloneNode(!0),(0,a.default)(t,c),(t.$newDom=c).style.position="fixed",c.style.top=(r||u)+"px",c.style.left=o+"px",c.style.zIndex=e||2,c.style.width="100%",c.style.color="#fff"),c.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var f=t.$newDom;f&&(f.style.visibility="hidden")}}function o(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");i(t,document.body.scrollTop,-63,2,0),i(n,document.body.scrollTop,1,3,0)}var f=e(r(163)),a=e((e(r(164)),r(414))),u=e(r(134)),c=e(r(204)),s=r(135);u.default.versions.mobile&&window.screen.width<800&&(function(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var i=t[r];o=n,u=i.getAttribute("href"),c=/\/|index.html/g,o.replace(c,"")===u.replace(c,"")&&(0,f.default)(i,"active")}var o,u,c}(),document.querySelector("#container").addEventListener("scroll",function(t){o()}),window.addEventListener("scroll",function(t){o()}),o()),(0,s.addLoadEvent)(function(){c.default.init()}),t.exports={}},,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object.defineProperty(t,n,{writable:!0,configurable:!0,value:r})}if(r(413),r(209),r(211),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},function(L,t){(function(t){!function(t){"use strict";function o(t,n,r,e){var o,u,c,f,i=n&&n.prototype instanceof h?n:h,a=Object.create(i.prototype),s=new p(e||[]);return a._invoke=(o=t,u=r,c=s,f=_,function(t,n){if(f===E)throw new Error("Generator is already running");if(f===M){if("throw"===t)throw n;return d()}for(c.method=t,c.arg=n;;){var r=c.delegate;if(r){var e=v(r,c);if(e){if(e===P)continue;return e}}if("next"===c.method)c.sent=c._sent=c.arg;else if("throw"===c.method){if(f===_)throw f=M,c.arg;c.dispatchException(c.arg)}else"return"===c.method&&c.abrupt("return",c.arg);f=E;var i=l(o,u,c);if("normal"===i.type){if(f=c.done?M:O,i.arg===P)continue;return{value:i.arg,done:c.done}}"throw"===i.type&&(f=M,c.method="throw",c.arg=i.arg)}}),a}function l(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function h(){}function r(){}function n(){}function e(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function u(c){function f(t,n,r,e){var i=l(c[t],c,n);if("throw"!==i.type){var o=i.arg,u=o.value;return u&&"object"==typeof u&&y.call(u,"__await")?Promise.resolve(u.__await).then(function(t){f("next",t,r,e)},function(t){f("throw",t,r,e)}):Promise.resolve(u).then(function(t){o.value=t,r(o)},e)}e(i.arg)}var n;"object"==typeof t.process&&t.process.domain&&(f=t.process.domain.bind(f)),this._invoke=function(r,e){function t(){return new Promise(function(t,n){f(r,e,t,n)})}return n=n?n.then(t,t):t()}}function v(t,n){var r=t.iterator[n.method];if(r===a){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=a,v(t,n),"throw"===n.method))return P;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return P}var e=l(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,P;var i=e.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=a),n.delegate=null,P):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,P)}function i(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function c(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(i,this),this.reset(!0)}function f(n){if(n){var t=n[b];if(t)return t.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var r=-1,e=function t(){for(;++r<n.length;)if(y.call(n,r))return t.value=n[r],t.done=!1,t;return t.value=a,t.done=!0,t};return e.next=e}}return{next:d}}function d(){return{value:a,done:!0}}var a,s=Object.prototype,y=s.hasOwnProperty,g="function"==typeof Symbol?Symbol:{},b=g.iterator||"@@iterator",x=g.asyncIterator||"@@asyncIterator",m=g.toStringTag||"@@toStringTag",S="object"==typeof L,w=t.regeneratorRuntime;if(w)S&&(L.exports=w);else{(w=t.regeneratorRuntime=S?L.exports:{}).wrap=o;var _="suspendedStart",O="suspendedYield",E="executing",M="completed",P={},j={};j[b]=function(){return this};var F=Object.getPrototypeOf,A=F&&F(F(f([])));A&&A!==s&&y.call(A,b)&&(j=A);var I=n.prototype=h.prototype=Object.create(j);r.prototype=I.constructor=n,n.constructor=r,n[m]=r.displayName="GeneratorFunction",w.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===r||"GeneratorFunction"===(n.displayName||n.name))},w.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,n):(t.__proto__=n,m in t||(t[m]="GeneratorFunction")),t.prototype=Object.create(I),t},w.awrap=function(t){return{__await:t}},e(u.prototype),u.prototype[x]=function(){return this},w.AsyncIterator=u,w.async=function(t,n,r,e){var i=new u(o(t,n,r,e));return w.isGeneratorFunction(n)?i:i.next().then(function(t){return t.done?t.value:i.next()})},e(I),I[m]="Generator",I[b]=function(){return this},I.toString=function(){return"[object Generator]"},w.keys=function(r){var e=[];for(var t in r)e.push(t);return e.reverse(),function t(){for(;e.length;){var n=e.pop();if(n in r)return t.value=n,t.done=!1,t}return t.done=!0,t}},w.values=f,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=a,this.done=!1,this.delegate=null,this.method="next",this.arg=a,this.tryEntries.forEach(c),!t)for(var n in this)"t"===n.charAt(0)&&y.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=a)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){function t(t,n){return o.type="throw",o.arg=r,e.next=t,n&&(e.method="next",e.arg=a),!!n}if(this.done)throw r;for(var e=this,n=this.tryEntries.length-1;0<=n;--n){var i=this.tryEntries[n],o=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var u=y.call(i,"catchLoc"),c=y.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return t(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;0<=r;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&y.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,P):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),P},finish:function(t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),c(r),P}},catch:function(t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;c(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:f(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=a),P}}}}("object"==typeof t?t:"object"==typeof window?window:"object"==typeof self?self:this)}).call(t,function(){return this}())},,function(t,n,r){r(221),t.exports=r(46).RegExp.escape},,,,function(t,n,r){var e=r(5),i=r(123),o=r(7)("species");t.exports=function(t){var n;return i(t)&&("function"!=typeof(n=t.constructor)||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&(null===(n=n[o])&&(n=void 0))),void 0===n?Array:n}},function(t,n,r){"use strict";var e=r(4),i=Date.prototype.getTime,o=Date.prototype.toISOString,u=function(t){return 9<t?t:"0"+t};t.exports=e(function(){return"0385-07-25T07:06:39.999Z"!=o.call(new Date(-5e13-1))})||!e(function(){o.call(new Date(NaN))})?function(){if(!isFinite(i.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":9999<n?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(99<r?r:"0"+u(r))+"Z"}:o},function(t,n,r){"use strict";var e=r(2),i=r(53);t.exports=function(t){if("string"!==t&&"number"!==t&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),"number"!=t)}},function(t,n,r){var c=r(74),f=r(127),a=r(117);t.exports=function(t){var n=c(t),r=f.f;if(r)for(var e,i=r(t),o=a.f,u=0;i.length>u;)o.call(t,e=i[u++])&&n.push(e);return n}},function(t,n,r){t.exports=r(118)("native-function-to-string",Function.toString)},function(t,n){t.exports=function(n,r){var e=r===Object(r)?function(t){return r[t]}:r;return function(t){return String(t).replace(n,e)}}},function(t,n,r){var e=r(1),i=r(220)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(166)}),r(67)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(50)(4);e(e.P+e.F*!r(48)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(137)}),r(67)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(50)(2);e(e.P+e.F*!r(48)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(50)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0)}}),r(67)(o)},function(t,n,r){"use strict";var e=r(1),i=r(50)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0)}}),r(67)(o)},function(t,n,r){"use strict";var e=r(1),i=r(50)(0),o=r(48)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var h=r(47),e=r(1),v=r(17),p=r(177),d=r(145),y=r(8),g=r(139),b=r(161);e(e.S+e.F*!r(125)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,e,i,o=v(t),u="function"==typeof this?this:Array,c=arguments.length,f=1<c?arguments[1]:void 0,a=void 0!==f,s=0,l=b(o);if(a&&(f=h(f,2<c?arguments[2]:void 0,2)),null==l||u==Array&&d(l))for(r=new u(n=y(o.length));s<n;s++)g(r,s,a?f(o[s],s):o[s]);else for(i=l.call(o),r=new u;!(e=i.next()).done;s++)g(r,s,a?p(i,f,[e.value,s],!0):e.value);return r.length=s,r}})},function(t,n,r){"use strict";var e=r(1),i=r(120)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(48)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(123)})},function(t,n,r){"use strict";var e=r(1),i=r(33),o=[].join;e(e.P+e.F*(r(116)!=Object||!r(48)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(33),o=r(49),u=r(8),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(48)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(1<arguments.length&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);0<=e;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(50)(1);e(e.P+e.F*!r(48)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(139);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);t<n;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(168);e(e.P+e.F*!r(48)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(168);e(e.P+e.F*!r(48)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(143),a=r(45),s=r(78),l=r(8),h=[].slice;e(e.P+e.F*r(4)(function(){i&&h.call(i)}),"Array",{slice:function(t,n){var r=l(this.length),e=a(this);if(n=void 0===n?r:n,"Array"==e)return h.call(this,t,n);for(var i=s(t,r),o=s(n,r),u=l(o-i),c=new Array(u),f=0;f<u;f++)c[f]="String"==e?this.charAt(i+f):this[i+f];return c}})},function(t,n,r){"use strict";var e=r(1),i=r(50)(3);e(e.P+e.F*!r(48)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(21),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(48)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(77)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){var e=r(1),i=r(216);e(e.P+e.F*(Date.prototype.toISOString!==i),"Date",{toISOString:i})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(26)(i,e,r(217))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(27)(e,o,function(){var t=c.call(this);return t==t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(169)})},function(t,n,r){"use strict";var e=r(5),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=Function.prototype,o=/^\s*function ([^ (]*)/;"name"in i||r(10)&&e(i,"name",{configurable:!0,get:function(){try{return(""+this).match(o)[1]}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(180),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:94906265.62425156<t?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){var e=r(1),i=Math.asinh;e(e.S+e.F*!(i&&0<1/i(0)),"Math",{asinh:function t(n){return isFinite(n=+n)&&0!=n?n<0?-t(-n):Math.log(n+Math.sqrt(n*n+1)):n}})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(149);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(148);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1);e(e.S,"Math",{fround:r(179)})},function(t,n,r){var e=r(1),f=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,i=0,o=0,u=arguments.length,c=0;o<u;)c<(r=f(arguments[o++]))?(i=i*(e=c/r)*e+1,c=r):0<r?i+=(e=r/c)*e:i+=r;return c===1/0?1/0:c*Math.sqrt(i)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)*Math.LOG10E}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(180)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(149)})},function(t,n,r){var e=r(1),i=r(148),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(148),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(0<t?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(30),o=r(45),u=r(144),s=r(53),c=r(4),f=r(73).f,a=r(31).f,l=r(11).f,h=r(84).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(72)(y))==v,b="trim"in String.prototype,x=function(t){var n=s(t,!1);if("string"==typeof n&&2<n.length){var r,e,i,o=(n=b?n.trim():h(n,3)).charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,c=n.slice(2),f=0,a=c.length;f<a;f++)if((u=c.charCodeAt(f))<48||i<u)return NaN;return parseInt(c,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?c(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(x(n)),r,p):x(n)};for(var m,S=r(10)?f(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),w=0;S.length>w;w++)i(d,m=S[w])&&!i(p,m)&&l(p,m,a(d,m));(p.prototype=y).constructor=p,r(27)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(176)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(176),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(188);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(189);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),a=r(49),s=r(165),l=r(156),i=1..toFixed,o=Math.floor,u=[0,0,0,0,0,0],h="Number.toFixed: incorrect invocation!",v=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*u[r],u[r]=e%1e7,e=o(e/1e7)},p=function(t){for(var n=6,r=0;0<=--n;)r+=u[n],u[n]=o(r/t),r=r%t*1e7},d=function(){for(var t=6,n="";0<=--t;)if(""!==n||0===t||0!==u[t]){var r=String(u[t]);n=""===n?r:n+l.call("0",7-r.length)+r}return n},y=function(t,n,r){return 0===n?r:n%2==1?y(t,n-1,r*t):y(t*t,n/2,r)};e(e.P+e.F*(!!i&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){i.call({})})),"Number",{toFixed:function(t){var n,r,e,i,o=s(this,h),u=a(t),c="",f="0";if(u<0||20<u)throw RangeError(h);if(o!=o)return"NaN";if(o<=-1e21||1e21<=o)return String(o);if(o<0&&(c="-",o=-o),1e-21<o)if(r=(n=function(t){for(var n=0,r=t;4096<=r;)n+=12,r/=4096;for(;2<=r;)n+=1,r/=2;return n}(o*y(2,69,1))-69)<0?o*y(2,-n,1):o/y(2,n,1),r*=4503599627370496,0<(n=52-n)){for(v(0,r),e=u;7<=e;)v(1e7,0),e-=7;for(v(y(10,e,1),0),e=n-1;23<=e;)p(1<<23),e-=23;p(1<<e),v(1,1),p(2),f=d()}else v(0,r),v(1<<-n,0),f=d()+l.call("0",u);return f=0<u?c+((i=f.length)<=u?"0."+l.call("0",u-i)+f:f.slice(0,i-u)+"."+f.slice(i-u)):c+f}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(165),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(182)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(72)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(183)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(5),i=r(69).onFreeze;r(52)("freeze",function(n){return function(t){return n&&e(t)?n(i(t)):t}})},function(t,n,r){var e=r(33),i=r(31).f;r(52)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(52)("getOwnPropertyNames",function(){return r(184).f})},function(t,n,r){var e=r(17),i=r(32);r(52)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(5);r(52)("isExtensible",function(n){return function(t){return!!e(t)&&(!n||n(t))}})},function(t,n,r){var e=r(5);r(52)("isFrozen",function(n){return function(t){return!e(t)||!!n&&n(t)}})},function(t,n,r){var e=r(5);r(52)("isSealed",function(n){return function(t){return!e(t)||!!n&&n(t)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(192)})},function(t,n,r){var e=r(17),i=r(74);r(52)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(5),i=r(69).onFreeze;r(52)("preventExtensions",function(n){return function(t){return n&&e(t)?n(i(t)):t}})},function(t,n,r){var e=r(5),i=r(69).onFreeze;r(52)("seal",function(n){return function(t){return n&&e(t)?n(i(t)):t}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(153).set})},function(t,n,r){"use strict";var e=r(81),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(27)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(188);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(189);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u,c=r(68),f=r(3),a=r(47),s=r(81),l=r(1),h=r(5),v=r(21),p=r(70),d=r(71),y=r(119),g=r(158).set,b=r(150)(),x=r(151),m=r(190),S=r(133),w=r(191),_="Promise",O=f.TypeError,E=f.process,M=E&&E.versions,P=M&&M.v8||"",j=f[_],F="process"==s(E),A=function(){},I=i=x.f,L=!!function(){try{var t=j.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(A,A)};return(F||"function"==typeof PromiseRejectionEvent)&&t.then(A)instanceof n&&0!==P.indexOf("6.6")&&-1===S.indexOf("Chrome/66")}catch(t){}}(),N=function(t){var n;return!(!h(t)||"function"!=typeof(n=t.then))&&n},T=function(s,r){if(!s._n){s._n=!0;var e=s._c;b(function(){for(var f=s._v,a=1==s._s,t=0,n=function(t){var n,r,e,i=a?t.ok:t.fail,o=t.resolve,u=t.reject,c=t.domain;try{i?(a||(2==s._h&&C(s),s._h=1),!0===i?n=f:(c&&c.enter(),n=i(f),c&&(c.exit(),e=!0)),n===t.promise?u(O("Promise-chain cycle")):(r=N(n))?r.call(n,o,u):o(n)):u(f)}catch(t){c&&!e&&c.exit(),u(t)}};e.length>t;)n(e[t++]);s._c=[],s._n=!1,r&&!s._h&&k(s)})}},k=function(o){g.call(f,function(){var t,n,r,e=o._v,i=R(o);if(i&&(t=m(function(){F?E.emit("unhandledRejection",e,o):(n=f.onunhandledrejection)?n({promise:o,reason:e}):(r=f.console)&&r.error&&r.error("Unhandled promise rejection",e)}),o._h=F||R(o)?2:1),o._a=void 0,i&&t.e)throw t.v})},R=function(t){return 1!==t._h&&0===(t._a||t._c).length},C=function(n){g.call(f,function(){var t;F?E.emit("rejectionHandled",n):(t=f.onrejectionhandled)&&t({promise:n,reason:n._v})})},D=function(t){var n=this;n._d||(n._d=!0,(n=n._w||n)._v=t,n._s=2,n._a||(n._a=n._c.slice()),T(n,!0))},G=function(t){var r,e=this;if(!e._d){e._d=!0,e=e._w||e;try{if(e===t)throw O("Promise can't be resolved itself");(r=N(t))?b(function(){var n={_w:e,_d:!1};try{r.call(t,a(G,n,1),a(D,n,1))}catch(t){D.call(n,t)}}):(e._v=t,e._s=1,T(e,!1))}catch(t){D.call({_w:e,_d:!1},t)}}};L||(j=function(t){p(this,j,_,"_h"),v(t),e.call(this);try{t(a(G,this,1),a(D,this,1))}catch(t){D.call(this,t)}},(e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=r(76)(j.prototype,{then:function(t,n){var r=I(y(this,j));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=F?E.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&T(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),o=function(){var t=new e;this.promise=t,this.resolve=a(G,t,1),this.reject=a(D,t,1)},x.f=I=function(t){return t===j||t===u?new o(t):i(t)}),l(l.G+l.W+l.F*!L,{Promise:j}),r(83)(j,_),r(77)(_),u=r(46)[_],l(l.S+l.F*!L,_,{reject:function(t){var n=I(this);return(0,n.reject)(t),n.promise}}),l(l.S+l.F*(c||!L),_,{resolve:function(t){return w(c&&this===u?j:this,t)}}),l(l.S+l.F*!(L&&r(125)(function(t){j.all(t).catch(A)})),_,{all:function(t){var u=this,n=I(u),c=n.resolve,f=n.reject,r=m(function(){var e=[],i=0,o=1;d(t,!1,function(t){var n=i++,r=!1;e.push(void 0),o++,u.resolve(t).then(function(t){r||(r=!0,e[n]=t,--o||c(e))},f)}),--o||c(e)});return r.e&&f(r.v),n.promise},race:function(t){var n=this,r=I(n),e=r.reject,i=m(function(){d(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i.e&&e(i.v),r.promise}})},function(t,n,r){var e=r(1),o=r(21),u=r(2),c=(r(3).Reflect||{}).apply,f=Function.apply;e(e.S+e.F*!r(4)(function(){c(function(){})}),"Reflect",{apply:function(t,n,r){var e=o(t),i=u(r);return c?c(e,n,i):f.call(e,n,i)}})},function(t,n,r){var e=r(1),c=r(72),f=r(21),a=r(2),s=r(5),i=r(4),l=r(169),h=(r(3).Reflect||{}).construct,v=i(function(){function t(){}return!(h(function(){},[],t)instanceof t)}),p=!i(function(){h(function(){})});e(e.S+e.F*(v||p),"Reflect",{construct:function(t,n){f(t),a(n);var r=arguments.length<3?t:f(arguments[2]);if(p&&!v)return h(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(l.apply(t,e))}var i=r.prototype,o=c(s(i)?i:Object.prototype),u=Function.apply.call(t,o,n);return s(u)?u:o}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(53);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(146)(o,"Object",function(){var t,n=this._k;do{if(this._i>=n.length)return{value:void 0,done:!0}}while(!((t=n[this._i++])in this._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){var u=r(31),c=r(32),f=r(30),e=r(1),a=r(5),s=r(2);e(e.S,"Reflect",{get:function t(n,r){var e,i,o=arguments.length<3?n:arguments[2];return s(n)===o?n[r]:(e=u.f(n,r))?f(e,"value")?e.value:void 0!==e.get?e.get.call(o):void 0:a(i=c(n))?t(i,r,o):void 0}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(187)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(153);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){var f=r(11),a=r(31),s=r(32),l=r(30),e=r(1),h=r(75),v=r(2),p=r(5);e(e.S,"Reflect",{set:function t(n,r,e){var i,o,u=arguments.length<4?n:arguments[3],c=a.f(v(n),r);if(!c){if(p(o=s(n)))return t(o,r,e,u);c=h(0)}if(l(c,"value")){if(!1===c.writable||!p(u))return!1;if(i=a.f(u,r)){if(i.get||i.set||!1===i.writable)return!1;i.value=e,f.f(u,r,i)}else f.f(u,r,h(0,e));return!0}return void 0!==c.set&&(c.set.call(u,e),!0)}})},function(t,n,r){var e=r(3),o=r(144),i=r(11).f,u=r(73).f,c=r(124),f=r(115),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),i=void 0===n;return!r&&e&&t.constructor===a&&i?t:o(p?new s(e&&!i?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&i?f.call(t):n),r?this:l,a)};for(var d=function(n){n in a||i(a,n,{configurable:!0,get:function(){return s[n]},set:function(t){s[n]=t}})},y=u(s),g=0;y.length>g;)d(y[g++]);(l.constructor=a).prototype=l,r(27)(e,"RegExp",a)}r(77)("RegExp")},function(t,n,r){"use strict";var l=r(2),h=r(8),v=r(136),p=r(128);r(122)("match",1,function(e,i,a,s){return[function(t){var n=e(this),r=null==t?void 0:t[i];return void 0!==r?r.call(t,n):new RegExp(t)[i](String(n))},function(t){var n=s(a,t,this);if(n.done)return n.value;var r=l(t),e=String(this);if(!r.global)return p(r,e);for(var i,o=r.unicode,u=[],c=r.lastIndex=0;null!==(i=p(r,e));){var f=String(i[0]);""===(u[c]=f)&&(r.lastIndex=v(e,h(r.lastIndex),o)),c++}return 0===c?null:u}]})},function(t,n,r){"use strict";var O=r(2),e=r(17),E=r(8),M=r(49),P=r(136),j=r(128),F=Math.max,A=Math.min,h=Math.floor,v=/\$([$&`']|\d\d?|<[^>]*>)/g,p=/\$([$&`']|\d\d?)/g;r(122)("replace",2,function(i,o,S,w){function _(o,u,c,f,a,t){var s=c+o.length,l=f.length,n=p;return void 0!==a&&(a=e(a),n=v),S.call(t,n,function(t,n){var r;switch(n.charAt(0)){case"$":return"$";case"&":return o;case"`":return u.slice(0,c);case"'":return u.slice(s);case"<":r=a[n.slice(1,-1)];break;default:var e=+n;if(0===e)return t;if(l<e){var i=h(e/10);return 0===i?t:i<=l?void 0===f[i-1]?n.charAt(1):f[i-1]+n.charAt(1):t}r=f[e-1]}return void 0===r?"":r})}return[function(t,n){var r=i(this),e=null==t?void 0:t[o];return void 0!==e?e.call(t,r,n):S.call(String(r),t,n)},function(t,n){var r=w(S,t,this,n);if(r.done)return r.value;var e=O(t),i=String(this),o="function"==typeof n;o||(n=String(n));var u,c=e.global;if(c){var f=e.unicode;e.lastIndex=0}for(var a=[];;){var s=j(e,i);if(null===s)break;if(a.push(s),!c)break;""===String(s[0])&&(e.lastIndex=P(i,E(e.lastIndex),f))}for(var l="",h=0,v=0;v<a.length;v++){s=a[v];for(var p=String(s[0]),d=F(A(M(s.index),i.length),0),y=[],g=1;g<s.length;g++)y.push(void 0===(u=s[g])?u:String(u));var b=s.groups;if(o){var x=[p].concat(y,d,i);void 0!==b&&x.push(b);var m=String(n.apply(void 0,x))}else m=_(p,i,d,y,b,n);h<=d&&(l+=i.slice(h,d)+m,h=d+p.length)}return l+i.slice(h)}]})},function(t,n,r){"use strict";var f=r(2),a=r(192),s=r(128);r(122)("search",1,function(e,i,u,c){return[function(t){var n=e(this),r=null==t?void 0:t[i];return void 0!==r?r.call(t,n):new RegExp(t)[i](String(n))},function(t){var n=c(u,t,this);if(n.done)return n.value;var r=f(t),e=String(this),i=r.lastIndex;a(i,0)||(r.lastIndex=0);var o=s(r,e);return a(r.lastIndex,i)||(r.lastIndex=i),null===o?-1:o.index}]})},function(t,n,r){"use strict";var l=r(124),x=r(2),m=r(119),S=r(136),w=r(8),_=r(128),h=r(152),e=r(4),O=Math.min,v=[].push,u="split",p="length",d="lastIndex",E=4294967295,M=!e(function(){RegExp(E,"y")});r(122)("split",2,function(i,o,y,g){var b;return b="c"=="abbc"[u](/(b)*/)[1]||4!="test"[u](/(?:)/,-1)[p]||2!="ab"[u](/(?:ab)*/)[p]||4!="."[u](/(.?)(.?)/)[p]||1<"."[u](/()()/)[p]||""[u](/.?/)[p]?function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!l(t))return y.call(r,t,n);for(var e,i,o,u=[],c=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),f=0,a=void 0===n?E:n>>>0,s=new RegExp(t.source,c+"g");(e=h.call(s,r))&&!(f<(i=s[d])&&(u.push(r.slice(f,e.index)),1<e[p]&&e.index<r[p]&&v.apply(u,e.slice(1)),o=e[0][p],f=i,u[p]>=a));)s[d]===e.index&&s[d]++;return f===r[p]?!o&&s.test("")||u.push(""):u.push(r.slice(f)),u[p]>a?u.slice(0,a):u}:"0"[u](void 0,0)[p]?function(t,n){return void 0===t&&0===n?[]:y.call(this,t,n)}:y,[function(t,n){var r=i(this),e=null==t?void 0:t[o];return void 0!==e?e.call(t,r,n):b.call(String(r),t,n)},function(t,n){var r=g(b,t,this,n,b!==y);if(r.done)return r.value;var e=x(t),i=String(this),o=m(e,RegExp),u=e.unicode,c=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(M?"y":"g"),f=new o(M?e:"^(?:"+e.source+")",c),a=void 0===n?E:n>>>0;if(0===a)return[];if(0===i.length)return null===_(f,i)?[i]:[];for(var s=0,l=0,h=[];l<i.length;){f.lastIndex=M?l:0;var v,p=_(f,M?i:i.slice(l));if(null===p||(v=O(w(f.lastIndex+(M?0:l)),i.length))===s)l=S(i,l,u);else{if(h.push(i.slice(s,l)),h.length===a)return h;for(var d=1;d<=p.length-1;d++)if(h.push(p[d]),h.length===a)return h;l=s=v}}return h.push(i.slice(s)),h}]})},function(t,n,r){"use strict";r(198);var e=r(2),i=r(115),o=r(10),u="toString",c=/./[u],f=function(t){r(27)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(28)("anchor",function(n){return function(t){return n(this,"a","name",t)}})},function(t,n,r){"use strict";r(28)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(28)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(28)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(131)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),u=r(8),c=r(155),f="endsWith",a=""[f];e(e.P+e.F*r(142)(f),"String",{endsWith:function(t){var n=c(this,t,f),r=1<arguments.length?arguments[1]:void 0,e=u(n.length),i=void 0===r?e:Math.min(u(r),e),o=String(t);return a?a.call(n,o,i):n.slice(i-o.length,i)===o}})},function(t,n,r){"use strict";r(28)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(28)("fontcolor",function(n){return function(t){return n(this,"font","color",t)}})},function(t,n,r){"use strict";r(28)("fontsize",function(n){return function(t){return n(this,"font","size",t)}})},function(t,n,r){var e=r(1),o=r(78),u=String.fromCharCode,i=String.fromCodePoint;e(e.S+e.F*(!!i&&1!=i.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,i=0;i<e;){if(n=+arguments[i++],o(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?u(n):u(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(155);e(e.P+e.F*r(142)("includes"),"String",{includes:function(t){return!!~i(this,t,"includes").indexOf(t,1<arguments.length?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(28)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(131)(!0);r(147)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(28)("link",function(n){return function(t){return n(this,"a","href",t)}})},function(t,n,r){var e=r(1),u=r(33),c=r(8);e(e.S,"String",{raw:function(t){for(var n=u(t.raw),r=c(n.length),e=arguments.length,i=[],o=0;o<r;)i.push(String(n[o++])),o<e&&i.push(String(arguments[o]));return i.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(156)})},function(t,n,r){"use strict";r(28)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(8),o=r(155),u="startsWith",c=""[u];e(e.P+e.F*r(142)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(1<arguments.length?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(28)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(28)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(28)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(84)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),u=r(30),i=r(10),o=r(1),c=r(27),f=r(69).KEY,a=r(4),s=r(118),l=r(83),h=r(79),v=r(7),p=r(195),d=r(160),y=r(218),g=r(123),b=r(2),x=r(5),m=r(17),S=r(33),w=r(53),_=r(75),O=r(72),E=r(184),M=r(31),P=r(127),j=r(11),F=r(74),A=M.f,I=j.f,L=E.f,N=e.Symbol,T=e.JSON,k=T&&T.stringify,R="prototype",C=v("_hidden"),D=v("toPrimitive"),G={}.propertyIsEnumerable,W=s("symbol-registry"),U=s("symbols"),V=s("op-symbols"),B=Object[R],q="function"==typeof N&&!!P.f,z=e.QObject,K=!z||!z[R]||!z[R].findChild,H=i&&a(function(){return 7!=O(I({},"a",{get:function(){return I(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=A(B,n);e&&delete B[n],I(t,n,r),e&&t!==B&&I(B,n,e)}:I,J=function(t){var n=U[t]=O(N[R]);return n._k=t,n},$=q&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===B&&Y(V,n,r),b(t),n=w(n,!0),b(r),u(U,n)?(r.enumerable?(u(t,C)&&t[C][n]&&(t[C][n]=!1),r=O(r,{enumerable:_(0,!1)})):(u(t,C)||I(t,C,_(1,{})),t[C][n]=!0),H(t,n,r)):I(t,n,r)},X=function(t,n){b(t);for(var r,e=y(n=S(n)),i=0,o=e.length;i<o;)Y(t,r=e[i++],n[r]);return t},Q=function(t){var n=G.call(this,t=w(t,!0));return!(this===B&&u(U,t)&&!u(V,t))&&(!(n||!u(this,t)||!u(U,t)||u(this,C)&&this[C][t])||n)},Z=function(t,n){if(t=S(t),n=w(n,!0),t!==B||!u(U,n)||u(V,n)){var r=A(t,n);return!r||!u(U,n)||u(t,C)&&t[C][n]||(r.enumerable=!0),r}},tt=function(t){for(var n,r=L(S(t)),e=[],i=0;r.length>i;)u(U,n=r[i++])||n==C||n==f||e.push(n);return e},nt=function(t){for(var n,r=t===B,e=L(r?V:S(t)),i=[],o=0;e.length>o;)!u(U,n=e[o++])||r&&!u(B,n)||i.push(U[n]);return i};q||(c((N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var n=h(0<arguments.length?arguments[0]:void 0),r=function(t){this===B&&r.call(V,t),u(this,C)&&u(this[C],n)&&(this[C][n]=!1),H(this,n,_(1,t))};return i&&K&&H(B,n,{configurable:!0,set:r}),J(n)})[R],"toString",function(){return this._k}),M.f=Z,j.f=Y,r(73).f=E.f=tt,r(117).f=Q,P.f=nt,i&&!r(68)&&c(B,"propertyIsEnumerable",Q,!0),p.f=function(t){return J(v(t))}),o(o.G+o.W+o.F*!q,{Symbol:N});for(var rt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;rt.length>et;)v(rt[et++]);for(var it=F(v.store),ot=0;it.length>ot;)d(it[ot++]);o(o.S+o.F*!q,"Symbol",{for:function(t){return u(W,t+="")?W[t]:W[t]=N(t)},keyFor:function(t){if(!$(t))throw TypeError(t+" is not a symbol!");for(var n in W)if(W[n]===t)return n},useSetter:function(){K=!0},useSimple:function(){K=!1}}),o(o.S+o.F*!q,"Object",{create:function(t,n){return void 0===n?O(t):X(O(t),n)},defineProperty:Y,defineProperties:X,getOwnPropertyDescriptor:Z,getOwnPropertyNames:tt,getOwnPropertySymbols:nt});var ut=a(function(){P.f(1)});o(o.S+o.F*ut,"Object",{getOwnPropertySymbols:function(t){return P.f(m(t))}}),T&&o(o.S+o.F*(!q||a(function(){var t=N();return"[null]"!=k([t])||"{}"!=k({a:t})||"{}"!=k(Object(t))})),"JSON",{stringify:function(t){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);if(r=n=e[1],(x(n)||void 0!==t)&&!$(t))return g(n)||(n=function(t,n){if("function"==typeof r&&(n=r.call(this,t,n)),!$(n))return n}),e[1]=n,k.apply(T,e)}}),N[R][D]||r(26)(N[R],D,N[R].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(132),o=r(159),a=r(2),s=r(78),l=r(8),u=r(5),c=r(3).ArrayBuffer,h=r(119),v=o.ArrayBuffer,p=o.DataView,f=i.ABV&&c.isView,d=v.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(c!==v),{ArrayBuffer:v}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return f&&f(t)||u(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new v(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(a(this),t);for(var r=a(this).byteLength,e=s(t,r),i=s(void 0===n?r:n,r),o=new(h(this,v))(l(i-e)),u=new p(this),c=new p(o),f=0;e<i;)c.setUint8(f++,u.getUint8(e++));return o}}),r(77)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(132).ABV,{DataView:r(159).DataView})},function(t,n,r){r(57)("Float32",4,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Float64",8,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Int16",2,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Int32",4,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Int8",1,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint16",2,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint32",4,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint8",1,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint8",1,function(e){return function(t,n,r){return e(this,t,n,r)}},!0)},function(t,n,r){"use strict";var e=r(172),i=r(80);r(121)("WeakSet",function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},{add:function(t){return e.def(i(this,"WeakSet"),t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(173),o=r(17),u=r(8),c=r(21),f=r(138);e(e.P,"Array",{flatMap:function(t){var n,r,e=o(this);return c(t),n=u(e.length),r=f(e,0),i(r,e,e,n,0,1,t,arguments[1]),r}}),r(67)("flatMap")},function(t,n,r){"use strict";var e=r(1),i=r(173),o=r(17),u=r(8),c=r(49),f=r(138);e(e.P,"Array",{flatten:function(){var t=arguments[0],n=o(this),r=u(n.length),e=f(n,0);return i(e,n,n,r,0,void 0===t?1:c(t)),e}}),r(67)("flatten")},function(t,n,r){"use strict";var e=r(1),i=r(120)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0)}}),r(67)("includes")},function(t,n,r){var e=r(1),i=r(150)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.G,{global:r(3)})},function(t,n,r){r(129)("Map")},function(t,n,r){r(130)("Map")},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(171)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{clamp:function(t,n,r){return Math.min(r,Math.max(n,t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{DEG_PER_RAD:Math.PI/180})},function(t,n,r){var e=r(1),i=180/Math.PI;e(e.S,"Math",{degrees:function(t){return t*i}})},function(t,n,r){var e=r(1),o=r(181),u=r(179);e(e.S,"Math",{fscale:function(t,n,r,e,i){return u(o(t,n,r,e,i))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=r>>>0;return(n>>>0)+(e>>>0)+((i&o|(i|o)&~(i+o>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=+t,e=+n,i=65535&r,o=65535&e,u=r>>16,c=e>>16,f=(u*o>>>0)+(i*o>>>16);return u*c+(f>>16)+((i*c>>>0)+(65535&f)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=r>>>0;return(n>>>0)-(e>>>0)-((~i&o|~(i^o)&i-o>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{RAD_PER_DEG:180/Math.PI})},function(t,n,r){var e=r(1),i=Math.PI/180;e(e.S,"Math",{radians:function(t){return t*i}})},function(t,n,r){var e=r(1);e(e.S,"Math",{scale:r(181)})},function(t,n,r){var e=r(1);e(e.S,"Math",{signbit:function(t){return(t=+t)!=t?t:0==t?1/t==1/0:0<t}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=+t,e=+n,i=65535&r,o=65535&e,u=r>>>16,c=e>>>16,f=(u*o>>>0)+(i*o>>>16);return u*c+(f>>>16)+((i*c>>>0)+(65535&f)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(21),u=r(11);r(10)&&e(e.P+r(126),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(21),u=r(11);r(10)&&e(e.P+r(126),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(186)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),f=r(187),a=r(33),s=r(31),l=r(139);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r,e=a(t),i=s.f,o=f(e),u={},c=0;o.length>c;)void 0!==(r=i(e,n=o[c++]))&&l(u,n,r);return u}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53),u=r(32),c=r(31).f;r(10)&&e(e.P+r(126),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53),u=r(32),c=r(31).f;r(10)&&e(e.P+r(126),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(186)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),o=r(3),u=r(46),i=r(150)(),c=r(7)("observable"),f=r(21),a=r(2),s=r(70),l=r(76),h=r(26),v=r(71),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},x=function(t,n){a(t),this._c=void 0,this._o=t,t=new m(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};x.prototype=l({},{unsubscribe:function(){b(this)}});var m=function(t){this._s=t};m.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var S=function(t){s(this,S,"Observable","_f")._f=f(t)};l(S.prototype,{subscribe:function(t){return new x(t,this._f)},forEach:function(e){var i=this;return new(u.Promise||o.Promise)(function(t,n){f(e);var r=i.subscribe({next:function(t){try{return e(t)}catch(t){n(t),r.unsubscribe()}},error:n,complete:t})})}}),l(S,{from:function(t){var n="function"==typeof this?this:S,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return i(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,e=new Array(n);t<n;)e[t]=arguments[t++];return new("function"==typeof this?this:S)(function(n){var r=!1;return i(function(){if(!r){for(var t=0;t<e.length;++t)if(n.next(e[t]),r)return;n.complete()}}),function(){r=!0}})}}),h(S.prototype,c,function(){return this}),e(e.G,{Observable:S}),r(77)("Observable")},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(3),u=r(119),c=r(191);e(e.P+e.R,"Promise",{finally:function(n){var r=u(this,i.Promise||o.Promise),t="function"==typeof n;return this.then(t?function(t){return c(r,n()).then(function(){return t})}:n,t?function(t){return c(r,n()).then(function(){throw t})}:n)}})},function(t,n,r){"use strict";var e=r(1),i=r(151),o=r(190);e(e.S,"Promise",{try:function(t){var n=i.f(this),r=o(t);return(r.e?n.reject:n.resolve)(r.v),n.promise}})},function(t,n,r){var e=r(56),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(56),o=r(2),u=e.key,c=e.map,f=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:u(arguments[2]),e=c(o(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var i=f.get(n);return i.delete(r),!!i.size||f.delete(n)}})},function(t,n,r){var o=r(199),u=r(167),e=r(56),i=r(2),c=r(32),f=e.keys,a=e.key,s=function(t,n){var r=f(t,n),e=c(t);if(null===e)return r;var i=s(e,n);return i.length?r.length?u(new o(r.concat(i))):i:r};e.exp({getMetadataKeys:function(t){return s(i(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(56),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(56),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=r(21),u=e.key,c=e.set;e.exp({metadata:function(r,e){return function(t,n){c(r,e,(void 0!==n?i:o)(t),u(n))}}})},function(t,n,r){r(129)("Set")},function(t,n,r){r(130)("Set")},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(171)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(131)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(51),o=r(8),u=r(124),c=r(115),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(146)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(193),o=r(133),u=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(o);e(e.P+e.F*u,"String",{padEnd:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(193),o=r(133),u=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(o);e(e.P+e.F*u,"String",{padStart:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(84)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(84)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(160)("asyncIterator")},function(t,n,r){r(160)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){r(129)("WeakMap")},function(t,n,r){r(130)("WeakMap")},function(t,n,r){r(129)("WeakSet")},function(t,n,r){r(130)("WeakSet")},function(t,n,r){for(var e=r(162),i=r(74),o=r(27),u=r(3),c=r(26),f=r(82),a=r(7),s=a("iterator"),l=a("toStringTag"),h=f.Array,v={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},p=i(v),d=0;d<p.length;d++){var y,g=p[d],b=v[g],x=u[g],m=x&&x.prototype;if(m&&(m[s]||c(m,s,h),m[l]||c(m,l,g),f[g]=h,b))for(y in e)m[y]||o(m,y,e[y],!0)}},function(t,n,r){var e=r(1),i=r(158);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(133),u=[].slice,c=/MSIE .\./.test(o),f=function(i){return function(t,n){var r=2<arguments.length,e=!!r&&u.call(arguments,2);return i(r?function(){("function"==typeof t?t:Function(t)).apply(this,e)}:t,n)}};i(i.G+i.B+i.F*c,{setTimeout:f(e.setTimeout),setInterval:f(e.setInterval)})},function(t,n,r){r(341),r(280),r(282),r(281),r(284),r(286),r(291),r(285),r(283),r(293),r(292),r(288),r(289),r(287),r(279),r(290),r(294),r(295),r(247),r(249),r(248),r(297),r(296),r(267),r(277),r(278),r(268),r(269),r(270),r(271),r(272),r(273),r(274),r(275),r(276),r(250),r(251),r(252),r(253),r(254),r(255),r(256),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(266),r(328),r(333),r(340),r(331),r(323),r(324),r(329),r(334),r(336),r(319),r(320),r(321),r(322),r(325),r(326),r(327),r(330),r(332),r(335),r(337),r(338),r(339),r(242),r(244),r(243),r(246),r(245),r(231),r(229),r(235),r(232),r(238),r(240),r(228),r(234),r(225),r(239),r(223),r(237),r(236),r(230),r(233),r(222),r(224),r(227),r(226),r(241),r(162),r(313),r(197),r(318),r(198),r(314),r(315),r(316),r(317),r(298),r(196),r(199),r(200),r(353),r(342),r(343),r(348),r(351),r(352),r(346),r(349),r(347),r(350),r(344),r(345),r(299),r(300),r(301),r(302),r(303),r(306),r(304),r(305),r(307),r(308),r(309),r(310),r(312),r(311),r(356),r(354),r(355),r(397),r(400),r(399),r(401),r(402),r(398),r(403),r(404),r(378),r(381),r(377),r(375),r(376),r(379),r(380),r(362),r(396),r(361),r(395),r(407),r(409),r(360),r(394),r(406),r(408),r(359),r(405),r(358),r(363),r(364),r(365),r(366),r(367),r(369),r(368),r(370),r(371),r(372),r(374),r(373),r(383),r(384),r(385),r(386),r(388),r(387),r(390),r(389),r(391),r(392),r(393),r(357),r(382),r(412),r(411),r(410),t.exports=r(46)},function(t,n){t.exports=function(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}}])</script><script src="/./main.a5fda8.js"></script><script>!function(){var e,t;e="/slider.27463f.js",t=document.createElement("script"),document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}()</script>



<!--  -->


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Android</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Andorid</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Architecture</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">Java</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color1">Material Design</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">RxJava</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Git</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">gradle</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Python</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">笔记</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">数据结构</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">Bitcoin</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">算法</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia-plus根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="/" target="_blank" class="search-title" >
                
                  <i class="icon-link icon"></i>
                
                张小伦爱学习
              </a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
        
          
  	  		<div class="aboutme-wrap" id="aboutme">程序员的男人</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>

  
  
  
  <!-- <script async type="text/javascript" size="90" alpha="0.2" zIndex="0" src="/plugins/ribbon.js/ribbon.min.js"></script> -->
  
  
  
</body>

</html>
